<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>nmap</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>nmap</h1><br/><p><strong><h1>TRYHACKME NMAP COMPLETE</h1></strong><h1>----&gt;</h1></p><p></p><p><strong><h3>List the IPs to be scanned without actually scanning them:</h3></strong></p><p></p><p>(-n to skip Reverse DNS lookup)</p><p>nmap -nsL Target_List/Target_IP</p><p></p><p>nmap -nsL 10.10.12.13/29</p><p>nmap -nsL 10.10.0-255.101-125</p><p></p><p></p><p>(With Reverse DNS lookup)</p><p>nmap -sL Target_List/Target_IP</p><p></p><p>nmap -sL 10.1</p><p>nmap -sL 10.10.0-255.101-125</p><p></p><p></p><p><strong><h3>Host Discovery “without” any Port Scans:</h3></strong><h3> (To check if Host/s are up)</h3></p><p></p><p>(General Host Discovery)</p><p>nmap -sn Target_List/Target_IP</p><p><strong>Note:</strong> Previous versions used -sP (Check man nmap)</p><p></p><p>(ARP only Host Discovery)</p><p>nmap -PR -sn Target_List/Target_IP</p><p></p><p>(PING/ICMP echo only Host Discovery)  ICMP 8/0</p><p>nmap -PE -sn Target_List/Target_IP</p><p>Remember that an ARP query will precede the ICMP request if your target is on the same subnet.</p><p></p><p>As Ping is blocked accross most machines. We can use ICMP Timestamp</p><p>(ICMP Timestamp Host Discovery)  ICMP 13/14</p><p>nmap -PP -sn Target_List/Target_IP</p><p></p><p>As Ping is blocked accross most machines. We can use ICMP Address Mask</p><p>(ICMP Address Mask Host Discovery) ICMP 17/18</p><p>nmap -PM -sn Target_List/Target_IP</p><p></p><p>Host Discovery using TCP &amp; UDP Ping</p><p>TCP SYN ping: nmap -PS -sn Target_List/Target_IP</p><p></p><p>-PS80 (default)</p><p>-PS20-25</p><p>-PS80,443,8080</p><p></p><p>Super User: 	SYN			SYN/ACK			RST</p><p>Normal User: 	SYN			SYN/ACK			ACK			</p><p></p><p></p><p>TCP ACK ping: nmap -PA -sn Target_List/Target_IP</p><p></p><p>-PS80 (default)</p><p>-PS20-25</p><p>-PS80,443,8080</p><p></p><p>Super User: 	ACK			RST</p><p>Normal User: 	Cannot Perform this</p><p></p><p></p><p>UDP Ping: 	nmap -PU -sn Target_List/Target_IP</p><p></p><p>Uses an uncommon port as only if port is closed we get a response &amp; know that system is online. (If port is open, we get no response)</p><p></p><p><strong><h3>Reverse DNS Lookup:</h3></strong></p><p></p><p>By Default nmap does Reverse DNS lookup. This can be skipped by -n option.</p><p>Now, to use reverse DNS lookup for all hosts(even offline) can be done using -R option</p><p></p><p><strong><h2>Port Scans:</h2></strong></p><p></p><p><strong><h3>TCP Connect Scan</h3></strong><h3>  (Can be performed by normal user also)</h3></p><p>By Default it scans <strong>most common</strong> 1000 ports:</p><p></p><p>nmap -sT Target_List/Target_IP</p><p></p><p></p><p><strong><h3>TCP SYN Scan</h3></strong><h3> (Only Preveleged User) : Default mode for Preveleged user.</h3></p><p></p><p>nmap -sS Target_List/Target_IP</p><p></p><p><strong><h3>UDP Scan:</h3></strong><h3> (Only Preveleged User)</h3></p><p></p><p>nmap -sU Target_List/Target_IP</p><p><strong>Note:</strong></p><p>As UDP Scan is very slow. So the Following Scans the Commonly used top 20 UDP Ports</p><p>nmap -sU --top-ports 20 &lt;target&gt;</p><p></p><p><strong><h3>Fine Tuning &amp; Managing Scope:</h3></strong></p><p></p><p>-F</p><p>We can use <strong>-F</strong> to enable fast mode and decrease the number of scanned ports from <strong>1000 to 100 </strong>most common ports.</p><p></p><p>--top-ports &lt;number&gt; : Eg. --top-ports 10  will scan 10 most common ports</p><p></p><p>-r</p><p>It is worth mentioning that the <strong>-r</strong> option can also be added to scan the ports in consecutive order instead of random order. </p><p>This option is useful when testing whether ports open in a consistent manner, for instance, when a target boots up.</p><p></p><p>-p</p><p>Port list: </p><p>-p22			: Scan 22</p><p>-p20-25 	: Scan 20,21,22,23,24,25</p><p>-p22,80	: Scan 22 &amp; 80</p><p>-p-			: Scan all 65535 </p><p></p><p>-T</p><p>Timmings. -T&lt;0-5&gt;</p><p>-T0	:	Paranoid (Slowest)</p><p>-T1	: 	Sneaky (Real World)</p><p>-T2	:	Polite</p><p>-T3	: 	Normal (Nmap Default)</p><p>-T4	:	Aggressive (CTFs)</p><p>-T5	:	Insane (Fastest)</p><p></p><p>Slow --→ Helps in IDS evasion</p><p></p><p>Alternatively we can control the packet rate:</p><p>--min-rate &lt;number&gt; Eg. --min-rate 10</p><p>--max-rate &lt;number&gt; Eg. --max-rate 20</p><p></p><p>Probing Parallelization: (Determines the number of parallel probes for host discovery &amp; port scans)</p><p>--min-parallelism &lt;numprobes&gt;  </p><p>--max-parallelism &lt;numprobes&gt;</p><p>Eg. --min-parallelism 512 : Indicates that nmap has to maintain atlest 512 parallel probes for host discovery &amp; port scans.</p><p></p><p></p><p><strong><h2>Advanced Port Scans:</h2></strong></p><p></p><p><strong><h3>Null Scan:</h3></strong><h3> (Only Preveleged User)</h3></p><p>Send TCP with no flags set. If Port Open or Firewall is present we get no response.</p><p>If no firewall  &amp; port is closed: We get a RST flag response. (indicating port is closed)</p><p></p><p>nmap -sN Target_List/Target_IP</p><p></p><p>Note: It can say with certainity if a port is closed. But for open ports its not sure as no response is recorded. (open|filtered)</p><p></p><p><strong><h3>FIN</h3></strong><h3> </h3><strong><h3>Scan:</h3></strong><h3> (Only Preveleged User)</h3></p><p>Send TCP with FIN flag set. If Port Open or Firewall is present we get no response.</p><p>If no firewall  &amp; port is closed: We get a RST flag response. (indicating port is closed)</p><p></p><p>nmap -sF Target_List/Target_IP</p><p></p><p>Note: It can say with certainity if a port is closed. But for open ports its not sure as no response is recorded. (open|filtered)</p><p></p><p><strong><h3>Xmas</h3></strong><h3> </h3><strong><h3>Scan:</h3></strong><h3> (Only Preveleged User)</h3></p><p>Send TCP with URG,PSH,FIN flag set. If Port Open or Firewall is present we get no response.</p><p>If no firewall  &amp; port is closed: We get a RST flag response. (indicating port is closed)</p><p></p><p>nmap -sX Target_List/Target_IP</p><p></p><p>Note: It can say with certainity if a port is closed. But for open ports its not sure as no response is recorded. (open|filtered)</p><p></p><p></p><p><strong>Null, FIN &amp; Xmas </strong>are best used when there is a stateless firewall. (That blocks SYN flag packets)</p><p>However, a Stateful Firewall will still block these 3 scans.</p><p></p><p><strong><h3>Maimon Scan:</h3></strong><h3> (Used for BSD-Derived System)</h3></p><p></p><p>Uses a TCP packet with FIN &amp; ACK flag set. Normally Open/Closed all ports should respond with a RST flag. So not very useful.</p><p>However, in certain BSD-Derived systems, if the port is open the packet is dropped &amp; no response is recorded. (Used to find Open|Filtered Ports)</p><p></p><p>nmap -sM Target_List/Target_IP</p><p></p><p><strong><h3>TCP ACK Scan:</h3></strong><h3> (Used to detect Firewall rule sets &amp; configuration)</h3></p><p></p><p>We send a TCP packet with ACK flag set. Irrespective of whether port is open or closed we get a RST flag in response. (So we cannot check for open ports)</p><p>However, if a port is blocked by the firewall, the packet is dropped. (Indicating Firewall blocked it)</p><p></p><p>Thus, the ports where we receive RST flag, we know that its accessible in firewall rules. (Can be open|closed)</p><p></p><p>nmap -sA Target_List/Target_IP</p><p></p><p><strong><h3>TCP Window Scan:</h3></strong><h3> (Used to detect Firewall rule sets &amp; configuration)</h3></p><p></p><p>We send a TCP packet with ACK flag set. Irrespective of whether port is open or closed we get a RST flag in response. </p><p>But upon checking the window position in the TCP header, we see certain differences.</p><p></p><p>If Firewall is blocking the port, packet is dropped. Else we get a RST flag.</p><p></p><p>nmap -sW Target_List/Target_IP</p><p></p><p><strong><h3>Custom Scan:</h3></strong></p><p></p><p>nmap --scanflags &lt;FLAGS&gt; Target_List/Target_IP</p><p></p><p>We can se multiple flags in our request and test.</p><p></p><p>-scanflags RSTSYNFIN : It will set the RST, SYN and FIN flags</p><p>-scanflags SYNACKURGPSHRSTFIN : It will set all flags: SYN, ACK, URG, PSH, RST and FIN</p><p></p><p><strong><h3>Spoof &amp; Decoy:</h3></strong></p><p></p><p>Spoof:</p><p>To make target think nmap coming from different IP/MAC &amp; send responses back to that IP/MAC. (Note: -Pn is required as we don&#39;t want any packets back to source)</p><p></p><p>IP Spoof</p><p>nmap -e NET_INTERFACE -Pn SPOOFED_IP Target_List/Target_IP</p><p>eg: nmap -e eth0 -Pn 10.10.10.10 Target_List/Target_IP</p><p></p><p>Responses will be sent to 10.10.10.10</p><p></p><p>MAC Spoof (Only works in all systems on same ethernet or wifi network)</p><p>nmap --spoof-mac SPOOFED_MAC Target_List/Target_IP</p><p></p><p>Decoy:</p><p>To send packets from multiple dummy targets as well as the attacker.</p><p>Keywords:</p><p>ME: Attacker IP</p><p>RND: Random IP</p><p></p><p>nmap -D 10.10.0.1,10.10.0.2,RND,RND,ME Target_List/Target_IP</p><p></p><p><strong><h3>Fragmented Packets:</h3></strong></p><p>Used for evasion against firewalls &amp; IDS. (Old)</p><p></p><p>nmap -f Target_List/Target_IP 	:	Divided packet into 8 bytes fragments plus change.</p><p>nmap -ff Target_List/Target_IP 	: 	Divides packet into 16 bytes fragments plus change.</p><p></p><p><strong><h3>Idle/Zombie Scan:</h3></strong></p><p>It spoofs the scan from zombie_ip and records the IP ID of the zombie/idle device for any increment <strong>more than 1</strong> in IP ID. </p><p>if <strong>IP ID increased more than 1</strong>, it means port is open &amp; the zombie/ID device received a SYN/ACK from target &amp; responded with a RST(thus increasing its IP ID by 2).</p><p>if <strong>IP ID remained the same</strong>, it means either the port is closed(a RST flag is recieved by zoombie → IP ID increase by 1) or firewall is blocking(no communication is recieved → IP ID remains same)</p><p></p><p>nmap -sI ZOMBIE_IP Target_List/Target_IP</p><p></p><p><strong><h3>Getting More Details:</h3></strong></p><p></p><p>--reason </p><p>Option gives the reason of all the outputs</p><p></p><p>-v</p><p>Option for verbose display</p><p></p><p>-vv</p><p>For very verbose display</p><p></p><p>-d</p><p>Detailed debug output</p><p></p><p>-dd</p><p>Very detailed debug output</p><p></p><p>--source-port PORT_NUM</p><p>Specify source Port Number</p><p></p><p>--data-length NUM</p><p>Append random data to reach given length</p><p></p><p><strong><h3>Service Detection:</h3></strong></p><p></p><p>Service Detection is achieved through -sV. It does a complete 3 way hankshake</p><p></p><p>--version-intensity LEVEL			:		LEVEL (0-9) 0: Lightest 9: Most Complete</p><p>--version-light							: 		Its equivalent to --version-intensity 2</p><p></p><p>eg. nmap -sV --version-intensity 7  Target_List/Target_IP</p><p>eg, nmap -sV --version-light Target_List/Target_IP</p><p></p><p><strong><h3>OS Detection:</h3></strong></p><p></p><p>-O </p><p>Capital O option is used for OS detection.</p><p>Generally type of OS is correctly determined in most cases. (Windows/Linux)</p><p>However, the version of running OS is not so accurate.</p><p></p><p>eg. nmap -sS -O Target_List/Target_IP</p><p></p><p><strong><h3>Traceroute:</h3></strong></p><p></p><p>-traceroute</p><p>It is used to show traceroute details in nmap scan. (It runs opposite to normal windows/linux traceroute)</p><p></p><p>eg. nmap -sS -traceroute Target_List/Target_IP</p><p></p><p><strong><h3>Scripts:</h3></strong></p><p></p><p>nmap -sS -sC Target_List/Target_IP								: This uses the default script, same as --script=default</p><p>nmap -sS --script=CATEGORY Target_List/Target_IP		: This uses the mentioned category</p><p>nmap -sS --script “xyz.nse” Target_List/Target_IP 			: This searches for xyz.nse in /usr/share/nmap/scripts folder</p><p></p><p>Categories---&gt;</p><p>auth 				: authentication related</p><p>broadcast			: discover hosts by sending broadcast messages</p><p>brute				: performs brute-force password auditing against logins</p><p>default				: default scripts, same as -sC</p><p>discovery			: retrieve accessible information such as database tables and dns names</p><p>dos					: detects servers vulnerable to denial of service</p><p>exploit				: attempts to exploit various vulnerable services</p><p>external			: checks using a third party plugin such as Geoplugin and Virustotal</p><p>fuzzer				: launch fuzzing attacks</p><p>intrusive			: intrusive scripts such as brute-force attacks and exploitation</p><p>malware			: scans for backdoors</p><p>safe					: safe scripts that wont crash the target</p><p>version				: retrieve service versions</p><p>vuln 					: checks for vulnerabilities or exploit vulnerable services</p><p></p><p><strong>Note: </strong>Multiple Scripts can be run using <strong>,</strong> as separator</p><p>eg. </p><p>nmap --script=smb-enum-users,smb-enum-shares Target_List/Target_IP</p><p></p><p><strong><h3>Script Arguments:</h3></strong></p><p></p><p>Some script requires additional arguments, the name of those arguments can be found by opening the scirpt in a text editor.</p><p>Then to pass the arguments to script we use --script-args ‘arga-name_1=value,arg_name_2=value’</p><p></p><p>Example-1:</p><p>Database Enumeration (Using Script Args)</p><p>nmap --script=mysql-databases.nse --script-args &#39;mysqluser=root,mysqlpass=&quot;password&quot;&#39; 10.10.213.240</p><p></p><p>Example-2:</p><p>Uploading a file using HTTP-POST</p><p>nmap --script http-put --script-args http-put.url=&#39;/dav/shell.php&#39;,http-put.file=&#39;./shell.php&#39; &lt;Target&gt;</p><p></p><p></p><p><strong><h3>Nmap Scripts Help Options:</h3></strong></p><p>By Default the Nmap Scripts come with help options which can be accessed by the following.</p><p></p><p>nmap --script-help &lt;script-name&gt;</p><p></p><p><strong>Note:</strong> List of Nmap Scripts in Text Format: /usr/share/nmap/scripts/script.db</p><p></p><p><strong><h3>Updating Scripts</h3></strong></p><p><strong>Automatic:</strong></p><p>Updating nmap (apt upgrage nmap)</p><p></p><p><strong>Manual:</strong></p><p>sudo wget -O /usr/share/nmap/scripts/&lt;script-name&gt;.nse https://svn.nmap.org/nmap/scripts/&lt;script-name&gt;.nse</p><p>nmap --script-updatedb</p><p></p><p><strong>Note:</strong> You would require the same &quot;updatedb&quot; command if you were to make your own NSE script and add it into Nmap -- a more than manageable task with some basic knowledge of Lua! </p><p></p><p></p><p><strong><h3>Outputs:</h3></strong></p><p></p><p>Formats: Normal, Grepable, XML &amp; Script Kiddie</p><p></p><p>-oN	:	Normal</p><p>-oG	:	Grepable</p><p>-oX	:	XML</p><p>-oA	:	Writes output in all 3 Normal, Grepable &amp; XML formats</p><p>-oS	:	Script Kiddie (Just normal output with styled charecters, no significant need)</p><p></p><p><strong><h3>Misc:</h3></strong></p><p></p><p>-A 	:	Equivalent to -sV -O -sC -traceroute</p><p></p><p></p><p><strong><h4>Firewall Evasion (Along with Techniques discussed above) </h4></strong><strong></strong></p><p><strong>Reference: </strong><a href="https://nmap.org/book/man-bypass-firewalls-ids.html">https://nmap.org/book/man-bypass-firewalls-ids.html</a></p><p></p><p>The following switches are of particular note:</p><p></p><p>    <strong>-f</strong>	# Used to fragment the packets (i.e. split them into smaller pieces) making it less likely that the packets will be detected by a firewall or IDS.</p><p>    An alternative to <strong>-f</strong>, but providing more control over the size of the packets: <strong>--mtu &lt;number&gt;</strong>, accepts a maximum transmission unit size to use for the packets sent. This must be a multiple of 8.</p><p>    <strong>--scan-delay &lt;time&gt;ms</strong> # used to add a delay between packets sent. This is very useful if the network is unstable, but also for evading any time-based firewall/IDS triggers which may be in place.</p><p>    <strong>--badsum</strong> # this is used to generate in invalid checksum for packets. Any real TCP/IP stack would drop this packet, however, firewalls may potentially respond automatically, without bothering to check the checksum of the packet. As such, this switch can be used to determine the presence of a firewall/IDS.</p><p>   <strong>--data-length &lt;number&gt;</strong> # Allows you to append an arbitrary length of random data to the end of packets</p><p></p><p><strong>Making a ports variable with quick scan and using this open ports for detailed scan</strong></p><p></p><p>ports=$(nmap -p- --min-rate 1000 -T4 10.10.10.150 | grep ^[0-9] | cut -d&#39;/&#39; -f 1 | tr &#39;\n&#39; &#39;,&#39; | sed s/,$//)</p><p>nmap -sC -sV -p$ports 10.10.10.150 --open</p><p></p><p><strong>Enumerating Samba with nmap:</strong></p><p>nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse 10.10.99.173</p><p></p><p><strong>Scanning RPC Port for NFS Shares:</strong></p><p>nmap -p 111 --script=nfs-ls,nfs-statfs,nfs-showmount 10.10.99.173</p><p></p><p></p><p><strong><h3>Red Teaming</h3></strong></p><p></p><p><strong>Example:</strong> The figure below shows the User-Agent that will be logged by the remote web server when running Nmap scans with the <strong>-sC</strong> option when Nmap probes the web server. If an HTTP user agent isn&#39;t set at the time of running the given Nmap script, the logs on the target system could log a user agent containing <strong>Nmap Scripting Engine</strong>. This can be mitigated using the option <strong>--script-args http.useragent=&quot;CUSTOM_AGENT&quot;</strong></p><p></p><p></p><p><img src="images/8-1.png" alt="images/8-1.png" /></p><p></p><p>By default, it will logged as above which we do not want in a Red Team Operation. Thus, use custom user agents.</p></div>
</body>
</html>
