<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>KAPE</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>KAPE</h1><br/><strong><h1>KAPE</h1></strong><br />An introduction to Kroll Artifact Parser and Extractor (KAPE) for collecting and processing forensic artifacts<br /><br /><strong><h2>Introduction to KAPE:</h2></strong><br /><br />Kroll Artifact Parser and Extractor (KAPE) parses and extracts Windows forensics artifacts. It is a tool that can significantly reduce the time needed to respond to an incident by providing forensic artifacts from a live system or a storage device much earlier than the imaging process completes. <br /><br />KAPE serves two primary purposes, 1) collect files and 2) process the collected files as per the provided options. For achieving these purposes, KAPE uses the concept of targets and modules. Targets can be defined as the forensic artifacts that need to be collected. Modules are programs that process the collected artifacts and extract information from them. We will learn about them in the upcoming tasks.<br /><br /><br /><strong><h3>How it works</h3></strong><br /><br />KAPE is extensible and highly configurable. In essence, the KAPE binary ﻿ collects files and processes them as per the provided configuration.<br /><br />The collection of files (targets) KAPE adds the files to a queue and copies them in two passes. In the first pass, it copies the files that it can. This works for files that the OS has not locked. The rest of the files are passed to a secondary queue. The secondary queue is processed using a different technique that uses raw disk reads to bypass the OS locks and copy the files. The copied files are saved with original timestamps and metadata and stored in a similar directory structure. <br /><br />Once the data is collected, KAPE can process it using modules. The modules can be independent binaries that run on the collected data and process them to extract information. For example, KAPE will collect and copy the Prefetch file to our target destination during the target collection. Running a Prefetch Parser (PECmd) module on this target will extract the prefetch file and save it in a CSV file. <br /><br /><img src="images/304-1.png" alt="images/304-1.png" /><br /><br />As the above image shows, KAPE can extract targets from a Live system, a mounted image, or the F-response utility. KAPE does not need to be installed. It is portable and can be used from network locations or USB drives. <br /><br /><br /><strong><h2>Target Options:</h2></strong><br /><br />In KAPE&#39;s lexicon, <strong>Targets</strong> are the artifacts that need to be collected from a system or image and copied to our provided destination. For example, as we learned in the last room, Windows Prefetch is a forensic artifact for evidence of execution so that we can create a <strong>Target</strong> for it. Similarly, we can also create <strong>Targets</strong> for the registry hives. In short, <strong>Targets</strong> copy files from one place to another.<br /><br />When we open the <strong>Targets</strong> directory of KAPE, this is what we will see:<br /><img src="images/304-2.png" alt="images/304-2.png" /><br /><br />The last four files at the bottom are <strong>guides</strong> and <strong>templates</strong> to create <strong>Targets</strong> and <strong>Compound Targets</strong> of our own. We will discuss Compound Targets later in this task. As you can see, the targets are grouped into different directories. Let&#39;s check out the <strong>Windows</strong> directory to see what we have:<br /><br /><img src="images/304-3.png" alt="images/304-3.png" /><br /><br />We can see different .tkape extension files. This is how a <strong>Target</strong> is defined for KAPE. A <strong>TKAPE</strong> file contains information about the artifact that we want to collect, such as the path, category, and file masks to collect. As an example, below is how the <strong>Prefetch</strong> <strong>Target</strong> is defined.<br /><br /><img src="images/304-4.png" alt="images/304-4.png" /><br /><br />This TKAPE file tells KAPE to collect files with the file mask <strong>*.pf</strong> from the path <strong>C:\Windows\prefetch</strong> and <strong>C:\Windows.old\prefetch</strong>.<br /><br />Notice that we have the <strong>C:\Windows.old</strong> path listed here as well. This path contains files retained after Windows has updated to a new version. For forensic analysis, we can also find interesting historical artifacts from this directory.<br /><br /><br /><strong><h3>Compound Targets:</h3></strong><br /><br />﻿KAPE also supports <strong>Compound Targets</strong>. These are <strong>Targets</strong> that are compounds of multiple other targets. As mentioned in the previous tasks, KAPE is often used for quick triage collection and analysis. The purpose of KAPE will not be fulfilled if we have to collect each artifact individually. Therefore,<strong> Compound Targets</strong> help us collect multiple targets by giving a single command. Examples of <strong>Compound Targets</strong> include <strong>!BasicCollection</strong>, <strong>!SANS_triage</strong> and <strong>KAPEtriage</strong>. We can view the Compound Targets on the path <strong>KAPE\Targets\Compound</strong>. The following image shows what a <strong>Compound Target</strong> for evidence of execution looks like:<br /><br /><img src="images/304-5.png" alt="images/304-5.png" /><br /><br />The above<strong> Compound Target </strong>will collect evidence of execution from <strong>Prefetch</strong>, <strong>RecentFileCache</strong>, <strong>AmCache</strong>, and <strong>Syscache</strong> Targets<br /><br /><strong><h3>!Disabled</h3></strong><br /><br />This directory contains Targets that you want to keep in the KAPE instance, but you don&#39;t want them to appear in the active Targets list.<br /><br /><strong><h3>!Local</h3></strong><br /><br />If you have created some Targets that you don&#39;t want to sync with the KAPE Github repository, you can place them in this directory. These can be Targets that are specific to your environment. Similarly, anything not present in the Github repository when we update KAPE will be moved to the !Local directory.<br /><br /><br /><strong><h2>Module Options:</h2></strong><br /><br /><strong>Modules</strong>, in KAPE&#39;s lexicon, run specific tools against the provided set of files. Their goal is not to copy files from one place to another but rather run some command and store the output. Generally, the output is in the form of CSV or TXT files.<br /><br />This is what the <strong>Modules</strong> directory looks like in KAPE:<br /><img src="images/304-6.png" alt="images/304-6.png" /><br /><br />Similar to the previous task, we see guides and templates for creating <strong>Modules</strong> and <strong>Compound Modules</strong>. We also see the <strong>!Disabled</strong>, <strong>!Local</strong> and <strong>Compound directories</strong>, which are similar to what we saw in the previous task. We will not discuss these again, as we discussed them in the last task. We see that most of the Modules are grouped together in different directories. One thing we find different is the <strong>bin</strong> directory. We will discuss that in a bit. For now, let&#39;s open the Windows directory and see what we have there:<br /><br /><img src="images/304-7.png" alt="images/304-7.png" /><br /><br />Here we see files with the <strong>.mkape</strong> extension. These are understood as Modules by KAPE. Let&#39;s open an MKAPE file and see how it is structured. The following image shows the <strong>Windows_IPConfig MKAPE</strong> file.<br /><br /><img src="images/304-8.png" alt="images/304-8.png" /><br /><br /><strong>Notice</strong> that the MKAPE file tells KAPE about the executable that has to be run, the command line parameters of the executable file, the output export format, and the filename to export to. But what if the executable that we want to run is not present on the system? This brings us to the bin directory.<br /><br /><strong><h3>The bin directory:</h3></strong><br /><br />The <strong>bin</strong> directory contains executables that we want to run on the system but are not natively present on most systems. KAPE will run executables either from the bin directory or the complete path. An example of files to be kept in the bin directory are <strong>Eric Zimmerman&#39;s tools</strong>, which are generally not present on a Windows system. We used them extensively in the Windows Forensics rooms. <br /><br /><img src="images/304-9.png" alt="images/304-9.png" /><br /><br /><br /><strong><h3>GUI Mode:</h3></strong><br />After selecting one/or more options. At the bottom of the screen, we get to equivalent command. Thus, use it as you will. Lets focus on the command.<br /><br /><br /><strong><h3>Command Line Mode:</h3></strong><br /><br /><strong>kape.exe --tsource C: --target KapeTriage --tdest C:\Users\thm-4n6\Desktop\Target --mdest C:\Users\thm-4n6\Desktop\Module --module !EZParser</strong><br /><br /><strong>Please note</strong> that we will need to run this command in an elevated shell (with Administrator privileges) for KAPE to collect the data.<br /><br /><br /><strong><h3>Batch Mode:</h3></strong><br /><br />﻿KAPE can also be run in<strong> batch mode</strong>. What this means is that we can provide a list of commands for KAPE to run in a file named <strong>_kape.cli</strong>. Then we <strong>keep</strong> this <strong>file</strong> in the <strong>directory</strong> containing the <strong>KAPE binary</strong>. When <strong>kape.exe</strong> is executed as an <strong>administrator,</strong> it checks if there is<strong> _kape.cli</strong> file present in the directory. If so, it executes the commands mentioned in the cli file. This mode can be used if you need someone to run KAPE for you, you will <strong>keep all the commands in a single line</strong>, and all you need is for the person to <strong>right-click</strong> and r<strong>un kape.exe as administrator</strong>. For example, if we have to perform the same task as we did earlier in this task using batch mode, we will have to create a <strong>_kape.cli</strong> file with the following content:<br /><br /><strong>--tsource C: --target KapeTriage --tdest C:\Users\thm-4n6\Desktop\Target --mdest C:\Users\thm-4n6\Desktop\Module --module !EZParser</strong><br /><br />When we run <strong>kape.exe</strong>, it will perform the same tasks as when we ran it through CLI above.<br /><br /></div>
</body>
</html>
