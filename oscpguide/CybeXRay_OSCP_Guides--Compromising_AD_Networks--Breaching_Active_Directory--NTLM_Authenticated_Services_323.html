<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>NTLM Authenticated Services</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>NTLM Authenticated Services</h1><br/><p><strong><h2>NTLM Authenticated Services</h2></strong></p><p></p><p><strong>1. NTLM and NetNTLM</strong></p><p></p><p>New Technology LAN Manager (NTLM) is the suite of security protocols used to authenticate users&#39; identities in AD. NTLM can be used for authentication by using a <strong>challenge-response-based</strong> scheme called <strong>NetNTLM</strong>. This authentication mechanism is heavily used by the services on a network. However, services that use NetNTLM can also be exposed to the internet. The following are some of the popular examples:</p><p></p><p>    ▪ Internally-hosted Exchange (Mail) servers that expose an Outlook Web App (OWA) login portal.</p><p>    ▪ Remote Desktop Protocol (RDP) service of a server being exposed to the internet.</p><p>    ▪ Exposed VPN endpoints that were integrated with AD.</p><p>    ▪ Web applications that are internet-facing and make use of NetNTLM.</p><p></p><p>NetNTLM, also often referred to as Windows Authentication or just NTLM Authentication, allows the application to play the role of a middle man between the client and AD. All authentication material is forwarded to a Domain Controller in the form of a challenge, and if completed successfully, the application will authenticate the user.</p><p></p><p>This means that the application is authenticating on behalf of the user and not authenticating the user directly on the application itself. This prevents the application from storing AD credentials, which should only be stored on a Domain Controller. This process is shown in the diagram below:</p><p></p><p><img src="images/323-1.png" alt="images/323-1.png" /></p><p></p><p><strong>2. Brute-force Login Attacks</strong></p><p></p><p>These exposed services provide an excellent location to test credentials discovered using other means. However, these services can also be used directly in an attempt to recover an initial set of valid AD credentials. We could perhaps try to use these for brute force attacks if we recovered information such as valid email addresses during our initial red team recon.</p><p></p><p>Since most AD environments have <strong>account lockout configured</strong>, we won&#39;t be able to run a full brute-force attack. Instead, we need to perform a <strong>password spraying</strong> attack. Instead of trying multiple different passwords, which may trigger the account lockout mechanism, we choose and use one password and attempt to authenticate with all the usernames we have acquired. However, it should be noted that these types of attacks can be detected due to the amount of failed authentication attempts they will generate.</p><p></p><p>You have been provided with a list of usernames discovered during a red team OSINT exercise. The OSINT exercise also indicated the organisation&#39;s initial onboarding password, which seems to be &quot;Changeme123&quot;. Although users should always change their initial password, we know that users often forget. We will be using a custom-developed script to stage a password spraying against the web application hosted at this URL: <strong><a href="http://ntlmauth.za.tryhackme.com">http://ntlmauth.za.tryhackme.com</a></strong>.</p><p></p><p><img src="images/323-2.png" alt="images/323-2.png" /></p><p></p><p>We could use tools such as <strong>Hydra</strong> to assist with the password spraying attack. However, it is often better to script up these types of attacks yourself, which allows you more control over the process. A base python script has been provided in the task files that can be used for the password spraying attack. The following function is the main component of the script:</p><p></p><p>Location: <strong>CybeXRay Guides -----→ Active Directory ----→ Tools -----→ password_sprayer.py</strong></p><p></p><p><strong>Explanation:</strong></p><p>The <strong>password_spray</strong> function takes our suggested password and the URL that we are targeting as input and attempts to authenticate to the URL with each username in the textfile. By monitoring the differences in HTTP response codes from the application, we can determine if the credential pair is valid or not. If the credential pair is valid, the application would respond with a 200 HTTP (OK) code. If the pair is invalid, the application will return a 401 HTTP (Unauthorised) code. </p><p></p><p><strong><span style="text-decoration:underline;">Password Spray Usage:</span></strong></p><p></p><p><strong>python ntlm_passwordspray.py -u &lt;userfile&gt; -f &lt;fqdn&gt; -p &lt;password&gt; -a &lt;attackurl&gt;</strong></p><p></p><p>We provide the following values for each of the parameters:</p><p></p><p>    &lt;userfile&gt; 		- Textfile containing our usernames - &quot;usernames.txt&quot;</p><p>    &lt;fqdn&gt; 			- Fully qualified domain name associated with the organisation that we are attacking - &quot;za.tryhackme.com&quot;</p><p>    &lt;password&gt; 	- The password we want to use for our spraying attack - &quot;Changeme123&quot;</p><p>    &lt;attackurl&gt; 	- The URL of the application that supports Windows Authentication - &quot;http://ntlmauth.za.tryhackme.com&quot;</p><p>    </p><p></p><p><img src="images/323-3.png" alt="images/323-3.png" /></p><p></p></div>
</body>
</html>
