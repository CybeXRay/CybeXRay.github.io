<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>LAPS</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>LAPS</h1><br/><p><strong><h1>Local Administrator Password Soultion (LAPS)</h1></strong></p><p></p><p>This task discusses how to enumerate and obtain a local administrator password within the Active Directory environment if a LAPS feature is configured and enabled.</p><p></p><p><strong><h3>Group Policy Preferences (GPP)</h3></strong></p><p></p><p>A Windows OS has a built-in Administrator account which can be accessed using a password. Changing passwords in a large Windows environment with many computers is challenging. Therefore, Microsoft implemented a method to change local administrator accounts across workstations using Group Policy Preferences (GPP).</p><p></p><p>GPP is a tool that allows administrators to create domain policies with embedded credentials. Once the GPP is deployed, different XML files are created in the SYSVOL folder. SYSVOL is an essential component of Active Directory and creates a shared directory on an NTFS volume that all authenticated domain users can access with reading permission.</p><p></p><p>The issue was the GPP relevant XML files contained a password encrypted using AES-256 bit encryption. At that time, the encryption was good enough until Microsoft somehow published its private key on MSDN. Since Domain users can read the content of the SYSVOL folder, it becomes easy to decrypt the stored passwords. One of the tools to crack the SYSVOL encrypted password is <strong>Get-GPPPassword</strong>.</p><p></p><p>Link: <strong>https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1</strong> </p><p></p><p></p><p><strong><h3>Local Administrator Password Solution (LAPS)</h3></strong></p><p></p><p>In 2015, Microsoft removed storing the encrypted password in the SYSVOL folder. It introduced the Local Administrator Password Solution (LAPS), which offers a much more secure approach to remotely managing the local administrator password.</p><p></p><p>The new method includes two new attributes (<strong>ms-mcs-AdmPwd</strong> and <strong>ms-mcs-AdmPwdExpirationTime</strong>) of computer objects in the Active Directory. The <strong>ms-mcs-AdmPwd</strong> attribute contains a <strong>clear-text password </strong>of the <strong>local administrator</strong>, while the <strong>ms-mcs-AdmPwdExpirationTime</strong> contains the <strong>expiration</strong> <strong>time</strong> to <strong>reset</strong> the <strong>password</strong>. LAPS uses <strong>admpwd.dll</strong> to change the local administrator password and update the value of <strong>ms-mcs-AdmPwd</strong>.</p><p></p><p><strong><h3>Enumerate for LAPS</h3></strong></p><p></p><p>The provided VM has the LAPS enabled, so let&#39;s start enumerating it. First, we check if LAPS is installed in the target machine, which can be done by checking the <strong>admpwd.dll</strong> path.</p><p></p><p><strong>dir &quot;C:\Program Files\LAPS\CSE\&quot;</strong></p><p></p><p><img src="images/373-1.png" alt="images/373-1.png" /></p><p></p><p>The output confirms that we have LAPS on the machine. Let&#39;s check the available commands to use for <strong>AdmPwd</strong> cmdlets as follows:</p><p></p><p><strong>Get-Command *AdmPwd*</strong></p><p></p><p><img src="images/373-2.png" alt="images/373-2.png" /></p><p></p><p></p><p>Next, we need to find which AD organizational unit (OU) has the &quot;<strong>All extended rights</strong>&quot; attribute that deals with LAPS. We will be using the &quot;<strong>Find-AdmPwdExtendedRights</strong>&quot; cmdlet to provide the right OU. Note that getting the available OUs could be done in the enumeration step. Our OU target in this example is THMorg. You can use the <strong>-Identity *  </strong>argument to list all available OUs.</p><p></p><p><strong>Find-AdmPwdExtendedRights -Identity *</strong></p><p></p><p><img src="images/373-3.png" alt="images/373-3.png" /></p><p></p><p>I go one by one to fine the THMorg having ExtendedRights as <strong>THM\LAPsReader</strong></p><p></p><p><strong>Find-AdmPwdExtendedRights -Identity “THMorg”</strong></p><p></p><p><img src="images/373-4.png" alt="images/373-4.png" /></p><p></p><p>The output shows that the Group <strong>LAPsReader</strong> has access to LAPS. Lets enumerate this group.</p><p></p><p><strong>net groups “LAPsReader”</strong></p><p><img src="images/373-5.png" alt="images/373-5.png" /></p><p></p><p>The above shows that the user <strong>bk-admin</strong> has access to LAPS</p><p></p><p></p><p><strong><h3>Getting the Password</h3></strong></p><p></p><p>We found that the <strong>bk-admin</strong> user is a member of <strong>LAPsReader</strong>, so in order to get the <strong>LAPS password</strong>, we need to <strong>compromise</strong> or <strong>impersonate</strong> the <strong>bk-admin</strong> user. After compromising the right user, we can get the LAPS password using <strong>Get-AdmPwdPassword</strong> cmdlet by providing the target machine with LAPS enabled.</p><p></p><p>As we are using Local Administrator account provided to us, we can directly use <strong>Get-AdmPwdPassword</strong> Or we can add a user we control the <strong>LAPsReader</strong> group</p><p></p><p><strong>Note:</strong> In the Previous “Domain Controller” task we had found the password for <strong>bk-admin</strong>. I will use this in <strong>runas</strong> tool and then use the above command.</p><p></p><p>I will do it using <strong>bk-admin</strong> user. (Assuming I don&#39;t have administrator access to the machine)</p><p></p><p><span style="text-decoration:underline;">Command</span>:</p><p><strong>runas /user:thm.red\bk-admin cmd</strong></p><p><img src="images/373-6.png" alt="images/373-6.png" /></p><p></p><p></p><p><span style="text-decoration:underline;">Command</span>:</p><p><strong>Get-AdmPwdPassword -ComputerName creds-harvestin</strong></p><p></p><p><img src="images/373-7.png" alt="images/373-7.png" /></p></div>
</body>
</html>
