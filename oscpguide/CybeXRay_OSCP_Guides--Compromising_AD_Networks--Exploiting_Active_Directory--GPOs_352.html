<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>GPOs</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>GPOs</h1><br/><p><strong><h1>Exploiting GPOs</h1></strong></p><p></p><p>Keylogging the user allowed us to decrypt their credential database, providing us with credentials that can be useful to further our goal of AD exploitation, namely the <strong>svcServMan</strong> account. We need to perform a bit of enumeration to figure out what these credentials will be useful for. Luckily for us, we already have Sharphound data that we can use. Using the search feature in Bloodhound, let&#39;s review the permissions that the discovered account has:</p><p></p><p><img src="images/352-1.png" alt="images/352-1.png" /></p><p></p><p><strong><h3>BloodHound:</h3></strong></p><p><img src="images/352-2.png" alt="images/352-2.png" /></p><p></p><p>One permission, in particular, stands out for this account, ownership over a Group Policy Object (GPO). Furthermore, when we do a bit of investigation, it seems like this GPO is applied to our <strong>THMSERVER2</strong> machine: </p><p></p><p><img src="images/352-3.png" alt="images/352-3.png" /></p><p></p><p>This may provide us with the ideal opportunity to further our AD exploitation!</p><p></p><p><strong><h3>Group Policy Objects</h3></strong></p><p></p><p>Remember when we discussed the SYSVOL directory in Enumerating AD? This is the directory where AD GPOs are stored to be replicated to domain-joined machines. A GPO is a virtual collection of policy settings. Each GPO has a unique name, called a GUID. That&#39;s why if you try to read the contents of the SYSVOL directory, it won&#39;t make a lot of sense with all the random names.</p><p></p><p>Each Windows computer has a Local Policy Configuration. This contains several notable configurations such as:</p><p></p><p>    ▪ Application configuration for services such as the Firewall, Anti-Virus, and Applocker.</p><p>    ▪ Local Group membership such as the Administrator or Remote Desktop Users groups.</p><p>    ▪ Startup configuration such as scripts that should be executed.</p><p>    ▪ Security and protocol settings such as SMBv1 support.</p><p></p><p>These are just a few examples. There are a significant amount of configuration options that can be set.</p><p></p><p><strong><h3>Group Policy Management</h3></strong></p><p></p><p>If you only have one Windows computer, it is easy to change the local policy configuration directly on the host. However, you need a mechanism to deploy a configuration from a central location in large organisations. This is where Group Policy Management (GPM) comes into play. Instead of defining policies locally on each machine, GPM allows us to define policies directly on the AD structure. Essentially, we can define GPOs for AD objects, such as a specific OU or group.</p><p></p><p>Domain-joined computers would then pull all policies from SYSVOL periodically and apply the relevant ones. By default, policies are replicated every 15 minutes through the gpupdate application. We can, however, also manually execute this application from Command Prompt to apply policies instantly.</p><p></p><p><strong><h3>Exploiting GPOs</h3></strong></p><p></p><p>Although there are several ways in which GPOs can be exploited, we will stick with the simple solution of adding an AD account we control to both the local Administrators and local Remote Desktop Users groups. This will allow us administrative privileges on THMSERVER2 and the ability to RDP in. We could also use the exposed SSH port, but not many organisations have upgraded to providing SSH access. Hence, RDP access or conventional lateral movement techniques like SMBExec are safer.</p><p></p><p>In order to modify the GPO, we need to access Group Policy Management as the AD user that has the relevant permissions. We could RDP into THMSERVER1 as the user, but that may kick the user out of their active session, raising suspicion. Instead, we will <strong>RDP</strong> into <strong>THMWRK1</strong> with <strong>either</strong> our <strong>normal</strong> or our<strong> Tier 2 Admin account</strong>, inject the AD user&#39;s credentials into memory using the runas command, and open MMC to modify the GPO. For a recap on the runas command, refer to the Enumerating AD room; however, the required command is also provided here that should be executed from an administrative command prompt window:</p><p><strong></strong></p><p><strong>Note: </strong>Administrative Command Prompt was not required. (I tested it)</p><p>Thus, we can <strong>RDP</strong> into <strong>THMWRK1</strong> machine with <strong>any account</strong>.</p><p>Then do the following.</p><p></p><p><strong>runas /netonly /user:za.tryhackme.loc\svcServMan cmd.exe</strong></p><p></p><p>Then, Enter the Password as recovered from the Password Database. [<strong>Sup3rStr0ngPass!@</strong>]</p><p>Once we get a new CMD, run <strong>mmc</strong></p><p></p><p>We now want to add the Group Policy Management snap-in:</p><p></p><p><strong>    Click File -&gt; Add/Remove Snap-in</strong></p><p><strong>    Select the Group Policy Management snap-in and click Add</strong></p><p><strong>    Click Ok</strong></p><p>    </p><p>You should now be able to see GPOs for the za.tryhackme.com domain:</p><p></p><p><img src="images/352-4.png" alt="images/352-4.png" /></p><p></p><p>We can now navigate to the GPO that our user has permission to modify (<strong>Servers &gt; Management Servers&gt; Management Server Pushes</strong>).</p><p></p><p><img src="images/352-5.png" alt="images/352-5.png" /></p><p></p><p>We can right-click on the GPO and select Edit. This will open the new <strong>Group Policy Management Editor</strong> window.</p><p></p><p><img src="images/352-6.png" alt="images/352-6.png" /></p><p></p><p>In order to add our account to the local groups, we need to perform the following steps:</p><p></p><p>    1. Expand Computer Configuration</p><p>    2. Expand Policies</p><p>    3. Expand Windows Settings</p><p>    4. Expand Security Settings</p><p>    5. Right Click on Restricted Groups and select Add Group (If the IT Support group already exists, it means someone has already performed the exploit. You can either delete it to create it yourself, or just inspect it to see what was configured.)</p><p>    6. Click Browse, enter IT Support and  click Check Names</p><p>    7. Click Okay twice</p><p>    </p><p><strong>Note:</strong> In My Case, I added the Group <strong>Tier 2 Admins</strong> in Restricted Groups. (So that i can use the following user from Password Delegation Task)</p><p><img src="images/352-7.png" alt="images/352-7.png" /></p><p></p><p><img src="images/352-8.png" alt="images/352-8.png" /></p><p></p><p>We will do the same in &quot;<strong>Tier 2 Admins</strong>&quot;</p><p>The first filter is not used. For the second filter, we want to add both the <strong>Administrators</strong> and <strong>Remote Desktop</strong> Users groups. In the end, it should look something like this:</p><p></p><p><img src="images/352-9.png" alt="images/352-9.png" /></p><p></p><p>Once the configuration has been made, we can click Apply and OK. Now, all we need to do is wait for a maximum of 15 minutes for the GPO to be applied.</p><p><strong>Note:</strong> We can also use <strong>gpupdate /force</strong> as the user <strong>svcServMan</strong> to make it faster from GPO update.</p><p></p><p>Now, we can use any “<strong>Tier 2 Admin</strong>” to <strong>RDP</strong> into the <strong>THMSERVER2</strong> Machine.</p><p></p><p>I Used the Following Credentials To Finish the Room Questions:</p><p></p><p><strong>Username: t2_ross.bird</strong></p><p><strong>Password: Admin@123</strong></p></div>
</body>
</html>
