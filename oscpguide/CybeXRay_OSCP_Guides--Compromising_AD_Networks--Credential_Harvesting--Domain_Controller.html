<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Domain Controller</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Domain Controller</h1><br/><strong><h1>Domain Controller</h1></strong><br /><br />This task discusses the required steps to dump Domain Controller Hashes locally and remotely.<br /><br /><strong><h3>NTDS Domain Controller</h3></strong><br /><br />New Technologies Directory Services (NTDS) is a database containing all Active Directory data, including objects, attributes, credentials, etc. The NTDS.DTS data consists of three tables as follows:<br /><br />    <strong>• Schema table</strong>: it contains types of objects and their relationships.<br />    <strong>• Link table</strong>: it contains the object&#39;s attributes and their values.<br />    <strong>• Data type</strong>: It contains users and groups.<br /><br /><strong>NTDS</strong> is located in <strong>C:\Windows\NTDS</strong> by <strong>default</strong>, and it is encrypted to prevent data extraction from a target machine. Accessing the <strong>NTDS.dit</strong> file from the machine running is <strong>disallowed</strong> since the file is <strong>used</strong> by<strong> Active Directory</strong> and is <strong>locked</strong>. However, there are various ways to gain access to it. This task will discuss how to get a copy of the NTDS file using the <strong>ntdsutil</strong> and <strong>Diskshadow</strong> <strong>tool</strong> and finally how to dump the file&#39;s content. It is important to note that decrypting the NTDS file requires a <strong>system Boot Key </strong>to attempt to <strong>decrypt</strong> <strong>LSA</strong> <strong>Isolated</strong> <strong>credentials</strong>, which is stored in the <strong>SECURITY</strong> file system. Therefore, we must also dump the security file containing all required files to decrypt. <br /><br /><strong><h3>Ntdsutil</h3></strong><br /><br /><strong>Ntdsutil</strong> is a Windows utility to used manage and maintain Active Directory configurations. It can be used in various scenarios such as <br /><br />    <strong>• </strong>Restore deleted objects in Active Directory.<br />    <strong>• </strong>Perform maintenance for the AD database.<br />    <strong>• </strong>Active Directory snapshot management.<br />    <strong>• </strong>Set Directory Services Restore Mode (DSRM) administrator passwords.<br /><br />For more information about Ntdsutil, you may visit the Microsoft documentation page.<br /><br /><br /><strong><h3>Local Dumping (No Credentials)</h3></strong><br /><br />This is usually done if you have <strong>no credentials available</strong> but have <strong>administrator</strong> <strong>access</strong> to the domain controller. Therefore, we will be relying on Windows utilities to dump the NTDS file and crack them offline. As a requirement, first, we <strong>assume</strong> we have administrator access to a domain controller. <br /><br />To successfully dump the content of the NTDS file we need the following files:<br /><br />    <strong>• </strong>C:\Windows\NTDS\ntds.dit<br />    <strong>• </strong>C:\Windows\System32\config\SYSTEM<br />    <strong>• </strong>C:\Windows\System32\config\SECURITY<br /><br />The following is a one-liner PowerShell command to dump the NTDS file using the Ntdsutil tool in the C:\temp directory:<br /><br /><span style="text-decoration:underline;">Command</span>:<br /><br /><strong>powershell &quot;ntdsutil.exe &#39;ac i ntds&#39; &#39;ifm&#39; &#39;create full c:\temp&#39; q q&quot;</strong><br /><br /><br /><img src="images/372-1.png" alt="images/372-1.png" /><br /><br />Now, if we check the<strong> c:\temp</strong> directory, we see two folders: <strong>Active</strong> <strong>Directory</strong> and <strong>registry</strong>, which contain the three files we need. Transfer them to the AttackBox and run the <strong>secretsdump.py</strong> script to extract the hashes from the dumped memory file.<br /><br /><span style="text-decoration:underline;">Command</span>:<br /><strong>secretsdump.py -security path/to/SECURITY -system path/to/SYSTEM -ntds path/to/ntds.dit local</strong><br /><br /><br /><img src="images/372-2.png" alt="images/372-2.png" /><br /><br /><br /><br /><strong><h3>Remote Dumping (With Credentials)</h3></strong><br /><br />In the previous section, we discussed how to get hashes from memory with no credentials in hand. In this task, we will be showing how to dump a system and domain controller hashes remotely, which requires credentials, such as passwords or NTLM hashes. We also need credentials for users with administrative access to a domain controller or special permissions as discussed in the DC Sync section.<br /><strong><br /></strong><strong><h3>DC Sync</h3></strong><br /><br />The DC Sync is a popular attack to perform within an Active Directory environment to dump credentials remotely. This attack works when an account (special account with necessary permissions) or AD admin account is compromised that has the following AD permissions:<br /><br />    <strong>• </strong>Replicating Directory Changes<br />    <strong>• </strong>Replicating Directory Changes All<br />    <strong>• </strong>Replicating Directory Changes in Filtered Set<br /><br />An adversary takes advantage of these configurations to perform domain replication, commonly referred to as &quot;DC Sync&quot;, or Domain Controller Sync. For more information about the DC Sync attack, you can visit the <strong>THM Persisting AD room (Task 2)</strong>.<br /><br /><strong>impacket-secretsdump -just-dc THM.red/thm@10.10.209.28</strong><br /><br /><img src="images/372-3.png" alt="images/372-3.png" /><br /><br />Or we can provide the password in the command.<br /><br /><strong>secretsdump.py -just-dc ‘THM.red/thm:Passw0rd!’@10.10.209.28</strong><br /><br />Let&#39;s explain the command a bit more.<br /><br />    <strong>• </strong>The <strong>-just-dc</strong> argument is for extracting the NTDS data.<br />    <strong>• </strong>The <strong>thm.red/AD_Admin_User</strong> is the authenticated domain user in the form of (domain/user).<br /><br />Note if we are interested to dump <strong>only</strong> the <strong>NTLM hashes</strong>, then we can use the <strong>-just-dc-ntlm</strong> argument as follows,<br /><br /><strong>impacket-secretsdump -just-dc-ntlm &#39;THM.red/thm:Passw0rd!&#39;@10.10.209.28</strong><br /><br /><img src="images/372-4.png" alt="images/372-4.png" /><br /><br />Once we obtained hashes, we can either use the hash for a specific user to impersonate him or crack the hash using Cracking tools, such hashcat. We can use the <strong>hashcat -m 1000</strong> mode to crack the Windows NTLM hashes<br /><br /></div>
</body>
</html>
