<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Rogue LDAP Server @Kali Machine</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Rogue LDAP Server @Kali Machine</h1><br/><p><strong><h3>Creating/Setting Up a Rogue LDAP Server in Our Kali Machine:</h3></strong></p><p></p><p><strong>apt install slapd ldap-utils </strong></p><p><strong>apt install libsasl2-modules libsasl2-modules-ldap</strong></p><p></p><p><strong>Note:</strong> The Last 2 Library files are installed to install the Cyrus SASL (This helps for default authentication of LDAP serer)</p><p></p><p><strong><a href="https://www.cyrusimap.org/sasl/sasl/installation.html">https://www.cyrusimap.org/sasl/sasl/installation.html</a></strong></p><p><strong><a href="https://github.com/cyrusimap/cyrus-sasl/releases">https://github.com/cyrusimap/cyrus-sasl/releases</a></strong></p><p></p><p></p><p>Set a Password during <strong>slapd</strong> installation.</p><p></p><p><img src="images/321-1.png" alt="images/321-1.png" /></p><p></p><p></p><p>Once Installation is Complete, we need to configure the slapd using the following commands.</p><p></p><p><strong>dpkg-reconfigure -p low slapd</strong></p><p></p><p>1- Omit OpenLDAP server configuration? <strong>No</strong></p><p></p><p><img src="images/321-2.png" alt="images/321-2.png" /></p><p></p><p>2- DNS domain name: {target AD domain name} i.e. <strong>testdomain.com</strong> Or in our case <strong>za.tryhackme.com</strong></p><p></p><p><img src="images/321-3.png" alt="images/321-3.png" /></p><p></p><p>3- Organization name: {target AD domain name} i.e. <strong>testdomain.com</strong> Or in our case <strong>za.tryhackme.com</strong></p><p></p><p><img src="images/321-4.png" alt="images/321-4.png" /></p><p></p><p></p><p>4- Administrator password: {password}, same as the one we configured earlier during the initial installation.</p><p></p><p><img src="images/321-5.png" alt="images/321-5.png" /></p><p></p><p></p><p>5- Do you want the database to be removed when slapd is purged? <strong>No</strong></p><p></p><p><img src="images/321-6.png" alt="images/321-6.png" /></p><p></p><p></p><p>6- Move old database files before creating a new database — Yes</p><p></p><p><img src="images/321-7.png" alt="images/321-7.png" /></p><p></p><p></p><p>After finishing the configuration steps, start the slapd server.</p><p></p><p><strong>systemctl start slapd</strong></p><p></p><p></p><p>Now that the server is up and running, we need to configure its authentication methods to support <strong>PLAIN</strong> and <strong>LOGIN</strong> <strong>only</strong>. By default, OpenLDAP supports <strong>DIGEST-MD5, CRAM-MD5, and NTLM</strong> as authentication mechanisms. We can check that by running the ldapsearch command with the supported authentication flag “<strong>supportedSASLMechanisms</strong>.” to see the supported methods.</p><p></p><p><strong>ldapsearch -H ldap:// -x -LLL -s base -b &quot;&quot; supportedSASLMechanisms</strong></p><p></p><p><img src="images/321-8.png" alt="images/321-8.png" /></p><p></p><p><strong>Important Note:</strong> If the two library files would not have been installed, <strong>(libsasl2-modules libsasl2-modules-ldap) Cyrus SASL</strong> we would have got blank output below dn:</p><p></p><p>Thus, the following libraries are required for basic LDAP Authentication.</p><p></p><p>Basic LDAP Authentication: <strong>libsasl2-modules &amp; libsasl2-modules-ldap</strong></p><p>Kerberos LDAP Authentication: <strong>libsasl2-modules-gssapi-heimdal or libsasl2-modules-gssapi-mit</strong> (More Secure)</p><p></p><p>However, we want the opposite of security since we will be sniffing the LDAP communication.</p><p>To capture the credentials in clear-text, we need to re-configure the LDAP server to support <strong>PLAIN</strong> and <strong>LOGIN</strong> authentication methods.</p><p></p><p>To do that, we create a ldif file i.e. “<strong>olcSaslSecProps.ldif </strong>” with the below configurations. {We can give any name, but extention should be <strong>ldif</strong>)</p><p></p><p>         </p><p><strong>#olcSaslSecProps.ldif</strong></p><p><strong>dn: cn=config</strong></p><p><strong>replace: olcSaslSecProps</strong></p><p><strong>olcSaslSecProps: noanonymous,minssf=0,passcred</strong></p><p></p><p>The file has the following properties:</p><p></p><p>    ▸ <strong>olcSaslSecProps:</strong> Specifies the SASL security properties</p><p>    ▸ <strong>noanonymous:</strong> Disables mechanisms that support anonymous login</p><p>    ▸<strong> minssf:</strong> Specifies the minimum acceptable security strength with 0, meaning no protection.</p><p>    </p><p>The file contents are as follows:</p><p><img src="images/321-9.png" alt="images/321-9.png" /></p><p><strong>Note:</strong> I used a custom name but extention need to be <strong>ldif</strong></p><p></p><p></p><p>Now, to Replace our Security configuration use the following:</p><p>Commit the new changes with <strong>ldapmodify</strong> and restart the server.</p><p></p><p><strong>ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcPlainAuthOnly.ldif</strong></p><p><strong>service slapd restart</strong></p><p></p><p><img src="images/321-10.png" alt="images/321-10.png" /></p><p></p><p>Re-run the ldapsearch command to check for the supported SASL mechanisms one more time; you should be able to see the new modified methods of PLAIN and LOGIN.</p><p></p><p><strong>ldapsearch -H ldap:// -x -LLL -s base -b &quot;&quot; supportedSASLMechanisms</strong></p><p></p><p><img src="images/321-11.png" alt="images/321-11.png" /></p><p></p><p>We have successfully setup our Rogue LDAP Server with least security. Cheers !!</p><p></p><p></p></div>
</body>
</html>
