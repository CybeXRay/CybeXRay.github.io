<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>LDAP Bind Credentials</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>LDAP Bind Credentials</h1><br/><strong><h2>LDAP Bind Credentials</h2></strong><br /><br /><strong>LDAP</strong><br /><br />Another method of AD authentication that applications can use is Lightweight Directory Access Protocol (LDAP) authentication. LDAP authentication is similar to NTLM authentication. However, with LDAP authentication, the application directly verifies the user&#39;s credentials. The application has a pair of AD credentials that it can use first to query LDAP and then verify the AD user&#39;s credentials.<br /><br />LDAP authentication is a popular mechanism with third-party (non-Microsoft) applications that integrate with AD. These include applications and systems such as:<br /><br />    ▪ Gitlab<br />    ▪ Jenkins<br />    ▪ Custom-developed web applications<br />    ▪ Printers<br />    ▪ VPNs<br /><br />If any of these applications or services are exposed on the internet, the same type of attacks as those leveraged against NTLM authenticated systems can be used. However, since a service using LDAP authentication requires a set of AD credentials, it opens up additional attack avenues. In essence, we can attempt to recover the AD credentials used by the service to gain authenticated access to AD. The process of authentication through LDAP is shown below:<br /><br /><br /><img src="images/324-1.png" alt="images/324-1.png" /><br /><br />If you could gain a foothold on the correct host, such as a Gitlab server, it might be as simple as reading the configuration files to recover these AD credentials. These credentials are often stored in plain text in configuration files since the security model relies on keeping the location and storage configuration file secure rather than its contents. Configuration files are covered in more depth later.<br /><br /><strong>LDAP Pass-back Attacks</strong><br /><br />However, one other very interesting attack can be performed against LDAP authentication mechanisms, called an LDAP Pass-back attack. This is a common attack against network devices, such as printers, when you have gained initial access to the internal network, such as plugging in a rogue device in a boardroom.<br /><br />LDAP Pass-back attacks can be performed when we gain access to a device&#39;s configuration where the LDAP parameters are specified. This can be, for example, the web interface of a network printer. Usually, the credentials for these interfaces are kept to the default ones, such as <strong>admin:admin</strong> or <strong>admin:password</strong>. Here, we won&#39;t be able to directly extract the LDAP credentials since the password is usually hidden. However, we can alter the LDAP configuration, such as the IP or hostname of the LDAP server. In an LDAP Pass-back attack, we can modify this IP to our IP and then test the LDAP configuration, which will force the device to attempt LDAP authentication to our rogue device. We can intercept this authentication attempt to recover the LDAP credentials.<br /><br /><strong>Performing an LDAP Pass-back</strong><br /><br />There is a network printer in this network where the administration website does not even require credentials. Navigate to <a href="http://printer.za.tryhackme.com/settings.aspx">http://printer.za.tryhackme.com/settings.aspx</a>  to find the settings page of the printer:<br /><br /><img src="images/324-2.png" alt="images/324-2.png" />4<br /><br />Using browser inspection, we can also verify that the printer website was at least secure enough to not just send the LDAP password back to the browser:<br /><br /><img src="images/324-3.png" alt="images/324-3.png" /><br /><br />So we have the username, but not the password. However, when we press test settings, we can see that an authentication request is made to the domain controller to test the LDAP credentials. Let&#39;s try to exploit this to get the printer to connect to us instead, which would disclose the credentials. To do this, let&#39;s use a simple Netcat listener to test if we can get the printer to connect to us. Since the default port of LDAP is 389, we can use the following command:<br /><br /><strong>nc -lvp 389</strong><br /><br />Then, I changed the Server IP in the webpage to my <strong>tun0 IP</strong> &amp; clicked on <strong>Test Settings</strong><br /><br /><img src="images/324-4.png" alt="images/324-4.png" /><br /><br />I got a connection from the Printer. However, there is an issue.<br /><br />You may require more than one try to receive a connection back but it should respond within 5 seconds. The <strong>supportedCapabilities</strong> response tells us we have a problem. Essentially, before the printer sends over the credentials, it is trying to negotiate the LDAP authentication method details. It will use this negotiation to select the most secure authentication method that both the printer and the LDAP server support. If the authentication method is too secure, the credentials will not be transmitted in cleartext. With some authentication methods, the credentials will not be transmitted over the network at all! So we can&#39;t just use normal Netcat to harvest the credentials. We will need to create a rogue LDAP server and configure it insecurely to ensure the credentials are sent in plaintext.<br /><br /><br /><br /><strong><h3>Creating/Setting Up a Rogue LDAP Server in Our Kali Machine:</h3></strong><br /><br /><strong>apt install slapd ldap-utils <br />apt install libsasl2-modules libsasl2-modules-ldap</strong><br /><br /><strong>Note:</strong> The Last 2 Library files are installed to install the Cyrus SASL (This helps for default authentication of LDAP serer)<br /><br /><a href="https://www.cyrusimap.org/sasl/sasl/installation.html">https://www.cyrusimap.org/sasl/sasl/installation.html</a><br /><a href="https://github.com/cyrusimap/cyrus-sasl/releases">https://github.com/cyrusimap/cyrus-sasl/releases</a><br /><br /><br />Set a Password during <strong>slapd</strong> installation.<br /><br /><img src="images/324-5.png" alt="images/324-5.png" /><br /><br /><br />Once Installation is Complete, we need to configure the slapd using the following commands.<br /><br /><strong>dpkg-reconfigure -p low slapd</strong><br /><br />1- Omit OpenLDAP server configuration? <strong>No</strong><br /><br /><img src="images/324-6.png" alt="images/324-6.png" /><br /><br />2- DNS domain name: {target AD domain name} i.e. <strong>testdomain.com</strong> Or in our case <strong>za.tryhackme.com</strong><br /><br /><img src="images/324-7.png" alt="images/324-7.png" /><br /><br />3- Organization name: {target AD domain name} i.e. <strong>testdomain.com</strong> Or in our case <strong>za.tryhackme.com</strong><br /><br /><img src="images/324-8.png" alt="images/324-8.png" /><br /><br /><br />4- Administrator password: {password}, same as the one we configured earlier during the initial installation.<br /><br /><img src="images/324-9.png" alt="images/324-9.png" /><br /><br /><br />5- Do you want the database to be removed when slapd is purged? <strong>No</strong><br /><br /><img src="images/324-10.png" alt="images/324-10.png" /><br /><br /><br />6- Move old database files before creating a new database — Yes<br /><br /><img src="images/324-11.png" alt="images/324-11.png" /><br /><br /><br />After finishing the configuration steps, start the slapd server.<br /><br /><strong>systemctl start slapd</strong><br /><br /><br />Now that the server is up and running, we need to configure its authentication methods to support <strong>PLAIN</strong> and <strong>LOGIN</strong> <strong>only</strong>. By default, OpenLDAP supports <strong>DIGEST-MD5, CRAM-MD5, and NTLM</strong> as authentication mechanisms. We can check that by running the ldapsearch command with the supported authentication flag “<strong>supportedSASLMechanisms</strong>.” to see the supported methods.<br /><br /><strong>ldapsearch -H ldap:// -x -LLL -s base -b &quot;&quot; supportedSASLMechanisms</strong><br /><br /><img src="images/324-12.png" alt="images/324-12.png" /><br /><br /><strong>Important Note:</strong> If the two library files would not have been installed, <strong>(libsasl2-modules libsasl2-modules-ldap) Cyrus SASL</strong> we would have got blank output below dn:<br /><br />Thus, the following libraries are required for basic LDAP Authentication.<br /><br />Basic LDAP Authentication: <strong>libsasl2-modules &amp; libsasl2-modules-ldap</strong><br />Kerberos LDAP Authentication: <strong>libsasl2-modules-gssapi-heimdal or libsasl2-modules-gssapi-mit</strong> (More Secure)<br /><br />However, we want the opposite of security since we will be sniffing the LDAP communication.<br />To capture the credentials in clear-text, we need to re-configure the LDAP server to support <strong>PLAIN</strong> and <strong>LOGIN</strong> authentication methods.<br /><br />To do that, we create a ldif file i.e. “<strong>olcSaslSecProps.ldif </strong>” with the below configurations. {We can give any name, but extention should be <strong>ldif</strong>)<br /><br />         <br /><strong>#olcSaslSecProps.ldif<br />dn: cn=config<br />replace: olcSaslSecProps<br />olcSaslSecProps: noanonymous,minssf=0,passcred</strong><br /><br />The file has the following properties:<br /><br />    ▸ <strong>olcSaslSecProps:</strong> Specifies the SASL security properties<br />    ▸ <strong>noanonymous:</strong> Disables mechanisms that support anonymous login<br />    ▸<strong> minssf:</strong> Specifies the minimum acceptable security strength with 0, meaning no protection.<br />    <br />The file contents are as follows:<br /><img src="images/324-13.png" alt="images/324-13.png" /><br /><strong>Note:</strong> I used a custom name but extention need to be <strong>ldif</strong><br /><br /><br />Now, to Replace our Security configuration use the following:<br />Commit the new changes with <strong>ldapmodify</strong> and restart the server.<br /><br /><strong>ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcPlainAuthOnly.ldif<br />service slapd restart</strong><br /><br /><img src="images/324-14.png" alt="images/324-14.png" /><br /><br />Re-run the ldapsearch command to check for the supported SASL mechanisms one more time; you should be able to see the new modified methods of PLAIN and LOGIN.<br /><br /><strong>ldapsearch -H ldap:// -x -LLL -s base -b &quot;&quot; supportedSASLMechanisms</strong><br /><br /><img src="images/324-15.png" alt="images/324-15.png" /><br /><br />We have successfully setup our Rogue LDAP Server with least security. Cheers !!<br /><br /><strong><span style="text-decoration:underline;">Capturing LDAP Credentials</span></strong><br /><br />Our rogue LDAP server has now been configured. When we click the &quot;Test Settings&quot; at http://printer.za.tryhackme.com/settings.aspx, the authentication will occur in clear text. If you configured your rogue LDAP server correctly and it is downgrading the communication, you will receive the following error: &quot;<strong>This distinguished name contains invalid syntax</strong>&quot;. If you receive this error, you can use a tcpdump to capture the credentials using the following command:<br /><br /><strong>tcpdump -SX -i tun0 tcp port 389</strong><br /><br />      ▸ -S flag prints the packet’s sequence numbers.<br />      ▸ -X flag returns the content of the packets<br />      <br /><img src="images/324-16.png" alt="images/324-16.png" /><br /><br />We got the indicated error, which means <strong>tcpdump</strong> would have collected the required info.<br /><br />tcpdump - Output Snippet:<br /><img src="images/324-17.png" alt="images/324-17.png" /><br /><br />We already knew the Username from the Printer Webpage:<br /><br /><strong>Username: svcLDAP<br />Password: tryhackmeldappass1@</strong><br /><br /><br /></div>
</body>
</html>
