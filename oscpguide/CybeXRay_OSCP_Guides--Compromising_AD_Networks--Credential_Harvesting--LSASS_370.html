<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>LSASS</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>LSASS</h1><br/><p><strong><h1>Local Security Authority Subsystem Service (LSASS)</h1></strong></p><p></p><p></p><p><strong><h3>What is the LSASS?</h3></strong></p><p></p><p>Local Security Authority Server Service (LSASS) is a Windows process that handles the operating system security policy and enforces it on a system. It verifies logged in accounts and ensures passwords, hashes, and Kerberos tickets. Windows system stores credentials in the LSASS process to enable users to access network resources, such as file shares, SharePoint sites, and other network services, without entering credentials every time a user connects.</p><p></p><p>Thus, the LSASS process is a juicy target for red teamers because it stores sensitive information about user accounts. The LSASS is commonly abused to dump credentials to either escalate privileges, steal data, or move laterally. Luckily for us, if we have administrator privileges, we can dump the process memory of LSASS. Windows system allows us to create a dump file, a snapshot of a given process. This could be done either with the Desktop access (GUI) or the command prompt. This attack is defined in the MITRE ATT&amp;CK framework as &quot;OS Credential Dumping: LSASS Memory (T1003)&quot;.</p><p></p><p></p><p><strong><h3>Graphic User Interface (GUI)</h3></strong></p><p></p><p>To dump any running Windows process using the GUI, open the<strong> Task Manager</strong>, and from the <strong>Details</strong> tab, find the required process, <strong>right-click</strong> on it, and select &quot;<strong>Create dump file</strong>&quot;.</p><p></p><p><img src="images/370-1.png" alt="images/370-1.png" /></p><p></p><p>Once the dumping process is finished, a pop-up message will show containing the path of the dumped file. Now copy the file and transfer it to the AttackBox to extract NTLM hashes offline. </p><p></p><p><strong>Note: </strong>if we try this on the provided VM, you should get an <strong>error</strong> the first time this is run, until we fix the registry value in the <strong>Protected LSASS</strong> section later in this task.</p><p></p><p>We need to <strong>Disable LSASS Protection</strong>, then run the foilowing.</p><p></p><p><img src="images/370-2.png" alt="images/370-2.png" /></p><p></p><p><strong><h3>Sysinternals Suite (CLI)</h3></strong></p><p></p><p>An alternative way to dump a process if a GUI is not available to us is by using ProcDump. ProcDump is a Sysinternals process dump utility that runs from the command prompt. The SysInternals Suite is already installed in the provided machine at the following path: </p><p><strong>c:\Tools\SysinternalsSuite</strong></p><p><strong></strong></p><p><span style="text-decoration:underline;">Command</span>:</p><p></p><p><strong>c:\Tools\SysinternalsSuite\procdump.exe -accepteula -ma lsass.exe c:\Tools\Mimikatz\lsass_dump</strong></p><p></p><p><strong>Note: </strong>if we try this on the provided VM, you should get an <strong>error</strong> the first time this is run, until we fix the registry value in the <strong>Protected LSASS</strong> section later in this task.</p><p></p><p>We need to <strong>Disable LSASS Protection</strong>, then run the foilowing.</p><p></p><p><img src="images/370-3.png" alt="images/370-3.png" /></p><p></p><p><strong>Note</strong> that the dump process is writing to disk. Dumping the LSASS process is a known technique used by adversaries. Thus, AV products may flag it as malicious. In the real world, you may be more creative and write code to encrypt or implement a method to bypass AV products.</p><p></p><p></p><p><strong><h3>MimiKatz</h3></strong></p><p></p><p>Mimikatz is a well-known tool used for extracting passwords, hashes, PINs, and Kerberos tickets from memory using various techniques. Mimikatz is a post-exploitation tool that enables other useful attacks, such as pass-the-hash, pass-the-ticket, or building Golden Kerberos tickets. Mimikatz deals with operating system memory to access information. Thus, it requires administrator and system privileges in order to dump memory and extract credentials.</p><p></p><p>We will be using the Mimikatz tool to extract the memory dump of the lsass.exe process. We have provided the necessary tools for you, and they can be found at: <strong>c:\Tools\Mimikatz</strong>.</p><p></p><p>Remember that the LSASS process is running as a SYSTEM. Thus in order to access users&#39; hashes, we need a <strong>system</strong> or <strong>local administrator</strong> permissions. Thus, open the command prompt and run it as administrator. Then, execute the mimikatz binary as follows,</p><p></p><p><span style="text-decoration:underline;">Commands</span>:</p><p></p><p><strong>privilege::debug</strong></p><p><strong>sekurlsa::logonpasswords</strong></p><p></p><p><strong>Note: </strong>if we try this on the provided VM, you should get an <strong>error</strong> the first time this is run, until we fix the registry value in the <strong>Protected LSASS</strong> section later in this task.</p><p></p><p>We need to <strong>Disable LSASS Protection</strong>, then run the foilowing.</p><p></p><p><strong>privilege::debug</strong></p><p><strong>sekurlsa::logonpasswords</strong></p><p></p><p>Mimikatz lists a lot of information about accounts and machines. If we check closely in the Primary section for Administrator users, we can see that we have an NTLM hash. </p><p></p><p><strong>Note:</strong> To get users&#39; hashes, a user (victim) must have logged in to a system, and the user&#39;s credentials have been cached.</p><p></p><p></p><p><strong><h3>Protected LSASS</h3></strong></p><p></p><p>In 2012, Microsoft implemented an LSA protection, to keep LSASS from being accessed to extract credentials from memory. This task will show how to disable the LSA protection and dump credentials from memory using Mimikatz. To <strong>enable</strong> <strong>LSASS protection</strong>, we can modify the registry “<strong>RunAsPPL</strong>” DWORD value in <strong>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa to 1</strong>.</p><p></p><p><em><strong><span style="text-decoration:underline;">Disbale LSASS Protection</span></strong></em></p><p></p><p><strong><span style="text-decoration:underline;">Step - 1</span></strong></p><p>To <strong>disable</strong> <strong>LSASS protection</strong>, we can modify the registry “<strong>RunAsPPL</strong>” DWORD value in <strong>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa to 0</strong></p><p></p><p><img src="images/370-4.png" alt="images/370-4.png" /></p><p></p><p></p><p><strong><span style="text-decoration:underline;">Step-2</span></strong></p><p>Remove the Protection Using Mimikatz</p><p>Mimikatz provides a mimidrv.sys driver that works on kernel level to disable the LSA protection. We can import it to Mimikatz by executing &quot;!+&quot; as follows:</p><p></p><p><strong>privilege:;debug</strong></p><p><strong>!+</strong></p><p><strong>!processprotect /process:lsass.exe /remove</strong></p><p></p><p><img src="images/370-5.png" alt="images/370-5.png" /></p><p></p><p><strong>Note:</strong> If this fails with an <strong>isFileExist</strong> error, exit mimikatz, navigate to <strong>C:\Tools\Mimikatz\</strong> and run the command again.</p><p>Once the driver is loaded, we can disable the LSA protection by executing the following Mimikatz command:</p><p><strong>!processprotect /process:lsass.exe /remove</strong></p><p></p><p>Finally, we tested using <strong>sekurlsa::logonpasswords</strong> &amp; the dump was successful.</p><p></p></div>
</body>
</html>
