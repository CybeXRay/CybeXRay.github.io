<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>ACLs</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>ACLs</h1><br/><p><strong><h1>Persistence Through ACLs</h1></strong></p><p></p><p>Sometimes, we need more than just persisting to normal AD groups. What if we want to persist to all protected groups simultaneously?</p><p></p><p><strong><h3>Persisting through AD Group Templates</h3></strong></p><p></p><p>While we can just add an account we control to every single privileged group we can find, the blue team would still be able to perform cleanup and remove our membership. In order to ensure a bit better persistence and make the blue team scratch their heads, we should rather inject into the templates that generate the default groups. By injecting into these templates, even if they remove our membership, we just need to wait until the template refreshes, and we will once again be granted membership.</p><p></p><p>One such template is the AdminSDHolder container. This container exists in every AD domain, and its <strong>Access Control List (ACL)</strong> is used as a template to copy permissions to all protected groups. Protected groups include privileged groups such as Domain Admins, Administrators, Enterprise Admins, and Schema Admins.</p><p></p><p>A process called SDProp takes the ACL of the AdminSDHolder container and applies it to all protected groups every 60 minutes. We can thus write an <strong>ACE(Access Control Entry)</strong> that will grant us full permissions on all protected groups. If the blue team is not aware that this type of persistence is being used, it will be quite frustrating. Every time they remove the inappropriate permission on the protected object or group, it reappears within the hour. Since this reconstruction occurs through normal AD processes, it would also not show any alert to the blue team, making it harder to pinpoint the source of the persistence.</p><p></p><p><strong><h3>Persisting with AdminSDHolder</h3></strong></p><p></p><p>In order to deploy our persistence to the <strong>AdminSDHolder</strong>, we will use Microsoft Management Console (<strong>MMC</strong>). To avoid kicking users out of their RDP sessions, it will be best to RDP into <strong>THMWRK1</strong> using your<strong> low privileged credentials,</strong> use the runas command to inject the Administrator credentials, and then execute MMC from this new terminal:</p><p></p><p><strong>runas /netonly /user:Administrator cmd.exe</strong></p><p></p><p>Once you have an MMC window, <strong>add</strong> the <strong>Users</strong> and <strong>Groups</strong> <strong>Snap-in</strong> (File-&gt;Add Snap-In-&gt;Active Directory Users and Groups). Make sure to <strong>enable</strong> <strong>Advanced</strong> <strong>Features</strong> (<strong>View</strong>-&gt;<strong>Advanced</strong> <strong>Features</strong>). We can find the <strong>AdminSDHolder</strong> group under <strong>Domain</strong>-&gt;<strong>System</strong>:</p><p></p><p><img src="images/364-1.png" alt="images/364-1.png" /></p><p></p><p>Navigate to the Security of the group (<strong>Right-click</strong>-&gt;<strong>Properties</strong>-&gt;<strong>Security</strong>):</p><p></p><p><img src="images/364-2.png" alt="images/364-2.png" /></p><p></p><p>Let&#39;s add our low-privileged user and grant Full Control:</p><p></p><p>    1. Click <strong>Add</strong>.</p><p>    2. Search for your low-privileged username and click<strong> Check Names</strong>.</p><p>    3. Click <strong>OK</strong>.</p><p>    4. Click <strong>Allow</strong> on <strong>Full Control</strong>.</p><p>    5. Click <strong>Apply</strong>.</p><p>    6. Click <strong>OK</strong>.</p><p></p><p>It should look something like this:</p><p></p><p><img src="images/364-3.png" alt="images/364-3.png" /></p><p></p><p><strong><h3>SDProp</h3></strong></p><p></p><p>Now we just need to wait 60 minutes, and our user will have full control over all Protected Groups. This is because the Security Descriptor Propagator (SDProp) service executes automatically every 60 minutes and will propagate this change to all Protected Groups. However, since we do not like to wait, let&#39;s kick off the process manually using Powershell. In the <strong>C:\Tools\ </strong>directory, a script <strong>Invoke-ADSDPropagation</strong> is provided::</p><p></p><p><strong>Note:</strong> The CMDLET has to be run from the DC Machine as a Domain Admin user.</p><p></p><p><img src="images/364-4.png" alt="images/364-4.png" /></p><p></p><p>Once done, give it a minute and then review the security permissions of a Protected Group such as the Domain Admins group (you can use the search command to find this group):</p><p></p><p><img src="images/364-5.png" alt="images/364-5.png" /></p><p></p><p>As can be seen, our low privilege user has full control over the group. You can verify that this will continue to propagate by removing your user from the security permissions and rerunning the PowerShell script. Your user will be added again. </p><p></p><p><strong><h3>Important Note:</h3></strong></p><p>Interestingly, although we have permissions to modify the group, it does not <strong>automatically</strong> add us to the group:</p><p>We have to manually add our user to this group for Administrative Access.</p><p></p><p><img src="images/364-6.png" alt="images/364-6.png" /></p><p></p><p>However, using our new permissions, we can add ourselves to this group:</p><p></p><p><img src="images/364-7.png" alt="images/364-7.png" /></p><p></p><p>Now, our user has administrator access.</p><p></p><p><strong><span style="text-decoration:underline;">It Is Going Downhill For The Blue Team</span></strong></p><p></p><p>Imagine combining this with the nesting groups of the previous task. Just as the blue team finished revoking your access through numerous group changes, 60 minutes later, you can just do it all again. Unless the blue team understands that the permissions are being altered through the AdminSDHolder group, they would be scratching their heads every 60 minutes. Since the persistence propagates through a legitimate AD service, they would most likely be none the wiser every time it happens. If you really want to persist, you can grant full control to the Domain Users group in the AdminSDHolder group, which means any low-privileged user would be granted full control over all Protected Groups. Combining this with a full DC Sync means the blue team will have to reset every single credential in the domain to flush us out completely.</p><p></p></div>
</body>
</html>
