<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Windows Credential Manager</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Windows Credential Manager</h1><br/><strong><h1>Windows Credential Manager</h1></strong><br /><br /><br /><strong><h3>What is Credentials Manager?</h3></strong><br /><br />Credential Manager is a Windows feature that stores logon-sensitive information for websites, applications, and networks. It contains login credentials such as usernames, passwords, and internet addresses. There are four credential categories:<br /><br />    <strong>• </strong>Web credentials contain authentication details stored in Internet browsers or other applications.<br />    <strong>• </strong>Windows credentials contain Windows authentication details, such as NTLM or Kerberos.<br />    <strong>• </strong>Generic credentials contain basic authentication details, such as clear-text usernames and passwords.<br />    <strong>• </strong>Certificate-based credentials: Athunticated details based on certifications.<br /><br />Note that authentication details are stored on the user&#39;s folder and are not shared among Windows user accounts. However, they are cached in memory.<br /><br /><br /><strong><h3>Accessing Credential Manager</h3></strong><br /><br />We can access the Windows Credential Manager through GUI (<strong>Control Panel</strong> <strong>-&gt; User Accounts -&gt; Credential Manager</strong>) or the command prompt. In this task, the focus will be more on the command prompt scenario where the GUI is not available.<br /><br /><img src="images/371-1.png" alt="images/371-1.png" /><br /><br />We will be using the Microsoft Credentials Manager <strong>vaultcmd</strong> utility. Let&#39;s start to enumerate if there are any stored credentials. First, we list the current windows vaults available in the Windows target. <br /><span style="text-decoration:underline;"><br />Command</span>:<br /><strong>Vaultcmd /list</strong><br /><br /><img src="images/371-2.png" alt="images/371-2.png" /><br /><br />By default, Windows has two vaults, one for Web and the other one for Windows machine credentials. The above output confirms that we have the two default vaults.<br /><br />Let&#39;s check if there are any stored credentials in the Web Credentials vault by running the vaultcmd command with <strong>/listproperties</strong>.<br /><span style="text-decoration:underline;"><br />Command</span>:<br /><strong>Vaultcmd /listproperties:&quot;Web Credentials&quot;</strong><br /><br /><img src="images/371-3.png" alt="images/371-3.png" /><br /><br />The output shows that we have one stored credential in the specified vault. Now let&#39;s try to list more information about the stored credential as follows,<br /><br /><span style="text-decoration:underline;">Command</span>:<br /><strong>VaultCmd /listcreds:&quot;Web Credentials&quot;</strong><br /><br /><img src="images/371-4.png" alt="images/371-4.png" /><br /><br /><br /><strong><h3>Credential Dumping</h3></strong><br /><br />The VaultCmd is not able to show the password, but we can rely on other PowerShell Scripts such as <strong>Get-WebCredentials.ps1</strong>, which is already included in the attached VM.<br /><br />Link: <strong>https://github.com/samratashok/nishang/blob/master/Gather/Get-WebCredentials.ps1</strong> <br /><br />Ensure to execute PowerShell with bypass policy to import it as a module as follows,<br /><br /><span style="text-decoration:underline;">Command</span>:<br /><br /><strong>powershell -ex bypass<br />Import-Module C:\Tools\Get-WebCredentials.ps1<br />Get-WebCredentials</strong><br /><br /><img src="images/371-5.png" alt="images/371-5.png" /><br /><br />The output shows that we obtained the username and password for accessing the internal application.<br /><br /><br /><strong><h3>RunAs</h3></strong><br /><br />An alternative method of taking advantage of stored credentials is by using RunAs. RunAs is a command-line built-in tool that allows running Windows applications or tools under different users&#39; permissions. The RunAs tool has various command arguments that could be used in the Windows system. The <strong>/savecred </strong>argument allows you to save the credentials of the user in Windows Credentials Manager (under the Windows Credentials section). So, the next time we execute as the same user, runas will not ask for a password.<br /><br />Let&#39;s apply it to the attached Windows machine. Another way to enumerate stored credentials is by using <strong>cmdkey</strong>, which is a tool to create, delete, and display stored Windows credentials. By providing the <strong>/list</strong> argument, we can show all stored credentials, or we can specify the credential to display more details<strong> /list:computername</strong>.<br /><br /><span style="text-decoration:underline;">Command</span>:<br /><strong>cmdkey /list</strong><br /><br /><img src="images/371-6.png" alt="images/371-6.png" /><br /><br />The output shows that we have a domain password stored as the <strong>thm\thm-local</strong> user. Note that stored credentials could be for other servers too. Now let&#39;s use <strong>runas</strong> to execute Windows applications as the <strong>thm-local </strong>user. <br /><br /><span style="text-decoration:underline;">Command</span>:<br /><strong>runas /savecred /user:THM.red\thm-local cmd.exe</strong><br /><br /><img src="images/371-7.png" alt="images/371-7.png" /><br /><br />A new cmd.exe pops up with a command prompt ready to use. Now run the whoami command to confirm that we are running under the desired user. There is a flag in the<strong> c:\Users\thm-local\Saved Games\flag.txt</strong>, try to read it and answer the question below.<br /><br /><br /><br /><strong><h3>Mimikatz</h3></strong><br /><br />Mimikatz is a tool that can dump clear-text passwords stored in the Credential Manager from memory. The steps are similar to those shown in the previous section (Memory dump), but we can specify to show the credentials manager section only this time.<br /><br /><span style="text-decoration:underline;">Command</span>:<br /><br /><strong>privilege::debug<br />sekurlsa::credman</strong><br /><br /><img src="images/371-8.png" alt="images/371-8.png" /><br /><br /><br />The techniques discussed in this task also could be done through other tools such as <strong>Empire</strong>, <strong>Metasploit</strong>, etc. You can do your own research to expand your knowledge.<br /><br /></div>
</body>
</html>
