<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Certificates</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Certificates</h1><br/><strong><h1>Exploiting Certificates</h1></strong><br /><br /><strong><h3>AD Certificate Services</h3></strong><br /><br />AD Certificate Services (CS) is Microsoft&#39;s Public Key Infrastructure (PKI) implementation. Since AD provides a level of trust in an organisation, it can be used as a CA to prove and delegate trust. AD CS is used for several things, such as encrypting file systems, creating and verifying digital signatures, and even user authentication, making it a promising avenue for attackers. <br /><br />Since AD CS is a privileged function, it usually runs on selected domain controllers. Meaning normal users can&#39;t really interact with the service directly. On the other side of the coin, organisations tend to be too large to have an administrator create and distribute each certificate manually. This is where certificate templates come in. Administrators of AD CS can create several templates that can allow any user with the relevant permissions to request a certificate themselves. These templates have parameters that say which user can request the certificate and what is required. SpecterOps found that specific combinations of these parameters can be incredibly toxic and abused for privilege escalation and persistent access.<br /><br />Before we dive deeper into certificate abuse, some terminology:<br /><br />    • PKI - Public Key Infrastructure is a system that manages certificates and public key encryption<br />    • AD CS - Active Directory Certificate Services is Microsoft&#39;s PKI implementation which usually runs on domain controllers<br />    • CA - Certificate Authority is a PKI that issues certificates<br />    • Certificate Template - a collection of settings and policies that defines how and when a certificate may be issued by a CA<br />    • CSR - Certificate Signing Request is a message sent to a CA to request a signed certificate<br />    • EKU - Extended/Enhanced Key Usage are object identifiers that define how a generated certificate may be used<br />    <br /><strong><h3>Finding Vulnerable Certificate Templates</h3></strong><br /><br />In order to find vulnerable templates, we will use Window&#39;s built-in tool <strong>certutil</strong>. Using our <strong>RDP</strong> access on <strong>THMSERVER</strong> from <strong>GPOs</strong> Task,  we can run the following Powershell script to enumerate certificates.<br /><br /><strong>certutil -Template -v &gt; templates.txt</strong><br /><br />This will provide output on all configured templates. We could also use a certificate auditing tool such as Ghostpack&#39;s <strong>PSPKIAudit</strong> (Automatic). However, a <strong>manual</strong> approach allows us to make sure we find all possible misconfigurations. A certificate template is deemed misconfigured if a combination of parameter values becomes poisonous, allowing the requester to perform privilege escalation. In our case, we are looking for a template with the following poisonous parameter combination:<br /><br />    • <strong>Client Authentication</strong> - The certificate can be used for Client Authentication.<br />    • <strong>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT </strong>- The certificate template allows us to specify the Subject Alternative Name (SAN).<br />    • <strong>CTPRIVATEKEY_FLAG_EXPORTABLE_KEY</strong> - The certificate will be exportable with the private key.<br />    • <strong>Certificate Permissions</strong> - We have the required permissions to use the certificate template.<br /><br />If you are interested in learning more about poisonous parameter combinations, have a read of the whitepaper from SpecterOps. Since the aim of this room is to gain more broad knowledge of AD exploitation attacks, we will be pointing out that <strong>Template[32]</strong> is the vulnerable template. In this template, we can see that the <strong>machine account</strong> of <strong>THMSERVER2</strong> can issue a <strong>CSR</strong> for a <strong>template</strong> that allows us to specify the <strong>Subject Alternative Name (SAN)</strong> and can be used for<strong> client authentication</strong>.<br /><br />SpecterOps mentions eight common security misconfigurations with AD CS, so it should be noted that there are still a significant amount of potential misconfigurations that can be found.<br /><br />References: <strong>https://posts.specterops.io/certified-pre-owned-d95910965cd2</strong><br />References: <strong>https://github.com/GhostPack/PSPKIAudit</strong>     <br /><br /><br /><strong><h3>Exploiting a Certificate Template</h3></strong><br /><br />Using <strong>RDP</strong> access on <strong>THMSERVER2</strong>, we will now request our certificate.We will use the Microsoft Management Console (<strong>MMC</strong>):<br /><br />    1. Click Start-&gt;run<br />    2. Type mmc and hit enter<br />    3. Click File-&gt;Add/Remove Snap-in..<br />    4. Add the <strong>Certificates</strong> <strong>snap-in </strong>and make sure to select <strong>Computer Account and Local computer </strong>on the<strong> prompts</strong>.<br />    5. Click OK<br /><br />You should now see the Certificate snap-in:<br /><br /><img src="images/353-1.png" alt="images/353-1.png" /><br /><br />We will request a personal certificate:<br /><br />    1. Right Click on <strong>Personal</strong> and select <strong>All Tasks-&gt;Request New Certificate</strong>...<br />    2. Click <strong>Next</strong> twice to select the AD enrollment policy.<br />    3. You will see that we have one template that we can request, but first, we need to provide additional information.<br />    4. Click on the <strong>More Information warning</strong>.<br />    5. Change the <strong>Subject name Type</strong> option to <strong>Common Name</strong> and provide<strong> any value,</strong> since it does not matter, and click <strong>Add</strong>.<br />    6. Change the <strong>Alternative name Type</strong> option to <strong>User principal name</strong>.<br />    7. Supply the <strong>UPN</strong> of the <strong>user</strong> you want to <strong>impersonate</strong>. The best would be a DA account such as <strong>Administrator@za.tryhackme.loc</strong> and click <strong>Add</strong>.<br />    <br />Your additional information should look something like this:<br /><br /><img src="images/353-2.png" alt="images/353-2.png" /><br /><br />Once you are happy with it, click <strong>Apply</strong> and <strong>OK</strong>. Then, select the certificate and click <strong>Enroll</strong>. You should be able to see your certificate:<br /><br /><img src="images/353-3.png" alt="images/353-3.png" /><br /><br />The last step is to export our certificate with the private key:<br /><br />    1. <strong>Right-click</strong> on the certificate and select <strong>All Tasks-&gt;Export</strong>...<br />    2. Click <strong>Next</strong>, select <strong>Yes</strong>, <strong>export the private key</strong>, and click <strong>Next</strong>.<br />    3. Click <strong>Next</strong>, then <strong>set a password</strong> for the certificate since the private key cannot be exported without a password. <br />    4. Click <strong>Next</strong> and <strong>select a location &amp; Name</strong> to store the certificate.<br />    5. Click <strong>Next</strong> and finally click <strong>Finish</strong>.<br />    <br /><strong>Note:</strong> While setting the Password there are 2 encryption options. Choosing any (TripleDES or AES256) will work fine with the following steps of Rubeus.<br /><br /><br /><strong><h3>User Impersonation through a Certificate</h3></strong><br /><br />Now we can finally impersonate a user. To perform this, two steps are required:<br /><br />    ▪ Use the certificate to request a Kerberos ticket-granting ticket (TGT) <em>[Tool Used - Rubeus]</em><br />    ▪ Load the Kerberos TGT into your hacking platform of choice <em>[Tool Used - Mimikatz &amp; winrs/PSSession]</em><br /><br /><br /><strong><span style="text-decoration:underline;">A) Requesting a TGT</span></strong><br /><br />We will use <strong>Rubeus</strong><br />Reference: [<strong>https://github.com/GhostPack/Rubeus</strong>]<br /><br /><br /><strong>.\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:C:\Users\t2_ross.bird\Desktop\CybeX-Cert-Export.pfx /password:Admin@123 /outfile:administrator.kirbi /domain:za.tryhackme.loc /dc:10.200.79.101</strong><br /><br />Let&#39;s break down the parameters:<br /><br />   	• <strong>/user </strong>- This specifies the user that we will impersonate and has to match the UPN for the certificate we generated<br />    • <strong>/enctype</strong> -This specifies the encryption type for the ticket. Setting this is important for evasion, since the default encryption algorithm is weak, which would result in an overpass-the-hash alert<br />    • <strong>/certificate</strong> - Path to the certificate we have generated<br />    • <strong>/password</strong> - The password for our certificate file<br />    • <strong>/outfile</strong> - The file where our TGT will be output to<br />    • <strong>/domai</strong>n - The FQDN of the domain we are currently attacking<br />    • <strong>/dc</strong> - The IP of the domain controller which we are requesting the TGT from. Usually it is best to select a DC that has a CA service running<br /><br />Once we execute the command, we should receive our TGT:<br /><br /><img src="images/353-4.png" alt="images/353-4.png" /><br /><br /><strong><span style="text-decoration:underline;">B) Loading the TGT</span></strong><br /><br />Now we can use <strong>Mimikatz</strong> to load the TGT and authenticate to THMDC:<br /><strong><br />privilege::debug<br />kerberos::ptt administrator.kirbi</strong><br /><br /><img src="images/353-5.png" alt="images/353-5.png" /><br /><br />We loaded the TGT successfully &amp; verified with <strong>klist</strong>.<br /><br />Next, exit Mimikatz &amp; to access the DC we need to use <strong>winrs.exe</strong><br /><br /><strong>winrs.exe -r:thmdc.za.tryhackme.loc cmd</strong><br /><br /><img src="images/353-6.png" alt="images/353-6.png" /><br /><br />Thanks!!</div>
</body>
</html>
