<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Credentials</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Credentials</h1><br/><strong><h1>Persistence Through Credentials</h1></strong><br /><br />Congratulations weary traveler! After breaching AD, performing enumeration, and exploiting it all the way to the top (if you have done these AD networks in order), you have finally made it to the tavern of persistence. The hard work is over and it is now time for some fun. While AD persistence is still serious business, it is really not as stressful as the other phases. Here we can let our creativity flow free. So rest your weary bones in our tavern, get yourself a nice cup of tea and let&#39;s begin.<br /><br />Together with your low-privileged credentials, you will be provided with Domain Administrator credentials. What luck! When discussing persistence techniques, you will use the privileged credentials to perform the persistence technique on your low-privileged credential set. Make a note of the following <strong>DA account</strong>:<br /><br /><strong>Username: Administrator<br />Password: tryhackmewouldnotguess1@<br />Domain: ZA</strong><br /><br />Since we provide your with full access over the entire domain, we can&#39;t really hide any flags or force you to make sure you perform these persistence techniques yourself before answering the questions. It is however encouraged that you take your time to work through these methods, as they will pay dividends in return on a red team assessment when the blue team starts kicking you out.<br /><br />The <strong>first</strong> and <strong>least</strong> <strong>reliable</strong> persistence technique that we will discuss is <strong>credentials</strong>. Several of the lateral techniques discussed in previous rooms would have resulted in the attacker gaining access to credentials. When using the word credentials, it can mean a username and password pair, but in the context of AD, even the password hash is sufficient for authentication through pass-the-hash techniques. <br /><br /><strong><h2>DC Sync</h2></strong><br /><br />It is not sufficient to have a single domain controller per domain in large organisations. These domains are often used in multiple regional locations, and having a single DC would significantly delay any authentication services in AD. As such, these organisations make use of multiple DCs. The question then becomes, how is it possible for you to authenticate using the same credentials in two different offices?<br /><br />The answer to that question is domain <strong>replication</strong>. Each domain controller runs a process called the <strong>Knowledge Consistency Checker</strong> (KCC). The KCC generates a replication topology for the AD forest and automatically connects to other domain controllers through <strong>Remote Procedure Calls </strong>(RPC) to synchronise information. This includes updated information such as the user&#39;s new password and new objects such as when a new user is created. This is why you usually have to wait a couple of minutes before you authenticate after you have changed your password since the DC where the password change occurred could perhaps not be the same one as the one where you are authenticating to.<br /><br />The process of replication is called <strong>DC Synchronisation</strong>. It is not just the DCs that can initiate replication. Accounts such as those belonging to the Domain Admins groups can also do it for legitimate purposes such as creating a new domain controller.<br /><br />A popular attack to perform is a DC Sync attack. If we have access to an account that has domain replication permissions, we can stage a DC Sync attack to harvest credentials from a DC.<br /><br /><strong><h3>Not All Credentials Are Created Equal</h3></strong><br /><br />Before starting our DC Sync attack, let&#39;s first discuss what credentials we could potentially hunt for. While we should always look to dump privileged credentials such as those that are members of the Domain Admins group, these are also the credentials that will be rotated (a blue team term meaning to reset the account&#39;s password) first. As such, if we only have privileged credentials, it is safe to say as soon as the blue team discovers us, they will rotate those accounts, and we can potentially lose our access.<br /><br />The goal then is to persist with near-privileged credentials. We don&#39;t always need the full keys to the kingdom; we just need enough keys to ensure we can still achieve goal execution and always make the blue team look over their shoulder. As such, we should attempt to persist through credentials such as the following:<br /><br />    ▪ <strong>Credentials that have local administrator rights on several machines</strong>. Usually, organisations have a group or two with local admin rights on almost all computers. These groups are typically divided into one for workstations and one for servers. By harvesting the credentials of members of these groups, we would still have access to most of the computers in the estate.<br />    ▪ <strong>Service accounts that have delegation permissions</strong>. With these accounts, we would be able to force golden and silver tickets to perform Kerberos delegation attacks.<br />    ▪ <strong>Accounts used for privileged AD services</strong>. If we compromise accounts of privileged services such as Exchange, Windows Server Update Services (WSUS), or System Center Configuration Manager (SCCM), we could leverage AD exploitation to once again gain a privileged foothold.<br /><br />When it comes to what credentials to dump and persist through, it is subject to many things. You will have to get creative in your thinking and take it on a case-by-case basis. However, for this room, we are going to have some fun, make the blue team sweat, and dump every single credential we can get our hands on!<br /><br /><br /><strong><h3>DCSync All</h3></strong><br /><br />We will be using Mimikatz to harvest credentials. <strong>SSH</strong> into <strong>THMWRK1</strong> using the <strong>DA</strong> account and load <strong>Mimikatz</strong>:<br /><br /><strong>lsadump::dcsync /domain:za.tryhackme.loc /user:lorraine.gill</strong><br /><br /><img src="images/357-1.png" alt="images/357-1.png" /><br /><br />You will see quite a bit of output, including the current NTLM hash of your account. You can verify that the NTLM hash is correct by using a website such as this to transform your password into an NTLM hash. <br /><br />Link: <strong>https://codebeautify.org/ntlm-hash-generator</strong> <br /><br />[I checked with the above website by converting the password i received in the credential website to NTLM hash &amp; it matched]<br /><br />This is great and all, but we want to DC sync every single account. To do this, we will have to enable logging on Mimikatz &amp; instead of specifying our account, we will use the /all flag:<br /><br /><strong>log cybex_dcdump.txt</strong><br /><strong>lsadump::dcsync /domain:za.tryhackme.loc /user:lorraine.gill</strong><br /><br />This will take a bit of time to complete. Once done, <strong>exit</strong> <strong>Mimikatz</strong> to finalise the dump find and then you can <strong>download</strong> the <strong>&lt;username&gt;_dcdump.txt </strong>file. You can use <strong>cat &lt;username&gt;_dcdump.txt | grep &quot;SAM Username&quot;</strong> to recover all the <strong>usernames</strong> and <strong>cat &lt;username&gt;_dcdump.txt | grep &quot;Hash NTLM&quot;</strong> for all <strong>hashes</strong>. We can now either perform an offline password cracking attack to recover the plain text credentials or simply perform a pass the hash attack with Mimikatz.<br /><br /><strong>scp za.tryhackme.loc\\Administrator@thmwrk1.za.tryhackme.loc:c:/\tools/\cybex_dcdump.txt .</strong><br /><br /><img src="images/357-2.png" alt="images/357-2.png" /><br /><br />We can examine the log file to get the credential dump.<br /><br /><strong>Note:</strong><br />For the <strong>krbtgt</strong> user, there is a user for both the <strong>child</strong> and <strong>parent</strong> domains. So you need to be specific and use <strong>krbtgt@za.tryhackme.loc</strong> as the username.<br /><br /><strong>lsadump::dcsync /domain:za.tryhackme.loc /user:krbtgt@za.tryhackme.loc</strong><br /><br /><img src="images/357-3.png" alt="images/357-3.png" /></div>
</body>
</html>
