<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Local Windows Creds</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Local Windows Creds</h1><br/><strong><h1>Local Windows Credentials</h1></strong><br /><br />In general, Windows operating system provides two types of user accounts: <strong>Local</strong> and <strong>Domain</strong>. Local users&#39; details are stored locally within the Windows file system, while domain users&#39; details are stored in the centralized Active Directory. This task discusses credentials for local user accounts and demonstrates how they can be obtained.<br /><br /><br /><strong><h3>Keystrokes</h3></strong><br /><br />Keylogger is a software or hardware device to monitor and log keyboard typing activities. Keyloggers were initially designed for legitimate purposes such as feedback for software development or parental control. However, they can be misused to steal data. As a red teamer, hunting for credentials through keyloggers in a busy and interactive environment is a good option. If we know a compromised target has a logged-in user, we can perform keylogging using tools like the Metasploit framework or others.<br /><br />We have a use case example for exploiting users via keystrokes using Metasploit in another THM room. For more information, you should check THM Exploiting AD (Task 5). <br /><br /><br /><strong><h3>Security Account Manager (SAM)</h3></strong><br /><br />The SAM is a Microsoft Windows database that contains local account information such as usernames and passwords. The SAM database stores these details in an encrypted format to make them harder to be retrieved. Moreover, it can not be read and accessed by any users while the Windows operating system is running. However, there are various ways and attacks to dump the content of the SAM database. <br /><br />First, ensure you have deployed the provided VM and then confirm we are not able to <strong>copy</strong> or <strong>read</strong>  the <strong>c:\Windows\System32\config\sam</strong> file:<br /><br /><img src="images/369-1.png" alt="images/369-1.png" /><br /><br />The above is done as an Administrator. We get the file is being used.<br />As a Normal user we will get Access Denied Error.<br /><br /><br /><strong><h3>Metasploit&#39;s HashDump</h3></strong><br /><br />The first method is using the built-in Metasploit Framework feature, hashdump, to get a copy of the content of the SAM database. The Metasploit framework uses in-memory code injection to the LSASS.exe process to dump copy hashes. We will discuss dumping credentials directly from the LSASS.exe process in another task!<br /><br /><img src="images/369-2.png" alt="images/369-2.png" /><br /><br /><strong>Note:</strong> However, it requires administrator access.<br /><br /><br /><strong><h3>Volume Shadow Copy Service</h3></strong><br /><br />The other approach uses the Microsoft Volume shadow copy service, which helps perform a volume backup while applications read/write on volumes. You can visit the Microsoft documentation page for more information about the service.<br /><br />More specifically, we will be using wmic to create a shadow volume copy. This has to be done through the command prompt with <strong>administrator</strong> <strong>privileges</strong> as follows,<br /><br />    1. Run the standard cmd.exe prompt with administrator privileges.<br />    2. Execute the wmic command to create a copy shadow of C: drive<br />    3. Verify the creation from step 2 is available.<br />    4. Copy the SAM database from the volume we created in step 2<br /><br />Now let&#39;s apply what we discussed above and run the cmd.exe with administrator privileges. Then execute the following wmic command:<br /><br /><span style="text-decoration:underline;">Command</span>:<br /><br /><strong>wmic shadowcopy call create Volume=&#39;C:\&#39;</strong><br /><br /><img src="images/369-3.png" alt="images/369-3.png" /><br /><br />Once the command is successfully executed, let&#39;s use the <strong>vssadmin</strong>, Volume Shadow Copy Service administrative command-line tool, to list and confirm that we have a shadow copy of the<strong> C:</strong> volume. <br /><br /><span style="text-decoration:underline;">Command</span>:<br /><br /><strong>vssadmin list shadows</strong><br /><br /><img src="images/369-4.png" alt="images/369-4.png" /><br /><br />The output shows that we have successfully created a shadow copy volume of (C:) with the following path: <br /><strong>\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1</strong><br /><br />As mentioned previously, the SAM database is encrypted either with <strong>RC4</strong> or <strong>AES</strong> encryption algorithms. In order to decrypt it, we need a decryption key which is also stored in the files system in <strong>c:\Windows\System32\Config\system</strong><br /><br />Now let&#39;s copy both files (sam and system) from the shadow copy volume we generated to the desktop as follows,<br /><br /><img src="images/369-5.png" alt="images/369-5.png" /><br /><br />Now we have both required files, transfer them to the AttackBox with your favourite method (SCP/SMB should work). <br /><br /><br /><strong><h3>Registry Hives</h3></strong><br /><br />Another possible method for dumping the SAM database content is through the Windows Registry. Windows registry also stores a copy of some of the SAM database contents to be used by Windows services. Luckily, we can save the value of the Windows registry using the reg.exe tool. As previously mentioned, we need two files to decrypt the SAM database&#39;s content. Ensure you run the command prompt with Administrator privileges.<br /><br /><span style="text-decoration:underline;">Command</span>:<br /><br /><strong>reg save HKLM\sam C:\users\thm\Desktop\sam-reg<br />reg save HKLM\system C:\users\thm\Desktop\system-reg</strong><br /><br /><img src="images/369-6.png" alt="images/369-6.png" /><br /><br />Let&#39;s this time decrypt it using one of the Impacket tools: <strong>secretsdump.py</strong>, which is already installed in the AttackBox. The Impacket SecretsDump script extracts credentials from a system locally and remotely using different techniques. <br /><br />Move both SAM and system files to the AttackBox and run the following command:<br /><br /><span style="text-decoration:underline;">Command</span>:<br /><br /><strong>secretsdump.py -sam /tmp/sam-reg -system /tmp/system-reg LOCAL</strong><br /><br /><img src="images/369-7.png" alt="images/369-7.png" /><br /><br /><strong>Note:</strong> We can use both the pairs (The ones from Registry &amp; The ones from Volume Shadow Copy method) as shown above. <br /><br /><strong>Note</strong> that we used the SAM and System files that we extracted from Windows Registry. The <strong>-sam</strong> argument is to specify the path for the dumped sam file from the Windows machine. The<strong> -system</strong> argument is for a path for the system file. We used the <strong>LOCAL</strong> argument at the end of the command to decrypt the Local SAM file as this tool handles other types of decryption. <br /><br /><strong>Note</strong> if we compare the output against the NTLM hashes we got from Metasploit&#39;s Hashdump, the result is different. The reason is the other accounts belong to Active Directory, and their information is not stored in the System file we have dumped. To Decrypt them, we need to dump the <strong>SECURITY</strong> file from the Windows file, which contains the required files to decrypt Active Directory accounts.<br /><br />Once we obtain NTLM hashes, we can try to crack them using Hashcat if they are guessable, or we can use different techniques to impersonate users using the hashes.<br /><br /></div>
</body>
</html>
