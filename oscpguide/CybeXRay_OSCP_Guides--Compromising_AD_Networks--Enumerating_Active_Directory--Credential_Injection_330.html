<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Credential Injection</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Credential Injection</h1><br/><p><strong><h1>Credential Injection</h1></strong></p><p></p><p><strong>Note:</strong> To be Solved ONLY using local own Windows Machine</p><p></p><p>You can get incredibly far doing AD enumeration from a Kali machine. Still, if you genuinely want to do in-depth enumeration and even exploitation, you need to understand and mimic your enemy. Thus, you need a Windows machine. This will allow us to use several built-in methods to stage our enumeration and exploits. In this network, we will explore one of these built-in tools, called the <strong>runas.exe</strong> binary.</p><p></p><p></p><p><strong><h2>Runas Explained</h2></strong></p><p><strong><h2></h2></strong></p><p>Have you ever found AD credentials but nowhere to log in with them? Runas may be the answer you&#39;ve been looking for!</p><p></p><p>In security assessments, you will often have network access and have just discovered AD credentials but have no means or privileges to create a new domain-joined machine. So we need the ability to use those credentials on a Windows machine we control.</p><p></p><p>If we have the AD credentials in the format of &lt;username&gt;:&lt;password&gt;, we can use Runas, a legitimate Windows binary, to inject the credentials into memory. The usual Runas command would look something like this:</p><p></p><p><strong>runas.exe /netonly /user:&lt;domain&gt;\&lt;username&gt; cmd.exe</strong></p><p></p><p>Let&#39;s look at the parameters:</p><p></p><p>    ▪<strong> /netonly</strong> - Since we are not domain-joined, we want to load the credentials for network authentication but not authenticate against a domain controller. So commands executed locally on the computer will run in the context of your standard Windows account, but any network connections will occur using the account specified here.</p><p>    ▪<strong> /user</strong> - Here, we provide the details of the domain and the username. It is always a safe bet to use the Fully Qualified Domain Name (FQDN) instead of just the NetBIOS name of the domain since this will help with resolution.</p><p>    ▪<strong> cmd.exe</strong> - This is the program we want to execute once the credentials are injected. This can be changed to anything, but the safest bet is cmd.exe since you can then use that to launch whatever you want, with the credentials injected.</p><p></p><p>Once you run this command, you will be <strong>prompted</strong> to supply a <strong>password</strong>. Note that since we added the /netonly parameter, the credentials will not be verified directly by a domain controller so that it will accept any password. We still need to confirm that the network credentials are loaded successfully and correctly.</p><p></p><p><strong>Note:</strong> If you use your own Windows machine, you should make sure that you run your first Command Prompt as Administrator. This will inject an Administrator token into CMD. If you run tools that require local Administrative privileges from your Runas spawned CMD, the token will already be available. This does not give you administrative privileges on the network, but will ensure that any local commands you execute, will execute with administrative privileges.</p><p></p><p><strong><h2>Important Note:</h2></strong></p><p>If we use the Tryhackme JUMP Machine, by doing RDP into it. We do not need <strong>runas</strong> Or this entire task of <strong>credential injection</strong>.</p><p>This is because, the machine <strong>THMJMP1</strong> already has the user<strong> jennifer.wright</strong> in it which is a valid domain credential &amp; also the system <strong>THMJMP1</strong> is joined in the domain. (So we <strong>already know</strong> where to use the credentials)</p><p></p><p>Thus, from <strong>THMJMP1</strong> we can directory list the <strong>SYSVOL</strong> without any <strong>runas</strong> command</p><p>However, the machine is still not Doamin Joined (Will discuss in next task)</p><p></p><p></p><p> </p><p><strong><h3>Scenario (Imp):</h3></strong></p><p>Suppose we are doing pentesting in an AD environment. We have been given VPN access <strong>only</strong>(No Machine Access). Say we found a credential. In such a case, we can use our <strong>own Windows Machine</strong>.</p><p></p><p><strong><h3>Setup:</h3></strong></p><p>1. First, install OpenVPN in the windows machine.</p><p>2. Then connect to the VPN Network. (In our case we connected to CybeX-adenumeration.ovpn)</p><p>	<strong>Note:</strong> We have to disconnect VPN from Kali machine as only 1 machine can access</p><p>3. We are now connected to the AD Network, However we need to setup DNS. It can be done by 2 ways</p><p>	A) Use the GUI Network Connection tools. I renamed the OpenVPN adapter to Tunnel0 for convenience. Then open the adapter properties(IPv4). Keep the IP Address to be Automatic &amp; Set the DNS as required.</p><p>	</p><p>	<img src="images/330-1.png" alt="images/330-1.png" /></p><p>	</p><p>	<img src="images/330-2.png" alt="images/330-2.png" /></p><p>	</p><p>	B) Using command line in a powershell.</p><p>	</p><p><strong>	$dnsip = &quot;&lt;DC IP&gt;&quot;</strong></p><p><strong>	$index = Get-NetAdapter -Name &#39;Ethernet&#39; | Select-Object -ExpandProperty &#39;ifIndex&#39;</strong></p><p><strong>	Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses $dnsip	</strong></p><p>	</p><p>	<strong>Of course</strong>, &#39;Ethernet&#39; will be whatever interface is connected to the TryHackMe network. So in our case: Tunnel0	</p><p>	</p><p>4. Test DNS connection.</p><p>	</p><p>	<strong>nslookup za.tryhackme.com</strong></p><p>	<img src="images/330-3.png" alt="images/330-3.png" /></p><p></p><p>	The above confirms our DNS is working.</p><p></p><p>5. Open an administator command prompt in our local windows machine &amp; run the following command.</p><p>	</p><p><strong>	runas.exe /netonly /user:za.tryhackme.com\jennifer.wright cmd.exe</strong></p><p>	It will ask for password &amp; then open a <strong>new </strong>cmd prompt with the domain user from our local machine.</p><p>	</p><p>	<img src="images/330-4.png" alt="images/330-4.png" /></p><p>6. Notice: If we try to list the SYSVOL from our <strong>old</strong> cmd. It won&#39;t work as my windows machine is not a part of the Active Directory.</p><p>	(<strong>Equivalent : Without runas</strong>)</p><p>	</p><p>	<img src="images/330-5.png" alt="images/330-5.png" /></p><p>	</p><p>7. Now, in the <strong>newly</strong> opened CMD we can list the SYSVOL indicating we have injected the credentials.</p><p>	(<strong>Equivalent : With runas</strong>)</p><p>	<img src="images/330-6.png" alt="images/330-6.png" /></p><p>	We won&#39;t go too much in-depth now into the contents of SYSVOL, but note that it is also good to enumerate its contents since there may be some additional AD credentials lurking there.</p><p>	</p><p><strong><h4>IP vs Hostnames</h4></strong></p><p></p><p><strong>Question:</strong> Is there a difference between <strong>dir \\za.tryhackme.com\SYSVOL</strong> and <strong>dir \\10.200.14.101\SYSVOL</strong> and why the big fuss about DNS?</p><p></p><p><img src="images/330-7.png" alt="images/330-7.png" /></p><p></p><p></p><p></p><p>There is quite a difference, and it boils down to the authentication method being used. When we provide the <strong>hostname</strong>, network authentication will attempt first to perform <strong>Kerberos</strong> <strong>authentication</strong>. Since Kerberos authentication uses hostnames embedded in the tickets, if we provide the <strong>IP</strong> instead, we can force the authentication type to be <strong>NTLM</strong>. While on the surface, this does not matter to us right now, it is good to understand these slight differences since they can allow you to remain more stealthy during a Red team assessment. In some instances, organisations will be monitoring for OverPass- and Pass-The-Hash Attacks. Forcing NTLM authentication is a good trick to have in the book to avoid detection in these cases.</p><p></p><p><strong><h3>Using Injected Credentials</h3></strong></p><p></p><p>Now that we have injected our AD credentials into memory, this is where the fun begins. With the /netonly option, all network communication will use these injected credentials for authentication. This includes all network communications of applications executed from that command prompt window.</p><p></p><p>This is where it becomes potent. Have you ever had a case where an MS SQL database used Windows Authentication, and you were not domain-joined? Start MS SQL Studio from that command prompt; even though it shows your local username, click Log In, and it will use the AD credentials in the background to authenticate! </p><p></p></div>
</body>
</html>
