<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Rogue LDAP Server @Kali Machine</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Rogue LDAP Server @Kali Machine</h1><br/><strong><h3>Creating/Setting Up a Rogue LDAP Server in Our Kali Machine:</h3></strong><br /><br /><strong>apt install slapd ldap-utils <br />apt install libsasl2-modules libsasl2-modules-ldap</strong><br /><br /><strong>Note:</strong> The Last 2 Library files are installed to install the Cyrus SASL (This helps for default authentication of LDAP serer)<br /><br /><a href="https://www.cyrusimap.org/sasl/sasl/installation.html">https://www.cyrusimap.org/sasl/sasl/installation.html</a><br /><a href="https://github.com/cyrusimap/cyrus-sasl/releases">https://github.com/cyrusimap/cyrus-sasl/releases</a><br /><br /><br />Set a Password during <strong>slapd</strong> installation.<br /><br /><img src="images/321-1.png" alt="images/321-1.png" /><br /><br /><br />Once Installation is Complete, we need to configure the slapd using the following commands.<br /><br /><strong>dpkg-reconfigure -p low slapd</strong><br /><br />1- Omit OpenLDAP server configuration? <strong>No</strong><br /><br /><img src="images/321-2.png" alt="images/321-2.png" /><br /><br />2- DNS domain name: {target AD domain name} i.e. <strong>testdomain.com</strong> Or in our case <strong>za.tryhackme.com</strong><br /><br /><img src="images/321-3.png" alt="images/321-3.png" /><br /><br />3- Organization name: {target AD domain name} i.e. <strong>testdomain.com</strong> Or in our case <strong>za.tryhackme.com</strong><br /><br /><img src="images/321-4.png" alt="images/321-4.png" /><br /><br /><br />4- Administrator password: {password}, same as the one we configured earlier during the initial installation.<br /><br /><img src="images/321-5.png" alt="images/321-5.png" /><br /><br /><br />5- Do you want the database to be removed when slapd is purged? <strong>No</strong><br /><br /><img src="images/321-6.png" alt="images/321-6.png" /><br /><br /><br />6- Move old database files before creating a new database — Yes<br /><br /><img src="images/321-7.png" alt="images/321-7.png" /><br /><br /><br />After finishing the configuration steps, start the slapd server.<br /><br /><strong>systemctl start slapd</strong><br /><br /><br />Now that the server is up and running, we need to configure its authentication methods to support <strong>PLAIN</strong> and <strong>LOGIN</strong> <strong>only</strong>. By default, OpenLDAP supports <strong>DIGEST-MD5, CRAM-MD5, and NTLM</strong> as authentication mechanisms. We can check that by running the ldapsearch command with the supported authentication flag “<strong>supportedSASLMechanisms</strong>.” to see the supported methods.<br /><br /><strong>ldapsearch -H ldap:// -x -LLL -s base -b &quot;&quot; supportedSASLMechanisms</strong><br /><br /><img src="images/321-8.png" alt="images/321-8.png" /><br /><br /><strong>Important Note:</strong> If the two library files would not have been installed, <strong>(libsasl2-modules libsasl2-modules-ldap) Cyrus SASL</strong> we would have got blank output below dn:<br /><br />Thus, the following libraries are required for basic LDAP Authentication.<br /><br />Basic LDAP Authentication: <strong>libsasl2-modules &amp; libsasl2-modules-ldap</strong><br />Kerberos LDAP Authentication: <strong>libsasl2-modules-gssapi-heimdal or libsasl2-modules-gssapi-mit</strong> (More Secure)<br /><br />However, we want the opposite of security since we will be sniffing the LDAP communication.<br />To capture the credentials in clear-text, we need to re-configure the LDAP server to support <strong>PLAIN</strong> and <strong>LOGIN</strong> authentication methods.<br /><br />To do that, we create a ldif file i.e. “<strong>olcSaslSecProps.ldif </strong>” with the below configurations. {We can give any name, but extention should be <strong>ldif</strong>)<br /><br />         <br /><strong>#olcSaslSecProps.ldif<br />dn: cn=config<br />replace: olcSaslSecProps<br />olcSaslSecProps: noanonymous,minssf=0,passcred</strong><br /><br />The file has the following properties:<br /><br />    ▸ <strong>olcSaslSecProps:</strong> Specifies the SASL security properties<br />    ▸ <strong>noanonymous:</strong> Disables mechanisms that support anonymous login<br />    ▸<strong> minssf:</strong> Specifies the minimum acceptable security strength with 0, meaning no protection.<br />    <br />The file contents are as follows:<br /><img src="images/321-9.png" alt="images/321-9.png" /><br /><strong>Note:</strong> I used a custom name but extention need to be <strong>ldif</strong><br /><br /><br />Now, to Replace our Security configuration use the following:<br />Commit the new changes with <strong>ldapmodify</strong> and restart the server.<br /><br /><strong>ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcPlainAuthOnly.ldif<br />service slapd restart</strong><br /><br /><img src="images/321-10.png" alt="images/321-10.png" /><br /><br />Re-run the ldapsearch command to check for the supported SASL mechanisms one more time; you should be able to see the new modified methods of PLAIN and LOGIN.<br /><br /><strong>ldapsearch -H ldap:// -x -LLL -s base -b &quot;&quot; supportedSASLMechanisms</strong><br /><br /><img src="images/321-11.png" alt="images/321-11.png" /><br /><br />We have successfully setup our Rogue LDAP Server with least security. Cheers !!<br /><br /><br /></div>
</body>
</html>
