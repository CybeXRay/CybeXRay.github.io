<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Configuration Files (Database)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Configuration Files (Database)</h1><br/><p><strong><h2>Configuration Files</h2></strong></p><p></p><p>The last enumeration avenue we will explore in this network is configuration files. Suppose you were lucky enough to cause a breach that gave you access to a host on the organisation&#39;s network. In that case, configuration files are an excellent avenue to explore in an attempt to recover AD credentials. Depending on the host that was breached, various configuration files may be of value for enumeration: </p><p></p><p>    ▸ Web application config files</p><p>    ▸ Service configuration files</p><p>    ▸ Registry keys</p><p>    ▸ Centrally deployed applications</p><p></p><p>Several enumeration scripts, such as <strong>Seatbelt</strong> (Github), can be used to automate this process.</p><p></p><p><strong>Configuration File Credentials</strong></p><p></p><p>However, we will focus on recovering credentials from a <strong>centrally deployed application</strong> in this task. Usually, these applications need a method to authenticate to the domain during both the installation and execution phases. An example of such as application is <strong>McAfee Enterprise Endpoint Security</strong>, which organisations can use as the endpoint detection and response tool for security.</p><p></p><p>McAfee embeds the credentials used during installation to connect back to the orchestrator in a file called ma.db. This database file can be retrieved and read with local access to the host to recover the associated AD service account. We will be using the SSH access on THMJMP1 again for this exercise.</p><p></p><p>The <strong>ma.db</strong> file is stored in a fixed location:</p><p></p><p><img src="images/327-1.png" alt="images/327-1.png" /></p><p></p><p>In our Case:</p><p><img src="images/327-2.png" alt="images/327-2.png" /></p><p></p><p>We can use SCP to copy the ma.db to our AttackBox:</p><p></p><p><strong>scp thm@THMJMP1.za.tryhackme.com:C:/ProgramData/McAfee/Agent/DB/ma.db .</strong></p><p></p><p><img src="images/327-3.png" alt="images/327-3.png" /></p><p></p><p></p><p>To read the database file, we will use a tool called <strong>sqlitebrowser</strong> in our local kali machine. We can open the database using the following command:</p><p><strong>sqlitebrowser ma.db</strong></p><p></p><p><img src="images/327-4.png" alt="images/327-4.png" /></p><p></p><p></p><p>We are particularly interested in the second entry focusing on the <strong>DOMAIN</strong>, <strong>AUTH_USER</strong>, and <strong>AUTH_PASSWD</strong> field entries. Make a note of the values stored in these entries. However, the <strong>AUTH_PASSWD</strong> field is <strong>encrypted</strong>. Luckily, McAfee encrypts this field with a <strong>known key</strong>. Therefore, we will use the following old python2 script to decrypt the password.</p><p></p><p>Right-click on Table to Browse it &amp; get the Base64 encoded &amp; encrypted password.</p><p><img src="images/327-5.png" alt="images/327-5.png" /></p><p></p><p><strong>Note:</strong> The tool we will use here is quite old. It uses Python v2 and relies on an old crypto library.</p><p></p><p>If we run the script as it is, we will get the following error.</p><p></p><p>###########################################################</p><p>File &quot;/usr/local/lib/python2.7/dist-packages/Crypto/Cipher/__init__.py&quot;, line 77, in _create_cipher</p><p>    raise TypeError(&quot;IV is not meaningful for the ECB mode&quot;)</p><p>TypeError: IV is not meaningful for the ECB mode</p><p>###########################################################</p><p></p><p><strong>Solution:</strong></p><p>Line No: 28</p><p>des3 = DES3.new(key, DES3.MODE_ECB, “”) To des3 = DES3.new(key, DES3.MODE_ECB)</p><p></p><p>Remove the <strong>“”</strong> part. The script should work now.</p><p></p><p><strong>Running the Script:</strong></p><p></p><p><img src="images/327-6.png" alt="images/327-6.png" /></p><p></p><p>We now once again have a set of AD credentials that we can use for further enumeration! This is just one example of recovering credentials from configuration files. If you are ever able to gain a foothold on a host, make sure to follow a detailed and refined methodology to ensure that you recover all loot from the host, including credentials and other sensitive information that can be stored in configuration files. </p></div>
</body>
</html>
