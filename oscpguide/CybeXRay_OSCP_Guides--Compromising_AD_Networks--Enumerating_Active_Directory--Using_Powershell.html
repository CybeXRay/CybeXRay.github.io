<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Using Powershell</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Using Powershell</h1><br/><strong><h1>Enumeration Through Powershell</h1></strong><br /><br /><br />PowerShell is the upgrade of Command Prompt. Microsoft first released it in 2006. While PowerShell has all the standard functionality Command Prompt provides, it also provides access to cmdlets (pronounced command-lets), which are .NET classes to perform specific functions. While we can write our own cmdlets, like the creators of <strong>PowerView</strong> did, we can already get very far using the built-in ones.<br /><br /><strong>Note:</strong> Powerview has been moved into recon category of (<a href="https://github.com/PowerShellMafia/PowerSploit">https://github.com/PowerShellMafia/PowerSploit</a>)<br /><br /><br />Since we installed the <strong>AD-RSAT</strong> tooling in Task 3, it <strong>automatically</strong> <strong>installed</strong> the <strong>associated</strong> <strong>cmdlets</strong> for us. There are 50+ cmdlets installed. We will be looking at some of these, but refer to this list for the complete list of cmdlets.<br />(<a href="https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps">https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps</a>)<br /><br />Using our SSH terminal, we can upgrade it to a PowerShell terminal using the following command: <strong>powershell</strong><br /><br /><strong><h3>Important Note:</h3></strong><br />Unlike CMD&#39;s <strong>net</strong> command, Powershell commands that enumerate domain can be run from our <strong>own Windows VM</strong> (Not Connected to Domain).<br />However, as usual we need a valid user credential.<br />Login to our <strong>own Windows VM</strong> using local account &amp; then use <strong>runas</strong> command to inject the credentials into memory &amp; in the <strong>new cmd </strong>prompt launch <strong>powershell</strong>.<br /><br /><strong>Also Note</strong>: The <strong>AD-RSAT</strong>  tools have to be installed to facilitate the CMDLETs required into powershell<br /><br /><strong><h3>Users</h3></strong><br /><br />We can use the <strong>Get-ADUser</strong> cmdlet to enumerate AD users:<br /><br /><strong>Get-ADUser -Identity gordon.stevens -Server za.tryhackme.com -Properties *</strong><br /><br /><img src="images/333-1.png" alt="images/333-1.png" /><br /><br />In Our Case:<br /><img src="images/333-2.png" alt="images/333-2.png" /><br /><br />The parameters are used for the following:<br />• <strong>-Identity</strong> - The account name that we are enumerating<br />• <strong>-Properties</strong> - Which properties associated with the account will be shown, * will show all properties<br />• <strong>-Server</strong> - Since our own Windows VM is not domain-joined, we have to use this parameter to point it to our domain controller<br />					[If we used THMJMP1 machine, we do not need the -Server option as the system is domain joined.]<br /><br /><br />For most of these cmdlets, we can also use the <strong>-Filter</strong> parameter that allows more control over enumeration and use the <strong>Format-Table</strong> cmdlet to display the results such as the following neatly:<br /><br /><strong>Get-ADUser -Filter &#39;Name -like &quot;*stevens&quot;&#39; -Server za.tryhackme.com | Format-Table Name,SamAccountName -A</strong><br /><br /><img src="images/333-3.png" alt="images/333-3.png" /><br /><br />In Our Case:<br /><img src="images/333-4.png" alt="images/333-4.png" /><br /><br /><strong><h3>Groups</h3></strong><br /><br />We can use the <strong>Get-ADGroup</strong> cmdlet to enumerate AD groups:<br /><br /><strong>Get-ADGroup -Identity Administrators -Server za.tryhackme.com</strong><br /><br /><img src="images/333-5.png" alt="images/333-5.png" /><br /><br />In Our Case:<br /><img src="images/333-6.png" alt="images/333-6.png" /><br /><br />We can also enumerate group membership using the <strong>Get-ADGroupMember</strong> cmdlet:<br /><br /><strong>Get-ADGroupMember -Identity Administrators -Server za.tryhackme.com</strong><br /><br /><img src="images/333-7.png" alt="images/333-7.png" /><br /><br />In Our Case:<br /><img src="images/333-8.png" alt="images/333-8.png" /><br /><strong><br />Note:</strong> To view all information about the group, use <strong>-Property *</strong><br /><br /><strong>AD Objects</strong><br /><br />1) A more generic search for any AD objects can be performed using the <strong>Get-ADObject</strong> cmdlet. For example, if we are looking for all AD objects that were <strong>changed</strong> after a <strong>specific</strong> <strong>date</strong>:<br /><br /><strong>$ChangeDate = New-Object DateTime(2022, 02, 28, 12, 00, 00)<br />Get-ADObject -Filter &#39;whenChanged -gt $ChangeDate&#39; -includeDeletedObjects -Server za.tryhackme.com</strong><br /><br /><img src="images/333-9.png" alt="images/333-9.png" /><br /><br />In Our Case:<br /><img src="images/333-10.png" alt="images/333-10.png" /><br /><br />2) If we wanted to, for example, perform a password spraying attack without locking out accounts, we can use this to enumerate accounts that have a <strong>badPwdCount</strong> that is greater than 0, to avoid these accounts in our attack:<br /><br /><strong>Get-ADObject -Filter &#39;badPwdCount -gt 0&#39; -Server za.tryhackme.com</strong><br /><br /><img src="images/333-11.png" alt="images/333-11.png" /><br /><br />This will only show results if one of the users in the network mistyped their password a couple of times.<br /><br />In Our Case:<br /><img src="images/333-12.png" alt="images/333-12.png" /><br /><br /><strong><h3>Domains</h3></strong><br /><br />We can use <strong>Get-ADDomain</strong> to retrieve additional information about the specific domain:<br /><br /><strong>Get-ADDomain -Server za.tryhackme.com</strong><br /><br /><img src="images/333-13.png" alt="images/333-13.png" /><br /><br />In Our Case:<br /><img src="images/333-14.png" alt="images/333-14.png" /><br /><br /><strong><h3>Altering AD Objects</h3></strong><br /><br />The great thing about the AD-RSAT cmdlets is that some even allow you to create new or alter existing AD objects. However, our focus for this network is on enumeration. Creating new objects or altering existing ones would be considered AD exploitation, which is covered later in the AD module.<br /><br />However, we will show an example of this by force changing the password of our AD user by using the <strong>Set-ADAccountPassword</strong> cmdlet:<br /><br /><strong>Set-ADAccountPassword -Identity gordon.stevens -Server za.tryhackme.com -OldPassword (ConvertTo-SecureString -AsPlaintext &quot;old&quot; -force) -NewPassword (ConvertTo-SecureString -AsPlainText &quot;new&quot; -Force)</strong><br /><br /><strong>Replace</strong>: <strong>old</strong> -→ Old Password &amp; <strong>new</strong> -→ New Password<br /><br />In Our Case:<br /><img src="images/333-15.png" alt="images/333-15.png" /><br /><br /><strong>Benefits</strong><br /><br />    ▪ The PowerShell cmdlets can enumerate significantly more information than the net commands from Command Prompt.<br />    ▪ We can specify the server and domain to execute these commands using <strong>runas</strong> from a <strong>non-domain-joined</strong> machine.<br />    ▪ We can create our own cmdlets to enumerate specific information.<br />    ▪ We can use the AD-RSAT cmdlets to directly change AD objects, such as resetting passwords or adding a user to a specific group.<br /><br /><strong>Drawbacks</strong><br /><br />    ▪ PowerShell is often monitored more by the blue teams than Command Prompt.<br />    ▪ We have to install the AD-RSAT tooling or use other, potentially detectable, scripts for PowerShell enumeration.</div>
</body>
</html>
