<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SID History</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>SID History</h1><br/><strong><h1>Persistence Through SID History</h1></strong><br /><br />The Security IDentifiers (SIDs) have been discussed before. But for a recap, SIDs are used to track the security principal and the account&#39;s access when connecting to resources. There is, however, an interesting attribute on accounts called the SID history.<br /><br />The legitimate use case of SID history is to enable access for an account to effectively be cloned to another. This becomes useful when an organisation is busy performing an AD migration as it allows users to retain access to the original domain while they are being migrated to the new one. In the new domain, the user would have a new SID, but we can add the user&#39;s existing SID in the SID history, which will still allow them to access resources in the previous domain using their new account. While SID history is good for migrations, we, as attackers, can also abuse this feature for persistence.<br /><br /><strong><h3>History Can Be Whatever We Want It To Be</h3></strong><br /><br />The thing is, SID history is not restricted to only including SIDs from other domains. With the right permissions, we can just add a SID of our current domain to the SID history of an account we control. Some interesting notes about this persistence technique:<br /><br />    <strong>• </strong>We normally require Domain Admin privileges or the equivalent thereof to perform this attack.<br />    <strong>• </strong>When the account creates a logon event, the SIDs associated with the account are added to the user&#39;s token, which then determines the privileges associated with the account. This includes group SIDs.<br />    <strong>• </strong>We can take this attack a step further if we inject the Enterprise Admin SID since this would elevate the account&#39;s privileges to effective be Domain Admin in all domains in the forest.<br />    <strong>• </strong>Since the SIDs are added to the user&#39;s token, privileges would be respected even if the account is not a member of the actual group. Making this a very sneaky method of persistence. We have all the permissions we need to compromise the entire domain (perhaps the entire forest), but our account can simply be a normal user account with membership only to the Domain Users group. We can up the sneakiness to another level by always using this account to alter the SID history of another account, so the initial persistence vector is not as easily discovered and remedied.<br />    <br /><br /><strong><h3>Forging History</h3></strong><br /><br />Get an <strong>SSH</strong> session on <strong>THMDC</strong> using the <strong>Administrator</strong> <strong>credentials</strong> for this next part. Before we forge SID history, let&#39;s just first get some information regarding the SIDs. Firstly, let&#39;s make sure that our low-privilege user does not currently have any information in their SID history:<br /><br /><strong>Get-ADUser lorraine.gill -properties sidhistory,memberof</strong><br /><br /><img src="images/362-1.png" alt="images/362-1.png" /><br /><br />This confirms that our user does not currently have any SID History set. Let&#39;s get the SID of the Domain Admins group since this is the group we want to add to our SID History:<br /><br /><strong>Get-ADGroup &quot;Domain Admins&quot;</strong><br /><br /><img src="images/362-2.png" alt="images/362-2.png" /><br /><br />We could use something like <strong>Mimikatz</strong> to add SID history. However, the latest version of Mimikatz has a flaw that does not allow it to patch LSASS to update SID history. Hence we need to use something else. In this case, we will use the <strong>DSInternals tools</strong> to directly patch the ntds.dit file, the AD database where all information is stored:<br /><br />Link: <strong>https://github.com/MichaelGrafnetter/DSInternals</strong> <br /><br /><img src="images/362-3.png" alt="images/362-3.png" /><br /><br /><span style="text-decoration:underline;">Commands:</span><br /><strong>Stop-Service -Name ntds -force<br />Add-ADDBSidHistory -SamAccountName &#39;lorraine.gill&#39; -SidHistory &#39;S-1-5-21-3885271727-2693558621-2658995185-512&#39; -DatabasePath C:\Windows\NTDS\ntds.dit<br />Start-Service -Name ntds</strong><br /><br /><img src="images/362-4.png" alt="images/362-4.png" /><br /><br />The <strong>NTDS</strong> <strong>database</strong> is <strong>locked</strong> when the <strong>NTDS</strong> <strong>service</strong> is <strong>running</strong>. In order to patch our SID history, we must <strong>first</strong> <strong>stop</strong> the <strong>service</strong>. You must <strong>restart</strong> the <strong>NTDS</strong> <strong>service</strong> <strong>after</strong> the <strong>patch</strong>, otherwise, authentication for the entire network will not work anymore.<br /><br />After these steps have been performed, let&#39;s SSH into THMWRK1 with our low-privileged credentials and verify that the SID history was added and that we now have Domain Admin privileges:<br /><br /><strong>Get-ADUser lorraine.gill -Properties sidhistory</strong><br /><br /><img src="images/362-5.png" alt="images/362-5.png" /><br /><br />Now, Lets try to access the DC as we have SIDHistory ready<br /><br /><img src="images/362-6.png" alt="images/362-6.png" /><br /><br />Based on the output above, that worked! We were able to forge our SID History, granting our low-privileged account DA access!<br /><br /><br /><strong><h3>Pitchforks and Torches from the Blue Team</h3></strong><br /><br />If you were to RDP into one of the hosts and use the AD Users and Groups snap-in, you would be able to view the SID history attribute added to your user. However, even with the highest possible privileges, you would not be able to remove the attribute since it is protected. In order to remove this, you would have to use tools such as the AD-RSAT PowerShell cmdlets to remove SID history.<br /><br />However, before you can even think about removing malicious SID history attributes, you first need to find them. None of the regular tools will tell you that something is wrong. That user will not all of a sudden pop up as a member of the Domain Admins group. So unless you are actively filtering through the attributes of your users, this is incredibly hard to find. This is because the SID history is only applied and used once the user authenticates.<br /><br />Imagine that you are the blue team dealing with an incident where you have just performed a domain takeback. You rotated the krbtgt account&#39;s password twice, removed golden and silver tickets, and rebuilt your entire CA server from scratch, just to see that the attacker is still performing DA commands with a low-privileged account. This would not be a great day.<br /><br /><br /><strong><h3>Extra (Self Research)</h3></strong><br /><br />Deleting SID-History using AD-RSAT Powershell cmdlets.<br /><br />Get the SID-History Value:<br /><strong>Get-ADUser -Identity lorraine.gill -Properties SidHistory | Select-Object -ExpandProperty SIDHistory</strong><br />Remove the Value:<br /><strong>Set-ADUser -Identity lorraine.gill -Remove @{SIDHistory=&#39;S-1-5-21-3885271727-2693558621-2658995185-512&#39;}</strong><br /><br /><img src="images/362-7.png" alt="images/362-7.png" /><br /><br />As we can see above, the SIDHistory column is blank again.<br /></div>
</body>
</html>
