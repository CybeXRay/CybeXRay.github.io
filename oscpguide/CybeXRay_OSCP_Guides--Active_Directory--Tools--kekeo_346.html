<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>kekeo</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>kekeo</h1><br/><p><strong><h1> Kekeo</h1></strong></p><p> </p><p><em> It is used to request TGT &amp; forge TGS.</em></p><p><em> </em></p><p> Now that we have access to the password associated with the <strong>svcIIS</strong> account, we can perform a <strong>Kerberos delegation attack</strong>. We will use a combination of <strong>Kekeo</strong> and <strong>Mimikatz</strong>. You can use another window for Mimikatz, but make sure to <strong>exit</strong> out of <strong>Mimikatz</strong> after the<strong> token::elevate</strong> command, otherwise the tickets will be loaded in the wrong context later on. We will use <strong>Kekeo</strong> to <strong>generate</strong> our <strong>tickets</strong> and then use <strong>Mimikatz</strong> to <strong>load</strong> those <strong>tickets</strong> into <strong>memory</strong>. Let&#39;s start by generating the tickets:</p><p> </p><p><img src="images/346-1.png" alt="images/346-1.png" /></p><p> </p><p> We first need to <strong>generate</strong> a <strong>TGT</strong> that can be used to <strong>generate tickets</strong> for the <strong>HTTP</strong> and <strong>WSMAN</strong> services:</p><p> </p><p><img src="images/346-2.png" alt="images/346-2.png" /></p><p> </p><p><strong>tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@ </strong></p><p> </p><p> Parameters explained:</p><p></p><p>    • user - The user who has the constrained delegation permissions.</p><p>    • domain - The domain that we are attacking since Kekeo can be used to forge tickets to abuse cross-forest trust.</p><p>    • password - The password associated with the svcIIS account.</p><p></p><p>Now that we have the <strong>TGT</strong> for the <strong>account</strong> that <strong>can</strong> <strong>perform delegation</strong>, we can <strong>forge</strong> <strong>TGS</strong> <strong>requests</strong> for the <strong>account</strong> we want to <strong>impersonate</strong>. We need to perform this for both <strong>HTTP</strong> and <strong>WSMAN</strong> to allow us to create a <strong>PSSession</strong> on <strong>THMSERVER1</strong>:</p><p></p><p>Lets Find a target account.</p><p></p><p><strong>Get-ADGroupMember -Identity &quot;Tier 1 Admins&quot;</strong></p><p></p><p><img src="images/346-3.png" alt="images/346-3.png" /></p><p></p><p>I selected “<strong>t1_pamela.dunn</strong>” &amp; will forge TGS for this account for the <strong>HTTP</strong> service.</p><p></p><p><strong>tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_pamela.dunn /service:http/THMSERVER1.za.tryhackme.loc</strong></p><p></p><p></p><p><img src="images/346-4.png" alt="images/346-4.png" /></p><p> </p><p>  Parameters explained:</p><p></p><p>    • tgt - We provide the TGT that we generated in the previous step.</p><p>    • user - The user we want to impersonate. Since<strong> t2_ accounts</strong> have <strong>administrative</strong> access over <strong>workstations</strong>, it is a safe assumption that <strong>t1_ accounts</strong> will have administrative access over <strong>servers</strong>, so choose a <strong>t1_ account</strong> that you would like to impersonate.</p><p>    • service - The services we want to impersonate using delegation. We first generate a TGS for the HTTP service. Then we can rerun the same command for the WSMAN service.</p><p></p><p>Run the command again, this time for the <strong>WSMAN</strong> service. </p><p></p><p><strong>tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_pamela.dunn /service:wsman/THMSERVER1.za.tryhackme.loc</strong></p><p></p><p><img src="images/346-5.png" alt="images/346-5.png" /></p><p></p><p>Now that we have the two TGS tickets, we can use Mimikatz to import them:</p><p>Mimikatz </p><p></p><p><img src="images/346-6.png" alt="images/346-6.png" /></p><p></p><p>I started Mimikatz from the same kekeo directory as the files were stored there &amp; i could use direct file names in mimikatz.</p></div>
</body>
</html>
