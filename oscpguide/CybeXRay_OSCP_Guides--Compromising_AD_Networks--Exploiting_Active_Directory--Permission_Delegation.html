<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Permission Delegation</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Permission Delegation</h1><br/><strong><h1>Exploiting Permission Delegation</h1></strong><br /><br /><br />Active Directory can delegate permissions and privileges through a feature called <strong>Permission Delegation</strong> (not to be confused with <strong>Kerberos Delegation</strong> that will be discussed in the <strong>next task</strong>). <strong>Delegation</strong> is what makes AD so powerful in organisations. Imagine we work for an organisation that has 50000 employees. Since we care about security, we only have three users that have access to DA credentials. It would be impossible for those three users to field all requests from the users, such as resetting their passwords. Using Delegation, we can delegate the permission to force change a user&#39;s password to the Helpdesk team, meaning they now have a delegated privilege for this specific function. In principle, to keep Delegation secure, the principle of least privilege should be followed. However, in large organisations, this is easier said than done. In this task we will look at exploiting some Delegation misconfigurations. <br /><br /><strong><h3>Permission Delegation</h3></strong><br /><br />Permission Delegation exploits are often referred to as ACL-based attacks. AD allows administrators to configure Access Control Entries (ACEs) that populates Discretionary Access Control Lists (DACLs), hence the name ACL-based attacks. Almost any AD object can be secured with ACEs, which then describe the allowed and denied permissions that any other AD object has against the target object.<br /><br />However, if these ACEs are misconfigured, it may be possible for an attacker to exploit them. Let&#39;s look at our example again. If the IT Support team were granted the ForceChangePassword ACE over the Domain Users group, this would be considered insecure. Sure they would be able to reset the passwords of employees that forgot their passwords, but this misconfiguration would allow them to also reset the passwords of privileged accounts, such as the accounts that are members of the Domain Admins group essentially allowing for privilege escalation.<br /><br /><br /><strong><h3>Exploiting ACEs</h3></strong><strong><br /></strong><br />A significant amount of ACEs can be misconfigured, and the exploits for each vary. The Bloodhound documentation assists in explaining enumerated ACEs and how they can be exploited. However, we will look at a couple of notable ones here:<br />[<a href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#">https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#</a>]<br /><br />    ▪ ForceChangePassword: We have the ability to set the user&#39;s current password without knowing their current password.<br />    ▪ AddMembers: We have the ability to add users (including our own account), groups or computers to the target group.<br />    ▪ GenericAll: We have complete control over the object, including the ability to change the user&#39;s password, register an SPN or add an AD object to the target group.<br />    ▪ GenericWrite: We can update any non-protected parameters of our target object. This could allow us to, for example, update the scriptPath parameter, which would cause a script to execute the next time the user logs on.<br />    ▪ WriteOwner: We have the ability to update the owner of the target object. We could make ourselves the owner, allowing us to gain additional permissions over the object.<br />    ▪ WriteDACL: We have the ability to write new ACEs to the target object&#39;s DACL. We could, for example, write an ACE that grants our account full control over the target object.<br />    ▪ AllExtendedRights: We have the ability to perform any action associated with extended AD rights against the target object. This includes, for example, the ability to force change a user&#39;s password.<br /><br />In order to exploit these ACEs, we will need a method to interact with AD to make these requests. The two best options for this are the<strong> AD-RSAT PowerShell cmdlets</strong> or <strong>PowerSploit</strong>. Depending on the breach and the detection tools in the environment, one option may be stealthier. In this task we will show both.<br /><br /><br /><strong><span style="text-decoration:underline;">Bloodhound</span></strong><br /><br />We ingested the provided loot file.<br />Privilege Escalation<br /><br />If we search for our user account that was assigned in Task 1 in Bloodhound, we see that we don&#39;t have a lot of permissions. We have the ability to RDP into THMWRK1, but this will only provide us with low-privileged access.<br /><br /><img src="images/343-1.png" alt="images/343-1.png" /><br /><br />Since the domain is tiered, our first step will be to compromise Tier 2 infrastructure. We need to compromise the Tier 2 Admins group since this group has administrative privileges on all workstations. Let&#39;s ask Bloodhound if there is perhaps a road that we can follow to compromise this group. Add your user account as the start position and the Tier 2 Admins group as the end position.<br /><br /><img src="images/343-2.png" alt="images/343-2.png" /><br /><br />Bloodhound shows us a very interesting path. It seems that there was a slight bit of Permission Delegation in this domain. An administrator has misconfigured the Permission Delegation of the IT Support group by providing the Domain Users group with the AddMembers ACE. This means that any member of the Domain Users group (including our account) can add accounts to the IT Support Group. Furthermore, Bloodhound shows that the IT Support Group has the ForceChangePassword ACE for the Tier 2 Admins group members. This is not really a misconfiguration since Tier 2 admins are not that sensitive, but it provides a very potent attack path when combined with the initial misconfiguration. Let&#39;s exploit it!<br /><br /><br /><strong><span style="text-decoration:underline;">AddMember</span></strong><br /><br />The first step in this attack path is to add our AD account to the IT Support group. We will use the<strong> Add-ADGroupMember </strong>PowerShell cmdlet from the <strong>AD-RSAT</strong> toolset for this. Start PowerShell (either in RDP or via SSH) on the THMWRK1 host and run the following command to add your account:<br /><br /><strong>Add-ADGroupMember &quot;IT Support&quot; -Members amy.king</strong><br /><br />We can verify that the command worked by using the <strong>Get-ADGroupMember</strong> cmdlet:<br /><br /><strong>Get-ADGroupMember -Identity &quot;IT Support&quot;</strong><br /><br />We should see our user <strong>amy.king</strong> in the list.<br /><br /><br /><br /><strong><span style="text-decoration:underline;">ForceChangePassword</span></strong><br /><br />Now that we are a member of the IT Support group, we have inherited the ForceChangePassword Permission Delegation over the Tier 2 Admins group. First, we need to identify the members of this group to <strong>select</strong> a <strong>target</strong>. We can use the <strong>Get-ADGroupMember</strong> cmdlet again to assist with this:<br /><br /><strong>Get-ADGroupMember -Identity &quot;Tier 2 Admins&quot;</strong><br /><br />I selected t2_ross_bird as target from the list.<br />We will use the <strong>Set-ADAccountPassword</strong> AD-RSAT cmdlet to force change the password:<br />        <br /><strong>$Password = ConvertTo-SecureString &quot;Admin@123&quot; -AsPlainText -Force <br />Set-ADAccountPassword -Identity &quot;t2_ross.bird&quot; -Reset -NewPassword $Password </strong><br /><br /><strong>Note:</strong> If you get an <strong>Access Denied error</strong>, your permissions have not yet propagated through the domain. This can take up to <strong>10 minutes</strong>. The best approach is to terminate your SSH or RDP session, take a quick break, and then reauthenticate and try again. You could also run <strong>gpupdate /force</strong> and then <strong>disconnect</strong> and <strong>reconnect</strong>, which in certain cases will cause the synchronisation to happen faster.<br /><br />If this step worked, you should now be able to authenticate to <strong>THMWRK1</strong> using this target account with its new password. You currently have administrative access to this workstation. Congratulations! You have officially escalated your privileged to Tier 2 Administrator by exploiting Permission Delegations.<br /><br /><img src="images/343-3.png" alt="images/343-3.png" /><br /><br />As we can see, successful RDP with the newly set password into the Tier 2 Admin&#39;s account.<br /><br /></div>
</body>
</html>
