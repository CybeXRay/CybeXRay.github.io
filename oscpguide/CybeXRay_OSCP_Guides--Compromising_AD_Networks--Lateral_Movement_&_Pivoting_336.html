<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Lateral Movement & Pivoting</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Lateral Movement & Pivoting</h1><br/><p><strong><h1>Lateral Movement &amp; Pivoting</h1></strong></p><p></p><p></p><p><img src="images/336-1.png" alt="images/336-1.png" /></p><p></p><p><strong><span style="text-decoration:underline;">Using Networks in Tryhackme:</span></strong></p><p></p><p></p><p>First, Download a different vpn file. Named: <strong>lateralmovementandpivoting.ovpn</strong> from Tryhackme</p><p></p><p>Then,</p><p> You will have to configure DNS on the host on which you are running the VPN connection. In order to configure our DNS, we must edit the<strong> /etc/systemd/resolved.conf</strong> file. Uncomment the DNS line and add the I<strong>P of THMDC</strong>: (As Shown in Network Diagram Above)</p><p> </p><p><img src="images/336-2.png" alt="images/336-2.png" /></p><p></p><p>Finally, Restart the service:</p><p></p><p><strong>systemctl restart systemd-resolved</strong></p><p></p><p>Or</p><p></p><p>Add the DNS in <strong>GUI Network Manager</strong>/<strong>nmtui</strong> tool (1st is the THM DNS then use default in the 2nd place).</p><p></p><p>and restart the Network Manager service:</p><p></p><p><strong>systemctl restart NetworkManager</strong></p><p></p><p><strong><span style="text-decoration:underline;">Testing DNS Status</span></strong></p><p></p><p><strong>nslookup thmdc.za.tryhackme.com</strong></p><p></p><p><img src="images/336-3.png" alt="images/336-3.png" /></p><p></p><p><strong>Note:</strong> For this box, nslookup didn&#39;t work. However, DNS is correctly setup.</p><p></p><p><strong>Requesting Your Credentials</strong></p><p></p><p>To simulate an AD breach, you will be provided with your first set of AD credentials. Once your networking setup has been completed, on your Attack Box, navigate to<strong> </strong><strong><a href="http://distributor.za.tryhackme.com/creds">http://distributor.za.tryhackme.com/creds</a></strong> to request your credential pair. Click the &quot;<strong>Get Credentials</strong>&quot; button to receive your credential pair that can be used for initial access.</p><p></p><p><img src="images/336-4.png" alt="images/336-4.png" /></p><p></p><p><strong>Credentials Received:</strong></p><p>Username: arthur.campbell</p><p>Password: Pksp9395</p><p></p><p>This credential pair will provide you SSH access to <strong>THMJMP2.za.tryhackme.com</strong>. <strong>THMJMP2</strong> can be seen as a jump host into this environment, simulating a foothold that you have achieved. </p><p></p><p>For SSH access, you can use the following command:</p><p></p><p><strong>ssh za\\&lt;AD Username&gt;@thmjmp2.za.tryhackme.com</strong></p><p></p><p><strong><h3>What is Lateral Movement?</h3></strong></p><p></p><p>Simply put, lateral movement is the group of techniques used by attackers to move around a network. Once an attacker has gained access to the first machine of a network, moving is essential for many reasons, including the following: - Reaching our goals as attackers - Bypassing network restrictions in place - Establishing additional points of entry to the network - Creating confusion and avoid detection.</p><p></p><p>While many cyber kill chains reference lateral movement as an additional step on a linear process, it is actually part of a cycle. During this cycle, we use any available credentials to perform lateral movement, giving us access to new machines where we elevate privileges and extract credentials if possible. With the newfound credentials, the cycle starts again.</p><p></p><p><img src="images/336-5.png" alt="images/336-5.png" /></p><p></p><p></p><p><strong><h3>A Quick Example (Very Nicely Explained)</h3></strong></p><p></p><p>Suppose we are performing a red team engagement where our final goal is to reach an internal code repository, where we got our first compromise on the target network by using a phishing campaign. Usually, phishing campaigns are more effective against non-technical users, so our first access might be through a machine in the Marketing department.</p><p></p><p>Marketing workstations will typically be limited through firewall policies to access any critical services on the network, including administrative protocols, database ports, monitoring services or any other that aren&#39;t required for their day to day labour, including code repositories.</p><p></p><p>To reach sensitive hosts and services, we need to move to other hosts and pivot from there to our final goal. To this end, we could try elevating privileges on the Marketing workstation and extracting local users&#39; password hashes. If we find a local administrator, the same account may be present on other hosts. After doing some recon, we find a workstation with the name DEV-001-PC. We use the local administrator&#39;s password hash to access DEV-001-PC and confirm it is owned by one of the developers in the company. From there, access to our target code repository is available.</p><p></p><p><strong>Simple Lateral Movement</strong></p><p></p><p><img src="images/336-6.png" alt="images/336-6.png" /></p><p></p><p>Notice that while lateral movement might need to be used to circumvent firewall restrictions, it is also helpful in evading detection. In our example, even if the Marketing workstation had direct access to the code repository, it is probably desirable to connect through the developer&#39;s PC. This behaviour would be less suspicious from the standpoint of a blue team analyst checking login audit logs.</p><p></p><p><strong><h3>The Attacker&#39;s Perspective</h3></strong></p><p></p><p>There are several ways in which an attacker can move laterally. The simplest way would be to use standard administrative protocols like WinRM, RDP, VNC or SSH to connect to other machines around the network. This approach can be used to emulate regular users&#39; behaviours somewhat as long as some coherence is maintained when planning where to connect with what account. While a user from IT connecting to the web server via RDP might be usual and go under the radar, care must be taken not to attempt suspicious connections (e.g. why is the local admin user connecting to the DEV-001-PC from the Marketing-PC?).</p><p></p><p>Attackers nowadays also have other methods of moving laterally while making it somewhat more challenging for the blue team to detect what is happening effectively. While no technique should be considered infallible, we can at least attempt to be as silent as possible. In the following tasks, we will look at some of the most common lateral movement techniques available.</p><p></p><p><strong><h3>Administrators and UAC</h3></strong><h3></h3></p><p><h3></h3></p><p>While performing most of the lateral movement techniques introduced throughout the room, we will mainly use administrator credentials. While one might expect that every single administrator account would serve the same purpose, a distinction has to be made between two types of administrators:</p><p></p><p><strong>    ◇ Local accounts part of the local Administrators group</strong></p><p><strong>    ◇ Domain accounts part of the local Administrators group</strong></p><p></p><p>The differences we are interested in are restrictions imposed by User Account Control (UAC) over local administrators (except for the default Administrator account). By default, local administrators won&#39;t be able to remotely connect to a machine and perform administrative tasks unless using an interactive session through RDP. Windows will deny any administrative task requested via RPC, SMB or WinRM since such administrators will be logged in with a filtered medium integrity token, preventing the account from doing privileged actions. The only local account that will get full privileges is the default Administrator account.</p><p></p><p>Domain accounts with local administration privileges won&#39;t be subject to the same treatment and will be logged in with full administrative privileges.</p><p></p><p>This security feature can be disabled if desired, and sometimes you will find no difference between local and domain accounts in the administrator&#39;s group. Still, it&#39;s essential to keep in mind that should some of the lateral movement techniques fail, it might be due to using a non-default local administrator where UAC is enforced. You can read more details about this security feature here.</p><p>(<a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction">https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction</a>)</p><p></p><p></p></div>
</body>
</html>
