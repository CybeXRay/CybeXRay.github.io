<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Osquery</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Osquery</h1><br/><strong><h1>Osquery</h1></strong><br /><br /><strong>Osquery</strong> is an open-source tool created by Facebook. With Osquery, Security Analysts, Incident Responders, Threat Hunters, etc., can query an endpoint (or multiple endpoints) using SQL syntax. Osquery can be installed on multiple platforms: Windows, Linux, macOS, and FreeBSD. <br /><br /><br />Some of the tools (open-source and commercial) that utilize Osquery are listed below.<br /><br />    <strong>Alienvault</strong>: The AlienVault agent is based on Osquery. <br />    <strong>Cisco</strong>: Cisco AMP (Advanced Malware Protection) for endpoints utilize Osquery in Cisco Orbital. <br />    <br />    <br />To Interact with the Osqury:<br /><br /><span style="text-decoration:underline;">Command</span>: <strong>osqueryi</strong><br /><br /><strong>Note:</strong> OSquery doesn&#39;t need elevated privileges for normal operation. However, to display all tables properly we need to start osquery from evelated shell.<br /><br />To view help<br /><br /><span style="text-decoration:underline;">Command</span>: <strong>.help</strong><br /><br /><strong>Note:</strong> Any meta commands in Osquery use <strong>“.”</strong> to start<br /><br /><img src="images/271-1.png" alt="images/271-1.png" /><br /><br /><br /><strong><span style="text-decoration:underline;">Tables &amp; Schema</span></strong><br /><br /><span style="text-decoration:underline;">Command</span>: <strong>.tables &lt;Names&gt;</strong><br /><span style="text-decoration:underline;">Command</span>: <strong>.schema &lt;Table_Name&gt;</strong><br /><br /><img src="images/271-2.png" alt="images/271-2.png" /><br /><br /><strong>Note:</strong> To check schema for another operating system, you&#39;ll need to use the <strong>--enable_foreign</strong> command-line flag. <br /><br /><br /><strong><span style="text-decoration:underline;">Schema Documentation</span></strong><br /><a href="https://osquery.io/schema/5.3.0/">https://osquery.io/schema/5.3.0/</a><br />We can view the documentations of all versions using the link.<br /><br />Table For Osquery Version:<br /><strong><h5>osquery_info</h5></strong><br /><br /><br /><strong><span style="text-decoration:underline;">Creating Queries</span></strong><br />The SQL language implemented in Osquery is not an entire SQL language that you might be accustomed to, but rather it&#39;s a superset of SQLite&#39;s. <br /><br />Realistically all your queries will start with a <strong>SELECT</strong> statement. This makes sense because, with Osquery, you are only querying information on an endpoint or endpoints. You won&#39;t be updating or deleting any information/data on the endpoint. <br /><br /><span style="text-decoration:underline;">Exception</span>: The use of other SQL statements, such as <strong>UPDATE</strong> and <strong>DELETE</strong>, is possible, but only if you&#39;re creating<strong> run-time tables (views)</strong> or using an <strong>extension</strong> if the <strong>extension supports them</strong>. <br /><br />Your queries will also include a <strong>FROM</strong> clause and end with a <strong>semicolon</strong>. <br /><br /><span style="text-decoration:underline;">Example</span>:<br />If you wish to retrieve all the information about the running processes on the endpoint.<br /><span style="text-decoration:underline;">Query</span>: <strong>SELECT * FROM processes;</strong><br /><br />The number of columns returned might be more than what you need. You can select specific columns rather than retrieving every column in the table. <br /><span style="text-decoration:underline;">Query</span>: <strong>SELECT pid, name, path FROM processes;</strong><br /><br />The <strong>count()</strong> function can be used to get exactly how many.<br /><span style="text-decoration:underline;">Query</span>: <strong>SELECT count(*) from processes;</strong><br /><br />The output can be limited to the first 3 in ascending order by process name.<br /><span style="text-decoration:underline;">Query</span>: <strong>SELECT pid, name, path FROM processes ORDER BY name LIMIT 3;</strong><br /><br />Optionally, you can use a <strong>WHERE</strong> clause to narrow down the list of results returned based on specified criteria.<br /><span style="text-decoration:underline;">Query</span>: <strong>SELECT pid, name, path FROM processes WHERE name=&#39;lsass.exe&#39;;</strong><br /><br />In the above query we used <strong>“=”</strong> Sign. However, there are others<br />Below are <strong>filtering operators</strong> that can be used in a WHERE clause:<br /><br /><br /><table class="table"><tr><th>Operator</th><th>Action</th></tr><tr><td>    = </td><td>[equal]</td></tr><tr><td>    &lt;&gt;  </td><td>[not equal]</td></tr><tr><td>    &gt;, &gt;= </td><td>[greater than, greater than or equal to]</td></tr><tr><td>    &lt;, &lt;= </td><td>[less than or less than or equal to] </td></tr><tr><td>    BETWEEN </td><td>[between a range]</td></tr><tr><td>    LIKE </td><td>[pattern wildcard searches]</td></tr><tr><td>    % </td><td>[wildcard, multiple characters]</td></tr><tr><td>    _ </td><td>[wildcard, one character]</td></tr></table><br /><br /><br />Below is a screenshot from the Osquery <a href="https://osquery.readthedocs.io/en/stable/deployment/file-integrity-monitoring/">documentation</a> showing examples of using wildcards when used in folder structures. <br /><img src="images/271-3.png" alt="images/271-3.png" /><br /><br /><strong>Note:</strong> Some tables will require a <strong>WHERE</strong> clause, such as the <strong>file table,</strong> to return a value. If the required <strong>WHERE</strong> clause is not included in the query, then you will get an <strong>error</strong>.<br /><br /><strong>JOIN</strong> <br />To join 2 or more tables, each table needs to <strong>share</strong> a column in common. <br />Let&#39;s look at 2 tables to demonstrate this further. Below is the schema for the <strong>osquery_info</strong> table and the <strong>processes</strong> table.<br /><br /><img src="images/271-4.png" alt="images/271-4.png" /><br />The common column in both tables is <strong>pid</strong>. A query can be constructed to use the <strong>JOIN</strong> clause to join these 2 tables <strong>USING</strong> the PID column.<br /><br /><span style="text-decoration:underline;">Query</span>: <strong>SELECT pid, name, path FROM osquery_info JOIN processes USING (pid);</strong><br /><br /><img src="images/271-5.png" alt="images/271-5.png" /><br /><br /><strong>Note:</strong> <strong>path</strong> was not in <strong>osquery_info</strong> table but due to the <strong>join</strong> with <strong>processes</strong>, we could <strong>query</strong> it.<br /><br /><strong>Example Challenge:</strong><br />What is the query to show the username field from the users table where the username is 3 characters long and ends with &#39;en&#39;?<br /><br /><span style="text-decoration:underline;">Query</span>: <strong>SELECT username FROM users WHERE username LIKE ‘_en’;</strong><br /><br /><br /><strong><h1>Kolide Fleet</h1></strong><br /><br />Open-source Osquery Fleet Manager. With Kolide Fleet, instead of using Osquery locally to query an endpoint, you can query multiple endpoints from the Kolide Fleet UI. <br /><br />Orginal Github Repo (Retired in 2020): 	<a href="https://github.com/kolide/fleet">https://github.com/kolide/fleet</a><br />Latest Similar Open Source Repo: 			<a href="https://github.com/fleetdm/fleet">https://github.com/fleetdm/fleet</a> <br /><br /><strong>Note:</strong> The open-source repo of Kolide Fleet is no longer supported and was retired on November 4th, 2020. A <strong>commercial version</strong>, known as <strong>Kolide K2</strong>, is available at: 						<a href="https://www.kolide.com/launcher">https://www.kolide.com/launcher</a><strong><br /></strong><br /><br /><strong><h4>Osquery Extentions</h4></strong><br /><br />Extensions add functionality/features (i.e., additional tables) that are not included in the core Osquery. Anyone can create extensions for Osquery. <br /><br />If you perform a search, you&#39;ll find some interesting ones that can be downloaded and implemented with Osquery with little hassle. Others might require extra steps, such as setting up additional dependencies and compiling the extension before use. <br /><br /><strong>    </strong><a href="https://github.com/trailofbits/osquery-extensions">https://github.com/trailofbits/osquery-extensions</a><strong> <br />    </strong><a href="https://github.com/polylogyx/osq-ext-bin">https://github.com/polylogyx/osq-ext-bin</a><br />    <br />    <br /><br /><strong>Example Challenge:</strong><br />Check all file hashes in the home directory for each user. One file will not show any hashes. Which file is that?<br /><span style="text-decoration:underline;">Query</span>: <strong>SELECT path,filename,md5 FROM file JOIN hash USING (path) WHERE path LIKE &quot;/home/%/%&quot; ; </strong><br /><br /><br /><strong>Example Challenge:</strong><br />There is a file that is categorized as malicious in one of the home directories. Query the Yara table to find this file. Use the sigfile which is saved in &#39;/var/osquery/yara/scanner.yara&#39;. Which file is it?<br /><span style="text-decoration:underline;">Query</span>:	<strong>SELECT * FROM yara WHERE path LIKE &#39;/home/%/%&#39; AND  sigfile=&#39;/var/osquery/yara/scanner.yara&#39;;</strong><br /><br /><strong>Example Challenge:</strong><br />Scan a specified file with a yara rule file.<br /><span style="text-decoration:underline;">Query</span>: <strong>SELECT path,matches,count,strings FROM yara WHERE path=&#39;/home/tryhackme/notsus&#39; AND sigfile=&#39;/var/osquery/yara/scanner.yara&#39;;</strong></div>
</body>
</html>
