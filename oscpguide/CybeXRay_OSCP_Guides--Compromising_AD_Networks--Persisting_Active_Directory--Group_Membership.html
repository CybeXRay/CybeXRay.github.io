<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Group Membership</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Group Membership</h1><br/><strong><h1>Persistence Through Group Membership</h1></strong><br /><br />If we don&#39;t want to tamper with SID histories, we can just add ourselves directly to AD groups for persistence. While SID history is a great persistence technique, credential rotation and cleanup can still remove our persistence. In certain cases, it may be better to perform persistence by targeting the AD groups themselves.<br /><br /><br />As discussed in task 1, the most privileged account, or group, is not always the best to use for persistence. Privileged groups are monitored more closely for changes than others. Any group that classifies as a protected group, such as Domain Admins or Enterprise Admins, receive additional security scrutiny. So if we want to persist through group membership, we may need to get creative regarding the groups we add our own accounts to for persistence:<br /><br />    <strong>• </strong>The IT Support group can be used to gain privileges such as force changing user passwords. Although, in most cases, we won&#39;t be able to reset the passwords of privileged users, having the ability to reset even low-privileged users can allow us to spread to workstations.<br />    <strong>• </strong>Groups that provide local administrator rights are often not monitored as closely as protected groups. With local administrator rights to the correct hosts through group membership of a network support group, we may have good persistence that can be used to compromise the domain again.<br />    <strong>• </strong>It is not always about direct privileges. Sometimes groups with indirect privileges, such as ownership over Group Policy Objects (GPOs), can be just as good for persistence.<br />    <br /><strong><h3><br />Nested Groups</h3></strong><br /><br />In most organisations, there are a significant amount of recursive groups. A recursive group is a group that is a member of another group. We can think of this as group nesting. Group nesting is used to create a more organised structure in AD. Take the IT Support group, for example. IT Support is very generic. So perhaps there are subgroups like Helpdesk, Access Card Managers, and Network Managers underneath this group. We can add all of these groups as members to the IT Support group, which gives all users in these subgroups the permissions and privileges associated with the IT Support group, but we can then assign more granular permissions and privileges for each of the subgroups.<br /><br />While group nesting helps to organise AD, it does reduce the visibility of effective access. Take our IT Support example again. If we query AD for membership of the IT Support group, it would respond with a count of three. However, this count is not really true since it is three groups. To get an idea for effective access, we would now have to enumerate those subgroups as well. But those subgroups can also have subgroups. So the question becomes: &quot;How many layers deep should we enumerate to get the real effective access number?&quot;<br /><br />This also becomes a monitoring problem. Let&#39;s say, for instance, we have an alert that fires off when a new member is added to the Domain Admins group. That is a good alert to have, but it won&#39;t fire off if a user is added to a subgroup within the Domain Admins group. This is a very common problem since AD is managed by the AD team, and alerting and monitoring are managed by the InfoSec team. All we need is a little bit of miscommunication, and the alert is no longer valid since subgroups are used.<br /><br />As an attacker, we can leverage this reduced visibility to perform persistence. Instead of targeting the privileged groups that would provide us with access to the environment, we focus our attention on the subgroups instead. Rather than adding ourselves to a privileged group that would raise an alert, we add ourselves to a subgroup that is not being monitored.<br /><br /><br /><strong><h3>Nesting Our Persistence<br /></h3></strong><br />Let&#39;s simulate this type of persistence. In order to allow other users also to perform the technique, make sure to prepend your username to all the groups that you create. In order to simulate the persistence, we will create some of our own groups. Let&#39;s start by creating a new base group that we will hide in the People-&gt;IT Organisational Unit (OU):<br /><br /><strong>Note:</strong> We need an Administrative Account for this purpose. However, we can do this from any host, even our own Windows machine which is not domain joined using runsas.<br /><br />[We are using AD-RSAT cmdlet]<br /><br /><strong>New-ADGroup -Path &quot;OU=IT,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot; -Name &quot;CybeX Net Group 1&quot; -SamAccountName &quot;cybex_nestgroup1&quot; -DisplayName &quot;CybeX Nest Group 1&quot; -GroupScope Global -GroupCategory Security</strong><br /><br /><img src="images/363-1.png" alt="images/363-1.png" /><br /><br />Let&#39;s now create another group in the People-&gt;Sales OU and add our previous group as a member:<br /><br /><strong>New-ADGroup -Path &quot;OU=SALES,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot; -Name &quot;CybeX Net Group 2&quot; -SamAccountName &quot;cybex_nestgroup2&quot; -DisplayName &quot;CybeX Nest Group 2&quot; -GroupScope Global -GroupCategory Security</strong><br /><br /><strong>Add-ADGroupMember -Identity &quot;cybex_nestgroup2&quot; -Members &quot;cybex_nestgroup1&quot;</strong><br /><br /><img src="images/363-2.png" alt="images/363-2.png" /><br /><br />We can do this a couple more times, every time adding the previous group as a member:<br /><br /><strong>New-ADGroup -Path &quot;OU=CONSULTING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot; -Name &quot;CybeX Net Group 3&quot; -SamAccountName &quot;cybex_nestgroup3&quot; -DisplayName &quot;CybeX Nest Group 3&quot; -GroupScope Global -GroupCategory Security<br /><br />Add-ADGroupMember -Identity &quot;cybex_nestgroup3&quot; -Members &quot;cybex_nestgroup2&quot;<br /><br />New-ADGroup -Path &quot;OU=MARKETING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot; -Name &quot;CybeX Net Group 4&quot; -SamAccountName &quot;cybex_nestgroup4&quot; -DisplayName &quot;CybeX Nest Group 4&quot; -GroupScope Global -GroupCategory Security<br /><br />Add-ADGroupMember -Identity &quot;cybex_nestgroup4&quot; -Members &quot;cybex_nestgroup3&quot;<br /><br />New-ADGroup -Path &quot;OU=IT,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot; -Name &quot;CybeX Net Group 5&quot; -SamAccountName &quot;cybex_nestgroup5&quot; -DisplayName &quot;CybeX Nest Group 5&quot; -GroupScope Global -GroupCategory Security<br /><br />Add-ADGroupMember -Identity &quot;cybex_nestgroup5&quot; -Members &quot;cybex_nestgroup4&quot;</strong><br /><br /><img src="images/363-3.png" alt="images/363-3.png" /><br /><br />With the last group, let&#39;s now add that group to the Domain Admins group:<br /><br /><strong>Add-ADGroupMember -Identity &quot;Domain Admins&quot; -Members &quot;cybex_nestgroup5&quot; </strong>       <br /><br /><img src="images/363-4.png" alt="images/363-4.png" /><br /><br />Lastly, let&#39;s add our low-privileged AD user to the first group we created:<br />        <br /><strong>Add-ADGroupMember -Identity &quot;cybex_nestgroup1&quot; -Members &quot;lorraine.gill&quot;</strong><br /><br /><img src="images/363-5.png" alt="images/363-5.png" /><br /><br /><br /><strong>Following is the Entire Operation:</strong><br /><br /><img src="images/363-6.png" alt="images/363-6.png" /><br /><br />Instantly, your low-privileged user should now have privileged access to THMDC. Let&#39;s verify this by using our SSH terminal on THMWRK1:<br /><br /><img src="images/363-7.png" alt="images/363-7.png" /><br /><br />Thus, we have DC access from our low-priviledged user.<br /><br />Let&#39;s also verify that even though we created multiple groups, the Domain Admins group only has one new member:<br />This is done using the Administrator Account.<br /><br /><strong>Get-ADGroupMember -Identity &quot;Domain Admins&quot;</strong><br /><br /><img src="images/363-8.png" alt="images/363-8.png" /><br /><br /><strong>Extra (Self Research)</strong><br /><strong><h3>Removing the User from the Privileged Group</h3></strong><br /><br /><strong>Remove-ADGroupMember -Identity cybex_nestgroup1 -Members &quot;lorraine.gill&quot;</strong><br /><br /><img src="images/363-9.png" alt="images/363-9.png" /><br /><br /><br /><strong><h3>Annoying More Than Just The Blue Team</h3></strong><br /><br />If this was a real organisation, we would not be creating new groups to nest. Instead, we would make use of the existing groups to perform nesting. However, this is something you would never do on a normal red team assessment and almost always dechain at this point since it breaks the organisation&#39;s AD structure, and if we sufficiently break it, they would not be able to recover. At this point, even if the blue team was able to kick us out, the organisation would more than likely still have to rebuild their entire AD structure from scratch, resulting in significant damages.<br /><br /></div>
</body>
</html>
