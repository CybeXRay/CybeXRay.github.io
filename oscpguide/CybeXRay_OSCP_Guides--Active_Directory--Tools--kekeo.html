<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>kekeo</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>kekeo</h1><br/><strong><h1> Kekeo</h1></strong><br /> <br /><em> It is used to request TGT &amp; forge TGS.<br /> </em><br /> Now that we have access to the password associated with the <strong>svcIIS</strong> account, we can perform a <strong>Kerberos delegation attack</strong>. We will use a combination of <strong>Kekeo</strong> and <strong>Mimikatz</strong>. You can use another window for Mimikatz, but make sure to <strong>exit</strong> out of <strong>Mimikatz</strong> after the<strong> token::elevate</strong> command, otherwise the tickets will be loaded in the wrong context later on. We will use <strong>Kekeo</strong> to <strong>generate</strong> our <strong>tickets</strong> and then use <strong>Mimikatz</strong> to <strong>load</strong> those <strong>tickets</strong> into <strong>memory</strong>. Let&#39;s start by generating the tickets:<br /> <br /><img src="images/346-1.png" alt="images/346-1.png" /><br /> <br /> We first need to <strong>generate</strong> a <strong>TGT</strong> that can be used to <strong>generate tickets</strong> for the <strong>HTTP</strong> and <strong>WSMAN</strong> services:<br /> <br /><img src="images/346-2.png" alt="images/346-2.png" /><br /> <br /><strong>tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@ </strong><br /> <br /> Parameters explained:<br /><br />    • user - The user who has the constrained delegation permissions.<br />    • domain - The domain that we are attacking since Kekeo can be used to forge tickets to abuse cross-forest trust.<br />    • password - The password associated with the svcIIS account.<br /><br />Now that we have the <strong>TGT</strong> for the <strong>account</strong> that <strong>can</strong> <strong>perform delegation</strong>, we can <strong>forge</strong> <strong>TGS</strong> <strong>requests</strong> for the <strong>account</strong> we want to <strong>impersonate</strong>. We need to perform this for both <strong>HTTP</strong> and <strong>WSMAN</strong> to allow us to create a <strong>PSSession</strong> on <strong>THMSERVER1</strong>:<br /><br />Lets Find a target account.<br /><br /><strong>Get-ADGroupMember -Identity &quot;Tier 1 Admins&quot;</strong><br /><br /><img src="images/346-3.png" alt="images/346-3.png" /><br /><br />I selected “<strong>t1_pamela.dunn</strong>” &amp; will forge TGS for this account for the <strong>HTTP</strong> service.<br /><br /><strong>tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_pamela.dunn /service:http/THMSERVER1.za.tryhackme.loc</strong><br /><br /><br /><img src="images/346-4.png" alt="images/346-4.png" /><br /> <br />  Parameters explained:<br /><br />    • tgt - We provide the TGT that we generated in the previous step.<br />    • user - The user we want to impersonate. Since<strong> t2_ accounts</strong> have <strong>administrative</strong> access over <strong>workstations</strong>, it is a safe assumption that <strong>t1_ accounts</strong> will have administrative access over <strong>servers</strong>, so choose a <strong>t1_ account</strong> that you would like to impersonate.<br />    • service - The services we want to impersonate using delegation. We first generate a TGS for the HTTP service. Then we can rerun the same command for the WSMAN service.<br /><br />Run the command again, this time for the <strong>WSMAN</strong> service. <br /><br /><strong>tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_pamela.dunn /service:wsman/THMSERVER1.za.tryhackme.loc</strong><br /><br /><img src="images/346-5.png" alt="images/346-5.png" /><br /><br />Now that we have the two TGS tickets, we can use Mimikatz to import them:<br />Mimikatz <br /><br /><img src="images/346-6.png" alt="images/346-6.png" /><br /><br />I started Mimikatz from the same kekeo directory as the files were stored there &amp; i could use direct file names in mimikatz.</div>
</body>
</html>
