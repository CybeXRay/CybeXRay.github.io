<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Microsoft Deployment Toolkit</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Microsoft Deployment Toolkit</h1><br/><p><strong><h2>Microsoft Deployment Toolkit</h2></strong></p><p></p><p>Large organisations need tools to deploy and manage the infrastructure of the estate. In massive organisations, you can&#39;t have your IT personnel using DVDs or even USB Flash drives running around installing software on every single machine. Luckily, Microsoft already provides the tools required to manage the estate. However, we can exploit misconfigurations in these tools to also breach AD.</p><p></p><p></p><p><strong>MDT and SCCM</strong></p><p></p><p><strong>Microsoft Deployment Toolkit (MDT)</strong> is a Microsoft service that assists with automating the deployment of Microsoft Operating Systems (OS). Large organisations use services such as <strong>MDT</strong> to help deploy new images in their estate more efficiently since the base images can be maintained and updated in a central location.</p><p></p><p>Usually, <strong>MDT</strong> is integrated with Microsoft&#39;s <strong>System Center Configuration Manager (SCCM)</strong>, which manages all updates for all Microsoft applications, services, and operating systems. <strong>MDT</strong> is used for new deployments. Essentially it allows the IT team to preconfigure and manage boot images. Hence, if they need to configure a new machine, they just need to plug in a network cable, and everything happens automatically. They can make various changes to the boot image, such as already installing default software like Office365 and the organisation&#39;s anti-virus of choice. It can also ensure that the new build is updated the first time the installation runs.</p><p></p><p><strong>SCCM</strong> can be seen as almost an expansion and the big brother to <strong>MDT</strong>. What happens to the software after it is installed? Well, SCCM does this type of patch management. It allows the IT team to review available updates to all software installed across the estate. The team can also test these patches in a sandbox environment to ensure they are stable before centrally deploying them to all domain-joined machines. It makes the life of the IT team significantly easier.</p><p></p><p>However, anything that provides central management of infrastructure such as MDT and SCCM can also be targetted by attackers in an attempt to take over large portions of critical functions in the estate. Although MDT can be configured in various ways, for this task, we will focus exclusively on a configuration called <strong>Preboot Execution Environment (PXE)</strong> boot.</p><p></p><p><strong>PXE Boot</strong></p><p></p><p>Large organisations use PXE boot to allow new devices that are connected to the network to load and install the OS directly over a network connection. MDT can be used to create, manage, and host PXE boot images. PXE boot is usually integrated with DHCP, which means that if DHCP assigns an IP lease, the host is allowed to request the PXE boot image and start the network OS installation process. The communication flow is shown in the diagram below:</p><p></p><p><img src="images/326-1.png" alt="images/326-1.png" /></p><p></p><p>Once the process is performed, the client will use a TFTP connection to download the PXE boot image. We can exploit the PXE boot image for two different purposes:</p><p></p><p>    ▪ Inject a privilege escalation vector, such as a Local Administrator account, to gain Administrative access to the OS once the PXE boot has been completed.</p><p>    ▪ Perform password scraping attacks to recover AD credentials used during the install.</p><p></p><p>In this task, we will focus on the latter. We will attempt to recover the deployment service account associated with the MDT service during installation for this password scraping attack. Furthermore, there is also the possibility of retrieving other AD accounts used for the unattended installation of applications and services.</p><p></p><p><strong>PXE Boot Image Retrieval</strong></p><p></p><p>Since DHCP is a bit finicky, we will bypass the initial steps of this attack. We will skip the part where we attempt to request an IP and the PXE boot preconfigure details from DHCP. We will perform the rest of the attack from this step in the process manually.</p><p></p><p><strong>The first piece</strong> of information regarding the PXE Boot preconfigure you would have received via DHCP is the IP of the MDT server. In our case, you can recover that information from the TryHackMe network diagram.</p><p></p><p><strong>The second piece</strong> of information you would have received was the names of the BCD files. These files store the information relevant to PXE Boots for the different types of architecture. To retrieve this information, you will need to connect to this website: <strong><a href="http://pxeboot.za.tryhackme.com">http://pxeboot.za.tryhackme.com</a></strong> . It will list various BCD files:</p><p></p><p><img src="images/326-2.png" alt="images/326-2.png" /></p><p></p><p>We check the BCD files:</p><p><img src="images/326-3.png" alt="images/326-3.png" /></p><p></p><p>Usually, you would use TFTP to request each of these BCD files and enumerate the configuration for all of them. However, in the interest of time, we will focus on the BCD file of the x64 architecture. Copy and store the full name of this file. For the rest of this exercise, we will be using this name placeholder <strong>x64{7B...B3}.bcd</strong> (As per THM Example) since the files and their names are regenerated by MDT every day. Each time you see this placeholder, remember to replace it with your specific BCD filename.</p><p></p><p>In Our Case:<strong> x64{744504C8-2087-4DA3-9A2E-BD83F23DC839}.bcd</strong></p><p></p><p>With this initial information now recovered from DHCP (wink wink), we can enumerate and retrieve the PXE Boot image. We will be using our SSH connection on THMJMP1 for the next couple of steps, so please authenticate to this SSH session using the following:</p><p></p><p><strong>ssh thm@THMJMP1.za.tryhackme.com</strong></p><p>and the password of <strong>Password1@</strong></p><p></p><p>To ensure that all users of the network can use SSH, start by creating a folder with your username and copying the powerpxe repo into this folder:</p><p><img src="images/326-4.png" alt="images/326-4.png" /></p><p></p><p>The first step we need to perform is using <strong>TFTP</strong> and downloading our<strong> BCD file</strong> to read the configuration of the <strong>MDT server</strong>. <strong>TFTP</strong> is a bit trickier than FTP since we can&#39;t list files. Instead, we send a file request, and the server will connect back to us via <strong>UDP</strong> to transfer the file. Hence, we need to be <strong>accurate</strong> when specifying <strong>files</strong> and <strong>file paths</strong>. The <strong>BCD</strong> files are always located in the <strong>/Tmp/</strong> <strong>directory</strong> on the <strong>MDT</strong> <strong>server</strong>. We can initiate the TFTP transfer using the following command in our SSH session:</p><p></p><p><img src="images/326-5.png" alt="images/326-5.png" /></p><p></p><p>In Our case:</p><p><strong>tftp -i 10.200.27.202 GET &quot;\Tmp\x64{744504C8-2087-4DA3-9A2E-BD83F23DC839}.bcd&quot; conf.bcd</strong></p><p></p><p><img src="images/326-6.png" alt="images/326-6.png" /></p><p></p><p>You will have to lookup THMMDT IP with <strong>nslookup thmmdt.za.tryhackme.com</strong>. With the BCD file now recovered, we will be using <strong>powerpxe</strong> to read its contents. Powerpxe is a PowerShell script that automatically performs this type of attack but usually with varying results, so it is better to perform a manual approach. We will use the <strong>Get-WimFile</strong> function of <strong>powerpxe</strong> to recover the <strong>locations</strong> of the <strong>PXE Boot images</strong> from the BCD file:</p><p></p><p><img src="images/326-7.png" alt="images/326-7.png" /></p><p></p><p>In Our case:</p><p><img src="images/326-8.png" alt="images/326-8.png" /></p><p></p><p>WIM files are bootable images in the Windows Imaging Format (WIM). Now that we have the location of the PXE Boot image, we can again use TFTP to download this image:</p><p></p><p><img src="images/326-9.png" alt="images/326-9.png" /></p><p></p><p>This download will take a while since you are downloading a fully bootable and configured Windows image. Maybe stretch your legs and grab a glass of water while you wait.</p><p></p><p>In Our Case:</p><p><strong>tftp -i 10.200.27.202 GET &quot;\Boot\x64\Images\LiteTouchPE_x64.wim&quot; pxeboot.wim</strong></p><p></p><p><img src="images/326-10.png" alt="images/326-10.png" /></p><p></p><p><strong>Recovering Credentials from a PXE Boot Image</strong></p><p></p><p>Now that we have recovered the PXE Boot image, we can exfiltrate stored credentials. It should be noted that there are various attacks that we could stage. We could inject a local administrator user, so we have admin access as soon as the image boots, we could install the image to have a domain-joined machine. If you are interested in learning more about these attacks, you can read this article (Bookmarked as AD compromise LAPS &amp; PXE Boot). This exercise will focus on a simple attack of just attempting to exfiltrate credentials.</p><p></p><p>Again we will use powerpxe to recover the credentials, but you could also do this step <strong>manually</strong> by <strong>extracting the image</strong> and <strong>looking</strong> for the <strong>bootstrap.ini</strong> file, where these types of <strong>credentials</strong> are often stored. To use powerpxe to recover the credentials from the bootstrap file, run the following command:</p><p></p><p><img src="images/326-11.png" alt="images/326-11.png" /></p><p></p><p>In Our case:</p><p><img src="images/326-12.png" alt="images/326-12.png" /></p><p>As you can see, powerpxe was able to recover the AD credentials. We now have another set of AD credentials that we can use!</p><p></p><p></p></div>
</body>
</html>
