<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>overpass-3 hosting</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>overpass-3 hosting</h1><br/><p><strong><h1>THM: Overpass 3 - Hosting</h1></strong></p><p></p><p></p><p><strong><h2>Enumeration</h2></strong></p><p></p><p></p><p><strong><span style="text-decoration:underline;">Rustscan &amp; Nmap</span></strong></p><p></p><p><strong>ports=$(rustscan -g -a 10.10.201.214 --ulimit 5000 | cut -d &quot;[&quot; -f 2 | cut -d &quot;]&quot; -f 1);echo $ports</strong></p><p><strong>nmap -A -p$ports 10.10.201.214</strong></p><p><img src="images/40-1.png" alt="images/40-1.png" /></p><p></p><p><strong><span style="text-decoration:underline;">Dirsearch</span></strong></p><p></p><p><strong>dirsearch -u http://10.10.201.214</strong></p><p><img src="images/40-2.png" alt="images/40-2.png" /></p><p></p><p><strong>Website Enumeration</strong></p><p></p><p><img src="images/40-3.png" alt="images/40-3.png" /></p><p></p><p>I opened the found<strong> /backups</strong> directory and found a zip file. I downloaded it locally and analyze its contents.</p><p></p><p><img src="images/40-4.png" alt="images/40-4.png" /></p><p></p><p>I found a Customer Details Excel file encrypted with gpg. There is also a key file.</p><p>Lets use this key file to open the <strong>gpg</strong> file.</p><p></p><p>KEY File: <strong>/home/cybex/lab/thm/CTFs/overpass-3/priv.key</strong></p><p>GPG File: <strong>/home/cybex/lab/thm/CTFs/overpass-3/CustomerDetails.xlsx.gpg</strong></p><p></p><p><strong>gpg --import priv.key</strong></p><p><strong>gpg CustomerDetails.xlsx.gpg</strong></p><p></p><p><img src="images/40-5.png" alt="images/40-5.png" /></p><p></p><p>We can see <strong>CustomerDetails.xlsx</strong> is <strong>extracted</strong> in the same folder. (As <strong>--decrypt</strong> option wasn&#39;t used)</p><p>We view the excel file.</p><p></p><p><img src="images/40-6.png" alt="images/40-6.png" /></p><p></p><p>We found quite a few credentials.</p><p>Lets try to use these in <strong>FTP</strong></p><p></p><p><strong>FTP</strong></p><p><img src="images/40-7.png" alt="images/40-7.png" /></p><p></p><p>I was able to login with the following credentials.</p><p></p><p><strong>FTP Credentials:</strong></p><p>Username:	<strong>paradox</strong></p><p>Password:	<strong>ShibesAreGreat123</strong></p><p></p><p>The <strong>backups</strong> directory is the same which was accessible through the web.</p><p></p><p><strong>Note:</strong> I tried the other 2 credentials, they are not working for the FTP server. Maybe it will work for some other service.  (May be SSH)</p><p></p><p><strong>SSH</strong></p><p>I will try to use the found credentials for SSH.</p><p></p><p><img src="images/40-8.png" alt="images/40-8.png" /></p><p></p><p>As we can see none of the credentials work for <strong>SSH Login</strong> with <strong>password</strong>. But we see an important thing.</p><p>The Paradox account doen&#39;t allow password authentication. But it allows <strong>publickey</strong>.</p><p>We will check if later if we find any system access.</p><p></p><p></p><p><strong><h2>Foothold</h2></strong></p><p></p><p>We know that home directory of FTP is writable and it is accessible by the web server. We can upload a php-reverse-shell and open it the page in the web browser to get initial foothold of the machine.</p><p></p><p><strong>cp /usr/share/webshells/php/php-reverse-shell.php .</strong></p><p></p><p>Make the necessary changes. (PORT &amp; IP)</p><p></p><p><strong>FTP</strong> the file in the backups directory &amp; start netcat listener.</p><p><img src="images/40-9.png" alt="images/40-9.png" /></p><p></p><p>Now, lets open the page in the browser.</p><p><strong>Note:</strong> As we are putting the php file in the home directory. We will not see it when the webpage is loaded.</p><p><img src="images/40-10.png" alt="images/40-10.png" /></p><p></p><p>The way the php file can be triggered is by entering the following in the URL:</p><p><strong>http://10.10.108.191/php-reverse-shell.php</strong></p><p></p><p><strong>Or</strong></p><p></p><p>We create a directory(say <strong>rshell</strong>) in the base folder of FTP &amp; put our php file in it and then access the folder from the website as shown below</p><p></p><p><img src="images/40-11.png" alt="images/40-11.png" /></p><p></p><p>And open in the browser as follows.</p><p><img src="images/40-12.png" alt="images/40-12.png" /></p><p></p><p></p><p>Any way is used, we get a connection once the file is triggered.</p><p><img src="images/40-13.png" alt="images/40-13.png" /></p><p></p><p><strong>Web Flag</strong></p><p>THM Hint: Flag belongs to apache</p><p>I used /etc/passwd to list all users and went to apache user&#39;s home. I found the <strong>web.flag</strong></p><p></p><p><img src="images/40-14.png" alt="images/40-14.png" /></p><p></p><p><strong><h2>Lateral Movement</h2></strong></p><p></p><p>Remember we had a SSH password login denied. Lets try to use the paradox user&#39;s credentials to switch the user/</p><p><img src="images/40-15.png" alt="images/40-15.png" /></p><p></p><p>Indeed we are able to login. Now, lets create a <strong>authorized_key</strong> file with my personal <strong>public id</strong></p><p>I added my <strong>id_rsa.pub</strong> to the <strong>authorized_keys</strong> of the <strong>paradox</strong> user</p><p><img src="images/40-16.png" alt="images/40-16.png" /></p><p></p><p></p><p>Now we can login with the system through <strong>SSH</strong></p><p><img src="images/40-17.png" alt="images/40-17.png" /></p><p></p><p><strong>Linpeas</strong> Report Snap</p><p></p><p><strong>[+] NFS exports?</strong></p><p><strong>[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation/nfs-no_root_squash-misconfiguration-pe</strong></p><p><strong>/home/james *(rw,fsid=0,sync,no_root_squash,insecure)</strong></p><p></p><p>Running <strong>linpeas.sh</strong> on the target will reveal an interesting NFS share (<strong>/home/james</strong>), with the <strong>no_root_squash</strong> option set. We’ll come back to this later for the privilege escalation, but at this stage, we only care about the NFS share. </p><p></p><p>Lets check for nfs</p><p></p><p><strong>cat /etc/exports</strong></p><p><strong>rpcinfo -p | grep nfs</strong></p><p><img src="images/40-18.png" alt="images/40-18.png" /></p><p></p><p>We find that NFS is running on port 2049. Lets check with <strong>nmap</strong></p><p><img src="images/40-19.png" alt="images/40-19.png" /></p><p></p><p></p><p>As we can see, the nfs service is <strong>filtered</strong> which means its blocked by <strong>firewall</strong> for remote access.</p><p></p><p><strong>Solution</strong></p><p>We can create a SSH Tunnel to connect my machine localhost to the NFS port in the remote machine.</p><p></p><p><strong>ssh -L 2049:localhost:2049 paradox@10.10.108.191</strong></p><p></p><p><img src="images/40-20.png" alt="images/40-20.png" /></p><p></p><p>Lets check Nmap in out Localhost at <strong>2049</strong> port.</p><p><img src="images/40-21.png" alt="images/40-21.png" /></p><p></p><p>The tunnel was successful.</p><p>It showing now as open in our local system.</p><p></p><p>We can connect to the nfs share using the following.</p><p></p><p><strong>mount -t nfs 127.0.0.1: nfs_share</strong></p><p><img src="images/40-22.png" alt="images/40-22.png" /></p><p></p><p></p><p><strong>Important Note:</strong></p><p>We created SSH tunnel to default nfs port: <strong>2049</strong></p><p></p><p><strong>ssh -L 2049:localhost:2049 paradox@10.10.108.191</strong></p><p><strong>mount -t nfs 127.0.0.1: nfs_share</strong></p><p></p><p>That is reason mount command connected automatically.</p><p>Note: If we tunnel to a custom port say <strong>9999</strong></p><p></p><p><strong>ssh -L 9999:localhost:2049 paradox@10.10.108.191</strong></p><p><strong>mount -t nfs -o port=9999 127.0.0.1: nfs_share</strong></p><p></p><p>Then we have to use <strong>-o option</strong> in mount with <strong>key port=9999</strong> for connection.</p><p></p><p></p><p><strong><h2>Privilege Escalation</h2></strong></p><p></p><p><strong>Linpeas</strong> Report Snap</p><p></p><p><strong>[+] NFS exports?</strong></p><p><strong>[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation/nfs-no_root_squash-misconfiguration-pe</strong></p><p><strong>/home/james *(rw,fsid=0,sync,no_root_squash,insecure)</strong></p><p></p><p>As <strong>no_root_squash</strong> is enabled. It can be used for privilege escalation.</p><p></p><p>There are 2 approaches here: (Check <strong>CybeXRay Guides → Privilege Escalation → Linux ----→ @Content :: Using NFS</strong>)</p><p>We will use <strong>Method-2:</strong> which tampers a local bash executible.</p><p></p><p><strong>Target Machine:</strong></p><p>Copy the local <strong>bash</strong> executible from the target machine to the NFS share.</p><p>Eg.</p><p><img src="images/40-23.png" alt="images/40-23.png" /></p><p></p><p></p><p><strong>Attacker Machine:</strong></p><p>Connect the NFS share as root. Then check the bash executible permission.</p><p>Next change it to be owned by root and have SUID bit set.</p><p></p><p><strong>chown root:root	bash</strong></p><p><strong>chmod u+s bash</strong></p><p></p><p>Eg.</p><p><img src="images/40-24.png" alt="images/40-24.png" /></p><p></p><p><strong>Target Machine:</strong></p><p>Run the bash program with -p option to preserver the permissiom</p><p><strong>./bash -p</strong></p><p></p><p><img src="images/40-25.png" alt="images/40-25.png" /></p><p></p><p><strong>Note:</strong> It will give <strong>euid root</strong> access.</p><p></p><p>We can collect the flags and complete the THM room.</p><p></p><p><strong><h2>Extra</h2></strong></p><p></p><p><strong>Method-1</strong> will give full root access. (It uses the <strong>StrongRoot</strong> program instead of the local bash)</p><p>(Check <strong>CybeXRay Guides → Privilege Escalation → Linux ----→ @Content :: Using NFS</strong>)</p><p></p><p><strong>Note:</strong> If Full Root Access is required check: (<strong>CybeXRay Guides → Wiki Miscellaneous → StrongRoot</strong>)</p><p></p><p>Thanks!!</p><p></p></div>
</body>
</html>
