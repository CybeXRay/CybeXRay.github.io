<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>watcher</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>watcher</h1><br/><strong><h1>THM: Watcher</h1></strong><br /><br /><strong><h2>Enumeration</h2></strong><br /><br /><img src="images/42-1.png" alt="images/42-1.png" /><br /><br /><strong>Dirsearch</strong><br /><img src="images/42-2.png" alt="images/42-2.png" /><br /><br /><strong>Website Enumeration</strong><br /><br /><img src="images/42-3.png" alt="images/42-3.png" /><br /><br />Its a <strong>PHP</strong> web server running <strong>Jekyll v4.1.1</strong> for static page generation<br />The Login link found in Dirsearch is not working.<br />However, we found some answers in <strong>/robots.txt</strong><br /><br /><img src="images/42-4.png" alt="images/42-4.png" /><br /><br />We were able to get to <strong>/flag_1.txt</strong> but the /<strong>secret_file....</strong> is forbidden. We will come back to it later.<br /><br /><strong>LFI Enumeration</strong><br />THM Hint: LFI<br />I noticed the URL when i opned any item.<br /><br /><strong>http://10.10.70.174/post.php?post=striped.php</strong> <br /><img src="images/42-5.png" alt="images/42-5.png" /><br /><br />It could be a potential LFI vector. Lets use <strong>LFISuite</strong> to scan it.<br /><br /><img src="images/42-6.png" alt="images/42-6.png" /><br /><br />LFISuite indeed suggests that the the URL is vulnerable. Lets try to open those 2 files manually.<br />Indeed it was vulnerable.<br /><br /><img src="images/42-7.png" alt="images/42-7.png" /><br /><br />Users Found:<br /><br /><strong>will<br />ftpuser<br />mat<br />toby</strong><br /><br />Now, remember we had a <strong>/secret_filsecret_file_do_not_read.txte_do_not_read.txt</strong> file which we had no permission to open in the web server. However, with LFI active now lets try to read it.<br /><br /><strong>Note:</strong> The /secret... confirms that the file will be in the same directory as the web server. <br />So I will use this URL: <strong>http://10.10.70.174/post.php?post=secret_file_do_not_read.txt</strong><br /><br /><img src="images/42-8.png" alt="images/42-8.png" /><br /><br />It opened and indeed, we found FTP credentials.<br /><br /><strong>FTP Credentials Found</strong><br />Username: 	<strong>ftpuser</strong><br />Password:	<strong>givemefiles777</strong><br /><br /><br /><strong>FTP Enumeration</strong><br /><br /><img src="images/42-9.png" alt="images/42-9.png" /><br /><br />I was able to login successfully with the FTP credentials. I got the <strong>flag_2.txt</strong>.<br />I noticed that the directory files is <strong>writable</strong> by me(ftpuser) , so i created a file <strong>hacked.txt</strong> with some <strong>contents</strong> to check if i can access it from browser.<br /><br />The default storage location for FTP is FTP user&#39;s home directory. However, it uses another directory named <strong>ftp</strong>.<br />Eg. <strong>/home/$USER/ftp</strong> <br /><br />How i found this ?<br />I searched for configuration files for <strong>vsftpd 3.0.3</strong> in google and found the configurations are stored in <strong>/etc/vsftpd.conf</strong><br />As we have LFI I open the file.<br /><br /><strong>http://10.10.70.174/post.php?post=/etc/vsftpd.conf</strong><br /><img src="images/42-10.png" alt="images/42-10.png" /><br /><br /><br />We can see the highlighted local root section. I open the same in our case.<br /><br /><strong>/home/ftpuser/ftp/flag_2.txt</strong><br />or<br /><strong>/home/ftpuser/ftp/files/hacked.txt</strong><br /><br /><strong>RCE</strong><br />We can run any of these in the LFI to confirm that we found the FTP&#39;s data directory. Now we can put PHP-Reverse-Shell through FTP inside the files folder and can run it using LFI.<br /><br /><img src="images/42-11.png" alt="images/42-11.png" /><br /><img src="images/42-12.png" alt="images/42-12.png" /><br /><br />The above confirms that we can use RCE. Lets create a PHP Reverse Shell and upload it with <strong>FTP</strong>.<br />We use the following.<br /><strong>/usr/share/webshells/php/php-reverse-shell.php</strong> form pentestmonkey<br /><br />I make the necessary IP and Port changes in the php file and uploaded it inside the files directory.<br /><br /><img src="images/42-13.png" alt="images/42-13.png" /><br /><br /><strong><h2>Foothold</h2></strong><br /><br />Lets start a netcat listener and open the file in the browser using LFI.<br /><br />Open this URL: <strong>http://10.10.70.174/post.php?post=/home/ftpuser/ftp/files/php-reverse-shell.php</strong> <br /><br /><img src="images/42-14.png" alt="images/42-14.png" /><br /><br />We have initial access of the system.<br /><br />Next, I searched for the next flag and found it inside a directory named <strong>more_secrets_a9f10a</strong> in the root directory of web server.<br /><br /><img src="images/42-15.png" alt="images/42-15.png" /><br /><br />No Privilege Escalation vectors are seen in this user.<br />Next, Lets try to do lateral movement to other users.<br /><br />Users Found:<br /><br /><strong>will<br /></strong>ftpuser<strong><br />mat<br />toby</strong><br /><br /><strong><h2>Lateral Movement</h2></strong><br /><br />I stabilized the shell with python. [<strong>Note:</strong> For this machine, i used <strong>/usr/bin/python3</strong>]<br />Check : (<strong>CybeXRay Guides ----&gt;	Shells ----&gt;	Shell Beautify</strong>)<br /><br /><img src="images/42-16.png" alt="images/42-16.png" /><br /><br />Then upon checking for sudo privileges, I found we can run any program as user <strong>toby</strong>.<br />I run <strong>sudo -u toby /bin/bash</strong> to switch to user <strong>toby</strong><br /><br />We got <strong>flag_4.txt</strong> and a <strong>note</strong> to continue our lateral movement.<br /><br /><br /><img src="images/42-17.png" alt="images/42-17.png" /><br /><br />I read the note.txt and found that there is crontab entry. I checked it &amp; indeed a <strong>script</strong> which is <strong>writable</strong> by <strong>me(toby)</strong> gets run every minute as the user <strong>mat</strong><br /><br /><strong>My Solution : (Without using a reverse shell connection)</strong><br /><br />I open the <strong>cow.sh</strong> and changed its content to the following.<br /><br /><em>#!/bin/bash<br />cp /home/mat/cow.jpg /tmp/cow.jpg<br /><br />if [ ! -d &quot;/home/mat/.ssh/&quot; ]; then<br />        mkdir /home/mat/.ssh<br />        echo &#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCybu4M+3Dw0hOMC5zXhzbTSGZMJ2vVSFTreZVVc1OQyw1eoF4+Yc8nsUOupsWVHRrPIDQQMfsIyPiPHrzxqOcxBTxIOcEvA9/OZ7AG53OGf3RwvAGxgzBSpnpGdtRUEzRJq9aMkxDXz22oymAVghK8xM2IMqI5FZQ7CJjKWxqsX7hXq2QJSO0JfhD/ZWjTi4xzEnAcrUeyxe3ueoLt2vJcS9yKPin8f0wxUAwU2Nm1gtL98SZFnjfxfRi0wbAqKBaEbuxZMFwjwRz/+7Dc8bv4gBKy4LiEtOWIzib6dX7lzFlKTcmo+cXI9OltfZ2FGGS/6AtaUFq5ies1/QfsvcxWGO+Pq5DiO6N4fWrIiSWB5xpsL/lLxmHnx5DH9j2RncTkSRru+goeNLLzhdT8YuvjHQyj6YR/ngHLjZX98W+h4DAnx1fGDG1JNsOd1n6IEc4g42vzAzL5tw7yzdNNERgZts/GVF1K73SHeBKAARuye32yskbOgcK0oDv9M4rjBNs= root@matrix&#39; &gt; /home/mat/.ssh/authorized_keys<br />        chmod 600 /home/mat/.ssh/authorized_keys<br />fi</em><br /><br />I copied my kali machine&#39;s <strong>id_rsa.pub</strong> file to a newly created <strong>.ssh </strong>directory into the file <strong>authrorized_keys</strong> using the above script.<br /><br /><img src="images/42-18.png" alt="images/42-18.png" /><br /><br />Then we wait 1 min and try to connec to mat with SSH. If everything works properly, we should be able to SSH into the machine using my own paraphrase.<br /><br />And indeed SSH was successful.<br /><img src="images/42-19.png" alt="images/42-19.png" /><br /><br />we get the flag_5 in the home directory of mat. Plus there is note to further help in our lateral movement.<br /><br /><img src="images/42-20.png" alt="images/42-20.png" /><br /><br />As we can see as per the notes, the program <strong>will_script.py</strong> can be run by <strong>me(mat)</strong> as user <strong>will</strong>.<br />We go to scripts folder and check the program.<br /><br /><img src="images/42-21.png" alt="images/42-21.png" /><br /><br />The program runs 3 system commands as user <strong>will</strong> &amp; also the program takes input from <strong>sys.argv[1] </strong>from command line.<br />Which represents the <strong>*</strong> in the <strong>sudo</strong><br /><strong>(will) NOPASSWD: /usr/bin/python3 /home/mat/scripts/will_script.py *</strong><br /><br />I run the program as: <strong>sudo -u will /usr/bin/python3 /home/mat/scripts/will_script.py 2</strong><br />To show the <strong>id</strong>, or we can use <strong>1 for ls -lah</strong> or <strong>3 for cat /etc/passwd</strong><br /><br /><img src="images/42-22.png" alt="images/42-22.png" /><br /><br />However, one intresting point is that, it uses a function called <strong>get_command</strong> to get parse the user input. <br />The <strong>get_command</strong> is loaded from a custom module <strong>cmd.py</strong><br /><strong>cmd.py</strong> is writable by <strong>me(mat)</strong><br /><br />I <strong>modify</strong> the <strong>cmd.py</strong> to the following:<br />(I added my own imports and command)<br /><br /><em>import os<br />import sys<br />def get_command(num):<br />        os.system(&quot;/bin/bash&quot;)<br />        if(num == &quot;1&quot;):<br />                return &quot;ls -lah&quot;<br />        if(num == &quot;2&quot;):<br />                return &quot;id&quot;<br />        if(num == &quot;3&quot;):<br />                return &quot;cat /etc/passwd&quot;</em><br /><br /><br /><img src="images/42-23.png" alt="images/42-23.png" /><br /><br />As we can see, we have become user <strong>will</strong> now.<br /><br /><strong><h2>Privilege Escalation</h2></strong><br /><br />Now, starts the path to root.<br /><br /><img src="images/42-24.png" alt="images/42-24.png" /><br /><br />Upon enumerating the user, I found that <strong>will</strong> belongs to a group named <strong>adm</strong><br />I then started to find all files having group <strong>adm</strong><br /><br /><strong>find / -type f -group adm 2&gt;/dev/null</strong><br /><br />We found a file at an  intresting location <strong>/opt/backups</strong><br />The file name is <strong>key.b64</strong><br /><br />The extention suggests its base64. Lets view it.<br /><br /><img src="images/42-25.png" alt="images/42-25.png" /><br /><br />It Looks like base64 encoded so I decoded it and found an id_rsa key. May be its the ssh id_rsa of root.<br /><strong>cat key.b64 | base64 -d</strong><br /><img src="images/42-26.png" alt="images/42-26.png" /><br /><br />I copied the key to a local file <strong>watcher_id_rsa</strong> and changed its permission to <strong>600</strong>. I tried to SHH into the machine as root using the <strong>watcher_id_rsa</strong> file. I was successful.<br /><br /><img src="images/42-27.png" alt="images/42-27.png" /><br /><br />Thanks!!</div>
</body>
</html>
