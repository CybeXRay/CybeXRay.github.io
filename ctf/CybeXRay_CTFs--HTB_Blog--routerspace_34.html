<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>routerspace</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>routerspace</h1><br/><p><strong><h1>HTB: RouterSpace</h1></strong></p><p></p><p><strong><h2>Enumeration</h2></strong></p><p></p><p><strong>Rustscan</strong></p><p><img src="images/34-1.png" alt="images/34-1.png" /></p><p></p><p><strong>Website</strong></p><p><img src="images/34-2.png" alt="images/34-2.png" /></p><p></p><p>We download the <strong>routerspace.apk</strong> file</p><p>From here we can do 2 things</p><p>1) Reverse Engineer the apk file</p><p>2) Open the APK file using <strong>Anbox</strong>(Linux) or <strong>android studio</strong> or <strong>genymotion</strong></p><p></p><p></p><p><strong><span style="text-decoration:underline;">Anbox &amp; ADB</span></strong></p><p></p><p>We need VPN access over the anroid instance. So its better we go in <strong>Anbox</strong> and install it in Kali Linux</p><p></p><p><strong>How to install</strong></p><p><strong>https://chennylmf.medium.com/how-to-install-anbox-on-kali-linux-2022-1-40d40cb77d9d</strong></p><p></p><p>1) apt install anbox</p><p></p><p>2) Download latest image from <strong>https://build.anbox.io/android-images/</strong></p><p><img src="images/34-3.png" alt="images/34-3.png" /></p><p></p><p>3) <strong>Important</strong> - Rename the file <strong>android_amd64.img</strong> to <strong>android.img</strong> and place it inside <strong>/var/lib/anbox </strong>directory</p><p></p><p>4) Start the service (<strong>As Root</strong>)</p><p><strong>	service anbox-container-manager start</strong></p><p></p><p>5) Open <strong>Anbox</strong> from Desktop Applications or Preferably use command line is a <strong>NON-Root</strong> user.</p><p>	</p><p>	<strong>anbox launch --package=org.anbox.appmgr --component=org.anbox.appmgr.AppViewActivity</strong></p><p>	</p><p><img src="images/34-4.png" alt="images/34-4.png" /></p><p></p><p><img src="images/34-5.png" alt="images/34-5.png" /></p><p></p><p></p><p><strong>Stopping Anbox</strong></p><p></p><p>1) Close the GUI Application</p><p></p><p>2) service anbox-container-manager stop</p><p></p><p></p><p></p><p><strong>Installing Applications &amp; Anbox using ADB</strong></p><p></p><p>1) <strong>Android Debug Bridge</strong> [Always to be used by <strong>NON-Root</strong> User (Read Description Below at heading <strong>Research</strong>)]</p><p>	 apt install adb</p><p></p><p>2) adb install app_name.apk</p><p>	<img src="images/34-6.png" alt="images/34-6.png" /></p><p>	</p><p><strong>To uninstall Application</strong></p><p>Go to settings ----→ Apps -----→ Uninstall </p><p>Same as a phone</p><p></p><p><strong>To uninstall Anbox</strong></p><p>1) Delete the image file from /var/lib/anbox</p><p></p><p>2) apt remove anbox</p><p></p><p></p><p></p><p>After Configuring the Anbox, we installed Routerspace.apk and run it.</p><p></p><p><img src="images/34-7.png" alt="images/34-7.png" /></p><p></p><p>We opned the RouterSpace icon and click on next.</p><p></p><p><img src="images/34-8.png" alt="images/34-8.png" /></p><p></p><p>Click on Check Status to get the result from server.</p><p></p><p><img src="images/34-9.png" alt="images/34-9.png" /></p><p></p><p>We got an error “<strong>Unable to connect to the server !</strong>”</p><p></p><p><strong><h2>Research</h2></strong></p><p></p><p>I installed Anbox without using snap(Shown above). Most important part is to run <strong>adb</strong> and <strong>anbox</strong> both as <strong>Non-Root</strong> user and only start the <strong>anbox-container-manager</strong> as <strong>root</strong></p><p></p><p><strong><h3>Problem(Error Explanation)</h3></strong></p><p></p><p>I opned the WebView app of anbox (Its a browser). I could connect to <strong>www.google.com</strong> as well as i could connect to <strong>http://10.10.11.148</strong></p><p>From here I confirm that <strong>internet</strong> connection and <strong>vpn</strong> connection are both working fine insde the <strong>container environment</strong>.</p><p></p><p>After certain brainstorming I found that the RouerSpace.apk app must be connecting to <strong>http://routerspace.htb</strong> (This was confirmed later by Burpsuite. [Check Solution Part])</p><p></p><p>The reason the app might not be able to connect is there is no entry about the host in the <strong>/etc/hosts</strong> file of the <strong>anbox container</strong></p><p></p><p></p><p><strong><h3>Solution</h3></strong></p><p></p><p><strong><span style="text-decoration:underline;">Method - 1</span></strong><span style="text-decoration:underline;"> </span><strong><span style="text-decoration:underline;">(Needs Rooted Android Image)</span></strong></p><p></p><p><strong>Note:</strong> Even if you do not have Rooted Android Image, just reading this method once will give you basic understanding of use of adb to mange the anbox container. Also you will get the idea of how to procure the images.</p><p></p><p>I figure if i add the following to /etc/hosts file of the anbox container. The app could connect to the required website (http://routerspace.htb).</p><p><strong>10.10.11.148		http://routerspace.htb		</strong>	</p><p></p><p>First check if device is accessible to adb. Start <strong>Anbox Application Manager </strong>and use the following command.</p><p><strong>adb devices -l</strong></p><p><img src="images/34-10.png" alt="images/34-10.png" /></p><p>Our device is showing here, means we can use <strong>adb</strong> to interact with it.</p><p></p><p></p><p><strong>Caution:</strong> I used <strong>adb</strong> with root and it caused a lot of issue. The program can&#39;t run as root so even if we connect to the container as root we could only be  non privileged user. </p><p></p><p>I then ran adb as non privileged user. To get shell use the following.</p><p></p><p><img src="images/34-11.png" alt="images/34-11.png" /></p><p>Any try to escalate privilege to <strong>root</strong> is not possible from within the shell.</p><p></p><p>Then i found the following adb command. (This is the place where if adb is run as root will not work)</p><p><strong>adb root</strong></p><p><img src="images/34-12.png" alt="images/34-12.png" /></p><p></p><p>Now, I try to edit the <strong>/etc/hosts</strong> file. location is <strong>/system/etc/hosts</strong></p><p><img src="images/34-13.png" alt="images/34-13.png" /></p><p></p><p>It tells an user called u1_root has write access. I tried to write to the file. (<strong>Note: </strong>vi, vim, nano are not present)</p><p></p><p><strong>echo “10.10.11.148		routerspace.htb” &gt;&gt; /system/etc/hosts</strong></p><p><img src="images/34-14.png" alt="images/34-14.png" /></p><p></p><p>OR</p><p></p><p>I use adb to <strong>pull</strong> files, <strong>edit</strong> it and then <strong>push</strong> back the files.</p><p></p><p>Copy /system/etc/hosts to current directory</p><p><strong>adb pull /system/etc/hosts .</strong></p><p></p><p>Edit the file with nano/vim and add “10.10.11.148		routerspace.htb” to it</p><p><strong>vim hosts</strong></p><p></p><p>Copy the edited local file into the anbox container filesystem.</p><p><strong>adb push hosts /system/etc/hosts</strong></p><p></p><p><img src="images/34-15.png" alt="images/34-15.png" /></p><p></p><p>As we can see we in <strong>both</strong> ways we cannot write to it.</p><p>I found another intresting point: <strong>Read-only file system</strong></p><p></p><p>I looked at the <strong>/proc/mounts</strong> we see that the image is loaded as <strong>ro</strong> → Read Only</p><p><img src="images/34-16.png" alt="images/34-16.png" /></p><p>Check the one highlighted</p><p></p><p></p><p>So I tried to remount the filesystem as Read-write, but it also failed</p><p><img src="images/34-17.png" alt="images/34-17.png" /></p><p>It says its <strong>write-protected</strong></p><p></p><p></p><p>Anbox Android images from  (<strong>https://build.anbox.io/android-images/</strong>) are <strong>write protected</strong>.</p><p>Thus I cannot make any changes in the filesystem.</p><p></p><p>I also researched that we need a <strong>rooted android image</strong> file to be able to make changes. However, anbox doesn&#39;t provide them.</p><p>Its not readily available to download as an image file as of now.</p><p></p><p><strong>Note:</strong> <strong>Arch Linux</strong> for anbox community has a dedicated page in its AUR(Arch User Repository) for rooted android image. however, the resource/webpage doen not provide any <strong>.img</strong> file download. It is about how to build an image using PKGBUILD script.</p><p></p><p>For Further Research Search : &quot;Arch Linux Rooted Android Image&quot;</p><p><strong>https://aur.archlinux.org/packages/anbox-image-gapps-rooted</strong></p><p></p><p></p><p><strong><span style="text-decoration:underline;">Method - 2 (Using a proxy server in the local machine)</span></strong></p><p></p><p>If We cannot edit the hosts file. We can route the container http traffic through a proxy server and use the hosts file of the proxy server to have the entry in it.</p><p></p><p>I can use Burpsuite and set up the proxy server. All the http traffic going from/to anbox container will go through burpsuite proxy and as burpsuite is running on the local machine. The /etc/hosts files of the local machine will be checked for domain names.</p><p></p><p>Thus my local kali machine&#39;s host file should have the entry.</p><p></p><p><img src="images/34-18.png" alt="images/34-18.png" /></p><p></p><p></p><p>I make the settings in the <strong>adb</strong> for the anbox container to use the proxy.</p><p></p><p><strong>adb shell settings put global http_proxy 10.10.16.28:9090</strong></p><p><img src="images/34-19.png" alt="images/34-19.png" /></p><p></p><p><strong>Note:</strong> To remove proxy use the following command.</p><p><strong>adb shell settings put global http_proxy :0</strong></p><p></p><p></p><p>I am using the VPN IP as our proxy server IP. Iwill point this to burpsuite proxy listeners</p><p></p><p>Next, I make the settings in <strong>burpsuite</strong></p><p></p><p>Open Proxy ---→ options</p><p><img src="images/34-20.png" alt="images/34-20.png" /></p><p></p><p>I need to add my previously set VPN IP here for burpsuite to listen to connection. </p><p><img src="images/34-21.png" alt="images/34-21.png" /></p><p></p><p>Now, its reflecting in the listeners.</p><p></p><p><img src="images/34-22.png" alt="images/34-22.png" /></p><p></p><p></p><p>For the time being lets keep <strong>intercept to off </strong>and try to run our app.</p><p></p><p><img src="images/34-23.png" alt="images/34-23.png" /></p><p></p><p>As it is going through the proxy server at VPN IP and therefore is able to connect to http://routerspace.htb<strong> </strong></p><p><strong></strong></p><p></p><p><strong><h2>FootHold</h2></strong></p><p></p><p>I turned the <strong>Intercept on</strong> in the burpsuite and run the app again to capture the request the app is making.</p><p>i then sent it to <strong>repeater</strong> to make tweaks and send it multiple times as per requirement.</p><p></p><p></p><p>Sending to server from repeater without any changes</p><p><img src="images/34-24.png" alt="images/34-24.png" /></p><p></p><p>We can see that whatever we give in the “ip”: field its getting reflected back.</p><p></p><p>I tried to put shell commands here to see if we have RCE.</p><p><img src="images/34-25.png" alt="images/34-25.png" /></p><p></p><p>The same name is reflected with \n.</p><p>Now let&#39;s try to do some basic method to bypass the filter.</p><p></p><p>I simply add <strong>\n</strong> in front of command.</p><p></p><p><img src="images/34-26.png" alt="images/34-26.png" /></p><p></p><p>And finally we can execute commands on the machine.</p><p></p><p>I  check the user&#39;s home directory and there is <strong>.ssh/authorized_keys</strong></p><p><img src="images/34-27.png" alt="images/34-27.png" /></p><p></p><p>I created my ssh keys with a paraphrase and add my public key to the authorized_keys file</p><p></p><p><img src="images/34-28.png" alt="images/34-28.png" /></p><p></p><p>I put the public key into the authorized_key file using burpsuite.</p><p><strong>echo ‘pub_key-contents’ &gt;&gt; /home/paul/.ssh/authorized_keys</strong></p><p><img src="images/34-29.png" alt="images/34-29.png" /></p><p></p><p></p><p>I then logged into the system with ssh as user <strong>paul</strong> and our <strong>paraphrase</strong> password.</p><p><img src="images/34-30.png" alt="images/34-30.png" /></p><p></p><p>I found the user flag in the home directory.</p><p></p><p><strong><h2>Privilege Escalation</h2></strong></p><p></p><p>We check for any vulnerabilities we can find using <strong>Linpeas</strong></p><p>Sudo was vulnerable</p><p></p><p><img src="images/34-31.png" alt="images/34-31.png" /></p><p></p><p>This version of sudo is vulnerable to Baron Samedit </p><p><strong>https://github.com/worawit/CVE-2021-3156/blob/main/exploit_nss.py</strong></p><p></p><p>We use this exploit in the machine and get root access.</p><p></p><p><img src="images/34-32.png" alt="images/34-32.png" /></p><p></p><p>We got the root flag in the /root directory.</p><p></p><p>Thanks!!</p></div>
</body>
</html>
