<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>YARA</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>YARA</h1><br/><strong><h1>YARA</h1></strong><br /><br />The applications and language that is Yara for everything threat intelligence, forensics, and threat hunting!<br /><br />YARA in a nutshell<br /><br />YARA is a tool aimed at (but not limited to) helping malware researchers to identify and classify malware samples. With YARA you can create descriptions of malware families (or whatever you want to describe) based on textual or binary patterns. Each description, a.k.a. rule, consists of a set of strings and a boolean expression which determine its logic. Let&#39;s see an example:<br /><br />rule silent_banker : banker<br />{<br />    meta:<br />        description = &quot;This is just an example&quot;<br />        threat_level = 3<br />        in_the_wild = true<br /><br />    strings:<br />        $a = {6A 40 68 00 30 00 00 6A 14 8D 91}<br />        $b = {8D 4D B0 2B C1 83 C0 27 99 6A 4E 59 F7 F9}<br />        $c = &quot;UVODFRYSIHLNWPEJXQZAKCBGMT&quot;<br /><br />    condition:<br />        $a or $b or $c<br />}<br /><br />The above rule is telling YARA that any file containing one of the three strings must be reported as silent_banker. This is just a simple example, more complex and powerful rules can be created by using wild-cards, case-insensitive strings, regular expressions, special operators and many other features that you&#39;ll find explained in YARA&#39;s documentation.<br /><br /><br /><em>Refernce to Rules:</em> <strong>https://yara.readthedocs.io/en/stable/writingrules.html</strong><br /><br /><br /><strong><h3>Practicals</h3></strong><br /><br /><strong><span style="text-decoration:underline;">Your First Yara Rule</span></strong><br /><br />The  proprietary language that Yara uses for rules is fairly trivial to pick  up, hard to master. This is because your rule is only as effective  as your understanding of the patterns you want to search for.<br /><br />Using a Yara rule is simple. Every <strong>yara</strong> command requires two arguments to be valid, these are:<br /><strong>1)</strong> The rule file we create<br /><strong>2) </strong>Name of file, directory, or process ID to use the rule for.<br /><br />Every rule must have a name and condition.<br /><br />For example, if we wanted to use &quot;myrule.yar&quot; on directory &quot;some directory&quot; we would use the following command:<br /><strong>yara myrule.yar somedirectory</strong><br /><br />Note that <strong>.yar</strong> is the standard file extension for all Yara rules.<br /><br />We&#39;ll make one of the most basic rules you can make below.<br /><br /><strong>1. </strong>Make a file named &quot;<strong>somefile</strong>&quot; via <strong>touch somefile</strong><br /><strong>2.</strong> Open a new file and name it &quot;<strong>myfirstrule.yar</strong>&quot; like below:<br /><br /><a href="https://i.imgur.com/RgUnRmI.png"><img src="images/257-1.png" alt="images/257-1.png" /></a><br /><br />3. With this open, input the snippet below and save the file:<br /><br /><strong>rule examplerule {<br />        condition: true<br />}</strong><br /><br /><img src="images/257-2.png" alt="images/257-2.png" /><br /><br />The <strong>name</strong> of the rule in this snippet is <strong>examplerule</strong>, where we have one condition - in this case, the <strong>condition</strong> is <strong>condition</strong>.  As previously discussed, every rule requires both <em><strong>a name</strong></em> and <em><strong>a condition</strong></em> to be valid. This rule has satisfied those two requirements.<br /><br />Simply, the rule we have made checks to see if the file/directory/PID that we specify exists via <strong>condition: true</strong>. If the file does exist, we are given the output of <strong>examplerule</strong> <br /><br />Let&#39;s give this a try on the file <strong>&quot;some file&quot;</strong> that we made in step one:<br /><strong>yara myfirstrule.yar somefile</strong><br /><br />If &quot;some file&quot; exists, Yara will say <strong>examplerule</strong> because the pattern has been met - as we can see below:<br /><br /><img src="images/257-3.png" alt="images/257-3.png" /><br /><br />If the file does not exist, Yara will output an error such as that below:<br /><br /><img src="images/257-4.png" alt="images/257-4.png" /><br /><br />Congrats! You&#39;ve made your first rule.<br /><br /><br /><br /><br /><br /><strong><h1>Brief Description of Some YARA Rules</h1></strong><br /><br /><br /><img src="images/257-5.png" alt="images/257-5.png" /><br /><br />Yara has a few conditions, which I encourage you to read “<strong>https://yara.readthedocs.io/en/stable/writingrules.html</strong>”at your own leisure. However, I&#39;ll detail a few below and explain their purpose.<br /><br /><table class="table"><tr><th>Keyword</th></tr><tr><td>Desc</td></tr><tr><td>Meta</td></tr><tr><td>Strings</td></tr><tr><td>Conditions</td></tr><tr><td>Weight</td></tr></table><br /><br /><br /><h3>6.1.1. Meta</h3><br />This section of a Yara rule is reserved for descriptive information by the author of the rule. For example, you can use `desc`, short for description, to summarise what your rule checks for. Anything within this section does not influence the rule itself. Similar to commenting code, it is useful to summarise your rule.<br /><br /><br /><br /><h3>6.1.2. Strings</h3><br />Remember  our discussion about strings in Task 2? Well, here we go. You can use  strings to search for specific text or hexadecimal in files or programs.  For example, say we wanted to search a directory for all files  containing &quot;Hello World!&quot;, we would create a rule such as below:<br /><br /><img src="images/257-6.png" alt="images/257-6.png" /><br /><br />We define the keyword `Strings` where the string that we want to search, i.e., &quot;Hello World!&quot; is stored within the variable <strong>$hello_world</strong><br /><br />Of course, we need a condition here to make the rule valid. In this example, to make this string the condition, we need to use the variable&#39;s name. In this case, <strong>$hello_world</strong>:<br /><br /><br /><br /><img src="images/257-7.png" alt="images/257-7.png" /><br /><br /><br /><small>Essentially,  if any file has the string &quot;Hello World!&quot; then the rule will match.  However, this is literally saying that it will only match if &quot;Hello  World!&quot; is found and will not match if &quot;hello world&quot; or &quot;HELLO WORLD.&quot;</small><br /><br />To solve this, the condition <strong>any of them</strong> allows multiple strings to be searched for, like below:<br /><br /><img src="images/257-8.png" alt="images/257-8.png" /><br /><br /><br /><small>Now, any file with the strings of:</small><br /><small>- Hello World!</small><br /><small>- hello world</small><br /><small>- HELLO WORLD</small><br /><br /><br /><small>Will now trigger the rule.</small><br /><br /><br /><br /><h3>6.2. Conditions</h3><br />We have already used the <strong>true</strong> and <strong>any of them</strong> condition. Much like regular programming, you can use operators such as:<br /><br /><br /><strong>&lt;=</strong><small> less than or equal to</small><br /><strong>&gt;=</strong><small> more than or equal to</small><br /><strong>!=</strong><small> not equal to</small><br /><br /><br />For example, the rule below would do the following:<br /><br /><img src="images/257-9.png" alt="images/257-9.png" /><br /><br />The rule will now: <br />- Look for the &quot;Hello World!&quot; string<br />- Only say the rule matches if there are less than or equal to ten occurrences of the &quot;Hello World!&quot; string<br /><br /><br /><h3>6.3. Combining keywords</h3><br /><small>Moreover, you can use keywords such as:</small><br /><strong>and</strong><br /><strong>not</strong><br /><strong>or</strong><small> </small><br /><br /><br />To combine multiple conditions. Say if you wanted the rule to match if any <strong>.txt</strong> files with &quot;Hello World!&quot; is found, you can use a rule like below:<br /><br /><img src="images/257-10.png" alt="images/257-10.png" /><br /><br />The rule will only match if both conditions are true. To illustrate: below, the rule we created, in this case, did not match because although the file has &quot;Hello World!&quot; it does not have the <strong>.txt</strong> extension:<br /><br /><img src="images/257-11.png" alt="images/257-11.png" /><br /><br /><br />However, the rule matched this time because the file has both &quot;Hello World!&quot; and the `.txt` extension.<br /><br /><img src="images/257-12.png" alt="images/257-12.png" /><br /><br /><strong>Note:</strong> The above way to check Extension doesn&#39;t work as shown above. It can be done using modules.<br /><br />Remembering that the text within the red box is the name of our rule, and the text within the green is the matched file.<br /><br /><br /><strong><h1>YARA Modules</h1></strong><br /><br /><h3>7.1. Integrating With Other Libraries</h3><br /><br /><br />Frameworks such as the <a href="https://cuckoosandbox.org/">Cuckoo Sandbox</a> or <a href="https://pypi.org/project/pefile/">Python&#39;s PE Module</a> allows you to improve the technicality of your Yara rules ten-fold.<br /><br /><br /><h3>7.2. Cuckoo</h3><br />Cuckoo Sandbox is an automated malware analysis environment. This module allows you to generate Yara rules based upon the behaviours discovered from Cuckoo Sandbox. As this environment executes malware, you can create rules on specific behaviours such as runtime strings and the likes.<br /><br /><h3>7.3. Python PE</h3><br />Python&#39;s PE module allows you to create Yara rules from the various sections and elements of the Windows Portable Executable (PE) structure.<br /><br /><br />Explaining this structure is out of scope as it is covered in my malware introductory room. However, this structure is the standard formatting of all executables and DLL files on windows. Including the programming libraries that are used. <br /><br /><br />Examining a PE file&#39;s contents is an essential technique in malware analysis; this is because behaviours such as cryptography or worming can be largely identified without reverse engineering or execution of the sample.<br /><br /><strong><h1>YARA External Tools</h1></strong><br /><br />8.1 Yara Tools<br />Knowing  how to create custom Yara rules is useful, but luckily you don&#39;t have  to create many rules from scratch to begin using Yara to search for  evil. There are plenty of GitHub resources and open source tools (along with commercial products) that can be utilized  to leverage Yara in hunt operations and/or incident response  engagements. <br /><br /><strong><span style="text-decoration:underline;">1. LOKI (what, not who, is Loki?)</span></strong><br />LOKI is a free open source IOC (<em>Indicator of Compromise</em>) scanner created/written by Florian Roth. <br />Based on the GitHub page, detection is based on 4 methods:<br />1. File Name IOC Check<br />2. Yara Rule Check<strong> (we are here)</strong><br />3. Hash Check<br />4. C2 Back Connect Check<br />There are additional checks that LOKI can be used for. For a full rundown, please reference the GitHub readme. <br />LOKI can be used on both Windows and Linux systems. Windows users can download the binary file (<a href="https://github.com/Neo23x0/Loki/releases">here</a>), which will run on both 32-bit and 64-bit systems. Linux users can use the same link to download LOKI.<br /><br /><img src="images/257-13.png" alt="images/257-13.png" /><br /><br /><br /><br /><strong><span style="text-decoration:underline;">2. THOR</span></strong><span style="text-decoration:underline;"> </span><strong><span style="text-decoration:underline;">(</span></strong><em><strong><span style="text-decoration:underline;">superhero named programs for a superhero blue teamer)</span></strong></em><br />THOR <em>Lite</em> is Florian&#39;s newest multi-platform IOC  AND YARA scanner. There are precompiled versions for Windows, Linux,  and macOS. A nice feature with THOR Lite is its scan throttling to limit  exhausting CPU resources. For more information and/or to download the  binary, start <a href="https://www.nextron-systems.com/thor-lite/">here</a>. You need to subscribe to their mailing list to obtain a copy of the binary. <strong>Note that THOR is geared towards corporate customers</strong>. THOR Lite is the free version.<br /><img src="images/257-14.png" alt="images/257-14.png" /><br /><br /><br /><strong><span style="text-decoration:underline;">3. FENRIR (naming convention still mythical themed)</span></strong><br />This is the 3rd <a href="https://github.com/Neo23x0/Fenrir">tool</a>  created by Neo23x0 (Florian Roth). You guessed it; the previous 2 are  named above. The updated version was created to address the issue from  its predecessors, where requirements must be met for them to function.  Fenrir is a bash script; it will run on any system capable of running  bash (nowadays even Windows). <br /><img src="images/257-15.png" alt="images/257-15.png" /><br /><br /><br /><br /><strong><span style="text-decoration:underline;">4. YAYA (</span></strong><em><strong><span style="text-decoration:underline;">Yet Another Yara Automaton</span></strong></em><strong><span style="text-decoration:underline;">)</span></strong><br />YAYA was created by the <a href="https://www.eff.org/deeplinks/2020/09/introducing-yaya-new-threat-hunting-tool-eff-threat-lab">EFF</a> (<em>Electronic Frontier Foundation</em>) and released in September 2020. Based on their website, &quot;<em>YAYA  is a new open-source tool to help researchers manage multiple YARA rule  repositories. YAYA starts by importing a set of high-quality YARA rules  and then lets researchers add their own rules, disable specific  rulesets, and run scans of files.</em>&quot;<br />Note: Currently, YAYA will only run on Linux systems. <br /><img src="images/257-16.png" alt="images/257-16.png" /><br /><br /><br /><strong><h1>YARA Rules Generator</h1></strong><br /><br />10.1 Creating Yara rules with yarGen<br /><br /><br />We need to create a Yara rule to detect this specific web shell in our environment. Typically this is what is done in the case of an incident, which is an event that affects/impacts the organization in a negative fashion.<br /><br />We can manually open the file and attempt to sift through lines upon lines of code to find possible strings that can be used in our newly created Yara rule.<br /><br />Let&#39;s check how many lines this particular file has. You can run the following:<strong> strings &lt;file name&gt; | wc -l.</strong><br /><br /><br />If you try to go through each string, line by line manually, you should quickly realize that this can be a daunting task.<br /><img src="images/257-17.png" alt="images/257-17.png" /><br /><br />Luckily, we can use yarGen (yes, another tool created by Florian Roth) to aid us with this task.<br /><br />What is yarGen? yarGen is a generator for YARA rules.<br /><br />From the README - &quot;The main principle is the creation of yara rules from strings found in malware files while removing all strings that also appear in goodware files. Therefore yarGen includes a big goodware strings and opcode database as ZIP archives that have to be extracted before the first use.&quot;<br /><br />Navigate to the yarGen directory, which is within tools. If you are running yarGen on your own system, you need to update it first by running the following command:<strong> python3 yarGen.py --update</strong>.<br /><br /><img src="images/257-18.png" alt="images/257-18.png" /><br /><br />This will update the good-opcodes and good-strings DB&#39;s from the online repository. This update will take a few minutes. <br />Once it has been updated successfully, you&#39;ll see the following message at the end of the output.<br /><br /><img src="images/257-19.png" alt="images/257-19.png" /><br /><br />To use <strong>yarGen</strong> to generate a Yara rule for file 2, you can run the following command:<br /><br /><strong>python3 yarGen.py -m /home/cmnatic/suspicious-files/file2 --excludegood -o /home/cmnatic/suspicious-files/file2.yar </strong><br /><br />A brief explanation of the parameters above:<br /><br />    <strong>-m</strong> is the path to the files you want to generate rules for<br />    <strong>--excludegood</strong> force to exclude all goodware strings (these are strings found in legitimate software and can increase false positives)<br />    <strong>-o</strong> location &amp; name you want to output the Yara rule<br /><br />If all is well, you should see the following output.<br /><br /><img src="images/257-20.png" alt="images/257-20.png" /><br /><br /><br />Generally, you would examine the Yara rule and remove any strings that you feel might generate false positives. For this exercise, we will leave the generated Yara rule as is and test to see if Yara will flag file 2 or no. <br /><br /><strong>Note:</strong> This freshly generated <strong>file2.yar</strong> can be used inside Loki. Just paste it inside the <strong>“signature base”</strong> directory of Loki and from next run onwards, this rule will be used. Thus the second file will be flagged now.<br /><br /><strong>Note:</strong> Another tool created to assist with this is called <strong>yarAnalyzer</strong> (<strong>https://github.com/Neo23x0/yarAnalyzer/</strong>- created by Florian Roth). We will not examine that tool in this room, but you should read up on it, especially if you decide to start creating your own Yara rules. <br /><br />Further Reading on creating Yara rules and using yarGen:<br /><br />    https://www.bsk-consulting.de/2015/02/16/write-simple-sound-yara-rules/<br />    https://www.bsk-consulting.de/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/<br />    https://www.bsk-consulting.de/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/<br /><br /><br /><strong><h1>YARA External Feed Website (Online Search)</h1></strong><br /><br /><strong>Valhalla</strong> is an online Yara feed created and hosted by <a href="https://www.nextron-systems.com/valhalla/">Nextron-Systems</a> (erm,  Florian Roth). By now, you should be aware of the ridiculous amount of  time and energy Florian has dedicated to creating these tools for the  community. Maybe we should have just called this the Florian Roth room.  (lol)<br />Per the website, &quot;<em>VALHALLA boosts your detection capabilities with the power of thousands of hand-crafted high-quality YARA rules.</em>&quot;<br /><img src="images/257-21.png" alt="images/257-21.png" /><br /><br /><br />From  the image above, we should denote that we can conduct searches based on  a keyword, tag, ATT&amp;CK technique, sha256, or rule name. <br /><strong><small>Note</small></strong><small>: For more information on ATT&amp;CK, please visit the </small><strong>MITRE</strong><small> room. </small><br />Taking a look at the data provided to us, let&#39;s examine the first rule listed on the feed (<em>as of this entry date</em>) <a href="https://valhalla.nextron-systems.com">here</a>.<br /><img src="images/257-22.png" alt="images/257-22.png" /><br /><br />We  are provided with the name of the rule, a brief description, a  reference link for more information about the rule, along with the rule  date. <br />Feel free to look at some rules to become familiar with the  usefulness of Valhalla. The best way to learn the product is by just  jumping right in. <br />Picking up from our scenario, at this point,  you know that the 2 files are related. Even though Loki classified the  files are suspicious, you know in your gut that they are malicious.  Hence the reason you created a Yara rule using yarGen to detect it on  other web servers. But let&#39;s further pretend that you are not code-savvy  (FYI - not all security professionals know how to code/script or read  it). You need to conduct further research regarding these files to  receive approval to eradicate these files from the network. <br /></div>
</body>
</html>
