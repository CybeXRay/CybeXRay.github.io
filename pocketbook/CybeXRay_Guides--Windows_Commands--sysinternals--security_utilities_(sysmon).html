<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>security utilities (sysmon)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>security utilities (sysmon)</h1><br/><strong><h1>Security Utilities</h1></strong><br /><br /><strong><h2>Sysmon</h2></strong><br /><br /><strong>System Monitor</strong> (<strong>Sysmon</strong>) is a Windows system service and device driver that, once installed on a system, remains resident across system reboots to monitor and log system activity to the Windows event log. It provides detailed information about process creations, network connections, and changes to file creation time. By collecting the events it generates using Windows Event Collection or SIEM agents and subsequently analyzing them, you can identify malicious or anomalous activity and understand how intruders and malware operate on your network.<br /><br />Events within Sysmon are stored in <strong>Applications and Services Logs/Microsoft/Windows/Sysmon/Operational</strong> &amp; can be viewed in Windows Event Viewer.<br /> <br /> <br /><strong>Sysmon Config Overview</strong><br /><br />Sysmon requires a config file in order to tell the binary how to analyze the events that it is receiving. You can create your own Sysmon config or you can download a config. Here is an example of a high-quality config that works well for identifying anomalies created by <strong>SwiftOnSecurity</strong>: <strong>Sysmon-Config</strong>. Sysmon includes 24 different types of Event IDs, all of which can be used within the config to specify how the events should be handled and analyzed. Below we will go over a few of the most important Event IDs and show examples of how they are used within config files.<br /><br />When creating or modifying configuration files you will notice that a <strong>majority of rules</strong> in sysmon-config will <strong>exclude events</strong> rather than include events. This will help filter out normal activity in your environment that will in turn decrease the number of events and alerts you will have to manually audit or search through in a SIEM. On the other hand, there are rulesets like the <strong>ION-Storm sysmon-config fork</strong> that takes a more proactive approach with it&#39;s ruleset by using a lot of <strong>include rules</strong>. You may have to modify configuration files to find what approach you prefer. Configuration preferences will vary depending on what SOC team so prepare to be flexible when monitoring.<br /><br /><br /><a href="https://github.com/SwiftOnSecurity/sysmon-config/blob/master/sysmonconfig-export.xml">https://github.com/SwiftOnSecurity/sysmon-config/blob/master/sysmonconfig-export.xml</a><br /><a href="https://github.com/ion-storm/sysmon-config/blob/master/sysmonconfig-export.xml">https://github.com/ion-storm/sysmon-config/blob/master/sysmonconfig-export.xml</a><br /><br />Note: As there are so many Event IDs Sysmon analyzes.            <br /><br /><span style="text-decoration:underline;">Running Sysmon (Lets use SwiftOnSecurity Sysmon-Config File)</span>:<br /><br /><strong>Sysmon.exe -accepteula -i sysmonconfig-export.xml</strong><br /><br /><strong>Note:</strong> At any time you can change the configuration file used by uninstalling or updating the current configuration and replacing it with a new configuration file. For more information look through the Sysmon help menu. <br /><br /><span style="text-decoration:underline;">Update</span>: <strong>Sysmon.exe -c sysmonconfig-export.xml</strong><br /><span style="text-decoration:underline;">Uninstall</span>: <strong>Sysmon.exe -u</strong><br /><br /><br /><strong>Detecting Metasploit</strong><br /><br /><span style="text-decoration:underline;">Sysmon-Config Rule</span>:<br /><strong>&lt;RuleGroup name=&quot;&quot; groupRelation=&quot;or&quot;&gt;<br />	&lt;NetworkConnect onmatch=&quot;include&quot;&gt;<br />		&lt;DestinationPort condition=&quot;is&quot;&gt;4444&lt;/DestinationPort&gt;<br />		&lt;DestinationPort condition=&quot;is&quot;&gt;5555&lt;/DestinationPort&gt;<br />	&lt;/NetworkConnect&gt;<br />&lt;/RuleGroup&gt;</strong><br /><br />Eg.We can put these filters together with various attributes and data to get the most control out of our logs. Look below for an example of using Get-WinEvent to look for network connections coming from port 4444.<br /><br /><span style="text-decoration:underline;">Powershell Command</span>:<br /><strong>Get-WinEvent -Path &lt;Path to Log&gt; -FilterXPath &#39;*/System/EventID=3 and */EventData/Data[@Name=&quot;DestinationPort&quot;] and */EventData/Data=4444&#39;</strong><br /><br /><span style="text-decoration:underline;">Demo</span>:<br /><img src="images/268-1.png" alt="images/268-1.png" /><br /><br /><strong>Detecting Mimikatz</strong><br /><br /><span style="text-decoration:underline;">Sysmon-Config Rule</span>:<br /><strong>&lt;RuleGroup name=&quot;&quot; groupRelation=&quot;or&quot;&gt;<br />	&lt;ProcessAccess onmatch=&quot;exclude&quot;&gt;<br />		&lt;SourceImage condition=&quot;image&quot;&gt;svchost.exe&lt;/SourceImage&gt;<br />	&lt;/ProcessAccess&gt;<br />	&lt;ProcessAccess onmatch=&quot;include&quot;&gt;<br />		&lt;TargetImage condition=&quot;image&quot;&gt;lsass.exe&lt;/TargetImage&gt;<br />	&lt;/ProcessAccess&gt;<br />&lt;/RuleGroup&gt;</strong><br /><br /><span style="text-decoration:underline;">Powershell Command</span>:<br /><strong>Get-WinEvent -Path &lt;Path to Log&gt; -FilterXPath &#39;*/System/EventID=10 and */EventData/Data[@Name=&quot;TargetImage&quot;] and */EventData/Data=&quot;C:\Windows\system32\lsass.exe&quot;&#39;</strong><br /><br /><strong>Hunting Malwares</strong><br /><br /><span style="text-decoration:underline;">Sysmon-Config Rule</span>:<br /><strong>&lt;RuleGroup name=&quot;&quot; groupRelation=&quot;or&quot;&gt;<br />	&lt;NetworkConnect onmatch=&quot;include&quot;&gt;<br />		&lt;DestinationPort condition=&quot;is&quot;&gt;1034&lt;/DestinationPort&gt;<br />		&lt;DestinationPort condition=&quot;is&quot;&gt;1604&lt;/DestinationPort&gt;<br />	&lt;/NetworkConnect&gt;<br />	&lt;NetworkConnect onmatch=&quot;exclude&quot;&gt;<br />		&lt;Image condition=&quot;image&quot;&gt;OneDrive.exe&lt;/Image&gt;<br />	&lt;/NetworkConnect&gt;<br />&lt;/RuleGroup&gt;</strong><br /><br /><span style="text-decoration:underline;">Powershell Command</span>:<br /><strong>Get-WinEvent -Path &lt;Path to Log&gt; -FilterXPath &#39;*/System/EventID=3 and */EventData/Data[@Name=&quot;DestinationPort&quot;] and */EventData/Data=&lt;Port&gt;&#39;</strong><br /><br /><strong>Hunting Startup Persistence</strong><br /><br /><span style="text-decoration:underline;">Sysmon-Config Rule</span>:<br /><strong>&lt;RuleGroup name=&quot;&quot; groupRelation=&quot;or&quot;&gt;<br />	&lt;FileCreate onmatch=&quot;include&quot;&gt;<br />		&lt;TargetFilename name=&quot;T1023&quot; condition=&quot;contains&quot;&gt;\Start Menu&lt;/TargetFilename&gt;<br />		&lt;TargetFilename name=&quot;T1165&quot; condition=&quot;contains&quot;&gt;\Startup\&lt;/TargetFilename&gt;<br />	&lt;/FileCreate&gt;<br />&lt;/RuleGroup&gt;</strong><br /><br /><strong>Hunting Registry Key Persistence</strong><br /><br /><span style="text-decoration:underline;">Sysmon-Config Rule</span>:<br /><strong>&lt;RuleGroup name=&quot;&quot; groupRelation=&quot;or&quot;&gt;<br />	&lt;RegistryEvent onmatch=&quot;include&quot;&gt;<br />		&lt;TargetObject name=&quot;T1060,RunKey&quot; condition=&quot;contains&quot;&gt;CurrentVersion\Run&lt;/TargetObject&gt;<br />		&lt;TargetObject name=&quot;T1484&quot; condition=&quot;contains&quot;&gt;Group Policy\Scripts&lt;/TargetObject&gt;<br />		&lt;TargetObject name=&quot;T1060&quot; condition=&quot;contains&quot;&gt;CurrentVersion\Windows\Run&lt;/TargetObject&gt;<br />	&lt;/RegistryEvent&gt;<br />&lt;/RuleGroup&gt;</strong><br /><br /><br /><strong>Detecting Evasion Techniques</strong><br /><strong>A) Hunting Alternate Data Streams</strong><br /><br /><span style="text-decoration:underline;">Sysmon-Config Rule</span>:<br /><strong>&lt;RuleGroup name=&quot;&quot; groupRelation=&quot;or&quot;&gt;<br />	&lt;FileCreateStreamHash onmatch=&quot;include&quot;&gt;<br />		&lt;TargetFilename condition=&quot;contains&quot;&gt;Downloads&lt;/TargetFilename&gt;<br />		&lt;TargetFilename condition=&quot;contains&quot;&gt;Temp\7z&lt;/TargetFilename&gt;<br />		&lt;TargetFilename condition=&quot;ends with&quot;&gt;.hta&lt;/TargetFilename&gt;<br />		&lt;TargetFilename condition=&quot;ends with&quot;&gt;.bat&lt;/TargetFilename&gt;<br />	&lt;/FileCreateStreamHash&gt;<br />&lt;/RuleGroup&gt;</strong><br /><br /><span style="text-decoration:underline;">Powershell Command</span>:<br /><strong>Get-WinEvent -Path &lt;Path to Log&gt; -FilterXPath &#39;*/System/EventID=15&#39;</strong><br /><br /><strong>B) Detecting Remote Threads</strong> <br /><br /><span style="text-decoration:underline;">Sysmon-Config Rule</span>:<br /><strong>&lt;RuleGroup name=&quot;&quot; groupRelation=&quot;or&quot;&gt;<br />	&lt;CreateRemoteThread onmatch=&quot;exclude&quot;&gt;<br />		&lt;SourceImage condition=&quot;is&quot;&gt;C:\Windows\system32\svchost.exe&lt;/SourceImage&gt;<br />		&lt;TargetImage condition=&quot;is&quot;&gt;C:\Program Files (x86)\Google\Chrome\Application\chrome.exe&lt;/TargetImage&gt;<br />	&lt;/CreateRemoteThread&gt;<br />&lt;/RuleGroup&gt;</strong><br /><br /><span style="text-decoration:underline;">Powershell Command</span>:<br /><strong>Get-WinEvent -Path &lt;Path to Log&gt; -FilterXPath &#39;*/System/EventID=8&#39;</strong><br /></div>
</body>
</html>
