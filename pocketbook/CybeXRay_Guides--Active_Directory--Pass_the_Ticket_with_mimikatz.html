<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Pass the Ticket with mimikatz</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Pass the Ticket with mimikatz</h1><br/><strong>THM: Attacking Kerberos - Task 6</strong><br /><br /><br />Mimikatz is a very popular and powerful post-exploitation tool most commonly used for dumping user credentials inside of an active directory network however well be using mimikatz in order to dump a TGT from LSASS memory<br /><br />This will only be an overview of how the pass the ticket attacks work as THM does not currently support networks but I challenge you to configure this on your own network.<br /><br />You can run this attack on the given machine however you will be escalating from a domain admin to a domain admin because of the way the domain controller is set up.<br /><br /><br /><br /><br /><br /><strong>Pass the Ticket(PTT) Overview</strong><br /><br />Pass the ticket works by <strong>dumping</strong> the <strong>TGT</strong> from the <strong>LSASS memory</strong> of the machine. The <strong>Local Security Authority Subsystem Service</strong> <strong>(LSASS)</strong> is a memory process that stores credentials on an active directory server and can store Kerberos ticket along with other credential types to act as the gatekeeper and accept or reject the credentials provided. You can dump the Kerberos Tickets from the LSASS memory just like you can dump hashes. When you dump the tickets with mimikatz it will give us a .kirbi ticket which can be used to gain domain admin if a domain admin ticket is in the LSASS memory. This attack is great for privilege escalation and lateral movement if there are unsecured domain service account tickets laying around. The attack allows you to escalate to domain admin if you dump a domain admin&#39;s ticket and then impersonate that ticket using mimikatz <strong>PTT attack</strong> allowing you to act as that domain admin. You can think of a pass the ticket attack like reusing an existing ticket were not creating or destroying any tickets here were simply reusing an existing ticket from another user on the domain and impersonating that ticket.<br /><br /><br /><a href=""><img src="images/147-1.png" alt="images/147-1.png" /></a><br /><br /><br /><br /><strong>Prepare Mimikatz &amp; Dump Tickets</strong><br /><br />You will need to run the command prompt as an administrator: use the same credentials as you did to get into the machine. If you don&#39;t have an elevated command prompt mimikatz will not work properly.<br /><br />1.) <strong>cd Downloads</strong> - navigate to the directory mimikatz is in<br />2.) <strong>mimikatz.exe</strong> - run mimikatz<br />3.) <strong>privilege::debug</strong> - Ensure this outputs <strong>[Privilege &#39;20&#39; OK]</strong> if it does not that means you do not have the administrator privileges to properly run mimikatz<br /><br /><a href=""><img src="images/147-2.png" alt="images/147-2.png" /></a><br /><br /><br />4.)<strong> sekurlsa::tickets /export</strong> - this will export all of the .kirbi tickets into the directory that you are currently in<br /><br />It Dumps the the tickets in same folder as the <strong>mimikatz</strong> application.<br /><br /><a href=""><img src="images/147-3.png" alt="images/147-3.png" /></a><br /><br /><br />When looking for which  ticket to impersonate I would recommend looking for an administrator  ticket from the krbtgt.<br /><br /><strong>Pass the Ticket with Mimikatz</strong><br /><br />Now that we have our ticket ready we can now perform a pass the ticket attack to gain domain admin privileges.<br /><br />1.) <strong>kerberos::ptt &lt;ticket&gt;</strong> - run this command inside of mimikatz with the ticket that you harvested from earlier. It will cache and impersonate the given ticket<br /><br /><strong>kerberos::ptt [0;4ac7d]-2-0-40e10000-Administrator@krbtgt-CONTROLLER.LOCAL.kirbi</strong><br /><br /><a href=""><img src="images/147-4.png" alt="images/147-4.png" /></a><br /><br />2.) <strong>klist</strong> - Here were just verifying that we successfully impersonated the ticket by listing our cached tickets.<br /><br />We will not be using mimikatz for the rest of the attack.<br /><br />3.) You now have impersonated the ticket giving you the same rights as the TGT you&#39;re impersonating. To verify this we can look at the admin share.<br /><strong>dir \\10.10.231.157\admin$</strong><br /><br /><a href=""><img src="images/147-5.png" alt="images/147-5.png" /></a><br /><br /><br /><strong>Note</strong> that this is only a POC to understand how to pass the ticket and gain domain admin the way that you approach passing the ticket may be different based on what kind of engagement you&#39;re in so do not take this as a definitive guide of how to run this attack.<br /><br /><br /><strong>Pass the Ticket Mitigation</strong><br /><br />Let&#39;s talk blue team and how to mitigate these types of attacks. <br /><br />Don&#39;t let your domain admins log onto anything except the domain controller - This is something so simple however a lot of domain admins still log onto low-level computers leaving tickets around that we can use to attack and move laterally with.</div>
</body>
</html>
