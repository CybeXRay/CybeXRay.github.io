<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>windows event logs</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>windows event logs</h1><br/><strong><h1>Windows Event Logs</h1></strong><br /><br />The <strong>Windows Event Logs</strong> are <strong>not</strong> text files that can be viewed using a <strong>text editor</strong>. However, the raw data can be translated into XML using the Windows API. The events stored in these log files are stored in a <strong>proprietary binary format</strong> with a <strong>.evt</strong> or .<strong>evtx</strong> extension. The log files with the <strong>.evtx</strong> file extension typically reside in <strong>C:\Windows\System32\winevt\Logs</strong>.<br /><br />There are 3 main ways of accessing these event logs within a Windows system:<br />1. <strong>Event Viewer</strong> (GUI-based application)<br />2. <strong>Wevtutil.exe</strong> (command-line tool)<br />3. <strong>Get-WinEvent</strong> (PowerShell cmdlet)<br /><br /><br /><strong><h2>Event Viewer</h2></strong><br /><br />Open In Search &quot;<strong>Event Viewer</strong>”<br />or<br />From CMD: <strong>eventvwr.msc</strong><br /><br />Event Viewer has 3 panes.<br />1. The pane on the left provides a hierarchical tree listing of the event log providers.<br />2. The pane in the middle will either display a general overview and summary or the events specific to a selected provider.<br />3. The pane on the right is the actions pane.<br /><br /><br />There are 5 types of events that can be logged.<br /><img src="images/263-1.png" alt="images/263-1.png" /><br /><br /><br />On the left pane, the standard logs are visible under <strong>Windows Logs</strong>.<br /><img src="images/263-2.png" alt="images/263-2.png" /><br /><br /><br />The next section is the <strong>Applications and Services Logs</strong>. Expand this section and drill down on <strong>Microsoft &gt; Windows &gt; PowerShell &gt; Operational</strong>.<br />PowerShell will log operations from the engine, providers, and cmdlets to the Windows event log.<br />Right-click on Operational then <strong>Properties</strong>.<br /><br /><img src="images/263-3.png" alt="images/263-3.png" /><br /><br />Within Properties, you see the <strong>log location</strong>, <strong>log size</strong>, and <strong>when it was created</strong>, <strong>modified</strong>, and <strong>last accessed</strong>. Within the Properties window, you can also see the <strong>maximum</strong> set <strong>log size </strong>and what action to take once the criteria are met. This concept is known as <strong>log rotation</strong>. These are discussions held with corporations of various sizes. How long to keep logs and when it&#39;s permissible to overwrite the logs with new data.<br /><br />Lastly, notice the <strong>Clear Log</strong> button at the bottom right. There are legitimate reasons to use this button, but adversaries will likely attempt to clear the logs to go undetected.  Note: This is not the only method to clear the event logs for any given event provider.<br /><br /><strong>Note:</strong><br />To view event logs from another computer, <strong>right-click Event Viewer (Local) &gt; Connect to Another Computer...</strong><br /><br /><br /><strong><h2>Wevtutil.exe</h2></strong><br /><br />You played around with Event Viewer. Imagine you have to sit there and manually sift through hundreds or even thousands of events (even after filtering the log). Not fun. It would be nice if you could write scripts to do this work for you. We will explore some tools that will allow you to query event logs via the command line and/or PowerShell.<br /><br />The <strong>wevtutil.exe</strong> tool &quot;enables you to retrieve information about event logs and publishers. You can also use this command to install and uninstall event manifests, to run queries, and to export, archive, and clear logs.&quot;<br /><br /><span style="text-decoration:underline;">Command</span>:	<strong>wevtutil.exe /?</strong><br /><br /><img src="images/263-4.png" alt="images/263-4.png" /><br /><br /><br /><br /><strong><h2>Get-WinEvent</h2></strong><br /><br />The <strong>Get-WinEvent</strong> cmdlet gets events from event logs and event tracing log files on local and remote computers.<br /><strong>Note:</strong> The <strong>Get-WinEvent</strong> cmdlet replaces the <strong>Get-EventLog</strong> cmdlet. <br /><br /><strong>Refernce:</strong> <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/Get-WinEvent?view=powershell-7.2&viewFallbackFrom=powershell-7.1">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/Get-WinEvent?view=powershell-7.2&amp;viewFallbackFrom=powershell-7.1</a><br /><br />Generally speaking, you can filter event logs as:<br /><strong>Get-WinEvent -LogName Application | Where-Object { $_.ProviderName -Match &#39;WLMS&#39; }</strong><br /><br /><strong>Note:</strong> When working with large event logs, per Microsoft, it&#39;s inefficient to send objects down the pipeline to a <strong>Where-Object</strong> command. The use of the Get-WinEvent cmdlet&#39;s <strong>FilterHashtable</strong> parameter is recommended to filter event logs. <br /><br /><img src="images/263-5.png" alt="images/263-5.png" /><br /><br />The syntax of a hash table is as follows: <br /><img src="images/263-6.png" alt="images/263-6.png" /><br /><br />Guidelines for defining a hash table is as follows:<br /><img src="images/263-7.png" alt="images/263-7.png" /><br /><br /><strong>Note</strong>:  You don&#39;t need to use a <strong>semicolon</strong> if you separate each key/value with a<strong> new line</strong> as in the screenshot above for the <strong>-FilterHashtable</strong> for <strong>ProviderName=&#39;WLMS&#39;</strong><br /><br /><span style="text-decoration:underline;">Command</span>:<br /><br /><strong>Get-WinEvent -FilterHashtable @{LogName=&#39;Application&#39;; ProviderName=&#39;wlms&#39;}</strong><br />or<br /><strong>Get-WinEvent -FilterHashtable @{<br />	LogName=&#39;Application&#39;<br />	ProviderName=&#39;wlms&#39;<br />}</strong><br /><br /><br /><br /><strong><h2>Miscellaneous</h2></strong><br /><br /><strong>XPath Queries</strong><br /><br /><img src="images/263-8.png" alt="images/263-8.png" /><br /><br />Note: XPath Queries can be used by both <strong>wevtutil.exe</strong> &amp; <strong>Get-WinEvent</strong> cmdlet.<br /><br />Let&#39;s create an XPath query for the same event from the previous section.<br /><br /><img src="images/263-9.png" alt="images/263-9.png" /><br /><br />We will create the XPath query from the above.<br />I opned the<strong> Windows Event Viewer</strong> and <strong>Filtered</strong> Event ID of <strong>100</strong>. (As per previous task)<br /><br />Next, we click on <strong>Details</strong> and Open the <strong>XML View</strong><br /><br />The <strong>first</strong> tag is the starting point. This can either be an <strong>*</strong> or the word <strong>Event</strong>. <br /><br /><span style="text-decoration:underline;">Command</span>: <strong>Get-WinEvent -LogName Application -FilterXPath &#39;*&#39;</strong><br /><br />The <strong>next</strong> tag is <strong>System</strong><br /><br /><span style="text-decoration:underline;">Command</span>: <strong>Get-WinEvent -LogName Application -FilterXPath &#39;*/System/&#39;</strong><br /><br /><strong>Note:</strong> Its best practice to explicitly use the keyword <strong>System</strong> but you can use an <strong>*</strong> instead as with the Event keyword. The query <strong>-FilterXPath &#39;*/*</strong>&#39; is still valid. <br /><br />The <strong>next</strong> tag Event ID. The Event ID is 100. Let&#39;s plug that into the command.<br /><br /><span style="text-decoration:underline;">Command</span>: <strong>Get-WinEvent -LogName Application -FilterXPath &#39;*/System/EventID=100&#39;</strong><br />Or<br /><span style="text-decoration:underline;">Command</span>: <strong>Get-WinEvent -LogName Application -FilterXPath &#39;*/System[EventID=100]&#39;</strong><br />Now, we can run it.<br /><br /><strong>Get-WinEvent (Powershell)</strong><br /><img src="images/263-10.png" alt="images/263-10.png" /><br /><br /><strong>wevtutil.exe (CMD)</strong><br /><br /><span style="text-decoration:underline;">Command</span>: <strong>wevtutil.exe qe Application /q:*/System/EventID=100 /f:text /c:1</strong><br />Or<br /><span style="text-decoration:underline;">Command</span>: <strong>wevtutil.exe qe Application /q:*/System[EventID=100] /f:text /c:1</strong><br /><img src="images/263-11.png" alt="images/263-11.png" /><br /><br /><strong><span style="text-decoration:underline;">Another Example:</span></strong><strong> </strong>(includes ProviderName)<br /><span style="text-decoration:underline;">Command</span>: <strong>Get-WinEvent -LogName Application -FilterXPath &#39;*/System/Provider[@Name=&quot;WLMS&quot;]&#39;</strong><br /><br /><br /><strong><span style="text-decoration:underline;">Combing XPath Queries:</span></strong><br /><br /><strong>Get-WinEvent -LogName Application -FilterXPath &#39;*/System/EventID=101 and */System/Provider[@Name=&quot;WLMS&quot;]&#39;</strong><br /><br /><strong><span style="text-decoration:underline;">Using Event Data in XPath Queries:</span></strong><br />For the Following Event Viewer XML<br /><img src="images/263-12.png" alt="images/263-12.png" /><br /><br /><br /><span style="text-decoration:underline;">Command</span>: <strong>Get-WinEvent -LogName Security -FilterXPath &#39;*/EventData/Data[@Name=&quot;TargetUserName&quot;]=&quot;System&quot;&#39;</strong> <strong>-MaxEvents 10</strong><br /><strong>Note:</strong> <strong>-MaxEvents</strong> was used to limit to 10 events of output<br /><br /><strong><h3>Example: Room Question</h3></strong><h3>                                                                                         </h3><br />Using <strong>Get-WinEvent</strong> and <strong>XPath</strong>, what is the query to find WLMS events with a System Time of 2020-12-15T01:09:08.940277500Z?  <br /><br /><span style="text-decoration:underline;">Command</span>: <strong>Get-WinEvent -LogName Application -FilterXPath &#39;*/System/Provider[@Name=&quot;WLMS&quot;] and */System/TimeCreated[@SystemTime=&quot;2020-12-15T01:09:08.940277500Z&quot;]&#39;</strong>                  <br />                        <br />Using <strong>Get-WinEvent</strong> and <strong>XPath</strong>, what is the query to find a user named Sam with an Logon Event ID of 4720?<br /><br /><span style="text-decoration:underline;">Command</span>: <strong>Get-WinEvent -LogName Security -FilterXPath &#39;*/EventData/Data[@Name=&quot;TargetUserName&quot;]=&quot;Sam&quot; and */System/EventID=4720&#39;</strong><br /><br /><br /><span style="text-decoration:underline;">Demo(First Event Display For a Local FIle Using wevtutil.exe)</span>:<br /><strong>wevtutil.exe qe C:\Users\THM-Analyst\Desktop\Scenarios\Practice\Filtering.evtx /lf:true /c:1 /f:text /q:*/System/EventID=3</strong><br /><br /><img src="images/263-13.png" alt="images/263-13.png" /></div>
</body>
</html>
